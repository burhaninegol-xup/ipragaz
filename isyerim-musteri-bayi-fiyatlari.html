<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bayi Fiyatlarƒ± - ƒ∞pragaz</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<script src="js/project-auth-check.js"></script>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			min-height: 100vh;
			background-color: #f5f5f5;
		}

		/* Main Content */
		.main-content {
			max-width: 800px;
			margin: 0 auto;
			padding: 30px 20px;
		}

		/* Info Banner */
		.info-banner {
			background: linear-gradient(135deg, #e31e24 0%, #c41a1f 100%);
			color: #fff;
			padding: 20px;
			border-radius: 12px;
			margin-bottom: 25px;
		}

		.info-banner-title {
			font-size: 16px;
			font-weight: 600;
			margin-bottom: 8px;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.info-banner-title svg {
			width: 20px;
			height: 20px;
		}

		.info-banner-text {
			font-size: 13px;
			opacity: 0.9;
			line-height: 1.5;
		}

		/* Price Cards */
		.price-list {
			display: flex;
			flex-direction: column;
			gap: 15px;
		}

		.price-card {
			background: #fff;
			border-radius: 12px;
			padding: 20px;
			display: flex;
			align-items: center;
			gap: 20px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.05);
			border: 1px solid #eee;
		}

		.price-card-image {
			width: 80px;
			height: 80px;
			flex-shrink: 0;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.price-card-image img {
			max-width: 100%;
			max-height: 100%;
			object-fit: contain;
		}

		.price-card-info {
			flex: 1;
		}

		.price-card-name {
			font-size: 15px;
			font-weight: 600;
			color: #333;
			margin-bottom: 8px;
		}

		.price-card-commitment {
			font-size: 12px;
			color: #888;
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.price-card-commitment svg {
			width: 14px;
			height: 14px;
			color: #e31e24;
		}

		.price-card-price {
			text-align: right;
			flex-shrink: 0;
		}

		.price-label {
			font-size: 11px;
			color: #888;
			margin-bottom: 4px;
		}

		.price-value {
			font-size: 20px;
			font-weight: 700;
			color: #e31e24;
		}

		.price-unit {
			font-size: 13px;
			font-weight: 500;
			color: #888;
		}

		/* Footer Note */
		.footer-note {
			margin-top: 30px;
			padding: 15px 20px;
			background: #fff5f5;
			border-radius: 8px;
			border-left: 4px solid #e31e24;
		}

		.footer-note-text {
			font-size: 13px;
			color: #666;
			line-height: 1.5;
		}

		.footer-note-text strong {
			color: #333;
		}

		/* Withdraw Button */
		.btn-withdraw {
			width: 100%;
			padding: 14px 20px;
			background: #fff;
			border: 2px solid #e31e24;
			border-radius: 25px;
			color: #e31e24;
			font-size: 14px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			margin-top: 30px;
			transition: all 0.2s;
		}

		.btn-withdraw:hover {
			background: #fff5f5;
		}

		/* Warning Overlay */
		.warning-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}

		.warning-overlay.active {
			display: flex;
		}

		.warning-modal {
			background: #fff;
			border-radius: 16px;
			width: 90%;
			max-width: 420px;
			padding: 30px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
			text-align: center;
		}

		.warning-icon {
			width: 60px;
			height: 60px;
			background: #fff5f5;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			margin: 0 auto 20px;
		}

		.warning-icon svg {
			width: 32px;
			height: 32px;
			color: #e31e24;
		}

		.warning-title {
			font-size: 20px;
			font-weight: 700;
			color: #333;
			margin-bottom: 15px;
		}

		.warning-text {
			font-size: 14px;
			color: #666;
			line-height: 1.6;
			margin-bottom: 25px;
		}

		.warning-buttons {
			display: flex;
			gap: 12px;
		}

		.btn-cancel {
			flex: 1;
			padding: 12px 20px;
			background: #f5f5f5;
			border: none;
			border-radius: 25px;
			color: #666;
			font-size: 14px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s;
		}

		.btn-cancel:hover {
			background: #eee;
		}

		.btn-confirm {
			flex: 1;
			padding: 12px 20px;
			background: #e31e24;
			border: none;
			border-radius: 25px;
			color: #fff;
			font-size: 14px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s;
		}

		.btn-confirm:hover {
			background: #c41a1f;
		}

		/* No Offer State */
		.no-offer-state {
			display: none;
		}

		.no-offer-state.active {
			display: block;
		}

		.no-offer-box {
			background: #fff;
			border-radius: 12px;
			padding: 40px 30px;
			text-align: center;
			box-shadow: 0 2px 8px rgba(0,0,0,0.05);
			border: 1px solid #eee;
		}

		.no-offer-icon {
			width: 80px;
			height: 80px;
			background: #fff8e6;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			margin: 0 auto 20px;
		}

		.no-offer-icon svg {
			width: 40px;
			height: 40px;
			color: #ffc107;
		}

		.no-offer-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 10px;
		}

		.no-offer-text {
			font-size: 14px;
			color: #666;
			line-height: 1.6;
			margin-bottom: 25px;
		}

		.btn-select-bayi {
			display: inline-block;
			padding: 14px 30px;
			background: #e31e24;
			border: none;
			border-radius: 25px;
			color: #fff;
			font-size: 14px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s;
		}

		.btn-select-bayi:hover {
			background: #c41a1f;
		}

		/* Selected Bayi Display */
		.selected-bayi-box {
			background: #f0fff4;
			border: 1px solid #28a745;
			border-radius: 12px;
			padding: 20px;
			margin-top: 20px;
			display: none;
		}

		.selected-bayi-box.active {
			display: block;
		}

		.selected-bayi-label {
			font-size: 12px;
			color: #28a745;
			font-weight: 500;
			margin-bottom: 8px;
		}

		.selected-bayi-name {
			font-size: 16px;
			font-weight: 600;
			color: #333;
		}

		/* Bayi Modal */
		.bayi-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}

		.bayi-overlay.active {
			display: flex;
		}

		.bayi-modal {
			background: #fff;
			border-radius: 16px;
			width: 90%;
			max-width: 500px;
			max-height: 80vh;
			overflow: hidden;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		.bayi-modal-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 20px 24px;
			border-bottom: 1px solid #eee;
		}

		.bayi-modal-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
		}

		.bayi-modal-close {
			width: 32px;
			height: 32px;
			border: none;
			background: #f5f5f5;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: background 0.2s;
		}

		.bayi-modal-close:hover {
			background: #eee;
		}

		.bayi-modal-close svg {
			width: 16px;
			height: 16px;
			color: #666;
		}

		.bayi-list {
			padding: 12px 0;
			max-height: 400px;
			overflow-y: auto;
		}

		.bayi-item {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 16px 24px;
			cursor: pointer;
			transition: background 0.2s;
		}

		.bayi-item:hover {
			background: #f9f9f9;
		}

		.bayi-item-info {
			flex: 1;
		}

		.bayi-item-name {
			font-size: 15px;
			font-weight: 500;
			color: #333;
			margin-bottom: 4px;
		}

		.bayi-item-address {
			font-size: 13px;
			color: #888;
		}

		.bayi-item-distance {
			font-size: 14px;
			font-weight: 600;
			color: #e31e24;
			margin-left: 20px;
		}

		/* Hide elements */
		.hidden {
			display: none !important;
		}

		/* Responsive */
		@media (max-width: 576px) {
			.price-card {
				flex-direction: column;
				text-align: center;
			}

			.price-card-info {
				text-align: center;
			}

			.price-card-commitment {
				justify-content: center;
			}

			.price-card-price {
				text-align: center;
			}

			.warning-buttons {
				flex-direction: column;
			}
		}
	</style>
</head>
<body>
	<!-- Top Bar (Component) -->
	<div id="isyerim-top-bar"></div>

	<!-- Header (Component) -->
	<div id="isyerim-header"></div>

	<!-- Main Content -->
	<main class="main-content">
		<!-- Info Banner -->
		<div class="info-banner">
			<div class="info-banner-title">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="12" cy="12" r="10"/>
					<line x1="12" y1="16" x2="12" y2="12"/>
					<line x1="12" y1="8" x2="12.01" y2="8"/>
				</svg>
				Size √ñzel Fiyatlar
			</div>
			<p class="info-banner-text">
				A≈üaƒüƒ±daki fiyatlar bayiniz tarafƒ±ndan i≈ületmenize √∂zel olarak tanƒ±mlanmƒ±≈ütƒ±r. Sipari≈ü verirken bu fiyatlar uygulanacaktƒ±r.
			</p>
		</div>

		<!-- Price List -->
		<div class="price-list" id="priceList">
			<!-- Fiyatlar Supabase'den dinamik olarak y√ºklenir -->
			<div class="loading-placeholder" style="text-align: center; padding: 40px; color: #666;">
				<p>Fiyatlar y√ºkleniyor...</p>
			</div>
		</div>

		<!-- Footer Note -->
		<div class="footer-note" id="footerNote">
			<p class="footer-note-text">
				<strong>Not:</strong> Bu fiyatlar bayiniz tarafƒ±ndan size √∂zel tanƒ±mlanmƒ±≈ütƒ±r. Fiyat deƒüi≈üikliƒüi talepleri i√ßin l√ºtfen bayinizle ileti≈üime ge√ßiniz.
			</p>
		</div>

		<!-- Withdraw Button (sadece owner gorebilir) -->
		<button class="btn-withdraw owner-only" id="btnWithdraw">Tekliften √áekil</button>

		<!-- No Offer State (Hidden by default) -->
		<div class="no-offer-state" id="noOfferState">
			<div class="no-offer-box">
				<div class="no-offer-icon">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="12" cy="12" r="10"/>
						<line x1="12" y1="8" x2="12" y2="12"/>
						<line x1="12" y1="16" x2="12.01" y2="16"/>
					</svg>
				</div>
				<h2 class="no-offer-title">√ñzel Teklif Bulunmuyor</h2>
				<p class="no-offer-text">
					Bayiden sizin i√ßin verilen √∂zel teklif bulunmuyor.<br>
					Yeni bir bayi se√ßerek fiyat teklifi alabilirsiniz.
				</p>
				<button class="btn-select-bayi" id="btnSelectBayi">Bayi Se√ß</button>
			</div>

			<!-- Selected Bayi Display -->
			<div class="selected-bayi-box" id="selectedBayiBox">
				<div class="selected-bayi-label">Se√ßilen Bayi</div>
				<div class="selected-bayi-name" id="selectedBayiName"></div>
			</div>
		</div>
	</main>

	<!-- Footer (Component) -->
	<div id="isyerim-footer"></div>

	<!-- Warning Overlay -->
	<div class="warning-overlay" id="warningOverlay">
		<div class="warning-modal">
			<div class="warning-icon">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
				</svg>
			</div>
			<h3 class="warning-title">Dikkat!</h3>
			<p class="warning-text">
				Bu i≈üleme devam ederseniz bayi tarafƒ±ndan size verilen t√ºm fiyatlar kaybolacaktƒ±r. Bir sonraki sipari≈üiniz √∂nce bayiniz ile yeni fiyatlar √ºzerinden anla≈ümanƒ±z gerekecektir.
			</p>
			<div class="warning-buttons">
				<button class="btn-cancel" id="btnCancel">ƒ∞ptal</button>
				<button class="btn-confirm" id="btnConfirm">Onayla</button>
			</div>
		</div>
	</div>

	<!-- Bayi Selection Overlay -->
	<div class="bayi-overlay" id="bayiOverlay">
		<div class="bayi-modal">
			<div class="bayi-modal-header">
				<h3 class="bayi-modal-title">Bayi Se√ßiniz</h3>
				<button class="bayi-modal-close" id="bayiModalClose">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="18" y1="6" x2="6" y2="18"/>
						<line x1="6" y1="6" x2="18" y2="18"/>
					</svg>
				</button>
			</div>
			<div class="bayi-list" id="bayiList">
				<!-- Bayiler Supabase'den dinamik olarak y√ºklenir -->
				<div style="text-align: center; padding: 20px; color: #666;">Bayiler y√ºkleniyor...</div>
			</div>
		</div>
	</div>

	<!-- Component Loader -->
	<script src="./js/component-loader.js"></script>

	<!-- Supabase -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/customer-prices-service.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/products-service.js"></script>
	<script src="./js/services/branches-service.js"></script>
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/notifications-service.js"></script>
	<script src="./js/services/offers-service.js"></script>
	<script>
		// Staff kullanicilar icin owner-only elementleri gizle
		(function() {
			var userRole = sessionStorage.getItem('isyerim_user_role');
			if (userRole !== 'owner') {
				// DOM yuklendikten sonra gizle
				document.addEventListener('DOMContentLoaded', function() {
					var ownerOnlyItems = document.querySelectorAll('.owner-only');
					ownerOnlyItems.forEach(function(item) {
						item.style.display = 'none';
					});
				});
			}
		})();

		// DOM elementleri
		var infoBanner = document.querySelector('.info-banner');
		var priceListEl = document.getElementById('priceList');
		var footerNote = document.getElementById('footerNote');
		var btnWithdraw = document.getElementById('btnWithdraw');
		var noOfferState = document.getElementById('noOfferState');
		var warningOverlay = document.getElementById('warningOverlay');
		var btnCancel = document.getElementById('btnCancel');
		var btnConfirm = document.getElementById('btnConfirm');
		var btnSelectBayi = document.getElementById('btnSelectBayi');
		var bayiOverlay = document.getElementById('bayiOverlay');
		var bayiModalClose = document.getElementById('bayiModalClose');
		var bayiListEl = document.getElementById('bayiList');
		var selectedBayiBox = document.getElementById('selectedBayiBox');
		var selectedBayiName = document.getElementById('selectedBayiName');

		var currentCustomerId = null;
		var currentDealerId = null;
		var currentOffer = null;
		var currentUserId = null;

		// Fiyatlarƒ± Supabase'den y√ºkle (offers + offer_details tablosundan)
		async function loadPrices() {
			var customerId = sessionStorage.getItem('isyerim_customer_id');
			var dealerId = sessionStorage.getItem('dealer_id');
			var branchId = sessionStorage.getItem('isyerim_branch_id') || sessionStorage.getItem('selected_address_id');

			// DEBUG
			console.log('=== loadPrices DEBUG ===');
			console.log('customerId:', customerId);
			console.log('dealerId:', dealerId);
			console.log('branchId:', branchId);

			if (!customerId) {
				console.log('‚ùå customerId yok, showWithdrawnState √ßaƒürƒ±lƒ±yor');
				showWithdrawnState();
				return;
			}

			currentCustomerId = customerId;

			// Bayi secilmemisse uyari goster
			if (!dealerId) {
				showWithdrawnState();
				return;
			}

			currentDealerId = dealerId;

			// Sube secilmemisse uyari goster
			if (!branchId) {
				priceListEl.innerHTML = '<div style="text-align: center; padding: 40px;"><p>L√ºtfen √∂nce bir ≈üube se√ßin.</p></div>';
				return;
			}

			try {
				// Bu bayi + sube icin accepted teklif var mi?
				const { data: offer, error } = await OffersService.getAcceptedOfferForBranch(dealerId, customerId, branchId);

				if (error) throw new Error(error);

				if (!offer || !offer.offer_details || offer.offer_details.length === 0) {
					showWithdrawnState();
					// Genisletme icin teklif bilgisini yukle
					loadExtensionInfo(dealerId, customerId, branchId);
					return;
				}

				// Teklifi sakla
				currentOffer = offer;

				// offer_details'tan fiyatlari renderPrices formatina cevir
				var activePrices = offer.offer_details.map(function(detail) {
					return {
						id: detail.id,
						dealer_id: dealerId,
						customer_id: customerId,
						product_id: detail.product?.id,
						unit_price: detail.unit_price,
						pricing_type: detail.pricing_type,
						discount_value: detail.discount_value,
						is_active: true,
						product: detail.product
					};
				});

				// Fiyatlarƒ± render et
				renderPrices(activePrices);

				// Teklif ve sube bilgisini yukle (branch extension icin)
				loadOfferAndBranchInfo();
			} catch (err) {
				console.error('Fiyat y√ºkleme hatasƒ±:', err);
				priceListEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #e31e24;"><p>Fiyatlar y√ºklenirken hata olu≈ütu</p></div>';
			}
		}

		// Bu sube icin teklif yoksa, baska subede teklif var mi kontrol et (genisletme icin)
		async function loadExtensionInfo(dealerId, customerId, currentBranchId) {
			try {
				// Bu bayi icin musterinin herhangi bir subesinde accepted teklif var mi?
				const { data: offers, error } = await OffersService.getByCustomerId(customerId, { status: 'accepted' });

				if (error) throw new Error(error);

				// Bu bayi icin baska subede teklif var mi?
				var otherBranchOffer = (offers || []).find(function(o) {
					return o.dealer_id === dealerId && o.customer_branch_id && o.customer_branch_id !== currentBranchId;
				});

				if (otherBranchOffer) {
					// Genisletme onerisi goster
					var branchName = otherBranchOffer.customer_branch?.branch_name || 'ba≈üka ≈üube';
					showExtensionSuggestion(otherBranchOffer, branchName, currentBranchId);
				}
			} catch (err) {
				console.error('Extension info y√ºkleme hatasƒ±:', err);
			}
		}

		// Genisletme onerisi goster
		function showExtensionSuggestion(existingOffer, existingBranchName, targetBranchId) {
			var suggestionHtml = '<div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #002c77;">' +
				'<p style="margin: 0 0 10px 0; font-weight: 600; color: #002c77;">üí° Bu bayiden ba≈üka ≈üubenizde teklif var!</p>' +
				'<p style="margin: 0 0 15px 0; color: #666;">"' + existingBranchName + '" ≈üubesindeki teklifi bu ≈üubeye de uygulatmak i√ßin talep olu≈üturabilirsiniz.</p>' +
				'<button onclick="requestExtension(\'' + existingOffer.id + '\', \'' + targetBranchId + '\')" class="btn-request-extension" style="background: #002c77; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Geni≈ületme Talep Et</button>' +
			'</div>';

			// Empty state'in altina ekle
			var emptyStateEl = document.querySelector('.empty-state-card');
			if (emptyStateEl) {
				emptyStateEl.insertAdjacentHTML('afterend', suggestionHtml);
			}
		}

		// Genisletme talebi olustur
		async function requestExtension(offerId, targetBranchId) {
			try {
				var userId = sessionStorage.getItem('isyerim_user_id');
				const { data, error } = await OffersService.createExtensionRequest(offerId, targetBranchId, userId);

				if (error) throw new Error(error);

				alert('Geni≈ületme talebiniz ba≈üarƒ±yla olu≈üturuldu! Bayi onayƒ±ndan sonra fiyatlar bu ≈üube i√ßin de ge√ßerli olacak.');
				location.reload();
			} catch (err) {
				console.error('Extension request hatasƒ±:', err);
				alert('Talep olu≈üturulurken hata: ' + err.message);
			}
		}

		// Musterinin aktif teklifini ve sube bilgisini yukle
		async function loadOfferAndBranchInfo() {
			if (!currentCustomerId || !currentDealerId) return;

			currentUserId = sessionStorage.getItem('isyerim_user_id');

			try {
				// Aktif teklifi bul
				const { data: offers, error: offersError } = await OffersService.getByCustomerId(currentCustomerId, { status: 'accepted' });

				if (offersError) throw new Error(offersError);

				// Bu bayi icin accepted teklif var mi?
				var acceptedOffer = (offers || []).find(function(o) {
					return o.dealer_id === currentDealerId && o.status === 'accepted';
				});

				if (acceptedOffer) {
					currentOffer = acceptedOffer;
				}

			} catch (err) {
				console.error('Teklif yukleme hatasi:', err);
			}
		}

		// √úr√ºn resmi getir
		function getProductImage(product) {
			if (product.image_url) return product.image_url;
			// Fallback
			if (product.code && product.code.includes('24')) return './ƒ∞pragaz Bayi_files/IPR-BAYI-24kg-sanayi.png';
			if (product.code && product.code.includes('45')) return './ƒ∞pragaz Bayi_files/IPR-BAYI-45kg-sanayi.png';
			return './ƒ∞pragaz Bayi_files/IPR-BAYI-12-kg-ipr-uzun.png';
		}

		// Fiyat kartƒ± olu≈ütur
		function createPriceCard(priceData) {
			var product = priceData.product || {};
			var formattedPrice = parseFloat(priceData.unit_price).toLocaleString('tr-TR', {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			});

			return '<div class="price-card">' +
				'<div class="price-card-image">' +
					'<img src="' + getProductImage(product) + '" alt="' + product.name + '">' +
				'</div>' +
				'<div class="price-card-info">' +
					'<div class="price-card-name">' + product.name + '</div>' +
					'<div class="price-card-commitment">' +
						'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
							'<path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>' +
						'</svg>' +
						'Taahh√ºt: ' + (priceData.commitment_quantity || 0) + ' Adet / Ay' +
					'</div>' +
				'</div>' +
				'<div class="price-card-price">' +
					'<div class="price-label">Birim Fiyat</div>' +
					'<div class="price-value">' + formattedPrice + ' <span class="price-unit">TL</span></div>' +
				'</div>' +
			'</div>';
		}

		// Fiyatlarƒ± render et
		function renderPrices(prices) {
			priceListEl.innerHTML = '';

			if (prices.length === 0) {
				priceListEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p>Fiyat bulunamadƒ±</p></div>';
				return;
			}

			prices.forEach(function(price) {
				priceListEl.innerHTML += createPriceCard(price);
			});
		}

		// Bayileri Supabase'den y√ºkle
		async function loadDealers() {
			try {
				const { data: dealers, error } = await DealersService.getAll();

				if (error) throw new Error(error);

				renderDealers(dealers || []);
			} catch (err) {
				console.error('Bayi y√ºkleme hatasƒ±:', err);
				bayiListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #e31e24;">Bayiler y√ºklenirken hata olu≈ütu</div>';
			}
		}

		// Bayi kartƒ± olu≈ütur
		function createDealerItem(dealer) {
			var address = [dealer.district, dealer.city].filter(Boolean).join(', ');

			return '<div class="bayi-item" data-id="' + dealer.id + '" data-name="' + dealer.name + '">' +
				'<div class="bayi-item-info">' +
					'<div class="bayi-item-name">' + dealer.name + '</div>' +
					'<div class="bayi-item-address">' + address + '</div>' +
				'</div>' +
				'<div class="bayi-item-distance">' + (dealer.distance ? dealer.distance.toFixed(1) + ' km' : '') + '</div>' +
			'</div>';
		}

		// Bayileri render et
		function renderDealers(dealers) {
			bayiListEl.innerHTML = '';

			if (dealers.length === 0) {
				bayiListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Bayi bulunamadƒ±</div>';
				return;
			}

			dealers.forEach(function(dealer) {
				bayiListEl.innerHTML += createDealerItem(dealer);
			});

			// Event listener'larƒ± baƒüla
			bindDealerEvents();
		}

		// Bayi event'lerini baƒüla
		function bindDealerEvents() {
			document.querySelectorAll('.bayi-item').forEach(function(item) {
				item.addEventListener('click', function() {
					var dealerId = this.getAttribute('data-id');
					var dealerName = this.getAttribute('data-name');
					sessionStorage.setItem('selected_bayi', dealerName);
					sessionStorage.setItem('dealer_id', dealerId);
					selectedBayiName.textContent = dealerName;
					selectedBayiBox.classList.add('active');
					bayiOverlay.classList.remove('active');
				});
			});
		}

		// Sayfa y√ºklendiƒüinde durum kontrol√º
		function checkWithdrawnState() {
			var isNewUser = sessionStorage.getItem('isNewUser') === 'true';
			var tekliftenCekildi = sessionStorage.getItem('tekliften_cekildi') === 'true';

			// Yeni √ºye ise veya tekliften √ßekildiyse "teklif yok" g√∂ster
			if (isNewUser || tekliftenCekildi) {
				showWithdrawnState();
				return true;
			}
			return false;
		}

		// √áekilmi≈ü durumu g√∂ster
		function showWithdrawnState() {
			infoBanner.classList.add('hidden');
			priceListEl.classList.add('hidden');
			footerNote.classList.add('hidden');
			btnWithdraw.classList.add('hidden');
			noOfferState.classList.add('active');

			// Se√ßilmi≈ü bayi varsa g√∂ster
			var savedBayi = sessionStorage.getItem('selected_bayi');
			if (savedBayi) {
				selectedBayiName.textContent = savedBayi;
				selectedBayiBox.classList.add('active');
			}
		}

		// Normal duruma d√∂n (fiyatlarƒ± g√∂ster)
		function showNormalState() {
			infoBanner.classList.remove('hidden');
			priceListEl.classList.remove('hidden');
			footerNote.classList.remove('hidden');
			btnWithdraw.classList.remove('hidden');
			noOfferState.classList.remove('active');
		}

		// Tekliften √ßekil butonu
		btnWithdraw.addEventListener('click', function() {
			warningOverlay.classList.add('active');
		});

		// ƒ∞ptal butonu
		btnCancel.addEventListener('click', function() {
			warningOverlay.classList.remove('active');
		});

		// Overlay dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
		warningOverlay.addEventListener('click', function(e) {
			if (e.target === this) {
				this.classList.remove('active');
			}
		});

		// Onayla butonu (Tekliften √ßekil)
		btnConfirm.addEventListener('click', async function() {
			this.disabled = true;
			this.textContent = 'ƒ∞≈üleniyor...';

			try {
				// Supabase'de fiyatlarƒ± deaktif et
				if (currentCustomerId) {
					const { error } = await CustomerPricesService.deactivateAllForCustomer(currentCustomerId);
					if (error) {
						console.error('Fiyat deaktif hatasƒ±:', error);
					}
				}

				sessionStorage.setItem('tekliften_cekildi', 'true');
				warningOverlay.classList.remove('active');
				showWithdrawnState();
			} catch (err) {
				console.error('Tekliften √ßekilme hatasƒ±:', err);
				alert('ƒ∞≈ülem sƒ±rasƒ±nda bir hata olu≈ütu.');
			} finally {
				this.disabled = false;
				this.textContent = 'Onayla';
			}
		});

		// Bayi se√ß butonu
		btnSelectBayi.addEventListener('click', function() {
			loadDealers();
			bayiOverlay.classList.add('active');
		});

		// Bayi modal kapat
		bayiModalClose.addEventListener('click', function() {
			bayiOverlay.classList.remove('active');
		});

		// Bayi overlay dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
		bayiOverlay.addEventListener('click', function(e) {
			if (e.target === this) {
				this.classList.remove('active');
			}
		});

		// Sayfa y√ºklendiƒüinde
		document.addEventListener('DOMContentLoaded', function() {
			// Durumu kontrol et
			var isWithdrawn = checkWithdrawnState();

			// √áekilmemi≈ü ise fiyatlarƒ± y√ºkle
			if (!isWithdrawn) {
				loadPrices();
			}
		});
	</script>
</body>
</html>
