<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sube Ekle - Ipragaz</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			min-height: 100vh;
			background-color: #e31e24;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			overflow: hidden;
		}

		/* B Pattern Background */
		.bg-pattern {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			pointer-events: none;
		}

		.bg-pattern::before {
			content: 'B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B';
			position: absolute;
			top: -50px;
			left: -50px;
			width: calc(100% + 100px);
			height: calc(100% + 100px);
			font-size: 80px;
			font-weight: 700;
			color: rgba(255, 255, 255, 0.08);
			word-spacing: 30px;
			line-height: 1.2;
			letter-spacing: 20px;
			word-break: break-all;
		}

		/* Card Container */
		.address-container {
			position: relative;
			z-index: 1;
			width: 100%;
			max-width: 480px;
			padding: 20px;
		}

		.address-card {
			background: #fff;
			border-radius: 12px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
			display: flex;
			flex-direction: column;
			max-height: 90vh;
		}

		/* Card Header */
		.card-header {
			padding: 30px 30px 20px;
			flex-shrink: 0;
		}

		/* Logo */
		.logo {
			text-align: center;
			margin-bottom: 20px;
		}

		.logo svg {
			width: 140px;
			height: auto;
		}

		/* Title */
		.card-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 8px;
		}

		.card-subtitle {
			font-size: 14px;
			color: #666;
			line-height: 1.5;
		}

		.card-subtitle .checkmark {
			color: #22c55e;
			font-weight: 600;
		}

		/* Card Body - Scrollable */
		.card-body {
			flex: 1;
			overflow-y: auto;
			padding: 0 30px 20px;
			max-height: 400px;
		}

		.card-body::-webkit-scrollbar {
			width: 5px;
		}

		.card-body::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 3px;
		}

		.card-body::-webkit-scrollbar-thumb {
			background: #ccc;
			border-radius: 3px;
		}

		.card-body::-webkit-scrollbar-thumb:hover {
			background: #bbb;
		}

		/* Form Styles */
		.form-group {
			margin-bottom: 18px;
		}

		.form-label {
			display: block;
			font-size: 13px;
			font-weight: 500;
			color: #333;
			margin-bottom: 8px;
		}

		.form-label .required {
			color: #e31e24;
		}

		.form-input,
		.form-select,
		.form-textarea {
			width: 100%;
			padding: 12px 14px;
			border: 1px solid #ddd;
			border-radius: 8px;
			font-size: 14px;
			font-family: inherit;
			color: #333;
			transition: border-color 0.2s, box-shadow 0.2s;
			background-color: #fff;
		}

		.form-input:focus,
		.form-select:focus,
		.form-textarea:focus {
			outline: none;
			border-color: #e31e24;
			box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
		}

		.form-input::placeholder,
		.form-textarea::placeholder {
			color: #aaa;
		}

		.form-select {
			appearance: none;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 14px center;
			padding-right: 40px;
			cursor: pointer;
		}

		.form-select:disabled {
			background-color: #f5f5f5;
			cursor: not-allowed;
			opacity: 0.7;
		}

		.form-textarea {
			resize: none;
			min-height: 70px;
		}

		/* Three Column Row */
		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr 1fr;
			gap: 12px;
		}

		.form-row .form-group {
			margin-bottom: 18px;
		}

		.field-hint {
			display: block;
			margin-top: 5px;
			font-size: 12px;
			color: #888;
		}

		/* Card Footer */
		.card-footer {
			padding: 20px 30px;
			border-top: 1px solid #eee;
			flex-shrink: 0;
			background: #fff;
			border-radius: 0 0 12px 12px;
		}

		/* Submit Button */
		.btn-submit {
			width: 100%;
			padding: 14px 20px;
			background: #c41e24;
			border: none;
			border-radius: 25px;
			color: #fff;
			font-size: 15px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s, transform 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
		}

		.btn-submit:hover {
			background: #a81a1f;
			transform: translateY(-1px);
		}

		.btn-submit:active {
			transform: translateY(0);
		}

		.btn-submit:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		.btn-submit svg {
			width: 18px;
			height: 18px;
		}

		/* Loading Spinner */
		.spinner {
			width: 18px;
			height: 18px;
			border: 2px solid #fff;
			border-top-color: transparent;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		/* Responsive */
		@media (max-width: 480px) {
			.address-card {
				max-height: 95vh;
			}

			.card-header {
				padding: 25px 20px 15px;
			}

			.card-body {
				padding: 0 20px 15px;
				max-height: 320px;
			}

			.card-footer {
				padding: 15px 20px;
			}

			.logo svg {
				width: 120px;
			}

			.card-title {
				font-size: 16px;
			}

			.card-subtitle {
				font-size: 13px;
			}

			.form-row {
				grid-template-columns: 1fr;
				gap: 0;
			}

			.bg-pattern::before {
				font-size: 50px;
			}
		}
	</style>
</head>
<body>
	<!-- Background Pattern -->
	<div class="bg-pattern"></div>

	<!-- Address Container -->
	<div class="address-container">
		<div class="address-card">
			<!-- Card Header -->
			<div class="card-header">
				<!-- Logo -->
				<div class="logo">
					<svg viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
						<circle cx="25" cy="25" r="20" fill="none" stroke="#e31e24" stroke-width="3"/>
						<path d="M25 10 L25 25" stroke="#e31e24" stroke-width="3" stroke-linecap="round"/>
						<text x="55" y="32" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#e31e24">iPRAGAZ</text>
					</svg>
				</div>

				<!-- Title -->
				<h1 class="card-title">Sube Bilgileri</h1>
				<p class="card-subtitle">
					<span class="checkmark">&#10003;</span> Hesabiniz olusturuldu! Merkez subenizi ekleyerek baslayalim.
				</p>
			</div>

			<!-- Card Body - Scrollable Form -->
			<div class="card-body">
				<form id="addressForm">
					<!-- İl -->
					<div class="form-group">
						<label class="form-label">İl <span class="required">*</span></label>
						<select class="form-select" id="citySelect" required>
							<option value="">İl Seçiniz</option>
						</select>
					</div>

					<!-- İlçe -->
					<div class="form-group">
						<label class="form-label">İlçe <span class="required">*</span></label>
						<select class="form-select" id="districtSelect" disabled required>
							<option value="">Önce il seçiniz</option>
						</select>
					</div>

					<!-- Mahalle -->
					<div class="form-group">
						<label class="form-label">Mahalle</label>
						<select class="form-select" id="neighborhoodSelect" disabled>
							<option value="">Önce ilçe seçiniz</option>
						</select>
					</div>

					<!-- Cadde/Sokak -->
					<div class="form-group">
						<label class="form-label">Cadde/Sokak</label>
						<select class="form-select" id="streetSelect" disabled>
							<option value="">Önce mahalle seçiniz</option>
						</select>
					</div>

					<!-- Bina No / Kat / Daire -->
					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Bina No</label>
							<input type="text" class="form-input" id="buildingNo" placeholder="Örn: 42">
						</div>
						<div class="form-group">
							<label class="form-label">Kat</label>
							<input type="text" class="form-input" id="floor" placeholder="Örn: 3">
						</div>
						<div class="form-group">
							<label class="form-label">Daire</label>
							<input type="text" class="form-input" id="apartment" placeholder="Örn: 5">
						</div>
					</div>

					<!-- Adres Tarifi -->
					<div class="form-group">
						<label class="form-label">Adres Tarifi</label>
						<textarea class="form-textarea" id="branchDescription" placeholder="Orn: Yesil kapili apartman, 2. blok"></textarea>
						<span class="field-hint">Kurye icin yonlendirici bilgiler</span>
					</div>

					<!-- Sube Adi -->
					<div class="form-group">
						<label class="form-label">Sube Adi <span class="required">*</span></label>
						<input type="text" class="form-input" id="branchName" value="Merkez" required>
						<span class="field-hint">Ilk subeniz otomatik olarak Merkez olarak kaydedilir</span>
					</div>
				</form>
			</div>

			<!-- Card Footer -->
			<div class="card-footer">
				<button class="btn-submit" id="submitBtn">
					Kaydet ve Devam Et
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M5 12h14M12 5l7 7-7 7"/>
					</svg>
				</button>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/branches-service.js"></script>
	<script src="./js/services/locations-service.js"></script>

	<script>
		// Browser back engelleme
		window.history.pushState(null, null, window.location.href);
		window.addEventListener('popstate', function() {
			window.history.pushState(null, null, window.location.href);
		});

		// Customer ID kontrol
		var customerId = sessionStorage.getItem('isyerim_customer_id');
		if (!customerId) {
			window.location.href = 'isyerim-musteri-login.html';
		}

		// Sayfa yüklendiğinde
		document.addEventListener('DOMContentLoaded', function() {
			loadCities();
			setupDropdownListeners();
		});

		// İlleri API'den yükle
		async function loadCities() {
			var select = document.getElementById('citySelect');
			select.innerHTML = '<option value="">İl Yükleniyor...</option>';

			var result = await LocationsService.getCities();

			if (result.error) {
				select.innerHTML = '<option value="">Hata oluştu</option>';
				console.error('İller yüklenemedi:', result.error);
				return;
			}

			select.innerHTML = '<option value="">İl Seçiniz</option>';
			result.data.forEach(function(city) {
				select.innerHTML += '<option value="' + city.id + '" data-name="' + city.name + '">' + city.name + '</option>';
			});
		}

		// Dropdown listener'ları kur
		function setupDropdownListeners() {
			document.getElementById('citySelect').addEventListener('change', function() {
				loadDistricts(this.value);
			});

			document.getElementById('districtSelect').addEventListener('change', function() {
				loadNeighborhoods(this.value);
			});

			document.getElementById('neighborhoodSelect').addEventListener('change', function() {
				loadStreets(this.value);
			});
		}

		// İlçeleri API'den yükle
		async function loadDistricts(cityId) {
			var select = document.getElementById('districtSelect');
			var neighborhoodSelect = document.getElementById('neighborhoodSelect');
			var streetSelect = document.getElementById('streetSelect');

			// Reset alt dropdown'lar
			neighborhoodSelect.innerHTML = '<option value="">Önce ilçe seçiniz</option>';
			neighborhoodSelect.disabled = true;
			streetSelect.innerHTML = '<option value="">Önce mahalle seçiniz</option>';
			streetSelect.disabled = true;

			if (!cityId) {
				select.innerHTML = '<option value="">Önce il seçiniz</option>';
				select.disabled = true;
				return;
			}

			select.innerHTML = '<option value="">İlçe Yükleniyor...</option>';
			select.disabled = true;

			var result = await LocationsService.getDistrictsByCityId(cityId);

			if (result.error) {
				select.innerHTML = '<option value="">Hata oluştu</option>';
				console.error('İlçeler yüklenemedi:', result.error);
				return;
			}

			select.innerHTML = '<option value="">İlçe Seçiniz</option>';
			select.disabled = false;

			result.data.forEach(function(district) {
				select.innerHTML += '<option value="' + district.id + '" data-name="' + district.name + '">' + district.name + '</option>';
			});
		}

		// Mahalleleri API'den yükle
		async function loadNeighborhoods(districtId) {
			var select = document.getElementById('neighborhoodSelect');
			var streetSelect = document.getElementById('streetSelect');

			// Reset sokak dropdown
			streetSelect.innerHTML = '<option value="">Önce mahalle seçiniz</option>';
			streetSelect.disabled = true;

			if (!districtId) {
				select.innerHTML = '<option value="">Önce ilçe seçiniz</option>';
				select.disabled = true;
				return;
			}

			select.innerHTML = '<option value="">Mahalle Yükleniyor...</option>';
			select.disabled = true;

			var result = await LocationsService.getNeighborhoodsByDistrictId(districtId);

			if (result.error || !result.data || result.data.length === 0) {
				// Mahalle bulunamadı - manuel giriş için boş bırak
				select.innerHTML = '<option value="">Mahalle bulunamadı</option>';
				select.disabled = false;
				return;
			}

			select.innerHTML = '<option value="">Mahalle Seçiniz</option>';
			select.disabled = false;

			result.data.forEach(function(n) {
				select.innerHTML += '<option value="' + n.id + '" data-name="' + n.name + '">' + n.name + '</option>';
			});
		}

		// Sokakları API'den yükle
		async function loadStreets(neighborhoodId) {
			var select = document.getElementById('streetSelect');

			if (!neighborhoodId) {
				select.innerHTML = '<option value="">Önce mahalle seçiniz</option>';
				select.disabled = true;
				return;
			}

			select.innerHTML = '<option value="">Sokak Yükleniyor...</option>';
			select.disabled = true;

			var result = await LocationsService.getStreetsByNeighborhoodId(neighborhoodId);

			if (result.error || !result.data || result.data.length === 0) {
				// Sokak bulunamadı - manuel giriş için boş bırak
				select.innerHTML = '<option value="">Sokak bulunamadı</option>';
				select.disabled = false;
				return;
			}

			select.innerHTML = '<option value="">Cadde/Sokak Seçiniz</option>';
			select.disabled = false;

			result.data.forEach(function(s) {
				select.innerHTML += '<option value="' + s.id + '" data-name="' + s.name + '">' + s.name + '</option>';
			});
		}

		// Seçili option'ın data-name değerini al
		function getSelectedOptionName(selectId) {
			var select = document.getElementById(selectId);
			var selectedOption = select.options[select.selectedIndex];
			return selectedOption ? selectedOption.getAttribute('data-name') : null;
		}

		// Form submit
		document.getElementById('submitBtn').addEventListener('click', async function(e) {
			e.preventDefault();

			var btn = this;
			var branchName = document.getElementById('branchName').value.trim();
			var cityId = document.getElementById('citySelect').value;
			var districtId = document.getElementById('districtSelect').value;
			var neighborhoodId = document.getElementById('neighborhoodSelect').value;
			var streetId = document.getElementById('streetSelect').value;

			// Text değerlerini de al (sessionStorage ve backward compatibility için)
			var cityName = getSelectedOptionName('citySelect');
			var districtName = getSelectedOptionName('districtSelect');
			var neighborhoodName = getSelectedOptionName('neighborhoodSelect');
			var streetName = getSelectedOptionName('streetSelect');

			// Validation
			if (!branchName) {
				alert('Lutfen sube adi giriniz.');
				document.getElementById('branchName').focus();
				return;
			}

			if (!cityId) {
				alert('Lütfen il seçiniz.');
				document.getElementById('citySelect').focus();
				return;
			}

			if (!districtId) {
				alert('Lütfen ilçe seçiniz.');
				document.getElementById('districtSelect').focus();
				return;
			}

			// Loading state
			btn.disabled = true;
			btn.innerHTML = '<div class="spinner"></div> Kaydediliyor...';

			try {
				var branchData = {
					customer_id: customerId,
					branch_name: branchName,
					// Yeni FK kolonlari
					city_id: cityId || null,
					district_id: districtId || null,
					neighborhood_id: neighborhoodId || null,
					street_id: streetId || null,
					// Eski VARCHAR kolonlari (backward compatibility ve display icin)
					city: cityName || null,
					district: districtName || null,
					neighborhood: neighborhoodName || null,
					street: streetName || null,
					// Diger alanlar
					building_no: document.getElementById('buildingNo').value.trim() || null,
					floor: document.getElementById('floor').value.trim() || null,
					apartment: document.getElementById('apartment').value.trim() || null,
					branch_description: document.getElementById('branchDescription').value.trim() || null,
					is_default: true // Ilk sube varsayilan olsun
				};

				var result = await BranchesService.create(branchData);

				if (result.error) {
					console.error('Sube kaydedilemedi:', result.error);
					alert('Sube kaydedilemedi. Lutfen tekrar deneyiniz.');
					btn.disabled = false;
					btn.innerHTML = 'Kaydet ve Devam Et <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
					return;
				}

				// SessionStorage'a sube bilgisi kaydet (header'da gosterilecek)
				sessionStorage.setItem('selected_address_id', result.data.id);
				sessionStorage.setItem('selected_address_name', result.data.branch_name);

				// Tam adres olustur ve kaydet (Mahalle, Sokak, Ilce, Il)
				var addressParts = [];
				if (neighborhoodName) addressParts.push(neighborhoodName);
				if (streetName) addressParts.push(streetName);
				if (districtName) addressParts.push(districtName);
				if (cityName) addressParts.push(cityName);
				var fullAddress = addressParts.join(', ');
				sessionStorage.setItem('selected_address', fullAddress);

				// SessionStorage'a il ve ilçe bilgisi kaydet (bayi seçimi için)
				sessionStorage.setItem('isyerim_user_city', cityName);
				sessionStorage.setItem('isyerim_user_district', districtName);
				// ID'leri de kaydet
				sessionStorage.setItem('isyerim_user_city_id', cityId);
				sessionStorage.setItem('isyerim_user_district_id', districtId);

				// Bayi seçim sayfasına yönlendir
				window.location.href = 'isyerim-musteri-bayi-sec.html';

			} catch (error) {
				console.error('Hata:', error);
				alert('Bir hata oluştu. Lütfen tekrar deneyiniz.');
				btn.disabled = false;
				btn.innerHTML = 'Kaydet ve Devam Et <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
			}
		});
	</script>
</body>
</html>
