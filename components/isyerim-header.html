<style>
	.header {
		background: #fff;
		box-shadow: 0 2px 10px rgba(0,0,0,0.05);
		position: sticky;
		top: 0;
		z-index: 100;
	}
	.header .container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 20px;
		display: flex;
		align-items: center;
		justify-content: space-between;
		height: 70px;
	}
	.header-logo {
		text-decoration: none;
	}
	.header-logo svg {
		height: 36px;
		width: auto;
	}
	.header-user-location {
		display: flex;
		align-items: center;
		gap: 8px;
		color: #333;
		font-size: 14px;
		cursor: pointer;
		padding: 10px 18px;
		border: 1px solid #e0e0e0;
		border-radius: 30px;
		transition: all 0.2s;
	}
	.header-user-location:hover {
		border-color: #e31e24;
	}
	.header-user-location svg {
		width: 18px;
		height: 18px;
		color: #e31e24;
	}
	.header-user-location .user-name {
		font-weight: 500;
	}
	.header-actions {
		display: flex;
		align-items: center;
		gap: 8px;
	}
	.header-action {
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 50%;
		color: #666;
		transition: background 0.2s, color 0.2s;
		text-decoration: none;
	}
	.header-action:hover {
		background: #f5f5f5;
		color: #e31e24;
	}
	.header-action svg {
		width: 22px;
		height: 22px;
	}
	.profile-dropdown-container {
		position: relative;
	}
	.profile-dropdown {
		position: absolute;
		top: calc(100% + 10px);
		right: 0;
		background: #fff;
		border-radius: 12px;
		box-shadow: 0 5px 25px rgba(0,0,0,0.15);
		min-width: 200px;
		opacity: 0;
		visibility: hidden;
		transform: translateY(-10px);
		transition: all 0.2s ease;
		z-index: 200;
		overflow: hidden;
	}
	.profile-dropdown.active {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
	}
	.profile-dropdown-item {
		display: flex;
		align-items: center;
		gap: 12px;
		padding: 14px 18px;
		color: #333;
		font-size: 14px;
		font-weight: 500;
		text-decoration: none;
		transition: background 0.2s;
		border-bottom: 1px solid #f0f0f0;
	}
	.profile-dropdown-item:last-child {
		border-bottom: none;
	}
	.profile-dropdown-item:hover {
		background: #f9f9f9;
	}
	.profile-dropdown-item svg {
		width: 18px;
		height: 18px;
		color: #888;
	}
	.profile-dropdown-item:hover svg {
		color: #e31e24;
	}
	.profile-dropdown-item.logout {
		color: #e31e24;
	}
	.profile-dropdown-item.logout svg {
		color: #e31e24;
	}
	/* Notification Styles */
	.notification-container {
		position: relative;
	}
	.notification-badge {
		position: absolute;
		top: -2px;
		right: -2px;
		background: #dc2626;
		color: #fff;
		font-size: 10px;
		font-weight: 600;
		min-width: 18px;
		height: 18px;
		border-radius: 9px;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 0 4px;
		animation: badge-pop 0.3s ease;
	}
	.notification-badge.hidden {
		display: none;
	}
	@keyframes badge-pop {
		0% { transform: scale(0); }
		50% { transform: scale(1.2); }
		100% { transform: scale(1); }
	}
	@keyframes badge-pulse {
		0%, 100% { transform: scale(1); }
		50% { transform: scale(1.1); }
	}
	.notification-badge.pulse {
		animation: badge-pulse 0.5s ease;
	}
	@keyframes bell-shake {
		0%, 100% { transform: rotate(0); }
		25% { transform: rotate(-15deg); }
		50% { transform: rotate(15deg); }
		75% { transform: rotate(-10deg); }
	}
	.notification-btn.shake svg {
		animation: bell-shake 0.5s ease;
	}
	.notification-dropdown {
		position: absolute;
		top: calc(100% + 10px);
		right: 0;
		background: #fff;
		border-radius: 12px;
		box-shadow: 0 5px 25px rgba(0,0,0,0.15);
		width: 360px;
		max-height: 480px;
		opacity: 0;
		visibility: hidden;
		transform: translateY(-10px);
		transition: all 0.2s ease;
		z-index: 200;
		overflow: hidden;
		display: flex;
		flex-direction: column;
	}
	.notification-dropdown.active {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
	}
	.notification-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 16px 18px;
		border-bottom: 1px solid #eee;
		flex-shrink: 0;
	}
	.notification-header-title {
		font-size: 16px;
		font-weight: 600;
		color: #333;
	}
	.notification-mark-all {
		font-size: 13px;
		color: #e31e24;
		cursor: pointer;
		background: none;
		border: none;
		font-family: inherit;
	}
	.notification-mark-all:hover {
		text-decoration: underline;
	}
	.notification-list {
		overflow-y: auto;
		flex: 1;
		max-height: 380px;
	}
	.notification-item {
		display: flex;
		gap: 12px;
		padding: 14px 18px;
		border-bottom: 1px solid #f0f0f0;
		cursor: pointer;
		transition: background 0.2s;
		position: relative;
	}
	.notification-item:hover {
		background: #f9f9f9;
	}
	.notification-item.unread {
		background: #f0f7ff;
	}
	.notification-item.unread::before {
		content: '';
		position: absolute;
		left: 6px;
		top: 50%;
		transform: translateY(-50%);
		width: 8px;
		height: 8px;
		background: #3b82f6;
		border-radius: 50%;
	}
	.notification-icon {
		width: 40px;
		height: 40px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}
	.notification-icon svg {
		width: 20px;
		height: 20px;
		color: #fff;
	}
	.notification-icon.accepted { background: #22c55e; }
	.notification-icon.rejected { background: #ef4444; }
	.notification-icon.pending { background: #3b82f6; }
	.notification-icon.price_updated { background: #f59e0b; }
	.notification-icon.cancelled { background: #6b7280; }
	.notification-icon.created, .notification-icon.requested { background: #8b5cf6; }
	.notification-icon.default { background: #6b7280; }
	.notification-content {
		flex: 1;
		min-width: 0;
	}
	.notification-title {
		font-size: 14px;
		font-weight: 600;
		color: #333;
		margin-bottom: 4px;
	}
	.notification-message {
		font-size: 13px;
		color: #666;
		line-height: 1.4;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	.notification-time {
		font-size: 11px;
		color: #999;
		margin-top: 6px;
	}
	.notification-empty {
		text-align: center;
		padding: 40px 20px;
		color: #666;
	}
	.notification-empty svg {
		width: 48px;
		height: 48px;
		color: #ddd;
		margin-bottom: 12px;
	}
	/* Toast Notifications */
	.toast-container {
		position: fixed;
		top: 20px;
		right: 20px;
		z-index: 9999;
		display: flex;
		flex-direction: column;
		gap: 10px;
	}
	.toast {
		background: #fff;
		border-radius: 12px;
		box-shadow: 0 5px 25px rgba(0,0,0,0.15);
		padding: 16px;
		min-width: 320px;
		max-width: 400px;
		animation: toast-slide-in 0.3s ease;
		position: relative;
		overflow: hidden;
	}
	@keyframes toast-slide-in {
		from { transform: translateX(100%); opacity: 0; }
		to { transform: translateX(0); opacity: 1; }
	}
	.toast.removing {
		animation: toast-slide-out 0.3s ease forwards;
	}
	@keyframes toast-slide-out {
		from { transform: translateX(0); opacity: 1; }
		to { transform: translateX(100%); opacity: 0; }
	}
	.toast-progress {
		position: absolute;
		bottom: 0;
		left: 0;
		height: 3px;
		background: #e31e24;
		animation: toast-progress 5s linear;
	}
	@keyframes toast-progress {
		from { width: 100%; }
		to { width: 0%; }
	}
	.toast-header {
		display: flex;
		align-items: center;
		gap: 12px;
		margin-bottom: 8px;
	}
	.toast-icon {
		width: 32px;
		height: 32px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}
	.toast-icon svg {
		width: 16px;
		height: 16px;
		color: #fff;
	}
	.toast-icon.accepted { background: #22c55e; }
	.toast-icon.rejected { background: #ef4444; }
	.toast-icon.pending { background: #3b82f6; }
	.toast-icon.price_updated { background: #f59e0b; }
	.toast-icon.cancelled { background: #6b7280; }
	.toast-icon.created, .toast-icon.requested { background: #8b5cf6; }
	.toast-icon.default { background: #6b7280; }
	.toast-title {
		font-size: 14px;
		font-weight: 600;
		color: #333;
		flex: 1;
	}
	.toast-close {
		background: none;
		border: none;
		cursor: pointer;
		padding: 4px;
		color: #999;
	}
	.toast-close:hover {
		color: #333;
	}
	.toast-message {
		font-size: 13px;
		color: #666;
		line-height: 1.4;
		margin-bottom: 12px;
	}
	.toast-action {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		font-size: 13px;
		color: #e31e24;
		font-weight: 500;
		cursor: pointer;
		background: none;
		border: none;
		font-family: inherit;
		padding: 0;
	}
	.toast-action:hover {
		text-decoration: underline;
	}
	.toast-action svg {
		width: 14px;
		height: 14px;
	}
	@media (max-width: 768px) {
		.notification-dropdown {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			width: 100%;
			max-height: 100%;
			border-radius: 0;
		}
		.notification-header {
			padding: 20px;
		}
		.toast-container {
			top: auto;
			bottom: 20px;
			left: 20px;
			right: 20px;
		}
		.toast {
			min-width: auto;
			max-width: none;
		}
	}
	/* Notification Detail Modal */
	.notification-modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.5);
		z-index: 1000;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease, visibility 0.3s ease;
	}
	.notification-modal-overlay.active {
		opacity: 1;
		visibility: visible;
	}
	.notification-modal {
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%) scale(0.95);
		background: #fff;
		border-radius: 16px;
		width: 480px;
		max-width: 90vw;
		max-height: 80vh;
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
		opacity: 0;
		transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s ease;
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}
	.notification-modal-overlay.active .notification-modal {
		transform: translate(-50%, -50%) scale(1);
		opacity: 1;
	}
	.notification-modal-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		padding: 20px 24px;
		border-bottom: 1px solid #eee;
		flex-shrink: 0;
	}
	.notification-modal-title-area {
		flex: 1;
	}
	.notification-modal-status {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		padding: 6px 12px;
		border-radius: 20px;
		font-size: 13px;
		font-weight: 600;
		margin-bottom: 8px;
	}
	.notification-modal-status.accepted { background: #dcfce7; color: #16a34a; }
	.notification-modal-status.rejected { background: #fee2e2; color: #dc2626; }
	.notification-modal-status.pending { background: #dbeafe; color: #2563eb; }
	.notification-modal-status.price_updated { background: #fef3c7; color: #d97706; }
	.notification-modal-status.message { background: #e0e7ff; color: #4f46e5; }
	.notification-modal-status.activated { background: #dcfce7; color: #16a34a; }
	.notification-modal-status.passived { background: #f3f4f6; color: #6b7280; }
	.notification-modal-status.cancelled { background: #f3f4f6; color: #6b7280; }
	.notification-modal-status svg {
		width: 16px;
		height: 16px;
	}
	.notification-modal-subtitle {
		font-size: 13px;
		color: #666;
	}
	.notification-modal-close {
		background: none;
		border: none;
		width: 36px;
		height: 36px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		color: #999;
		transition: background 0.2s, color 0.2s;
		flex-shrink: 0;
		margin-left: 12px;
	}
	.notification-modal-close:hover {
		background: #f5f5f5;
		color: #333;
	}
	.notification-modal-close svg {
		width: 20px;
		height: 20px;
	}
	.notification-modal-body {
		padding: 24px;
		overflow-y: auto;
		flex: 1;
	}
	.notification-modal-info {
		display: flex;
		flex-direction: column;
		gap: 16px;
	}
	.notification-modal-row {
		display: flex;
		align-items: flex-start;
		gap: 12px;
	}
	.notification-modal-row-icon {
		width: 40px;
		height: 40px;
		border-radius: 10px;
		background: #f5f5f5;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}
	.notification-modal-row-icon svg {
		width: 20px;
		height: 20px;
		color: #666;
	}
	.notification-modal-row-content {
		flex: 1;
	}
	.notification-modal-row-label {
		font-size: 12px;
		color: #999;
		margin-bottom: 2px;
	}
	.notification-modal-row-value {
		font-size: 15px;
		color: #333;
		font-weight: 500;
	}
	.notification-modal-row-value.price {
		font-size: 20px;
		color: #e31e24;
		font-weight: 700;
	}
	.notification-modal-message {
		background: #f9f9f9;
		border-radius: 12px;
		padding: 16px;
		margin-top: 8px;
	}
	.notification-modal-message-label {
		font-size: 12px;
		color: #999;
		margin-bottom: 6px;
	}
	.notification-modal-message-text {
		font-size: 14px;
		color: #333;
		line-height: 1.5;
	}
	.notification-modal-footer {
		display: flex;
		gap: 12px;
		padding: 20px 24px;
		border-top: 1px solid #eee;
		flex-shrink: 0;
	}
	.notification-modal-btn {
		flex: 1;
		padding: 14px 20px;
		border-radius: 10px;
		font-size: 15px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 8px;
		font-family: inherit;
	}
	.notification-modal-btn.primary {
		background: #e31e24;
		color: #fff;
		border: none;
	}
	.notification-modal-btn.primary:hover {
		background: #c91a1f;
	}
	.notification-modal-btn.secondary {
		background: #fff;
		color: #666;
		border: 1px solid #ddd;
	}
	.notification-modal-btn.secondary:hover {
		background: #f5f5f5;
		border-color: #ccc;
	}
	.notification-modal-btn svg {
		width: 18px;
		height: 18px;
	}
	.notification-modal-loading {
		text-align: center;
		padding: 40px;
		color: #666;
	}
	@media (max-width: 768px) {
		.notification-modal {
			top: auto;
			bottom: 0;
			left: 0;
			right: 0;
			transform: translateY(100%);
			width: 100%;
			max-width: 100%;
			max-height: 75vh;
			border-radius: 20px 20px 0 0;
		}
		.notification-modal-overlay.active .notification-modal {
			transform: translateY(0);
		}
		.notification-modal-header {
			padding: 16px 20px;
		}
		.notification-modal-body {
			padding: 20px;
		}
		.notification-modal-footer {
			padding: 16px 20px;
			flex-direction: column;
		}
	}
	/* Address Selection Modal */
	.address-modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0,0,0,0.5);
		z-index: 1000;
		display: none;
		align-items: center;
		justify-content: center;
	}
	.address-modal-overlay.active {
		display: flex;
	}
	.address-modal {
		background: #fff;
		border-radius: 12px;
		padding: 30px;
		width: 450px;
		max-width: 90%;
		max-height: 80vh;
		overflow-y: auto;
	}
	.address-modal-title {
		font-size: 18px;
		font-weight: 600;
		color: #333;
		text-align: center;
		margin-bottom: 25px;
	}
	.address-modal-list {
		display: flex;
		flex-direction: column;
		gap: 15px;
		margin-bottom: 25px;
	}
	.address-modal-item {
		display: flex;
		align-items: flex-start;
		gap: 15px;
		padding: 15px;
		border: 1px solid #e0e0e0;
		border-radius: 8px;
		cursor: pointer;
		transition: border-color 0.2s;
	}
	.address-modal-item:hover {
		border-color: #e31e24;
	}
	.address-modal-item.selected {
		border-color: #e31e24;
		background: #fff5f5;
	}
	.address-radio {
		width: 20px;
		height: 20px;
		border: 2px solid #ccc;
		border-radius: 50%;
		flex-shrink: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		margin-top: 2px;
	}
	.address-modal-item.selected .address-radio {
		border-color: #e31e24;
	}
	.address-radio-inner {
		width: 10px;
		height: 10px;
		background: #e31e24;
		border-radius: 50%;
		display: none;
	}
	.address-modal-item.selected .address-radio-inner {
		display: block;
	}
	.address-modal-info {
		flex: 1;
	}
	.address-modal-name {
		font-size: 15px;
		font-weight: 600;
		color: #333;
		margin-bottom: 5px;
	}
	.address-modal-full {
		font-size: 13px;
		color: #666;
		line-height: 1.4;
	}
	.address-continue-btn {
		width: 100%;
		background: #e31e24;
		color: #fff;
		border: none;
		border-radius: 8px;
		padding: 15px;
		font-size: 16px;
		font-weight: 600;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 8px;
		font-family: inherit;
		transition: background 0.3s;
	}
	.address-continue-btn:hover {
		background: #c91a1f;
	}
	.address-continue-btn:disabled {
		background: #ccc;
		cursor: not-allowed;
	}
	.address-continue-btn svg {
		width: 18px;
		height: 18px;
	}
	.address-empty {
		text-align: center;
		padding: 30px;
		color: #666;
	}
	.address-empty a {
		color: #e31e24;
		text-decoration: underline;
	}
	.profile-dropdown-header {
		display: flex;
		align-items: center;
		gap: 12px;
		padding: 16px 18px;
		background: #f9f9f9;
		border-bottom: 1px solid #eee;
	}
	.profile-avatar {
		width: 40px;
		height: 40px;
		background: #e31e24;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}
	.profile-avatar svg {
		width: 20px;
		height: 20px;
		color: #fff;
	}
	.profile-name {
		font-size: 14px;
		font-weight: 600;
		color: #333;
	}
	@media (max-width: 768px) {
		.header .container {
			padding: 0 15px;
		}
		.header-logo svg {
			height: 28px;
		}
		.header-user-location {
			display: none;
		}
		.header-dealer-select {
			display: none;
		}
	}
	/* Dealer Selection Button */
	.header-dealer-select {
		display: flex;
		align-items: center;
		gap: 8px;
		padding: 10px 18px;
		background: #fff;
		border: 1px solid #e0e0e0;
		border-radius: 30px;
		cursor: pointer;
		transition: all 0.2s;
		max-width: 200px;
		font-size: 14px;
		color: #333;
	}
	.header-dealer-select:hover {
		border-color: #e31e24;
		box-shadow: 0 2px 8px rgba(227, 30, 36, 0.15);
	}
	.header-dealer-select.empty {
		border-style: dashed;
		color: #999;
	}
	.header-dealer-select.no-dealer {
		opacity: 0.6;
		cursor: not-allowed;
		pointer-events: none;
	}
	.header-dealer-select .dealer-icon {
		width: 18px;
		height: 18px;
		color: #e31e24;
		flex-shrink: 0;
	}
	.header-dealer-select .dealer-name {
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		max-width: 140px;
		font-weight: 500;
	}
	.header-dealer-select .dealer-chevron {
		width: 14px;
		height: 14px;
		color: #999;
		flex-shrink: 0;
		transition: transform 0.2s;
	}
	.header-dealer-select:hover .dealer-chevron {
		color: #e31e24;
	}
	/* Dealer Modal */
	.dealer-modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0,0,0,0.5);
		z-index: 1000;
		display: none;
		align-items: center;
		justify-content: center;
	}
	.dealer-modal-overlay.active {
		display: flex;
	}
	.dealer-modal {
		background: #fff;
		border-radius: 12px;
		padding: 30px;
		width: 450px;
		max-width: 90%;
		max-height: 80vh;
		display: flex;
		flex-direction: column;
	}
	.dealer-modal-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		margin-bottom: 8px;
	}
	.dealer-modal-title {
		font-size: 18px;
		font-weight: 600;
		color: #333;
	}
	.dealer-modal-close {
		background: none;
		border: none;
		width: 32px;
		height: 32px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		color: #999;
		transition: background 0.2s, color 0.2s;
	}
	.dealer-modal-close:hover {
		background: #f5f5f5;
		color: #333;
	}
	.dealer-modal-close svg {
		width: 18px;
		height: 18px;
	}
	.dealer-modal-location {
		font-size: 13px;
		color: #666;
		margin-bottom: 20px;
		display: flex;
		align-items: center;
		gap: 6px;
	}
	.dealer-modal-location svg {
		width: 14px;
		height: 14px;
		color: #e31e24;
	}
	.dealer-modal-list {
		display: flex;
		flex-direction: column;
		gap: 12px;
		margin-bottom: 20px;
		overflow-y: auto;
		max-height: 320px;
		flex: 1;
	}
	.dealer-modal-item {
		display: flex;
		align-items: flex-start;
		gap: 15px;
		padding: 15px;
		border: 1px solid #e0e0e0;
		border-radius: 8px;
		cursor: pointer;
		transition: border-color 0.2s, background 0.2s;
	}
	.dealer-modal-item:hover {
		border-color: #e31e24;
	}
	.dealer-modal-item.selected {
		border-color: #e31e24;
		background: #fff5f5;
	}
	.dealer-radio {
		width: 20px;
		height: 20px;
		border: 2px solid #ccc;
		border-radius: 50%;
		flex-shrink: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		margin-top: 2px;
	}
	.dealer-modal-item.selected .dealer-radio {
		border-color: #e31e24;
	}
	.dealer-radio-inner {
		width: 10px;
		height: 10px;
		background: #e31e24;
		border-radius: 50%;
		display: none;
	}
	.dealer-modal-item.selected .dealer-radio-inner {
		display: block;
	}
	.dealer-modal-info {
		flex: 1;
	}
	.dealer-modal-name {
		font-size: 15px;
		font-weight: 600;
		color: #333;
		margin-bottom: 6px;
	}
	.dealer-modal-details {
		display: flex;
		flex-direction: column;
		gap: 4px;
	}
	.dealer-modal-detail {
		display: flex;
		align-items: center;
		gap: 6px;
		font-size: 13px;
		color: #666;
	}
	.dealer-modal-detail svg {
		width: 14px;
		height: 14px;
		color: #999;
	}
	.dealer-select-btn {
		width: 100%;
		background: #e31e24;
		color: #fff;
		border: none;
		border-radius: 8px;
		padding: 15px;
		font-size: 16px;
		font-weight: 600;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 8px;
		font-family: inherit;
		transition: background 0.3s;
		flex-shrink: 0;
	}
	.dealer-select-btn:hover {
		background: #c91a1f;
	}
	.dealer-select-btn:disabled {
		background: #ccc;
		cursor: not-allowed;
	}
	.dealer-select-btn svg {
		width: 18px;
		height: 18px;
	}
	.dealer-empty {
		text-align: center;
		padding: 40px 20px;
		color: #666;
	}
	.dealer-empty-icon {
		width: 64px;
		height: 64px;
		margin: 0 auto 16px;
		background: #fff3f3;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.dealer-empty-icon svg {
		width: 32px;
		height: 32px;
		color: #e31e24;
	}
	.dealer-empty-title {
		font-size: 16px;
		font-weight: 600;
		color: #333;
		margin-bottom: 8px;
	}
	.dealer-empty-text {
		font-size: 14px;
		color: #666;
		line-height: 1.5;
		margin-bottom: 20px;
	}
	.dealer-empty-btn {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		padding: 12px 24px;
		background: #f5f5f5;
		border: none;
		border-radius: 25px;
		color: #333;
		font-size: 14px;
		font-weight: 500;
		font-family: inherit;
		cursor: pointer;
		transition: background 0.2s;
	}
	.dealer-empty-btn:hover {
		background: #eee;
	}
	.dealer-empty-btn svg {
		width: 16px;
		height: 16px;
	}
	@media (max-width: 768px) {
		.dealer-modal {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			max-width: 100%;
			max-height: 85vh;
			border-radius: 20px 20px 0 0;
			padding: 24px;
		}
	}
</style>

<header class="header">
	<div class="container">
		<!-- Logo -->
		<a href="isyerim-musteri-anasayfa.html" class="header-logo">
			<svg viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
				<circle cx="25" cy="25" r="20" fill="none" stroke="#e31e24" stroke-width="3"/>
				<path d="M25 10 L25 25" stroke="#e31e24" stroke-width="3" stroke-linecap="round"/>
				<text x="55" y="32" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#e31e24">iPRAGAZ</text>
			</svg>
		</a>

		<!-- Right Section -->
		<div class="header-actions">
			<!-- User + Location Pill -->
			<div class="header-user-location">
				<span class="user-name" id="headerUserName">Kullanici</span>
				<span>:</span>
				<span id="headerUserLocation">Sube Seciniz</span>
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
				</svg>
			</div>
			<!-- Dealer Selection -->
			<div class="header-dealer-select empty" id="dealerSelectBtn" onclick="openDealerModal()">
				<svg class="dealer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
					<polyline points="9 22 9 12 15 12 15 22"/>
				</svg>
				<span class="dealer-name" id="selectedDealerName">Bayi Seciniz</span>
				<svg class="dealer-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<polyline points="6 9 12 15 18 9"/>
				</svg>
			</div>
			<!-- Notification -->
			<div class="notification-container">
				<a href="#" class="header-action notification-btn" id="notificationBtn">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
						<path d="M13.73 21a2 2 0 0 1-3.46 0"/>
					</svg>
					<span class="notification-badge" id="notificationBadge">0</span>
				</a>
				<!-- Notification Dropdown -->
				<div class="notification-dropdown" id="notificationDropdown">
					<div class="notification-header">
						<span class="notification-header-title">Bildirimler</span>
						<button class="notification-mark-all" id="markAllReadBtn">Tumunu Okundu Isaretle</button>
					</div>
					<div class="notification-list" id="notificationList">
						<div class="notification-empty">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
								<path d="M13.73 21a2 2 0 0 1-3.46 0"/>
							</svg>
							<p>Hic okunmamis mesajiniz yok</p>
						</div>
					</div>
				</div>
			</div>
			<!-- User Profile with Dropdown -->
			<div class="profile-dropdown-container">
				<a href="#" class="header-action" id="profileBtn">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
						<circle cx="12" cy="7" r="4"/>
					</svg>
				</a>
				<!-- Profile Dropdown Menu -->
				<div class="profile-dropdown" id="profileDropdown">
					<!-- Kullanıcı Adı Bölümü -->
					<div class="profile-dropdown-header">
						<div class="profile-avatar">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
								<circle cx="12" cy="7" r="4"/>
							</svg>
						</div>
						<span class="profile-name" id="profileUserName">Kullanici</span>
					</div>
					<a href="isyerim-musteri-bayi-fiyatlari.html" class="profile-dropdown-item">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="12" y1="1" x2="12" y2="23"/>
							<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
						</svg>
						Bayi Fiyatlari
					</a>
					<a href="isyerim-musteri-teklif-iste.html" class="profile-dropdown-item">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
							<polyline points="14 2 14 8 20 8"/>
							<line x1="12" y1="18" x2="12" y2="12"/>
							<line x1="9" y1="15" x2="15" y2="15"/>
						</svg>
						Teklif Iste
					</a>
					<a href="isyerim-musteri-bilgileri-guncelle.html" class="profile-dropdown-item">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<circle cx="12" cy="12" r="3"/>
							<path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
						</svg>
						Ayarlar
					</a>
					<a href="isyerim-musteri-login.html" class="profile-dropdown-item logout">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
							<polyline points="16 17 21 12 16 7"/>
							<line x1="21" y1="12" x2="9" y2="12"/>
						</svg>
						Cikis Yap
					</a>
				</div>
			</div>
		</div>
	</div>
</header>

<!-- Address Selection Modal -->
<div class="address-modal-overlay" id="addressModalOverlay" onclick="closeAddressModal(event)">
	<div class="address-modal" onclick="event.stopPropagation()">
		<h3 class="address-modal-title">Subelerim</h3>
		<div class="address-modal-list" id="addressModalList">
			<div class="address-empty">Yukleniyor...</div>
		</div>
		<button class="address-continue-btn" id="addressContinueBtn" onclick="confirmAddressSelection()" disabled>
			Devam Et
			<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M5 12h14"/>
				<path d="M12 5l7 7-7 7"/>
			</svg>
		</button>
	</div>
</div>

<!-- Dealer Selection Modal -->
<div class="dealer-modal-overlay" id="dealerModalOverlay" onclick="closeDealerModal(event)">
	<div class="dealer-modal" onclick="event.stopPropagation()">
		<div class="dealer-modal-header">
			<h3 class="dealer-modal-title">Bayi Secin</h3>
			<button class="dealer-modal-close" onclick="closeDealerModal()">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
				</svg>
			</button>
		</div>
		<p class="dealer-modal-location" id="dealerModalLocation">
			<svg viewBox="0 0 24 24" fill="currentColor">
				<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
			</svg>
			<span id="dealerModalLocationText">Yukleniyor...</span>
		</p>
		<div class="dealer-modal-list" id="dealerModalList">
			<div class="dealer-empty">Yukleniyor...</div>
		</div>
		<button class="dealer-select-btn" id="dealerSelectConfirmBtn" onclick="confirmDealerSelection()" disabled>
			Sec
			<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<polyline points="20 6 9 17 4 12"/>
			</svg>
		</button>
	</div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Notification Detail Modal -->
<div class="notification-modal-overlay" id="notificationModalOverlay" onclick="ComponentLoader.closeNotificationModal(event)">
	<div class="notification-modal" onclick="event.stopPropagation()">
		<div class="notification-modal-header">
			<div class="notification-modal-title-area">
				<div class="notification-modal-status" id="notificationModalStatus">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
					<span id="notificationModalStatusText">Durum</span>
				</div>
				<div class="notification-modal-subtitle" id="notificationModalTime">2 saat once</div>
			</div>
			<button class="notification-modal-close" onclick="ComponentLoader.closeNotificationModal()">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
				</svg>
			</button>
		</div>
		<div class="notification-modal-body" id="notificationModalBody">
			<div class="notification-modal-loading">Yukleniyor...</div>
		</div>
		<div class="notification-modal-footer">
			<button class="notification-modal-btn secondary" onclick="ComponentLoader.closeNotificationModal()">
				Kapat
			</button>
			<button class="notification-modal-btn primary" id="notificationModalViewBtn" onclick="ComponentLoader.goToOffer()">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
					<circle cx="12" cy="12" r="3"/>
				</svg>
				Teklifi Goruntule
			</button>
		</div>
	</div>
</div>

<script>
// Bayi modal fonksiyonlari component-loader.js'de tanimli

// Notification System
const NotificationUI = {
	isInitialized: false,
	currentUserId: null,
	currentUserType: 'customer',

	async init() {
		if (this.isInitialized) return;

		// Wait for supabase and service to be ready
		if (typeof supabaseClient === 'undefined' || typeof NotificationsService === 'undefined') {
			setTimeout(() => this.init(), 100);
			return;
		}

		// Get current customer from sessionStorage
		const customerId = sessionStorage.getItem('isyerim_customer_id');
		if (!customerId) return;

		this.currentUserId = customerId;
		this.isInitialized = true;

		// Setup event listeners
		this.setupEventListeners();

		// Load initial notifications
		await this.loadNotifications();

		// Subscribe to realtime
		this.subscribeToRealtime();
	},

	setupEventListeners() {
		const notificationBtn = document.getElementById('notificationBtn');
		const notificationDropdown = document.getElementById('notificationDropdown');
		const markAllBtn = document.getElementById('markAllReadBtn');

		if (notificationBtn) {
			notificationBtn.addEventListener('click', (e) => {
				e.preventDefault();
				notificationDropdown.classList.toggle('active');
				// Close profile dropdown if open
				const profileDropdown = document.getElementById('profileDropdown');
				if (profileDropdown) profileDropdown.classList.remove('active');
			});
		}

		if (markAllBtn) {
			markAllBtn.addEventListener('click', () => this.markAllAsRead());
		}

		// Close dropdown when clicking outside
		document.addEventListener('click', (e) => {
			if (notificationDropdown && !e.target.closest('.notification-container')) {
				notificationDropdown.classList.remove('active');
			}
		});
	},

	async loadNotifications() {
		const { data: notifications, error } = await NotificationsService.getAll(
			this.currentUserId,
			this.currentUserType,
			{ limit: 20 }
		);

		if (error) {
			console.error('Error loading notifications:', error);
			return;
		}

		this.renderNotifications(notifications);
		this.updateBadge(notifications);
	},

	renderNotifications(notifications) {
		const list = document.getElementById('notificationList');
		if (!list) return;

		if (!notifications || notifications.length === 0) {
			list.innerHTML = `
				<div class="notification-empty">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
						<path d="M13.73 21a2 2 0 0 1-3.46 0"/>
					</svg>
					<p>Hic okunmamis mesajiniz yok</p>
				</div>
			`;
			return;
		}

		list.innerHTML = notifications.map(n => this.renderNotificationItem(n)).join('');

		// Add click handlers
		list.querySelectorAll('.notification-item').forEach(item => {
			item.addEventListener('click', () => {
				const id = item.dataset.id;
				const offerId = item.dataset.offerId;
				this.handleNotificationClick(id, offerId);
			});
		});
	},

	renderNotificationItem(notification) {
		const timeAgo = this.getTimeAgo(notification.created_at);
		const iconClass = notification.action || 'default';
		const unreadClass = notification.is_read ? '' : 'unread';

		return `
			<div class="notification-item ${unreadClass}" data-id="${notification.id}" data-offer-id="${notification.offer_id || ''}">
				<div class="notification-icon ${iconClass}">
					${this.getActionIcon(notification.action)}
				</div>
				<div class="notification-content">
					<div class="notification-title">${notification.title}</div>
					<div class="notification-message">${notification.message}</div>
					<div class="notification-time">${timeAgo}</div>
				</div>
			</div>
		`;
	},

	getActionIcon(action) {
		const icons = {
			accepted: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
			rejected: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
			pending: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
			price_updated: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
			cancelled: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
			created: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>',
			requested: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>',
			message: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
		};
		return icons[action] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>';
	},

	getTimeAgo(dateString) {
		const date = new Date(dateString);
		const now = new Date();
		const seconds = Math.floor((now - date) / 1000);

		if (seconds < 60) return 'Az once';
		if (seconds < 3600) return Math.floor(seconds / 60) + ' dk once';
		if (seconds < 86400) return Math.floor(seconds / 3600) + ' saat once';
		if (seconds < 604800) return Math.floor(seconds / 86400) + ' gun once';
		return date.toLocaleDateString('tr-TR');
	},

	updateBadge(notifications) {
		const badge = document.getElementById('notificationBadge');
		if (!badge) return;

		const unreadCount = notifications ? notifications.filter(n => !n.is_read).length : 0;
		badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
	},

	async handleNotificationClick(notificationId, offerId) {
		// Mark as read
		await NotificationsService.markAsRead(notificationId);

		// Refresh list
		await this.loadNotifications();

		// Navigate to offer if available
		if (offerId) {
			window.location.href = 'isyerim-musteri-bayi-fiyatlari.html?offer_id=' + offerId;
		}
	},

	async markAllAsRead() {
		await NotificationsService.markAllAsRead(this.currentUserId, this.currentUserType);
		await this.loadNotifications();
	},

	subscribeToRealtime() {
		NotificationsService.subscribe(this.currentUserId, (notification) => {
			// Show toast
			this.showToast(notification);

			// Shake bell
			const btn = document.getElementById('notificationBtn');
			if (btn) {
				btn.classList.add('shake');
				setTimeout(() => btn.classList.remove('shake'), 500);
			}

			// Pulse badge
			const badge = document.getElementById('notificationBadge');
			if (badge) {
				badge.classList.add('pulse');
				setTimeout(() => badge.classList.remove('pulse'), 500);
			}

			// Reload notifications
			this.loadNotifications();
		});
	},

	showToast(notification) {
		const container = document.getElementById('toastContainer');
		if (!container) return;

		const toast = document.createElement('div');
		toast.className = 'toast';
		toast.innerHTML = `
			<div class="toast-progress"></div>
			<div class="toast-header">
				<div class="toast-icon ${notification.action || 'default'}">
					${this.getActionIcon(notification.action)}
				</div>
				<span class="toast-title">${notification.title}</span>
				<button class="toast-close" onclick="this.closest('.toast').remove()">
					<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
					</svg>
				</button>
			</div>
			<div class="toast-message">${notification.message}</div>
			${notification.offer_id ? `
				<button class="toast-action" onclick="window.location.href='isyerim-musteri-bayi-fiyatlari.html?offer_id=${notification.offer_id}'">
					Teklifi Goruntule
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M5 12h14"/><path d="M12 5l7 7-7 7"/>
					</svg>
				</button>
			` : ''}
		`;

		container.appendChild(toast);

		// Auto remove after 5 seconds
		setTimeout(() => {
			toast.classList.add('removing');
			setTimeout(() => toast.remove(), 300);
		}, 5000);
	}
};

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', () => {
	// Wait a bit for other scripts to load
	setTimeout(() => NotificationUI.init(), 500);
	setTimeout(() => DealerUI.init(), 600);
});

// Dealer Selection System
const DealerUI = {
	isInitialized: false,
	currentDealerId: null,
	currentDealers: [],
	selectedTempDealerId: null,
	currentAddressCity: null,
	currentAddressDistrict: null,

	async init() {
		if (this.isInitialized) return;

		// Wait for supabase and services to be ready
		if (typeof supabaseClient === 'undefined' ||
			typeof DealersService === 'undefined' ||
			typeof CustomersService === 'undefined' ||
			typeof AddressesService === 'undefined') {
			setTimeout(() => this.init(), 200);
			return;
		}

		this.isInitialized = true;

		// Load current dealer from customer data
		await this.loadCurrentDealer();
	},

	async loadCurrentDealer() {
		const customerId = sessionStorage.getItem('isyerim_customer_id');
		if (!customerId) return;

		try {
			// Get customer with dealer info
			const { data: customer, error } = await CustomersService.getById(customerId);
			if (error || !customer) return;

			if (customer.dealer_id && customer.dealer) {
				this.currentDealerId = customer.dealer_id;
				this.updateDealerButton(customer.dealer.name);
				sessionStorage.setItem('isyerim_dealer_id', customer.dealer_id);
				sessionStorage.setItem('isyerim_dealer_name', customer.dealer.name);
			}
		} catch (err) {
			console.error('Error loading current dealer:', err);
		}
	},

	updateDealerButton(dealerName) {
		const btn = document.getElementById('dealerSelectBtn');
		const nameEl = document.getElementById('selectedDealerName');

		if (btn && nameEl) {
			if (dealerName) {
				btn.classList.remove('empty');
				nameEl.textContent = dealerName;
			} else {
				btn.classList.add('empty');
				nameEl.textContent = 'Bayi Seciniz';
			}
		}
	},

	async getAddressLocation() {
		const addressId = sessionStorage.getItem('selected_address_id');
		if (!addressId) return null;

		try {
			const { data: address, error } = await AddressesService.getById(addressId);
			if (error || !address) return null;

			return {
				city: address.city,
				district: address.district
			};
		} catch (err) {
			console.error('Error getting address:', err);
			return null;
		}
	},

	async loadDealersForLocation(city, district) {
		try {
			const { data: dealers, error } = await DealersService.getByDistrict(city, district);
			if (error) {
				console.error('Error loading dealers:', error);
				return [];
			}
			return dealers || [];
		} catch (err) {
			console.error('Error loading dealers:', err);
			return [];
		}
	},

	renderDealerList(dealers) {
		const list = document.getElementById('dealerModalList');
		if (!list) return;

		if (!dealers || dealers.length === 0) {
			list.innerHTML = `
				<div class="dealer-empty">
					<div class="dealer-empty-icon">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<circle cx="12" cy="12" r="10"/>
							<path d="M16 16s-1.5-2-4-2-4 2-4 2"/>
							<line x1="9" y1="9" x2="9.01" y2="9"/>
							<line x1="15" y1="9" x2="15.01" y2="9"/>
						</svg>
					</div>
					<h4 class="dealer-empty-title">Bolgenizde Bayi Bulunamadi</h4>
					<p class="dealer-empty-text">Maalesef ${this.currentAddressDistrict || ''}, ${this.currentAddressCity || ''} bolgesinde aktif bayi bulunmamaktadir.</p>
					<button class="dealer-empty-btn" onclick="openAddressModal()">
						<svg viewBox="0 0 24 24" fill="currentColor">
							<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
						</svg>
						Farkli Adres Sec
					</button>
				</div>
			`;
			return;
		}

		this.currentDealers = dealers;

		list.innerHTML = dealers.map(dealer => {
			const isSelected = dealer.id === this.currentDealerId;
			return `
				<div class="dealer-modal-item ${isSelected ? 'selected' : ''}" onclick="DealerUI.selectDealer('${dealer.id}')">
					<div class="dealer-radio">
						<div class="dealer-radio-inner"></div>
					</div>
					<div class="dealer-modal-info">
						<div class="dealer-modal-name">${this.escapeHtml(dealer.name)}</div>
						<div class="dealer-modal-details">
							<div class="dealer-modal-detail">
								<svg viewBox="0 0 24 24" fill="currentColor">
									<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
								</svg>
								<span>${this.escapeHtml(dealer.district || '')}, ${this.escapeHtml(dealer.city || '')}</span>
							</div>
							${dealer.phone ? `
							<div class="dealer-modal-detail">
								<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
								</svg>
								<span>${this.escapeHtml(dealer.phone)}</span>
							</div>
							` : ''}
						</div>
					</div>
				</div>
			`;
		}).join('');

		// Pre-select current dealer
		if (this.currentDealerId) {
			this.selectedTempDealerId = this.currentDealerId;
			document.getElementById('dealerSelectConfirmBtn').disabled = false;
		}
	},

	selectDealer(dealerId) {
		// Update selection
		this.selectedTempDealerId = dealerId;

		// Update UI
		document.querySelectorAll('.dealer-modal-item').forEach(item => {
			item.classList.remove('selected');
		});
		event.currentTarget.classList.add('selected');

		// Enable confirm button
		document.getElementById('dealerSelectConfirmBtn').disabled = false;
	},

	async confirmSelection() {
		if (!this.selectedTempDealerId) return;

		const customerId = sessionStorage.getItem('isyerim_customer_id');
		if (!customerId) return;

		const btn = document.getElementById('dealerSelectConfirmBtn');
		btn.disabled = true;
		btn.innerHTML = '<span class="spinner"></span> Kaydediliyor...';

		try {
			// Update customer with new dealer_id
			const { error } = await CustomersService.update(customerId, {
				dealer_id: this.selectedTempDealerId
			});

			if (error) {
				console.error('Error updating dealer:', error);
				alert('Bayi kaydedilemedi. Lutfen tekrar deneyiniz.');
				btn.disabled = false;
				btn.innerHTML = 'Sec <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
				return;
			}

			// Update local state
			this.currentDealerId = this.selectedTempDealerId;

			// Find dealer name
			const dealer = this.currentDealers.find(d => d.id === this.selectedTempDealerId);
			const dealerName = dealer ? dealer.name : 'Bayi';

			// Update sessionStorage
			sessionStorage.setItem('isyerim_dealer_id', this.selectedTempDealerId);
			sessionStorage.setItem('isyerim_dealer_name', dealerName);

			// Update header button
			this.updateDealerButton(dealerName);

			// Close modal
			this.closeModal();

		} catch (err) {
			console.error('Error confirming dealer:', err);
			alert('Bir hata olustu. Lutfen tekrar deneyiniz.');
			btn.disabled = false;
			btn.innerHTML = 'Sec <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
		}
	},

	async openModal() {
		const overlay = document.getElementById('dealerModalOverlay');
		const locationText = document.getElementById('dealerModalLocationText');
		const list = document.getElementById('dealerModalList');
		const btn = document.getElementById('dealerSelectConfirmBtn');

		if (!overlay) return;

		// Reset state
		this.selectedTempDealerId = this.currentDealerId;
		btn.disabled = !this.currentDealerId;
		btn.innerHTML = 'Sec <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';

		// Show loading
		list.innerHTML = '<div class="dealer-empty">Yukleniyor...</div>';
		locationText.textContent = 'Yukleniyor...';

		// Show modal
		overlay.classList.add('active');

		// Get address location
		const location = await this.getAddressLocation();

		if (!location || !location.city || !location.district) {
			locationText.textContent = 'Adres bilgisi alinamadi';
			list.innerHTML = `
				<div class="dealer-empty">
					<div class="dealer-empty-icon">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<circle cx="12" cy="12" r="10"/>
							<line x1="12" y1="8" x2="12" y2="12"/>
							<line x1="12" y1="16" x2="12.01" y2="16"/>
						</svg>
					</div>
					<h4 class="dealer-empty-title">Adres Secilmedi</h4>
					<p class="dealer-empty-text">Lutfen once bir adres seciniz.</p>
					<button class="dealer-empty-btn" onclick="openAddressModal(); closeDealerModal();">
						<svg viewBox="0 0 24 24" fill="currentColor">
							<path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
						</svg>
						Adres Sec
					</button>
				</div>
			`;
			return;
		}

		this.currentAddressCity = location.city;
		this.currentAddressDistrict = location.district;

		// Update location text
		locationText.textContent = `${location.district}, ${location.city}`;

		// Load dealers for this location
		const dealers = await this.loadDealersForLocation(location.city, location.district);

		// Render dealer list
		this.renderDealerList(dealers);
	},

	closeModal() {
		const overlay = document.getElementById('dealerModalOverlay');
		if (overlay) {
			overlay.classList.remove('active');
		}
	},

	escapeHtml(text) {
		if (!text) return '';
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	}
};
</script>
