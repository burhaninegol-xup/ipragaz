<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>VKN Dogrulama - Ä°pragaz</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<script src="js/project-auth-check.js"></script>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			min-height: 100vh;
			background-color: #e31e24;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			overflow-x: hidden;
		}

		/* B Pattern Background */
		.bg-pattern {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			pointer-events: none;
		}

		.bg-pattern::before {
			content: 'B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B';
			position: absolute;
			top: -50px;
			left: -50px;
			width: calc(100% + 100px);
			height: calc(100% + 100px);
			font-size: 80px;
			font-weight: 700;
			color: rgba(255, 255, 255, 0.08);
			word-spacing: 30px;
			line-height: 1.2;
			letter-spacing: 20px;
			word-break: break-all;
		}

		/* Verification Container */
		.verification-container {
			position: relative;
			z-index: 1;
			width: 100%;
			max-width: 480px;
			padding: 20px;
		}

		.verification-card {
			background: #fff;
			border-radius: 12px;
			padding: 40px 35px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		/* Logo */
		.logo {
			text-align: center;
			margin-bottom: 30px;
		}

		.logo svg {
			width: 140px;
			height: auto;
		}

		/* Back Link */
		.back-link {
			display: flex;
			align-items: center;
			gap: 8px;
			color: #333;
			font-size: 18px;
			font-weight: 600;
			margin-bottom: 10px;
			cursor: pointer;
			text-decoration: none;
		}

		.back-link:hover {
			color: #e31e24;
		}

		.back-link svg {
			width: 20px;
			height: 20px;
		}

		/* Title & Description */
		h2 {
			font-size: 20px;
			font-weight: 600;
			color: #333;
			margin-bottom: 10px;
		}

		.description {
			color: #666;
			font-size: 14px;
			line-height: 1.6;
			margin-bottom: 25px;
		}

		/* VKN Info Box */
		.vkn-info-box {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 14px 16px;
			background: #f8f9fa;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			margin-bottom: 25px;
		}

		.vkn-info-box .label {
			font-size: 12px;
			color: #666;
		}

		.vkn-info-box .value {
			font-size: 16px;
			font-weight: 600;
			color: #333;
		}

		/* Document Upload */
		.document-upload {
			margin-bottom: 20px;
		}

		.document-upload label {
			display: block;
			font-size: 14px;
			font-weight: 500;
			color: #333;
			margin-bottom: 10px;
		}

		.upload-area {
			position: relative;
			border: 2px dashed #ddd;
			border-radius: 10px;
			padding: 30px 20px;
			text-align: center;
			background: #fafafa;
			cursor: pointer;
			transition: all 0.3s;
		}

		.upload-area:hover {
			border-color: #e31e24;
			background: #fff5f5;
		}

		.upload-area.has-file {
			border-color: #10b981;
			background: #f0fdf4;
		}

		.upload-area input[type="file"] {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			opacity: 0;
			cursor: pointer;
		}

		.upload-icon {
			width: 48px;
			height: 48px;
			margin: 0 auto 10px;
			color: #999;
		}

		.upload-area.has-file .upload-icon {
			color: #10b981;
		}

		.upload-text {
			font-size: 14px;
			color: #666;
		}

		.upload-text span {
			color: #e31e24;
			font-weight: 500;
		}

		.upload-hint {
			font-size: 12px;
			color: #999;
			margin-top: 5px;
		}

		/* Preview */
		.preview {
			margin-top: 10px;
			display: none;
		}

		.preview.active {
			display: block;
		}

		.preview-item {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 10px 12px;
			background: #f0fdf4;
			border: 1px solid #86efac;
			border-radius: 8px;
		}

		.preview-icon {
			width: 32px;
			height: 32px;
			color: #10b981;
		}

		.preview-name {
			flex: 1;
			font-size: 13px;
			color: #333;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.preview-remove {
			background: none;
			border: none;
			color: #dc2626;
			cursor: pointer;
			padding: 4px;
		}

		.preview-remove:hover {
			color: #b91c1c;
		}

		/* Info Box */
		.info-box {
			display: flex;
			align-items: flex-start;
			gap: 12px;
			padding: 14px 16px;
			background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
			border: 1px solid #f59e0b;
			border-radius: 10px;
			margin-bottom: 25px;
		}

		.info-box svg {
			width: 20px;
			height: 20px;
			color: #d97706;
			flex-shrink: 0;
			margin-top: 2px;
		}

		.info-box p {
			font-size: 13px;
			color: #92400e;
			margin: 0;
			line-height: 1.5;
		}

		/* Submit Button */
		.btn-submit {
			width: 100%;
			padding: 14px 20px;
			background: #e31e24;
			border: none;
			border-radius: 25px;
			color: #fff;
			font-size: 15px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s, transform 0.2s;
		}

		.btn-submit:hover:not(:disabled) {
			background: #c41a1f;
			transform: translateY(-1px);
		}

		.btn-submit:disabled {
			background: #9ca3af;
			cursor: not-allowed;
			transform: none;
		}

		.btn-submit:active:not(:disabled) {
			transform: translateY(0);
		}

		/* Success State */
		.success-state {
			display: none;
			text-align: center;
			padding: 20px 0;
		}

		.success-state.active {
			display: block;
		}

		.success-icon {
			width: 80px;
			height: 80px;
			background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			margin: 0 auto 20px;
		}

		.success-icon svg {
			width: 40px;
			height: 40px;
			color: #059669;
		}

		.success-state h3 {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 10px;
		}

		.success-state p {
			font-size: 14px;
			color: #666;
			line-height: 1.6;
		}

		/* Responsive */
		@media (max-width: 480px) {
			.verification-card {
				padding: 30px 25px;
			}

			.logo svg {
				width: 120px;
			}

			.back-link {
				font-size: 16px;
			}

			.bg-pattern::before {
				font-size: 50px;
			}

			.upload-area {
				padding: 20px 15px;
			}
		}
	</style>
</head>
<body>
	<!-- Background Pattern -->
	<div class="bg-pattern"></div>

	<!-- Verification Container -->
	<div class="verification-container">
		<div class="verification-card">
			<!-- Logo -->
			<div class="logo">
				<svg viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
					<circle cx="25" cy="25" r="20" fill="none" stroke="#e31e24" stroke-width="3"/>
					<path d="M25 10 L25 25" stroke="#e31e24" stroke-width="3" stroke-linecap="round"/>
					<text x="55" y="32" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#e31e24">iPRAGAZ</text>
				</svg>
			</div>

			<!-- Back Link -->
			<a href="isyerim-musteri-login.html" class="back-link">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M19 12H5M12 19l-7-7 7-7"/>
				</svg>
				VKN Dogrulama
			</a>

			<!-- Form State -->
			<div id="formState">
				<p class="description">
					Asagidaki belgeleri yukleyerek VKN sahipliginizi dogrulayabilirsiniz.
				</p>

				<!-- VKN Info -->
				<div class="vkn-info-box">
					<div>
						<div class="label">Dogrulanacak VKN</div>
						<div class="value" id="displayVkn">--</div>
					</div>
				</div>

				<!-- Vergi Levhasi Upload -->
				<div class="document-upload">
					<label>Vergi Levhasi *</label>
					<div class="upload-area" id="vergiLevhasiArea">
						<input type="file" accept="image/*,.pdf" id="vergiLevhasiInput" onchange="handleFileSelect(this, 'vergiLevhasi')">
						<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
							<polyline points="17 8 12 3 7 8"/>
							<line x1="12" y1="3" x2="12" y2="15"/>
						</svg>
						<p class="upload-text"><span>Tiklayin</span> veya surukleyin</p>
						<p class="upload-hint">PNG, JPG veya PDF (max 5MB)</p>
					</div>
					<div class="preview" id="vergiLevhasiPreview">
						<div class="preview-item">
							<svg class="preview-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
								<polyline points="14 2 14 8 20 8"/>
							</svg>
							<span class="preview-name" id="vergiLevhasiFileName">--</span>
							<button type="button" class="preview-remove" onclick="removeFile('vergiLevhasi')">
								<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<line x1="18" y1="6" x2="6" y2="18"/>
									<line x1="6" y1="6" x2="18" y2="18"/>
								</svg>
							</button>
						</div>
					</div>
				</div>

				<!-- Ticaret Sicil Gazetesi Upload -->
				<div class="document-upload">
					<label>Ticaret Sicil Gazetesi *</label>
					<div class="upload-area" id="ticaretSicilArea">
						<input type="file" accept="image/*,.pdf" id="ticaretSicilInput" onchange="handleFileSelect(this, 'ticaretSicil')">
						<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
							<polyline points="17 8 12 3 7 8"/>
							<line x1="12" y1="3" x2="12" y2="15"/>
						</svg>
						<p class="upload-text"><span>Tiklayin</span> veya surukleyin</p>
						<p class="upload-hint">PNG, JPG veya PDF (max 5MB)</p>
					</div>
					<div class="preview" id="ticaretSicilPreview">
						<div class="preview-item">
							<svg class="preview-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
								<polyline points="14 2 14 8 20 8"/>
							</svg>
							<span class="preview-name" id="ticaretSicilFileName">--</span>
							<button type="button" class="preview-remove" onclick="removeFile('ticaretSicil')">
								<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<line x1="18" y1="6" x2="6" y2="18"/>
									<line x1="6" y1="6" x2="18" y2="18"/>
								</svg>
							</button>
						</div>
					</div>
				</div>

				<!-- Info Box -->
				<div class="info-box">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="12" cy="12" r="10"/>
						<line x1="12" y1="8" x2="12" y2="12"/>
						<line x1="12" y1="16" x2="12.01" y2="16"/>
					</svg>
					<p>Belgeleriniz incelendikten sonra SMS ile bilgilendirileceksiniz.</p>
				</div>

				<!-- Submit Button -->
				<button class="btn-submit" id="submitBtn" disabled onclick="submitVerification()">Belgeleri Gonder</button>
			</div>

			<!-- Success State -->
			<div class="success-state" id="successState">
				<div class="success-icon">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
						<polyline points="22 4 12 14.01 9 11.01"/>
					</svg>
				</div>
				<h3>Basvurunuz Alindi</h3>
				<p>Belgeleriniz incelemeye alindi. Sonuc hakkinda SMS ile bilgilendirileceksiniz.</p>
			</div>
		</div>
	</div>

	<!-- Supabase CDN -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<!-- Supabase Client -->
	<script src="./js/supabase-client.js"></script>
	<!-- VKN Verification Service -->
	<script src="./js/services/vkn-verification-service.js"></script>

	<script>
		// Session verilerini al
		var phone = sessionStorage.getItem('isyerim_phone');
		var vkn = sessionStorage.getItem('vkn_verification_vkn');
		var existingCustomerId = sessionStorage.getItem('vkn_verification_existing_customer_id');

		// VKN yoksa login sayfasina yonlendir
		if (!vkn || !phone) {
			alert('VKN bilgisi bulunamadi. Lutfen tekrar deneyin.');
			window.location.href = 'isyerim-musteri-login.html';
		}

		// VKN'yi goster
		document.getElementById('displayVkn').textContent = vkn;

		// Dosya verileri
		var files = {
			vergiLevhasi: null,
			ticaretSicil: null
		};

		// Dosya secildiginde
		function handleFileSelect(input, type) {
			var file = input.files[0];
			if (!file) return;

			// Boyut kontrolu (5MB)
			if (file.size > 5 * 1024 * 1024) {
				alert('Dosya boyutu 5MB\'dan buyuk olamaz.');
				input.value = '';
				return;
			}

			// Dosyayi kaydet
			files[type] = file;

			// UI guncelle
			var area = document.getElementById(type + 'Area');
			var preview = document.getElementById(type + 'Preview');
			var fileName = document.getElementById(type + 'FileName');

			area.classList.add('has-file');
			preview.classList.add('active');
			fileName.textContent = file.name;

			// Submit butonunu kontrol et
			checkSubmitButton();
		}

		// Dosya kaldir
		function removeFile(type) {
			files[type] = null;

			var input = document.getElementById(type + 'Input');
			var area = document.getElementById(type + 'Area');
			var preview = document.getElementById(type + 'Preview');

			input.value = '';
			area.classList.remove('has-file');
			preview.classList.remove('active');

			checkSubmitButton();
		}

		// Submit butonu kontrolu
		function checkSubmitButton() {
			var submitBtn = document.getElementById('submitBtn');
			submitBtn.disabled = !(files.vergiLevhasi && files.ticaretSicil);
		}

		// Dogrulama gonder
		async function submitVerification() {
			var submitBtn = document.getElementById('submitBtn');
			submitBtn.disabled = true;
			submitBtn.textContent = 'Gonderiliyor...';

			try {
				// Dosyalari yukle
				var vergiLevhasiUrl = await VknVerificationService.uploadDocument(
					files.vergiLevhasi,
					'vergi_levhasi',
					phone
				);

				var ticaretSicilUrl = await VknVerificationService.uploadDocument(
					files.ticaretSicil,
					'ticaret_sicil',
					phone
				);

				// Dogrulama istegi olustur
				var result = await VknVerificationService.create({
					phone: phone,
					vkn: vkn,
					existing_customer_id: existingCustomerId,
					tax_certificate_url: vergiLevhasiUrl,
					trade_registry_url: ticaretSicilUrl,
					status: 'pending'
				});

				if (result.error) {
					throw result.error;
				}

				// Basari durumunu goster
				document.getElementById('formState').style.display = 'none';
				document.getElementById('successState').classList.add('active');

				// Session verilerini temizle
				sessionStorage.removeItem('vkn_verification_vkn');
				sessionStorage.removeItem('vkn_verification_existing_customer_id');
				sessionStorage.removeItem('vkn_verification_existing_customer_name');

			} catch (error) {
				console.error('Dogrulama hatasi:', error);
				alert('Belgeler gonderilirken bir hata olustu. Lutfen tekrar deneyin.');
				submitBtn.disabled = false;
				submitBtn.textContent = 'Belgeleri Gonder';
			}
		}
	</script>
</body>
</html>
