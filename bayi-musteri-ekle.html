<!DOCTYPE html>
<html lang="tr">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Müşteri Fiyat Tanımlama - İpragaz Bayi</title>
	<meta http-equiv="Content-Language" content="Turkish">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<link rel="shortcut icon" type="image/x-icon" media="all" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" type="text/css" href="./İpragaz Bayi_files/css">
	<link rel="stylesheet" type="text/css" media="all" href="./İpragaz Bayi_files/style.css">

	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #f5f7fa;
			min-height: 100vh;
		}

		/* Header */
		.header {
			background: #fff;
			box-shadow: 0 2px 10px rgba(0,0,0,0.08);
			position: sticky;
			top: 0;
			z-index: 100;
		}

		.header .container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 0 20px;
		}

		.header__wrapper {
			display: flex;
			align-items: center;
			justify-content: space-between;
			height: 70px;
		}

		.header__logo img {
			height: 40px;
		}

		.header__nav {
			display: flex;
			align-items: center;
			gap: 30px;
		}

		.header__nav nav ul {
			display: flex;
			list-style: none;
			gap: 25px;
		}

		.header__nav nav ul li a {
			text-decoration: none;
			color: #333;
			font-size: 14px;
			font-weight: 500;
			transition: color 0.2s;
		}

		.header__nav nav ul li a:hover {
			color: #002c77;
		}

		.header__user-panel ul {
			display: flex;
			align-items: center;
			list-style: none;
			gap: 20px;
		}

		.header__user-panel .date-display {
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			font-size: 12px;
			color: #666;
		}

		.header__user-panel .date-display span:first-child {
			font-weight: 600;
			color: #333;
		}

		.header__user-panel .icon-btn {
			position: relative;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 40px;
			height: 40px;
			border-radius: 10px;
			background: #f5f7fa;
			transition: background 0.2s;
		}

		.header__user-panel .icon-btn:hover {
			background: #e8ecf1;
		}

		.header__user-panel .icon-btn img {
			width: 20px;
			height: 20px;
		}

		.header__user-panel .badge {
			position: absolute;
			top: -5px;
			right: -5px;
			background: #e53935;
			color: #fff;
			font-size: 11px;
			font-weight: 600;
			min-width: 18px;
			height: 18px;
			border-radius: 9px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.header__mobile {
			display: none;
			width: 40px;
			height: 40px;
			align-items: center;
			justify-content: center;
			cursor: pointer;
		}

		.header__mobile span,
		.header__mobile span::before,
		.header__mobile span::after {
			display: block;
			width: 24px;
			height: 2px;
			background: #333;
			position: relative;
			transition: all 0.3s;
		}

		.header__mobile span::before,
		.header__mobile span::after {
			content: '';
			position: absolute;
			left: 0;
		}

		.header__mobile span::before {
			top: -7px;
		}

		.header__mobile span::after {
			top: 7px;
		}

		/* Main Content */
		.main-content {
			max-width: 1200px;
			margin: 0 auto;
			padding: 30px 20px;
		}

		/* Page Header */
		.page-header {
			display: flex;
			align-items: center;
			gap: 15px;
			margin-bottom: 25px;
		}

		.back-btn {
			display: flex;
			align-items: center;
			justify-content: center;
			width: 40px;
			height: 40px;
			border-radius: 10px;
			background: #fff;
			border: 1px solid #e0e0e0;
			color: #666;
			text-decoration: none;
			transition: all 0.2s;
		}

		.back-btn:hover {
			background: #f5f7fa;
			border-color: #002c77;
			color: #002c77;
		}

		.back-btn svg {
			width: 20px;
			height: 20px;
		}

		.page-header-text h1 {
			font-size: 24px;
			color: #1a1a2e;
			font-weight: 700;
			margin-bottom: 4px;
		}

		.page-header-text p {
			color: #666;
			font-size: 14px;
		}

		/* Form Sections */
		.form-section {
			background: #fff;
			border-radius: 16px;
			padding: 25px;
			margin-bottom: 20px;
			box-shadow: 0 2px 12px rgba(0,0,0,0.06);
		}

		.section-title {
			font-size: 16px;
			font-weight: 600;
			color: #1a1a2e;
			margin-bottom: 20px;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.section-title svg {
			width: 22px;
			height: 22px;
			color: #002c77;
		}

		/* VKN Search */
		.vkn-search-row {
			display: flex;
			gap: 15px;
			margin-bottom: 20px;
		}

		.vkn-input-wrapper {
			flex: 1;
		}

		.vkn-input-wrapper label {
			display: block;
			font-size: 13px;
			font-weight: 500;
			color: #666;
			margin-bottom: 8px;
		}

		.vkn-input-wrapper input {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid #e0e0e0;
			border-radius: 10px;
			font-size: 15px;
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		.vkn-input-wrapper input:focus {
			outline: none;
			border-color: #002c77;
			box-shadow: 0 0 0 3px rgba(0,44,119,0.1);
		}

		.vkn-search-btn {
			display: flex;
			align-items: flex-end;
		}

		.vkn-search-btn button {
			display: flex;
			align-items: center;
			gap: 8px;
			padding: 14px 24px;
			background: linear-gradient(135deg, #002c77 0%, #0056b3 100%);
			color: #fff;
			border: none;
			border-radius: 10px;
			font-size: 14px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
		}

		.vkn-search-btn button:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 15px rgba(0,44,119,0.3);
		}

		.vkn-search-btn button svg {
			width: 18px;
			height: 18px;
		}

		/* Customer Info Box */
		.customer-info-box {
			background: #f8fafe;
			border: 1px solid #e3f2fd;
			border-radius: 12px;
			padding: 18px;
			display: none;
		}

		.customer-info-box.visible {
			display: block;
		}

		.customer-info-box .info-label {
			font-size: 12px;
			color: #666;
			margin-bottom: 6px;
		}

		.customer-info-box .info-value {
			font-size: 16px;
			font-weight: 600;
			color: #002c77;
		}

		.customer-info-box.error {
			background: #fff5f5;
			border-color: #ffcdd2;
		}

		.customer-info-box.error .info-value {
			color: #c62828;
		}

		/* Products Section */
		.products-form {
			display: none;
		}

		.products-form.visible {
			display: block;
		}

		.product-row {
			display: flex;
			flex-wrap: wrap;
			align-items: flex-start;
			gap: 15px;
			padding: 18px;
			background: #f8f9fa;
			border-radius: 12px;
			margin-bottom: 12px;
			transition: all 0.2s;
		}

		.product-row:hover {
			background: #f0f4f8;
		}

		.product-row:last-child {
			margin-bottom: 0;
		}

		/* Product Stats Section */
		.product-stats {
			width: 100%;
			display: none;
			gap: 20px;
			padding-top: 15px;
			margin-top: 15px;
			border-top: 1px dashed #e0e0e0;
		}

		.product-stats.visible {
			display: flex;
		}

		.stat-box {
			flex: 1;
			background: #fff;
			border-radius: 8px;
			padding: 10px 12px;
			border: 1px solid #e8ecf1;
		}

		.stat-box-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 4px;
		}

		.stat-box-title {
			font-size: 11px;
			font-weight: 600;
			color: #666;
			text-transform: uppercase;
			letter-spacing: 0.3px;
		}

		.stat-box-value {
			font-size: 15px;
			font-weight: 700;
			color: #1a1a2e;
		}

		.stat-progress {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-top: 4px;
		}

		.stat-progress-percent {
			font-size: 11px;
			font-weight: 600;
			white-space: nowrap;
		}

		.stat-progress-percent.low {
			color: #e53935;
		}

		.stat-progress-percent.medium {
			color: #ff9800;
		}

		.stat-progress-percent.good {
			color: #4caf50;
		}

		.stat-progress-bar {
			flex: 1;
			height: 5px;
			background: #e8ecf1;
			border-radius: 3px;
			overflow: hidden;
		}

		.stat-progress-bar-fill {
			height: 100%;
			border-radius: 3px;
			transition: width 0.3s ease;
		}

		.stat-progress-bar-fill.low {
			background: linear-gradient(90deg, #e53935 0%, #ef5350 100%);
		}

		.stat-progress-bar-fill.medium {
			background: linear-gradient(90deg, #ff9800 0%, #ffb74d 100%);
		}

		.stat-progress-bar-fill.good {
			background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%);
		}

		@media (max-width: 768px) {
			.product-stats {
				flex-direction: column;
				gap: 12px;
			}
		}

		/* YENİ: Üst İstatistik Konteyner - GEÇEN AY | BU AY | AYLIK ORT. TÜKETİM */
		.product-stats-header {
			display: flex;
			gap: 12px;
			justify-content: flex-end;
			align-items: stretch;
			margin-bottom: 0;
		}

		.product-stats-header.visible {
			display: flex;
		}

		/* Kompakt Stat Kutuları (Geçen Ay & Bu Ay) */
		.stat-box-compact {
			min-width: 110px;
			max-width: 140px;
			background: #fff;
			border-radius: 8px;
			padding: 10px 12px;
			border: 1px solid #e8ecf1;
			box-shadow: 0 1px 3px rgba(0,0,0,0.04);
		}

		.stat-box-compact-title {
			font-size: 10px;
			font-weight: 700;
			color: #666;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-bottom: 4px;
		}

		.stat-box-compact-value {
			font-size: 13px;
			font-weight: 700;
			color: #1a1a2e;
			margin-bottom: 6px;
		}

		.stat-progress-compact {
			height: 4px;
			background: #e8ecf1;
			border-radius: 2px;
			overflow: hidden;
			margin-bottom: 4px;
		}

		.stat-progress-compact-fill {
			height: 100%;
			border-radius: 2px;
			transition: width 0.3s ease;
		}

		.stat-progress-compact-fill.low {
			background: linear-gradient(90deg, #e53935 0%, #ef5350 100%);
		}

		.stat-progress-compact-fill.medium {
			background: linear-gradient(90deg, #ff9800 0%, #ffb74d 100%);
		}

		.stat-progress-compact-fill.good {
			background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%);
		}

		.stat-percent-compact {
			font-size: 10px;
			font-weight: 700;
			text-align: right;
		}

		.stat-percent-compact.low { color: #e53935; }
		.stat-percent-compact.medium { color: #ff9800; }
		.stat-percent-compact.good { color: #4caf50; }

		/* Kompakt Tüketim Kutusu */
		.consumption-box-compact {
			min-width: 130px;
			max-width: 160px;
			padding: 10px 12px;
			background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
			border: 2px solid #1976d2;
			border-radius: 8px;
		}

		.consumption-box-compact-label {
			font-size: 10px;
			font-weight: 700;
			color: #1976d2;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-bottom: 6px;
		}

		.consumption-box-compact-input {
			position: relative;
		}

		.consumption-box-compact-input input {
			width: 100%;
			padding: 6px 32px 6px 8px;
			border: 1px solid #90caf9;
			border-radius: 6px;
			font-size: 14px;
			font-weight: 600;
			text-align: center;
			background: #fff;
		}

		.consumption-box-compact-input input:focus {
			outline: none;
			border-color: #1976d2;
			box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
		}

		.consumption-box-compact-input span {
			position: absolute;
			right: 8px;
			top: 50%;
			transform: translateY(-50%);
			font-size: 11px;
			color: #666;
			font-weight: 500;
		}

		/* Error state for consumption box */
		.consumption-box-compact.error {
			background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
			border-color: #e53935;
		}

		.consumption-box-compact.error .consumption-box-compact-label {
			color: #e53935;
		}

		.consumption-box-compact.error .consumption-box-compact-input input {
			border-color: #e53935;
		}

		/* Responsive: Tablet */
		@media (max-width: 1024px) {
			.product-stats-header {
				gap: 10px;
			}
			.stat-box-compact {
				min-width: 95px;
				max-width: 120px;
				padding: 9px 10px;
			}
			.consumption-box-compact {
				min-width: 115px;
				max-width: 140px;
			}
		}

		/* Responsive: Mobil */
		@media (max-width: 767px) {
			.product-stats-header {
				flex-wrap: wrap;
				justify-content: flex-end;
				gap: 10px;
			}
			.stat-box-compact {
				flex: 0 1 auto;
				min-width: 90px;
			}
			.consumption-box-compact {
				flex: 0 1 auto;
				min-width: 110px;
			}
		}

		/* Responsive: Küçük Mobil */
		@media (max-width: 575px) {
			.product-stats-header {
				flex-direction: column;
				align-items: flex-end;
				gap: 8px;
			}
			.stat-box-compact,
			.consumption-box-compact {
				min-width: 140px;
				max-width: 160px;
			}
		}

		/* ===== YENİ ÜRÜN EKLE SECTION ===== */
		.add-product-section {
			margin-top: 20px;
			padding: 20px;
			background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
			border: 2px dashed #002c77;
			border-radius: 12px;
			text-align: center;
		}

		.btn-add-product {
			display: inline-flex;
			align-items: center;
			gap: 10px;
			padding: 14px 28px;
			background: linear-gradient(135deg, #002c77 0%, #0056b3 100%);
			color: #fff;
			border: none;
			border-radius: 10px;
			font-size: 15px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.btn-add-product:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,44,119,0.3);
		}

		.btn-add-product svg {
			width: 20px;
			height: 20px;
		}

		/* ===== ÜRÜN SEÇİM MODALI ===== */
		.product-modal-overlay {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(0,0,0,0.6);
			z-index: 9999;
			align-items: center;
			justify-content: center;
		}

		.product-modal-overlay.active {
			display: flex;
		}

		.product-modal {
			background: #fff;
			width: 90%;
			max-width: 800px;
			max-height: 85vh;
			border-radius: 16px;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			box-shadow: 0 20px 60px rgba(0,0,0,0.3);
		}

		.product-modal-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 20px 24px;
			background: linear-gradient(135deg, #002c77 0%, #0056b3 100%);
			color: #fff;
		}

		.product-modal-header h3 {
			margin: 0;
			font-size: 18px;
			font-weight: 600;
		}

		.modal-close {
			width: 36px;
			height: 36px;
			background: rgba(255,255,255,0.2);
			border: none;
			border-radius: 50%;
			color: #fff;
			font-size: 24px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background 0.2s;
		}

		.modal-close:hover {
			background: rgba(255,255,255,0.3);
		}

		.product-modal-search {
			padding: 16px 24px;
			background: #f8f9fa;
			border-bottom: 1px solid #e9ecef;
		}

		.product-modal-search input {
			width: 100%;
			padding: 12px 16px;
			border: 1px solid #dee2e6;
			border-radius: 8px;
			font-size: 14px;
		}

		.product-modal-search input:focus {
			outline: none;
			border-color: #002c77;
			box-shadow: 0 0 0 3px rgba(0,44,119,0.1);
		}

		.product-modal-body {
			flex: 1;
			overflow-y: auto;
			padding: 20px;
		}

		.product-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 16px;
		}

		.product-grid-item {
			background: #fff;
			border: 1px solid #e9ecef;
			border-radius: 12px;
			padding: 16px;
			text-align: center;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.product-grid-item:hover {
			border-color: #002c77;
			box-shadow: 0 4px 12px rgba(0,44,119,0.15);
			transform: translateY(-2px);
		}

		.product-grid-item img {
			width: 60px;
			height: 75px;
			object-fit: contain;
			margin-bottom: 12px;
		}

		.product-grid-name {
			font-size: 13px;
			font-weight: 600;
			color: #333;
			margin-bottom: 4px;
		}

		.product-grid-code {
			font-size: 11px;
			color: #666;
			margin-bottom: 12px;
		}

		.btn-select-product {
			width: 100%;
			padding: 10px 16px;
			background: #002c77;
			color: #fff;
			border: none;
			border-radius: 8px;
			font-size: 13px;
			font-weight: 600;
			cursor: pointer;
			transition: background 0.2s;
		}

		.btn-select-product:hover {
			background: #0056b3;
		}

		.product-grid-empty {
			grid-column: 1 / -1;
			text-align: center;
			padding: 40px;
			color: #666;
		}

		/* Yeni eklenen satır highlight */
		@keyframes slideInHighlight {
			0% {
				opacity: 0;
				transform: translateY(-20px);
			}
			100% {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.product-row.newly-added {
			animation: slideInHighlight 0.5s ease;
			background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%) !important;
			border: 2px solid #ffc107 !important;
			box-shadow: 0 4px 20px rgba(255, 193, 7, 0.3);
		}

		/* Modal Responsive */
		@media (max-width: 768px) {
			.product-modal {
				width: 100%;
				max-width: 100%;
				max-height: 100vh;
				border-radius: 0;
			}

			.product-grid {
				grid-template-columns: repeat(2, 1fr);
				gap: 12px;
			}
		}

		@media (max-width: 480px) {
			.product-grid {
				grid-template-columns: 1fr;
			}
		}

		.product-image {
			width: 60px;
			height: 75px;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
		}

		.product-image img {
			max-width: 100%;
			max-height: 100%;
			object-fit: contain;
		}

		.product-info {
			flex: 1;
			min-width: 120px;
		}

		.product-name {
			font-size: 14px;
			font-weight: 600;
			color: #333;
			margin-bottom: 4px;
		}

		.product-code {
			font-size: 11px;
			color: #888;
		}

		.product-inputs {
			display: flex;
			gap: 15px;
			flex: 2;
		}

		.input-group {
			flex: 1;
			min-width: 100px;
		}

		.input-group label {
			display: block;
			font-size: 11px;
			font-weight: 500;
			color: #666;
			margin-bottom: 6px;
		}

		.input-group input {
			width: 100%;
			padding: 12px 14px;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			font-size: 14px;
			text-align: right;
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		.input-group input:focus {
			outline: none;
			border-color: #002c77;
			box-shadow: 0 0 0 3px rgba(0,44,119,0.1);
		}

		.input-group .input-suffix {
			position: relative;
		}

		.input-group .input-suffix input {
			padding-right: 45px;
		}

		.input-group .input-suffix span {
			position: absolute;
			right: 14px;
			top: 50%;
			transform: translateY(-50%);
			font-size: 12px;
			color: #888;
		}

		/* Pricing Type Selection */
		.pricing-section {
			width: 100%;
			margin-top: 15px;
			padding-top: 15px;
			border-top: 1px dashed #e0e0e0;
		}

		.base-price-display {
			display: flex;
			align-items: center;
			gap: 8px;
			margin-bottom: 12px;
			font-size: 13px;
			color: #666;
		}

		.base-price-display strong {
			color: #002c77;
			font-weight: 600;
		}

		.pricing-options {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}

		.pricing-option {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 12px 14px;
			background: #f8f9fa;
			border-radius: 10px;
			border: 2px solid transparent;
			cursor: pointer;
			transition: all 0.2s;
		}

		.pricing-option:hover {
			background: #f0f4f8;
		}

		.pricing-option.selected {
			background: #e3f2fd;
			border-color: #002c77;
		}

		.pricing-option.error {
			background: #fff5f5;
			border-color: #e53935;
		}

		.pricing-option input[type="radio"] {
			display: none;
		}

		.pricing-radio {
			width: 20px;
			height: 20px;
			border: 2px solid #ccc;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
			transition: all 0.2s;
		}

		.pricing-option.selected .pricing-radio {
			border-color: #002c77;
		}

		.pricing-radio-inner {
			width: 10px;
			height: 10px;
			background: #002c77;
			border-radius: 50%;
			transform: scale(0);
			transition: transform 0.2s;
		}

		.pricing-option.selected .pricing-radio-inner {
			transform: scale(1);
		}

		.pricing-label {
			flex: 1;
			font-size: 13px;
			font-weight: 500;
			color: #333;
			min-width: 140px;
		}

		.pricing-input-wrapper {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.pricing-input-wrapper input {
			width: 80px;
			padding: 8px 10px;
			border: 1px solid #e0e0e0;
			border-radius: 6px;
			font-size: 13px;
			text-align: right;
			transition: all 0.2s;
		}

		.pricing-input-wrapper input:focus {
			outline: none;
			border-color: #002c77;
			box-shadow: 0 0 0 2px rgba(0,44,119,0.1);
		}

		.pricing-input-wrapper input:disabled {
			background: #f5f5f5;
			color: #999;
			cursor: not-allowed;
		}

		.pricing-input-wrapper .input-unit {
			font-size: 12px;
			color: #666;
			min-width: 20px;
		}

		.pricing-input-wrapper .retail-price-display {
			font-size: 14px;
			font-weight: 600;
			color: #002c77;
			padding: 8px 12px;
			background: #e3f2fd;
			border-radius: 6px;
		}

		.final-price-display {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 8px;
			margin-top: 12px;
			padding: 12px 14px;
			background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
			border-radius: 10px;
		}

		.final-price-label {
			font-size: 13px;
			color: #2e7d32;
			font-weight: 500;
		}

		.final-price-value {
			font-size: 18px;
			font-weight: 700;
			color: #1b5e20;
		}

		/* Aylik Ortalama Tuketim input wrapper */
		.consumption-input-wrapper {
			display: flex;
			flex-direction: column;
			gap: 6px;
			min-width: 120px;
			background: #e3f2fd;
			padding: 12px 14px;
			border-radius: 10px;
			border: 2px solid #002c77;
		}

		.consumption-input-wrapper label {
			font-size: 11px;
			font-weight: 600;
			color: #002c77;
			text-transform: uppercase;
			letter-spacing: 0.3px;
		}

		.consumption-input-wrapper .input-suffix {
			position: relative;
		}

		.consumption-input-wrapper .input-suffix input {
			width: 100%;
			padding: 10px 40px 10px 12px;
			border: 1px solid #90caf9;
			border-radius: 6px;
			font-size: 15px;
			font-weight: 600;
			text-align: center;
			background: #fff;
		}

		.consumption-input-wrapper .input-suffix input:focus {
			outline: none;
			border-color: #002c77;
			box-shadow: 0 0 0 2px rgba(0,44,119,0.2);
		}

		.consumption-input-wrapper.error {
			background: #ffebee;
			border-color: #e53935;
		}

		.consumption-input-wrapper.error label {
			color: #e53935;
		}

		.consumption-input-wrapper.error .input-suffix input {
			border-color: #e53935;
		}

		.consumption-input-wrapper .input-suffix span {
			position: absolute;
			right: 10px;
			top: 50%;
			transform: translateY(-50%);
			font-size: 12px;
			color: #666;
		}

		@media (max-width: 768px) {
			.consumption-input-wrapper {
				width: 100%;
				order: 2;
			}

			.pricing-option {
				flex-wrap: wrap;
				gap: 8px;
			}

			.pricing-label {
				width: 100%;
				order: 1;
				margin-left: 32px;
			}

			.pricing-radio {
				order: 0;
			}

			.pricing-input-wrapper {
				order: 2;
				width: 100%;
				margin-left: 32px;
			}
		}

		/* Save Options - Custom Checkbox Design */
		.save-options {
			margin: 20px 0;
			padding: 16px;
			background: #f8fafc;
			border-radius: 8px;
			border: 1px solid #e2e8f0;
		}

		.checkbox-option {
			position: relative;
			display: flex;
			align-items: center;
			gap: 12px;
			cursor: pointer;
			padding: 8px 0;
			transition: all 0.2s ease;
		}

		.checkbox-option:hover .custom-checkbox {
			border-color: #f97316;
		}

		/* Native checkbox gizle ama erişilebilirlik koru */
		.checkbox-option input[type="checkbox"] {
			position: absolute !important;
			opacity: 0 !important;
			cursor: pointer;
			width: 20px !important;
			height: 20px !important;
			left: 0 !important;
			margin: 0 !important;
			z-index: 1;
		}

		/* Custom checkbox görünümü */
		.custom-checkbox {
			position: relative;
			width: 20px;
			height: 20px;
			min-width: 20px;
			border: 2px solid #cbd5e1;
			border-radius: 4px;
			background: #ffffff;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		/* Checkmark ikonu */
		.custom-checkbox::after {
			content: '';
			position: absolute;
			width: 5px;
			height: 10px;
			border: solid #ffffff;
			border-width: 0 2px 2px 0;
			transform: rotate(45deg) scale(0);
			transition: transform 0.15s ease;
		}

		/* Checked durumu */
		.checkbox-option input[type="checkbox"]:checked + .custom-checkbox {
			background: #f97316;
			border-color: #f97316;
		}

		.checkbox-option input[type="checkbox"]:checked + .custom-checkbox::after {
			transform: rotate(45deg) scale(1);
		}

		/* Focus durumu */
		.checkbox-option input[type="checkbox"]:focus + .custom-checkbox {
			outline: 2px solid #f97316;
			outline-offset: 2px;
		}

		/* Label text */
		.checkbox-label {
			font-size: 14px;
			color: #374151;
			user-select: none;
		}

		/* İkinci seçenek slide animasyonu */
		.checkbox-option.slide-option {
			max-height: 0;
			opacity: 0;
			overflow: hidden;
			padding: 0;
			transition: all 0.25s ease;
		}

		.checkbox-option.slide-option.show {
			max-height: 50px;
			opacity: 1;
			padding: 8px 0;
		}

		/* Form Actions */
		.form-actions {
			display: flex;
			gap: 15px;
			justify-content: flex-end;
			margin-top: 25px;
		}

		.btn {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 14px 28px;
			border-radius: 10px;
			font-size: 14px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
			text-decoration: none;
		}

		.btn-secondary {
			background: #f5f7fa;
			border: 1px solid #e0e0e0;
			color: #666;
		}

		.btn-secondary:hover {
			background: #e8ecf1;
			border-color: #ccc;
		}

		.btn-primary {
			background: linear-gradient(135deg, #002c77 0%, #0056b3 100%);
			border: none;
			color: #fff;
		}

		.btn-primary:hover {
			background: linear-gradient(135deg, #001a4d 0%, #003d80 100%);
			transform: translateY(-2px);
			box-shadow: 0 4px 15px rgba(0,44,119,0.3);
			color: #fff;
		}

		.btn-primary:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
			box-shadow: none;
		}

		.btn svg {
			width: 18px;
			height: 18px;
		}

		/* Delete Customer Button */
		.btn-danger {
			background: #fff;
			border: 1px solid #ffcdd2;
			color: #e53935;
		}

		.btn-danger:hover {
			background: #ffebee;
			border-color: #e53935;
		}

		/* Warning Button */
		.btn-warning {
			background: #fff;
			border: 1px solid #ffe0b2;
			color: #f57c00;
		}

		.btn-warning:hover {
			background: #fff3e0;
			border-color: #ff9800;
		}

		/* Input Error Styles */
		.input-group.error input {
			border-color: #e53935 !important;
			background: #fff5f5 !important;
		}

		.input-group .error-message {
			color: #e53935;
			font-size: 11px;
			margin-top: 4px;
			display: none;
		}

		.input-group.error .error-message {
			display: block;
		}

		/* Modal Message Styles */
		.modal-message {
			text-align: center;
			margin-bottom: 25px;
		}

		.modal-message p {
			color: #666;
			font-size: 14px;
			line-height: 1.6;
			margin-bottom: 12px;
		}

		.modal-message p:last-child {
			margin-bottom: 0;
		}

		/* Passive Status Banner */
		.passive-status-banner {
			display: none;
			align-items: center;
			gap: 10px;
			padding: 14px 18px;
			background: #ffebee;
			border: 2px solid #e53935;
			border-radius: 12px;
			margin-bottom: 20px;
		}

		.passive-status-banner.visible {
			display: flex;
		}

		.passive-status-banner svg {
			width: 24px;
			height: 24px;
			color: #e53935;
			flex-shrink: 0;
		}

		.passive-status-banner span {
			font-size: 14px;
			font-weight: 600;
			color: #c62828;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		/* Cancelled Status Banner */
		.cancelled-status-banner {
			display: none;
			align-items: center;
			gap: 10px;
			padding: 14px 18px;
			background: #fafafa;
			border: 2px solid #9e9e9e;
			border-radius: 12px;
			margin-bottom: 20px;
		}

		.cancelled-status-banner.visible {
			display: flex;
		}

		.cancelled-status-banner svg {
			width: 24px;
			height: 24px;
			color: #757575;
			flex-shrink: 0;
		}

		.cancelled-status-banner span {
			font-size: 14px;
			font-weight: 600;
			color: #616161;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		/* Success Button */
		.btn-success {
			background: #fff;
			border: 1px solid #c8e6c9;
			color: #43a047;
		}

		.btn-success:hover {
			background: #e8f5e9;
			border-color: #4caf50;
		}

		/* Modal */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0,0,0,0.5);
			z-index: 1000;
			display: flex;
			align-items: center;
			justify-content: center;
			opacity: 0;
			visibility: hidden;
			transition: all 0.3s;
		}

		.modal-overlay.active {
			opacity: 1;
			visibility: visible;
		}

		.modal {
			background: #fff;
			border-radius: 20px;
			padding: 30px;
			max-width: 450px;
			width: 90%;
			transform: translateY(20px);
			transition: transform 0.3s;
		}

		.modal-overlay.active .modal {
			transform: translateY(0);
		}

		.modal-icon {
			width: 60px;
			height: 60px;
			border-radius: 50%;
			background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
			display: flex;
			align-items: center;
			justify-content: center;
			margin: 0 auto 20px;
		}

		.modal-icon svg {
			width: 30px;
			height: 30px;
			color: #4caf50;
		}

		.modal-icon.warning {
			background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
		}

		.modal-icon.warning svg {
			color: #ff9800;
		}

		.modal h3 {
			text-align: center;
			font-size: 20px;
			color: #1a1a2e;
			margin-bottom: 10px;
		}

		.modal p {
			text-align: center;
			color: #666;
			font-size: 14px;
			line-height: 1.6;
			margin-bottom: 25px;
		}

		.modal-actions {
			display: flex;
			gap: 12px;
			justify-content: center;
		}

		.modal-actions .btn {
			min-width: 120px;
			justify-content: center;
		}

		/* Success Message */
		.success-message {
			position: fixed;
			top: 100px;
			left: 50%;
			transform: translateX(-50%) translateY(-20px);
			background: #4caf50;
			color: #fff;
			padding: 16px 30px;
			border-radius: 12px;
			font-size: 14px;
			font-weight: 500;
			box-shadow: 0 4px 20px rgba(76,175,80,0.4);
			display: flex;
			align-items: center;
			gap: 10px;
			opacity: 0;
			visibility: hidden;
			transition: all 0.3s;
			z-index: 1001;
		}

		.success-message.active {
			opacity: 1;
			visibility: visible;
			transform: translateX(-50%) translateY(0);
		}

		.success-message svg {
			width: 20px;
			height: 20px;
		}

		/* Mobile Sidebar */
		.mobile-sidebar {
			position: fixed;
			top: 0;
			right: -300px;
			width: 300px;
			height: 100vh;
			background: #fff;
			z-index: 1001;
			transition: right 0.3s ease;
			display: flex;
			flex-direction: column;
			box-shadow: -5px 0 25px rgba(0,0,0,0.15);
		}

		.mobile-sidebar.active {
			right: 0;
		}

		.mobile-sidebar-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 20px;
			border-bottom: 1px solid #eee;
		}

		.mobile-sidebar-header .logo {
			height: 35px;
		}

		.mobile-sidebar-close {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			background: #f5f5f5;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: background 0.2s;
		}

		.mobile-sidebar-close:hover {
			background: #eee;
		}

		.mobile-sidebar-close svg {
			width: 20px;
			height: 20px;
			color: #666;
		}

		.mobile-sidebar-menu {
			flex: 1;
			overflow-y: auto;
			padding: 15px 0;
		}

		.mobile-sidebar-menu ul {
			list-style: none;
		}

		.mobile-sidebar-menu li a {
			display: flex;
			align-items: center;
			gap: 15px;
			padding: 14px 20px;
			text-decoration: none;
			color: #333;
			font-size: 15px;
			transition: all 0.2s;
		}

		.mobile-sidebar-menu li a:hover,
		.mobile-sidebar-menu li.active a {
			background: #f8f9fa;
			color: #002c77;
		}

		.mobile-sidebar-menu li.active a {
			border-right: 3px solid #002c77;
			font-weight: 600;
		}

		.mobile-sidebar-menu .menu-icon {
			width: 22px;
			height: 22px;
			color: #666;
		}

		.mobile-sidebar-menu li.active .menu-icon,
		.mobile-sidebar-menu li a:hover .menu-icon {
			color: #002c77;
		}

		.mobile-sidebar-menu .menu-divider {
			height: 1px;
			background: #eee;
			margin: 10px 20px;
		}

		.mobile-sidebar-footer {
			border-top: 1px solid #eee;
			padding: 15px 20px;
		}

		.mobile-sidebar-footer-top {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 15px;
		}

		.mobile-sidebar-footer .date-info {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 13px;
			color: #666;
		}

		.mobile-sidebar-footer .date-info svg {
			width: 18px;
			height: 18px;
			color: #999;
		}

		.mobile-sidebar-footer .footer-icons {
			display: flex;
			gap: 10px;
		}

		.mobile-sidebar-footer .footer-icons a {
			position: relative;
			width: 36px;
			height: 36px;
			border-radius: 8px;
			background: #f5f5f5;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.mobile-sidebar-footer .footer-icons img {
			width: 18px;
			height: 18px;
		}

		.mobile-sidebar-footer .cart-badge {
			position: absolute;
			top: -4px;
			right: -4px;
			background: #e53935;
			color: #fff;
			font-size: 10px;
			min-width: 16px;
			height: 16px;
			border-radius: 8px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.mobile-sidebar-footer .logout-btn {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			width: 100%;
			padding: 12px;
			background: #f5f5f5;
			border: none;
			border-radius: 10px;
			color: #666;
			font-size: 14px;
			text-decoration: none;
			transition: all 0.2s;
		}

		.mobile-sidebar-footer .logout-btn:hover {
			background: #fee;
			color: #e53935;
		}

		.mobile-sidebar-footer .logout-btn svg {
			width: 18px;
			height: 18px;
		}

		.menu-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0,0,0,0.5);
			z-index: 1000;
			opacity: 0;
			visibility: hidden;
			transition: all 0.3s;
		}

		.menu-overlay.active {
			opacity: 1;
			visibility: visible;
		}

		/* Existing Customer Notice */
		.existing-customer-notice {
			display: none;
			align-items: center;
			gap: 12px;
			padding: 14px 18px;
			background: #fff3e0;
			border: 1px solid #ffe0b2;
			border-radius: 10px;
			margin-bottom: 20px;
		}

		.existing-customer-notice.visible {
			display: flex;
		}

		.existing-customer-notice svg {
			width: 22px;
			height: 22px;
			color: #ff9800;
			flex-shrink: 0;
		}

		.existing-customer-notice span {
			font-size: 13px;
			color: #e65100;
		}

		/* Offer Metadata - Minimal Timeline */
		.offer-metadata {
			margin-top: 40px;
			padding-top: 20px;
			border-top: 1px solid #e5e7eb;
		}

		.offer-metadata summary {
			display: flex;
			align-items: center;
			gap: 6px;
			padding: 8px 0;
			cursor: pointer;
			color: #9ca3af;
			font-size: 11px;
			font-weight: 500;
			letter-spacing: 0.02em;
			list-style: none;
			transition: color 0.2s;
		}

		.offer-metadata summary::-webkit-details-marker {
			display: none;
		}

		.offer-metadata summary:hover {
			color: #6b7280;
		}

		.offer-metadata summary svg {
			width: 12px;
			height: 12px;
			transition: transform 0.2s;
			opacity: 0.6;
		}

		.offer-metadata[open] summary svg {
			transform: rotate(180deg);
		}

		.metadata-timeline {
			margin-top: 12px;
			padding: 0;
			max-height: 300px;
			overflow-y: auto;
			animation: metadataSlide 0.2s ease-out;
		}

		@keyframes metadataSlide {
			from { opacity: 0; transform: translateY(-6px); }
			to { opacity: 1; transform: translateY(0); }
		}

		.timeline-item {
			display: flex;
			gap: 12px;
			padding: 10px 0;
			border-bottom: 1px solid #f0f0f0;
			font-size: 12px;
		}

		.timeline-item:last-child {
			border-bottom: none;
		}

		.timeline-dot {
			width: 8px;
			height: 8px;
			background: #9ca3af;
			border-radius: 50%;
			margin-top: 4px;
			flex-shrink: 0;
		}

		.timeline-dot.created { background: #22c55e; }
		.timeline-dot.requested { background: #3b82f6; }
		.timeline-dot.price_updated { background: #f59e0b; }
		.timeline-dot.accepted { background: #10b981; }
		.timeline-dot.rejected { background: #ef4444; }
		.timeline-dot.cancelled { background: #6b7280; }
		.timeline-dot.passived { background: #8b5cf6; }
		.timeline-dot.activated { background: #06b6d4; }

		.timeline-content {
			flex: 1;
		}

		.timeline-action {
			font-weight: 500;
			color: #374151;
		}

		.timeline-actor {
			color: #6b7280;
			font-size: 11px;
		}

		.timeline-time {
			color: #9ca3af;
			font-size: 10px;
		}

		.timeline-empty {
			color: #9ca3af;
			font-size: 12px;
			padding: 12px;
			text-align: center;
		}

		@media (max-width: 640px) {
			.metadata-list {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		/* Responsive */
		@media (max-width: 1024px) {
			.header__nav nav {
				display: none;
			}

			.header__mobile {
				display: flex;
			}
		}

		@media (max-width: 768px) {
			.header__user-panel .desktop-panel {
				display: none;
			}

			.page-header-text h1 {
				font-size: 20px;
			}

			.vkn-search-row {
				flex-direction: column;
			}

			.vkn-search-btn {
				align-items: stretch;
			}

			.vkn-search-btn button {
				width: 100%;
				justify-content: center;
			}

			.product-row {
				flex-wrap: wrap;
				gap: 12px;
			}

			.product-image {
				width: 50px;
				height: 60px;
			}

			.product-info {
				flex: 1;
				min-width: calc(100% - 110px);
			}

			.product-inputs {
				width: 100%;
				order: 3;
			}

			.product-remove {
				order: 2;
			}

			.form-actions {
				flex-direction: column;
			}

			.form-actions .btn {
				width: 100%;
				justify-content: center;
			}

			.modal-actions {
				flex-direction: column;
			}

			.modal-actions .btn {
				width: 100%;
			}
		}

		@media (max-width: 480px) {
			.main-content {
				padding: 20px 15px;
			}

			.form-section {
				padding: 20px 15px;
			}

			.product-inputs {
				flex-direction: column;
				gap: 10px;
			}

			.input-group {
				min-width: 100%;
			}
		}

		/* Two Column Layout with Chat */
		.content-with-chat {
			display: grid;
			grid-template-columns: 1fr 380px;
			gap: 30px;
			max-width: 1600px;
		}

		.main-column {
			min-width: 0;
		}

		/* Chat Column */
		.chat-column {
			position: sticky;
			top: 90px;
			height: calc(100vh - 120px);
			background: #fff;
			border-radius: 16px;
			box-shadow: 0 2px 12px rgba(0,0,0,0.08);
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		.chat-header {
			padding: 16px 20px;
			border-bottom: 1px solid #eee;
			display: flex;
			align-items: center;
			justify-content: space-between;
			background: #fafafa;
		}

		.chat-header h3 {
			font-size: 16px;
			font-weight: 600;
			margin: 0;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.chat-header h3 svg {
			width: 20px;
			height: 20px;
			color: #002c77;
		}

		.chat-badge {
			background: #e31e24;
			color: #fff;
			font-size: 12px;
			padding: 2px 8px;
			border-radius: 10px;
			font-weight: 600;
		}

		/* Chat Messages Area */
		.chat-messages {
			flex: 1;
			overflow-y: auto;
			padding: 20px;
			display: flex;
			flex-direction: column;
			gap: 12px;
			background: #f9fafb;
		}

		.chat-messages::-webkit-scrollbar {
			width: 6px;
		}

		.chat-messages::-webkit-scrollbar-track {
			background: transparent;
		}

		.chat-messages::-webkit-scrollbar-thumb {
			background: #ddd;
			border-radius: 3px;
		}

		/* Message Bubble */
		.message-bubble {
			max-width: 85%;
			padding: 12px 16px;
			border-radius: 16px;
			position: relative;
			animation: chatFadeInUp 0.3s ease;
		}

		@keyframes chatFadeInUp {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.message-bubble.dealer {
			align-self: flex-end;
			background: linear-gradient(135deg, #002c77 0%, #003d99 100%);
			color: #fff;
			border-bottom-right-radius: 4px;
		}

		.message-bubble.customer {
			align-self: flex-start;
			background: #fff;
			border: 1px solid #e5e7eb;
			border-bottom-left-radius: 4px;
		}

		.message-sender {
			font-size: 11px;
			font-weight: 600;
			margin-bottom: 4px;
		}

		.message-bubble.dealer .message-sender {
			color: rgba(255,255,255,0.8);
		}

		.message-bubble.customer .message-sender {
			color: #002c77;
		}

		.message-text {
			font-size: 14px;
			line-height: 1.5;
			word-break: break-word;
		}

		.message-time {
			font-size: 11px;
			margin-top: 6px;
		}

		.message-bubble.dealer .message-time {
			color: rgba(255,255,255,0.7);
		}

		.message-bubble.customer .message-time {
			color: #999;
		}

		/* Date Separator */
		.date-separator {
			display: flex;
			align-items: center;
			margin: 20px 0;
			gap: 12px;
		}

		.date-separator::before,
		.date-separator::after {
			content: '';
			flex: 1;
			height: 1px;
			background: #e5e7eb;
		}

		.date-separator span {
			font-size: 12px;
			color: #6b7280;
			font-weight: 500;
			white-space: nowrap;
		}

		/* No Messages State */
		.no-messages {
			text-align: center;
			padding: 40px 20px;
			color: #999;
		}

		.no-messages svg {
			width: 48px;
			height: 48px;
			color: #ddd;
			margin-bottom: 12px;
		}

		.no-messages p {
			font-size: 14px;
		}

		/* Chat Input Area */
		.chat-input-wrapper {
			padding: 16px;
			border-top: 1px solid #eee;
			display: flex;
			gap: 10px;
			background: #fff;
		}

		.chat-input-wrapper textarea {
			flex: 1;
			padding: 12px 14px;
			border: 1px solid #ddd;
			border-radius: 12px;
			resize: none;
			font-size: 14px;
			font-family: inherit;
			max-height: 100px;
			min-height: 44px;
			transition: border-color 0.2s;
		}

		.chat-input-wrapper textarea:focus {
			outline: none;
			border-color: #002c77;
		}

		.chat-input-wrapper textarea::placeholder {
			color: #999;
		}

		.btn-send-message {
			padding: 12px 18px;
			background: linear-gradient(135deg, #002c77 0%, #003d99 100%);
			color: #fff;
			border: none;
			border-radius: 12px;
			cursor: pointer;
			font-weight: 600;
			font-family: inherit;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
		}

		.btn-send-message:hover {
			background: linear-gradient(135deg, #003d99 0%, #0050cc 100%);
			transform: translateY(-1px);
		}

		.btn-send-message:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		.btn-send-message svg {
			width: 20px;
			height: 20px;
		}

		/* Chat Disabled State */
		.chat-disabled {
			padding: 20px;
			text-align: center;
			color: #999;
			font-size: 13px;
			background: #f9fafb;
			flex: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.chat-disabled svg {
			width: 40px;
			height: 40px;
			color: #ddd;
			margin-bottom: 12px;
		}

		/* Mobile Chat Toggle */
		.chat-toggle-mobile {
			display: none;
			position: fixed;
			bottom: 20px;
			right: 20px;
			padding: 14px 24px;
			background: linear-gradient(135deg, #002c77 0%, #003d99 100%);
			color: #fff;
			border: none;
			border-radius: 30px;
			font-size: 14px;
			font-weight: 600;
			box-shadow: 0 4px 15px rgba(0,44,119,0.3);
			z-index: 100;
			cursor: pointer;
			font-family: inherit;
		}

		.chat-toggle-mobile .unread-badge {
			background: #e31e24;
			color: #fff;
			font-size: 12px;
			padding: 2px 8px;
			border-radius: 10px;
			margin-left: 8px;
		}

		/* Mobile Close Button */
		.chat-close-mobile {
			display: none;
			position: absolute;
			top: 12px;
			right: 12px;
			width: 32px;
			height: 32px;
			border: none;
			background: #f0f0f0;
			border-radius: 50%;
			cursor: pointer;
			align-items: center;
			justify-content: center;
		}

		.chat-close-mobile svg {
			width: 18px;
			height: 18px;
			color: #666;
		}

		/* Responsive - Chat Column */
		@media (max-width: 1200px) {
			.content-with-chat {
				grid-template-columns: 1fr;
			}

			.chat-column {
				display: none;
				position: fixed;
				inset: 0;
				top: 0;
				height: 100vh;
				border-radius: 0;
				z-index: 1000;
			}

			.chat-column.active {
				display: flex;
			}

			.chat-toggle-mobile {
				display: flex;
				align-items: center;
			}

			.chat-close-mobile {
				display: flex;
			}
		}
	</style>
</head>

<body>
	<!-- Header Component -->
	<div id="bayi-header"></div>

	<!-- Main Content -->
	<main class="main-content content-with-chat">
		<!-- Main Column -->
		<div class="main-column">
			<!-- Page Header -->
			<div class="page-header">
			<a href="bayi-musteri-listesi.html" class="back-btn">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
				</svg>
			</a>
			<div class="page-header-text">
				<h1 id="page-title">Yeni Müşteri Fiyat Tanımlama</h1>
				<p id="page-subtitle">Müşteri için özel fiyat ve taahhüt tanımlayın</p>
			</div>
		</div>

		<!-- Existing Customer Notice -->
		<div class="existing-customer-notice" id="existing-notice">
			<svg viewBox="0 0 24 24" fill="currentColor">
				<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
			</svg>
			<span id="existing-notice-text">Bu müşteriniz için henüz fiyat tanımlamadınız.</span>
		</div>

		<!-- Passive Status Banner -->
		<div class="passive-status-banner" id="passive-status-banner">
			<svg viewBox="0 0 24 24" fill="currentColor">
				<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8 0-1.85.63-3.55 1.69-4.9L16.9 18.31C15.55 19.37 13.85 20 12 20zm6.31-3.1L7.1 5.69C8.45 4.63 10.15 4 12 4c4.42 0 8 3.58 8 8 0 1.85-.63 3.55-1.69 4.9z"/>
			</svg>
			<span>MÜŞTERİ FİYATLARI PASİF DURUMDA</span>
		</div>

		<!-- Cancelled Status Banner -->
		<div class="cancelled-status-banner" id="cancelled-status-banner">
			<svg viewBox="0 0 24 24" fill="currentColor">
				<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
			</svg>
			<span>BU TEKLİF İPTAL EDİLMİŞTİR</span>
		</div>

		<!-- VKN Search Section -->
		<div class="form-section">
			<div class="section-title">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
				</svg>
				Müşteri Bilgileri
			</div>

			<div class="vkn-search-row" id="vkn-search-section">
				<div class="vkn-input-wrapper">
					<label for="vkn-input">Vergi Kimlik Numarası (VKN)</label>
					<input type="text" id="vkn-input" placeholder="10 haneli VKN giriniz" maxlength="10">
				</div>
				<div class="vkn-search-btn">
					<button type="button" id="vkn-search-btn">
						<svg viewBox="0 0 24 24" fill="currentColor">
							<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
						</svg>
						Sorgula
					</button>
				</div>
			</div>

			<div class="customer-info-box" id="customer-info-box">
				<div class="info-label">Resmi Ünvan</div>
				<div class="info-value" id="customer-name"></div>
			</div>
		</div>

		<!-- Products Form Section -->
		<div class="form-section products-form" id="products-form">
			<div class="section-title">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
				</svg>
				Ürün Fiyatları ve Taahhütler
			</div>

			<div id="product-rows">
				<!-- Product rows will be added here dynamically -->
			</div>

			<!-- Yeni Ürün Ekle Bölümü -->
			<div class="add-product-section" id="addProductSection" style="display: none;">
				<button type="button" class="btn-add-product" id="btnAddProduct">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="12" cy="12" r="10"/>
						<line x1="12" y1="8" x2="12" y2="16"/>
						<line x1="8" y1="12" x2="16" y2="12"/>
					</svg>
					Yeni Ürün Ekle
				</button>
			</div>

		</div>

		<!-- Ürün Seçim Modalı -->
		<div class="product-modal-overlay" id="productModalOverlay">
			<div class="product-modal">
				<div class="product-modal-header">
					<h3>Ürün Seçin</h3>
					<button type="button" class="modal-close" id="productModalClose">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="18" y1="6" x2="6" y2="18"/>
							<line x1="6" y1="6" x2="18" y2="18"/>
						</svg>
					</button>
				</div>
				<div class="product-modal-search">
					<input type="text" id="productSearchInput" placeholder="Ürün adı veya kodu ile ara...">
				</div>
				<div class="product-modal-body">
					<div class="product-grid" id="productModalGrid">
						<!-- Ürünler JavaScript ile doldurulacak -->
					</div>
				</div>
			</div>
		</div>

		<!-- Teklif Kaydetme Seçenekleri -->
		<div class="save-options" id="save-options" style="display: none;">
			<label class="checkbox-option" for="save-as-accepted">
				<input type="checkbox" id="save-as-accepted">
				<span class="custom-checkbox"></span>
				<span class="checkbox-label">Teklifi "Kabul Edilmiş" olarak kaydet</span>
			</label>
			<label class="checkbox-option slide-option" id="notify-customer-option" for="notify-customer">
				<input type="checkbox" id="notify-customer">
				<span class="custom-checkbox"></span>
				<span class="checkbox-label">Müşteriye bildirim gönder</span>
			</label>
		</div>

		<!-- Form Actions -->
		<div class="form-actions" id="form-actions" style="display: none;">
			<button type="button" class="btn btn-warning" id="passive-customer-btn" style="display: none;">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8 0-1.85.63-3.55 1.69-4.9L16.9 18.31C15.55 19.37 13.85 20 12 20zm6.31-3.1L7.1 5.69C8.45 4.63 10.15 4 12 4c4.42 0 8 3.58 8 8 0 1.85-.63 3.55-1.69 4.9z"/>
				</svg>
				Pasife Çek
			</button>
			<button type="button" class="btn btn-success" id="activate-customer-btn" style="display: none;">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
				</svg>
				Aktif Et
			</button>
			<button type="button" class="btn btn-danger" id="cancel-offer-btn" style="display: none;">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
				</svg>
				Teklifi İptal Et
			</button>
			<a href="bayi-musteri-listesi.html" class="btn btn-secondary">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
				</svg>
				Vazgeç
			</a>
			<button type="button" class="btn btn-primary" id="save-btn">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
				</svg>
				Kaydet
			</button>
		</div>

		<!-- Teklif Gecmisi Timeline -->
		<details class="offer-metadata" id="offer-metadata" style="display: none;">
			<summary>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<polyline points="6 9 12 15 18 9"/>
				</svg>
				Teklif gecmisi
			</summary>
			<div class="metadata-timeline" id="metadata-timeline">
				<p class="timeline-empty">Yukleniyor...</p>
			</div>
		</details>
		</div>

		<!-- Chat Column -->
		<aside class="chat-column" id="chatColumn">
			<button class="chat-close-mobile" id="chatCloseMobile" onclick="closeChatMobile()">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<line x1="18" y1="6" x2="6" y2="18"/>
					<line x1="6" y1="6" x2="18" y2="18"/>
				</svg>
			</button>
			<div class="chat-header">
				<h3>
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
					</svg>
					Mesajlar
				</h3>
				<span class="chat-badge" id="chatBadge" style="display: none;">0</span>
			</div>
			<div class="chat-messages" id="chatMessages">
				<div class="no-messages" id="noMessages">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
					</svg>
					<p>Henuz mesaj yok</p>
				</div>
			</div>
			<div class="chat-input-wrapper" id="chatInputWrapper">
				<textarea id="messageInput" placeholder="Mesajinizi yazin..." rows="1" onkeydown="handleMessageKeydown(event)"></textarea>
				<button class="btn-send-message" id="btnSendMessage" onclick="sendMessage()">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="22" y1="2" x2="11" y2="13"/>
						<polygon points="22 2 15 22 11 13 2 9 22 2"/>
					</svg>
				</button>
			</div>
			<div class="chat-disabled" id="chatDisabled" style="display: none;">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="12" cy="12" r="10"/>
					<line x1="12" y1="8" x2="12" y2="12"/>
					<line x1="12" y1="16" x2="12.01" y2="16"/>
				</svg>
				<p>Musteri secimi yapildiginda mesajlasma aktif olacaktir</p>
			</div>
		</aside>
	</main>

	<!-- Mobile Chat Toggle -->
	<button class="chat-toggle-mobile" id="chatToggleMobile" onclick="openChatMobile()">
		Mesajlar
		<span class="unread-badge" id="unreadBadgeMobile" style="display: none;">0</span>
	</button>

	<!-- Confirm Save Modal -->
	<div class="modal-overlay" id="save-modal">
		<div class="modal">
			<div class="modal-icon">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
				</svg>
			</div>
			<h3>Fiyatları Kaydet</h3>
			<p>Bu müşteri için tanımlanan fiyatları kaydetmek istediğinize emin misiniz?</p>
			<div class="modal-actions">
				<button type="button" class="btn btn-secondary" id="modal-cancel">İptal</button>
				<button type="button" class="btn btn-primary" id="modal-confirm">Onayla</button>
			</div>
		</div>
	</div>

	<!-- Pasife Çek Modal -->
	<div class="modal-overlay" id="passive-modal">
		<div class="modal">
			<div class="modal-icon warning">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
				</svg>
			</div>
			<h3>Teklifi Pasife Çek</h3>
			<div class="modal-message">
				<p>Bu teklifi pasife çekmek üzeresiniz.</p>
				<p>Pasife çekerseniz müşteri bu teklifte belirlediğiniz fiyatlardan sipariş veremeyecektir.</p>
				<p>İstediğiniz zaman tekrar aktif edebilirsiniz.</p>
			</div>
			<div class="modal-actions">
				<button type="button" class="btn btn-secondary" id="passive-modal-cancel">İptal</button>
				<button type="button" class="btn btn-warning" id="passive-modal-confirm">Pasife Çek</button>
			</div>
		</div>
	</div>

	<!-- Aktif Et Modal -->
	<div class="modal-overlay" id="activate-modal">
		<div class="modal">
			<div class="modal-icon" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
				<svg viewBox="0 0 24 24" fill="currentColor" style="color: #4caf50;">
					<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
				</svg>
			</div>
			<h3>Teklifi Aktif Et</h3>
			<div class="modal-message">
				<p>Bu teklifi tekrar aktif etmek üzeresiniz.</p>
				<p>Aktif edildikten sonra müşteri bu fiyatlardan sipariş verebilecektir.</p>
			</div>
			<div class="modal-actions">
				<button type="button" class="btn btn-secondary" id="activate-modal-cancel">İptal</button>
				<button type="button" class="btn btn-success" id="activate-modal-confirm">Aktif Et</button>
			</div>
		</div>
	</div>

	<!-- Teklifi İptal Et Modal -->
	<div class="modal-overlay" id="cancel-offer-modal">
		<div class="modal">
			<div class="modal-icon warning">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
				</svg>
			</div>
			<h3>Teklifi İptal Et</h3>
			<div class="modal-message">
				<p>Bu teklifi iptal etmek üzeresiniz.</p>
				<p>İptal edildikten sonra müşteri bu teklifi göremeyecek ve bu fiyatlardan sipariş veremeyecektir.</p>
			</div>
			<div class="modal-actions">
				<button type="button" class="btn btn-secondary" id="cancel-offer-modal-cancel">Vazgeç</button>
				<button type="button" class="btn btn-danger" id="cancel-offer-modal-confirm">İptal Et</button>
			</div>
		</div>
	</div>

	<!-- Success Message -->
	<div class="success-message" id="success-message">
		<svg viewBox="0 0 24 24" fill="currentColor">
			<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
		</svg>
		<span>Fiyatlar başarıyla kaydedildi!</span>
	</div>

	<!-- Mobile Sidebar Component -->
	<div id="bayi-mobile-sidebar"></div>

	<script src="./İpragaz Bayi_files/jquery-3.6.0.min.js"></script>
	<!-- Supabase -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/products-service.js"></script>
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/offers-service.js"></script>
	<script src="./js/services/offer-logs-service.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/messages-service.js"></script>
	<script src="./js/services/notifications-service.js"></script>
	<script src="./js/component-loader.js"></script>
	<script>
		// Auth kontrol - giris yapilmamissa login'e yonlendir
		if (!bayiAuthCheck()) {
			throw new Error('Auth required');
		}

		$(document).ready(async function() {
			// Bayi componentlerini yukle
			ComponentLoader.loadBayiComponents();
			// Ürünler Supabase'den yüklenecek
			var products = [];
			var currentCustomer = null;
			var currentDealerId = null;
			var currentDealerName = null;
			var currentOffer = null; // Mevcut kabul edilmiş teklif
			var isEditMode = false;
			var currentVkn = '';
			var isLoading = false;
			var messageSubscription = null;
			var currentUserType = 'dealer';

			// Loading overlay
			function showLoading(text) {
				isLoading = true;
				if (!$('#loading-overlay').length) {
					$('body').append('<div id="loading-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;"><div style="text-align:center;"><div style="width:40px;height:40px;border:3px solid #e0e0e0;border-top-color:#002c77;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px;"></div><div style="color:#333;font-size:14px;">' + (text || 'Yükleniyor...') + '</div></div></div>');
					$('head').append('<style>@keyframes spin{to{transform:rotate(360deg)}}</style>');
				} else {
					$('#loading-overlay').find('div:last').text(text || 'Yükleniyor...');
					$('#loading-overlay').show();
				}
			}

			function hideLoading() {
				isLoading = false;
				$('#loading-overlay').hide();
			}

			// Error toast
			function showError(message) {
				if (!$('#error-toast').length) {
					$('body').append('<div id="error-toast" style="position:fixed;top:100px;left:50%;transform:translateX(-50%);background:#e53935;color:#fff;padding:16px 30px;border-radius:12px;font-size:14px;box-shadow:0 4px 20px rgba(229,57,53,0.4);z-index:1002;display:none;"><svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;display:inline-block;vertical-align:middle;margin-right:10px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg><span></span></div>');
				}
				$('#error-toast span').text(message);
				$('#error-toast').fadeIn(300);
				setTimeout(function() { $('#error-toast').fadeOut(300); }, 4000);
			}

			// Sayfa yüklendiğinde ürünleri ve bayi bilgisini al
			async function initPage() {
				showLoading('Ürünler yükleniyor...');
				try {
					// Ürünleri Supabase'den al
					const { data: productsData, error: productsError } = await ProductsService.getAll();
					if (productsError) throw new Error(productsError);

					products = productsData.map(p => ({
						id: p.id,
						code: p.code,
						name: p.name,
						image: p.image_url || './İpragaz Bayi_files/IPR-BAYI-12-kg-ipr-uzun.png',
						base_price: p.base_price
					}));

					// Session'dan bayi ID'sini ve ismini al
					currentDealerId = sessionStorage.getItem('bayi_dealer_id');
					currentDealerName = sessionStorage.getItem('bayi_dealer_name') || 'Bayi';
					if (!currentDealerId) {
						console.error('Bayi ID bulunamadi');
						hideLoading();
						showError('Bayi bilgisi bulunamadi. Lutfen tekrar giris yapin.');
						return;
					}

					hideLoading();

					// URL parametrelerini kontrol et
					var urlParams = new URLSearchParams(window.location.search);
					var offerIdParam = urlParams.get('offer_id');

					if (offerIdParam) {
						// Mevcut teklif düzenleme - VKN arama gizle
						$('#vkn-search-section').hide();
						await loadOfferById(offerIdParam);
					} else {
						// Yeni müşteri ekleme - VKN arama göster
						$('#vkn-search-section').show();
					}
				} catch (error) {
					hideLoading();
					showError('Sayfa yüklenirken hata oluştu: ' + error.message);
					console.error(error);
				}
			}

			// Sayfayı başlat
			initPage();

			// VKN search
			$('#vkn-search-btn').on('click', async function() {
				var vkn = $('#vkn-input').val().trim();
				if (vkn.length === 10) {
					await searchVkn(vkn);
				} else {
					$('#customer-info-box').addClass('visible error');
					$('#customer-name').text('Lütfen 10 haneli geçerli bir VKN giriniz.');
				}
			});

			$('#vkn-input').on('keypress', async function(e) {
				if (e.which === 13) {
					$('#vkn-search-btn').click();
				}
			});

			// Offer ID ile teklif yükleme
			async function loadOfferById(offerId) {
				showLoading('Teklif yükleniyor...');

				try {
					const { data: offer, error } = await OffersService.getById(offerId);

					if (error) {
						hideLoading();
						showError('Teklif yüklenirken hata oluştu');
						return;
					}

					if (!offer) {
						hideLoading();
						showError('Teklif bulunamadı');
						return;
					}

					// Bayi kontrolü - sadece kendi teklifini görebilir
					if (offer.dealer_id !== currentDealerId) {
						hideLoading();
						showError('Bu teklifi görüntüleme yetkiniz yok');
						return;
					}

					// Form değişkenlerini set et
					currentOffer = offer;
					currentCustomer = offer.customer;
					currentVkn = offer.customer.vkn;
					isEditMode = true;

					// Chat'i baslat
					initializeChat();

					// offer_details'ı customer_prices formatına dönüştür
					var customerPrices = offer.offer_details || [];

					$('#customer-info-box').removeClass('error').addClass('visible');
					$('#customer-name').text(offer.customer.name + (offer.customer.company_name ? ' - ' + offer.customer.company_name : ''));
					$('#page-title').text('Müşteri Fiyat Düzenleme');
					$('#page-subtitle').text('Mevcut müşteri fiyatlarını düzenleyin');

					// Fiyat tanımlanmış mı kontrolü
					var hasPrices = customerPrices.some(function(p) { return p.unit_price !== undefined; });

					if (!hasPrices) {
						$('#existing-notice').addClass('visible');
						$('#existing-notice-text').text('Bu müşteriniz için henüz fiyat tanımlamadınız.');
						$('#passive-status-banner').removeClass('visible');
						$('#passive-customer-btn').hide();
						$('#activate-customer-btn').hide();
						$('#cancel-offer-btn').hide();
					} else {
						$('#existing-notice').removeClass('visible');

						// Teklif durumuna gore buton kontrolu
						if (offer.status === 'passive') {
							$('#passive-status-banner').addClass('visible');
							$('#passive-customer-btn').hide();
							$('#activate-customer-btn').show();
							$('#cancel-offer-btn').show();
						} else if (offer.status === 'accepted') {
							$('#passive-status-banner').removeClass('visible');
							$('#passive-customer-btn').show();
							$('#activate-customer-btn').hide();
							$('#cancel-offer-btn').show();
						} else if (offer.status === 'cancelled' || offer.status === 'rejected') {
							// Cancelled/rejected teklif - banner göster, butonları gizle
							$('#passive-status-banner').removeClass('visible');
							$('#cancelled-status-banner').addClass('visible');
							$('#passive-customer-btn').hide();
							$('#activate-customer-btn').hide();
							$('#cancel-offer-btn').hide();
							// Form populate edilecek sonra disable edilecek
						} else {
							$('#passive-status-banner').removeClass('visible');
							$('#passive-customer-btn').hide();
							$('#activate-customer-btn').hide();
							$('#cancel-offer-btn').hide();
						}
					}

					// Ürün satırlarını temizle
					$('#product-rows').empty();

					// Teklif detayları varsa sadece onları göster
					if (customerPrices && customerPrices.length > 0) {
						customerPrices.forEach(function(detail) {
							var product = detail.product;
							if (product) {
								var fullProduct = products.find(function(p) { return p.id === product.id; }) || product;
								addProductRow(
									{ id: product.id, code: product.code, name: product.name, base_price: product.base_price, image: fullProduct.image || product.image_url },
									detail.commitment_quantity || '',
									detail.unit_price || '',
									detail.this_month_quantity,
									detail.last_month_quantity,
									detail.pricing_type || 'retail_price',
									detail.discount_value || 0
								);
							}
						});
					} else {
						// Teklif yoksa tüm ürünleri göster
						products.forEach(function(product) {
							addProductRow(product, '', '', undefined, undefined, 'retail_price', 0);
						});
					}

					$('#products-form').addClass('visible');
					$('#form-actions').show();

					// Save options - mevcut teklif var, gizle
					$('#save-options').hide();

					// Teklif gecmisini yukle
					loadOfferLogs(offer.id);

					// Teklif varsa "Yeni Ürün Ekle" butonunu göster
					if (customerPrices && customerPrices.length > 0) {
						$('#addProductSection').show();
					} else {
						$('#addProductSection').hide();
					}

					hideLoading();

					// Cancelled/rejected teklifler icin duzenlemeyi engelle (form doldurulduktan sonra)
					if (offer.status === 'cancelled' || offer.status === 'rejected') {
						disableEditingForCancelledOffer();
					}
				} catch (error) {
					hideLoading();
					showError('Teklif yüklenirken hata: ' + error.message);
					console.error(error);
				}
			}

			// Supabase ile VKN sorgulama
			async function searchVkn(vkn) {
				currentVkn = vkn;
				showLoading('Müşteri sorgulanıyor...');

				try {
					// Önce bu VKN'li müşterinin başka bayilerle aktif teklifi var mı kontrol et
					const { data: offerCheck, error: offerCheckError } = await OffersService.hasActiveOfferWithOtherDealer(vkn, currentDealerId);

					if (offerCheckError) {
						hideLoading();
						showError('Kontrol sırasında hata oluştu');
						return;
					}

					// Başka bayi ile anlaşması varsa uyarı göster ve devam etme
					if (offerCheck && offerCheck.hasOffer) {
						hideLoading();
						$('#customer-info-box').addClass('visible error');
						$('#customer-name').text('Bu VKN\'li müşterinin başka bayi ile anlaşması olduğu için müşteriyi ekleyemez ve fiyat oluşturamazsınız.');
						$('#products-form').removeClass('visible');
						$('#form-actions').hide();
						$('#existing-notice').removeClass('visible');
						$('#passive-status-banner').removeClass('visible');
						return;
					}

					console.log('Current Dealer ID:', currentDealerId);
					console.log('Offer Check Result:', offerCheck);

					// Supabase'den müşteriyi sorgula
					const { data: customer, error } = await CustomersService.getByVkn(vkn);

					if (error) {
						hideLoading();
						showError('Müşteri sorgulanırken hata oluştu');
						return;
					}

					hideLoading();

					if (customer) {
						// Mevcut müşteri bulundu
						currentCustomer = customer;
						isEditMode = true;

						// Bu bayi-müşteri için en son teklifi çek (tüm durumlar dahil)
						const { data: offer } = await OffersService.getLatestOfferForDealerCustomer(currentDealerId, customer.id);

						// Cancelled/rejected teklif döndüyse yeni teklif oluşturulabilmesi için null yap
						if (offer && (offer.status === 'cancelled' || offer.status === 'rejected')) {
							currentOffer = null; // Kaydetince yeni teklif oluşturulacak
						} else {
							currentOffer = offer; // Aktif teklif varsa güncelle
						}

						// Chat'i baslat
						initializeChat();

						// offer_details'ı customer_prices formatına dönüştür (uyumluluk için)
						// Sadece aktif teklif varsa (currentOffer set) fiyatları göster
						// Cancelled/rejected ise currentOffer null, boş form açılacak
						var customerPrices = [];
						if (currentOffer && currentOffer.offer_details) {
							customerPrices = currentOffer.offer_details;
						}
						customer.customer_prices = customerPrices;

						$('#customer-info-box').removeClass('error').addClass('visible');
						$('#customer-name').text(customer.name + (customer.company_name ? ' - ' + customer.company_name : ''));
						$('#page-title').text('Müşteri Fiyat Düzenleme');
						$('#page-subtitle').text('Mevcut müşteri fiyatlarını düzenleyin');

						// Fiyat tanımlanmış mı kontrolü
						var customerPrices = customer.customer_prices || [];
						var hasPrices = customerPrices.some(function(p) { return p.unit_price !== undefined; });

						if (!hasPrices) {
							$('#existing-notice').addClass('visible');
							$('#existing-notice-text').text('Bu müşteriniz için henüz fiyat tanımlamadınız.');
							$('#passive-status-banner').removeClass('visible');
							$('#passive-customer-btn').hide();
							$('#activate-customer-btn').hide();
							$('#cancel-offer-btn').hide();
						} else {
							$('#existing-notice').removeClass('visible');

							// Teklif durumuna gore buton kontrolu
							// Not: cancelled/rejected teklifler icin currentOffer = null
							// Bu durumda yeni teklif olusturma modu aktif, butonlar gizli
							if (currentOffer && currentOffer.status === 'passive') {
								$('#passive-status-banner').addClass('visible');
								$('#passive-customer-btn').hide();
								$('#activate-customer-btn').show();
								$('#cancel-offer-btn').show();
							} else if (currentOffer && currentOffer.status === 'accepted') {
								$('#passive-status-banner').removeClass('visible');
								$('#passive-customer-btn').show();
								$('#activate-customer-btn').hide();
								$('#cancel-offer-btn').show();
							} else {
								// Yeni teklif olusturma modu (cancelled/rejected veya hic teklif yok)
								$('#passive-status-banner').removeClass('visible');
								$('#cancelled-status-banner').removeClass('visible');
								$('#passive-customer-btn').hide();
								$('#activate-customer-btn').hide();
								$('#cancel-offer-btn').hide();
							}
						}

						// Ürün satırlarını temizle
						$('#product-rows').empty();

						// Teklif detayları varsa sadece onları göster
						if (customerPrices && customerPrices.length > 0) {
							customerPrices.forEach(function(detail) {
								var product = detail.product;
								if (product) {
									// Ürün bilgilerini products dizisinden tamamla (image için)
									var fullProduct = products.find(function(p) { return p.id === product.id; }) || product;
									addProductRow(
										{ id: product.id, code: product.code, name: product.name, base_price: product.base_price, image: fullProduct.image || product.image_url },
										detail.commitment_quantity || '',
										detail.unit_price || '',
										detail.this_month_quantity,
										detail.last_month_quantity,
										detail.pricing_type || 'retail_price',
										detail.discount_value || 0
									);
								}
							});
						} else {
							// Teklif yoksa tüm ürünleri göster
							products.forEach(function(product) {
								addProductRow(product, '', '', undefined, undefined, 'retail_price', 0);
							});
						}

						$('#products-form').addClass('visible');
						$('#form-actions').show();

						// Save options - sadece yeni teklif oluşturulurken göster
						if (currentOffer) {
							$('#save-options').hide();
						} else {
							$('#save-options').show();
						}

						// Teklif gecmisini yukle
						loadOfferLogs(currentOffer ? currentOffer.id : null);

						// Teklif varsa "Yeni Ürün Ekle" butonunu göster
						if (customerPrices && customerPrices.length > 0) {
							$('#addProductSection').show();
						} else {
							$('#addProductSection').hide();
						}
					} else {
						// Yeni müşteri
						currentCustomer = null;
						isEditMode = false;

						$('#customer-info-box').removeClass('error').addClass('visible');
						$('#customer-name').text('YENİ MÜŞTERİ - Şirket Ünvanı (VKN: ' + vkn + ')');

						$('#page-title').text('Yeni Müşteri Fiyat Tanımlama');
						$('#page-subtitle').text('Müşteri için özel fiyat ve taahhüt tanımlayın');
						$('#existing-notice').addClass('visible');
						$('#existing-notice-text').text('Bu VKN ile kayıtlı müşteri bulunamadı. Yeni müşteri olarak eklenecektir.');
						$('#passive-status-banner').removeClass('visible');
						$('#passive-customer-btn').hide();
						$('#activate-customer-btn').hide();
						$('#cancel-offer-btn').hide();

						// Tüm ürünleri varsayılan perakende fiyatla göster
						$('#product-rows').empty();

						products.forEach(function(product) {
							addProductRow(product, '', '', undefined, undefined, 'retail_price', 0);
						});

						$('#products-form').addClass('visible');
						$('#form-actions').show();
						$('#save-options').show(); // Yeni müşteri için save options göster
						$('#addProductSection').hide(); // Yeni müşteri için gösterme
					}
				} catch (err) {
					hideLoading();
					showError('Bir hata oluştu: ' + err.message);
					console.error(err);
				}
			}

			function addProductRow(product, quantity, price, thisMonth, lastMonth, pricingType, discountValue) {

				// Calculate percentages for stats
				var target = quantity || 0;
				var hasCommitment = target > 0;

				// Tüketim değerleri
				var thisMonthVal = thisMonth || 0;
				var lastMonthVal = lastMonth || 0;

				// Yüzde ve değer hesaplama
				var thisMonthPercent, lastMonthPercent;
				var thisMonthValueText, lastMonthValueText;

				if (hasCommitment) {
					thisMonthPercent = Math.round((thisMonthVal / target) * 100);
					lastMonthPercent = Math.round((lastMonthVal / target) * 100);
					thisMonthValueText = thisMonthVal + '/' + target;
					lastMonthValueText = lastMonthVal + '/' + target;
				} else {
					thisMonthPercent = 100;
					lastMonthPercent = 100;
					thisMonthValueText = thisMonthVal;
					lastMonthValueText = lastMonthVal;
				}

				function getColorClass(percent, hasCommitment) {
					if (!hasCommitment) return 'good';
					if (percent >= 80) return 'good';
					if (percent >= 50) return 'medium';
					return 'low';
				}

				var thisMonthClass = getColorClass(thisMonthPercent, hasCommitment);
				var lastMonthClass = getColorClass(lastMonthPercent, hasCommitment);

				var hasStats = thisMonth !== undefined || lastMonth !== undefined;
				var statsVisible = hasStats ? ' visible' : '';

				// Pricing type defaults - varsayılan perakende fiyat
				var selectedType = pricingType || 'retail_price';
				var basePrice = product.base_price || 0;

				// Hesaplanan degerler
				var fixedDiscountValue = selectedType === 'fixed_discount' ? (discountValue || '') : '';
				var fixedPriceValue = selectedType === 'fixed_price' ? (price || '') : '';
				var percentageValue = selectedType === 'percentage_discount' ? (discountValue || '') : '';

				// Son fiyat hesapla
				var finalPrice = calculateFinalPrice(basePrice, selectedType, discountValue || 0, price || 0);

				var rowHtml = '<div class="product-row" data-product-id="' + product.id + '" data-base-price="' + basePrice + '">' +
					'<div class="product-image">' +
						'<img src="' + product.image + '" alt="' + product.name + '">' +
					'</div>' +
					'<div class="product-info">' +
						'<div class="product-name">' + product.name + '</div>' +
						'<div class="product-code">' + product.code + '</div>' +
					'</div>' +

					// YENİ: Üst İstatistik Bölümü - GEÇEN AY | BU AY | AYLIK ORT. TÜKETİM
					'<div class="product-stats-header' + statsVisible + '">' +
						// 1. GEÇEN AY
						'<div class="stat-box-compact">' +
							'<div class="stat-box-compact-title">Geçen Ay</div>' +
							'<div class="stat-box-compact-value">' + lastMonthValueText + '</div>' +
							'<div class="stat-progress-compact">' +
								'<div class="stat-progress-compact-fill ' + lastMonthClass + '" style="width: ' + Math.min(lastMonthPercent, 100) + '%"></div>' +
							'</div>' +
							'<div class="stat-percent-compact ' + lastMonthClass + '">%' + lastMonthPercent + '</div>' +
						'</div>' +
						// 2. BU AY
						'<div class="stat-box-compact">' +
							'<div class="stat-box-compact-title">Bu Ay</div>' +
							'<div class="stat-box-compact-value">' + thisMonthValueText + '</div>' +
							'<div class="stat-progress-compact">' +
								'<div class="stat-progress-compact-fill ' + thisMonthClass + '" style="width: ' + Math.min(thisMonthPercent, 100) + '%"></div>' +
							'</div>' +
							'<div class="stat-percent-compact ' + thisMonthClass + '">%' + thisMonthPercent + '</div>' +
						'</div>' +
						// 3. AYLIK ORT. TÜKETİM
						'<div class="consumption-box-compact">' +
							'<div class="consumption-box-compact-label">Aylık Ort. Tüketim</div>' +
							'<div class="consumption-box-compact-input">' +
								'<input type="number" class="quantity-input" placeholder="0" value="' + (quantity || '') + '" min="0">' +
								'<span>adet</span>' +
							'</div>' +
						'</div>' +
					'</div>' +

					// Pricing Section
					'<div class="pricing-section">' +
						'<div class="base-price-display">' +
							'Perakende Fiyat: <strong>' + formatPrice(basePrice) + ' TL</strong>' +
						'</div>' +
						'<div class="pricing-options">' +
							// 1. Perakende Fiyatı Uygula
							'<div class="pricing-option' + (selectedType === 'retail_price' ? ' selected' : '') + '" data-type="retail_price">' +
								'<input type="radio" name="pricing_' + product.id + '" value="retail_price"' + (selectedType === 'retail_price' ? ' checked' : '') + '>' +
								'<div class="pricing-radio"><div class="pricing-radio-inner"></div></div>' +
								'<div class="pricing-label">Perakende Fiyatı Uygula</div>' +
								'<div class="pricing-input-wrapper">' +
									'<span class="retail-price-display">' + formatPrice(basePrice) + ' TL</span>' +
								'</div>' +
							'</div>' +
							// 2. Sabit Fiyat
							'<div class="pricing-option' + (selectedType === 'fixed_price' ? ' selected' : '') + '" data-type="fixed_price">' +
								'<input type="radio" name="pricing_' + product.id + '" value="fixed_price"' + (selectedType === 'fixed_price' ? ' checked' : '') + '>' +
								'<div class="pricing-radio"><div class="pricing-radio-inner"></div></div>' +
								'<div class="pricing-label">Sabit Fiyat</div>' +
								'<div class="pricing-input-wrapper">' +
									'<input type="number" class="discount-input fixed-price-input" placeholder="0" value="' + fixedPriceValue + '" min="0" step="0.01"' + (selectedType !== 'fixed_price' ? ' disabled' : '') + '>' +
									'<span class="input-unit">TL</span>' +
								'</div>' +
							'</div>' +
							// 3. Sabit Fiyat İndirimi
							'<div class="pricing-option' + (selectedType === 'fixed_discount' ? ' selected' : '') + '" data-type="fixed_discount">' +
								'<input type="radio" name="pricing_' + product.id + '" value="fixed_discount"' + (selectedType === 'fixed_discount' ? ' checked' : '') + '>' +
								'<div class="pricing-radio"><div class="pricing-radio-inner"></div></div>' +
								'<div class="pricing-label">Sabit Fiyat İndirimi</div>' +
								'<div class="pricing-input-wrapper">' +
									'<input type="number" class="discount-input fixed-discount-input" placeholder="0" value="' + fixedDiscountValue + '" min="0" step="0.01"' + (selectedType !== 'fixed_discount' ? ' disabled' : '') + '>' +
									'<span class="input-unit">TL indirim</span>' +
								'</div>' +
							'</div>' +
							// 4. Yüzdesel İndirim
							'<div class="pricing-option' + (selectedType === 'percentage_discount' ? ' selected' : '') + '" data-type="percentage_discount">' +
								'<input type="radio" name="pricing_' + product.id + '" value="percentage_discount"' + (selectedType === 'percentage_discount' ? ' checked' : '') + '>' +
								'<div class="pricing-radio"><div class="pricing-radio-inner"></div></div>' +
								'<div class="pricing-label">Yüzdesel İndirim</div>' +
								'<div class="pricing-input-wrapper">' +
									'<input type="number" class="discount-input percentage-input" placeholder="0" value="' + percentageValue + '" min="0" max="100" step="0.1"' + (selectedType !== 'percentage_discount' ? ' disabled' : '') + '>' +
									'<span class="input-unit">%</span>' +
								'</div>' +
							'</div>' +
						'</div>' +
						'<div class="final-price-display">' +
							'<span class="final-price-label">Musteriye Uygulanan Fiyat:</span>' +
							'<span class="final-price-value">' + formatPrice(finalPrice) + ' TL</span>' +
						'</div>' +
					'</div>' +
				'</div>';

				$('#product-rows').append(rowHtml);
			}

			// Fiyat formatlama
			function formatPrice(price) {
				return parseFloat(price || 0).toFixed(2);
			}

			// Son fiyat hesaplama
			function calculateFinalPrice(basePrice, pricingType, discountValue, fixedPrice) {
				switch(pricingType) {
					case 'retail_price':
						return basePrice;
					case 'fixed_discount':
						return Math.max(0, basePrice - (discountValue || 0));
					case 'fixed_price':
						return fixedPrice || 0;
					case 'percentage_discount':
						return basePrice * (1 - (discountValue || 0) / 100);
					default:
						return basePrice;
				}
			}

			// ===== YENİ ÜRÜN EKLEME FONKSİYONLARI =====

			// Eklenen ürün ID'lerini al
			function getAddedProductIds() {
				var ids = [];
				$('.product-row').each(function() {
					ids.push($(this).data('product-id'));
				});
				return ids;
			}

			// Modal aç ve kullanılabilir ürünleri göster
			function openProductModal() {
				var addedIds = getAddedProductIds();
				var available = products.filter(function(p) {
					return !addedIds.includes(p.id);
				});
				renderProductGrid(available);
				$('#productModalOverlay').addClass('active');
				$('body').css('overflow', 'hidden');
				$('#productSearchInput').val('').focus();
			}

			// Modal kapat
			function closeProductModal() {
				$('#productModalOverlay').removeClass('active');
				$('body').css('overflow', '');
			}

			// Ürün grid render
			function renderProductGrid(productList) {
				var html = '';
				if (productList.length === 0) {
					html = '<div class="product-grid-empty">Eklenebilecek ürün kalmadı.</div>';
				} else {
					productList.forEach(function(p) {
						html += '<div class="product-grid-item" data-id="' + p.id + '">' +
									'<img src="' + p.image + '" alt="' + p.name + '">' +
									'<div class="product-grid-name">' + p.name + '</div>' +
									'<div class="product-grid-code">' + p.code + '</div>' +
									'<button type="button" class="btn-select-product">Ekle</button>' +
								'</div>';
					});
				}
				$('#productModalGrid').html(html);
			}

			// Ürün seç ve listeye ekle
			function selectProduct(productId) {
				var product = products.find(function(p) { return p.id === productId; });
				if (!product) return;

				// Yeni satır ekle
				addProductRow(product, '', '', undefined, undefined, 'retail_price', 0);

				// Son eklenen satıra highlight ekle
				var $newRow = $('.product-row').last();
				$newRow.addClass('newly-added');

				// Smooth scroll
				setTimeout(function() {
					$newRow[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
				}, 100);

				// 3 saniye sonra highlight kaldır
				setTimeout(function() {
					$newRow.removeClass('newly-added');
				}, 3000);

				// Modal kapat
				closeProductModal();
			}

			// Yeni Ürün Ekle butonu click
			$('#btnAddProduct').on('click', function() {
				openProductModal();
			});

			// Modal kapat butonu
			$('#productModalClose').on('click', function() {
				closeProductModal();
			});

			// Modal overlay click - kapat
			$('#productModalOverlay').on('click', function(e) {
				if (e.target === this) {
					closeProductModal();
				}
			});

			// Save options checkbox toggle
			$('#save-as-accepted').on('change', function() {
				if (this.checked) {
					$('#notify-customer-option').addClass('show');
				} else {
					$('#notify-customer-option').removeClass('show');
					$('#notify-customer').prop('checked', false);
				}
			});

			// ESC tuşu ile modal kapat
			$(document).on('keydown', function(e) {
				if (e.key === 'Escape' && $('#productModalOverlay').hasClass('active')) {
					closeProductModal();
				}
			});

			// Ürün seç butonu click
			$(document).on('click', '.btn-select-product', function(e) {
				e.stopPropagation();
				var productId = $(this).closest('.product-grid-item').data('id');
				selectProduct(productId);
			});

			// Ürün kartına click (tüm kart tıklanabilir)
			$(document).on('click', '.product-grid-item', function(e) {
				if (!$(e.target).is('.btn-select-product')) {
					var productId = $(this).data('id');
					selectProduct(productId);
				}
			});

			// Ürün arama
			$('#productSearchInput').on('input', function() {
				var query = $(this).val().toLowerCase().trim();
				var addedIds = getAddedProductIds();
				var filtered = products.filter(function(p) {
					return !addedIds.includes(p.id) &&
						(p.name.toLowerCase().includes(query) || p.code.toLowerCase().includes(query));
				});
				renderProductGrid(filtered);
			});

			// ===== YENİ ÜRÜN EKLEME FONKSİYONLARI SONU =====

			// Pricing option click - select pricing type
			$(document).on('click', '.pricing-option', function(e) {
				// Input'a tıklandığında seçim değişmesin
				if ($(e.target).is('input.discount-input')) {
					return;
				}

				var $row = $(this).closest('.product-row');
				var $option = $(this);
				var selectedType = $option.data('type');

				// Zaten seçili ise bir şey yapma
				if ($option.hasClass('selected')) {
					return;
				}

				var basePrice = parseFloat($row.data('base-price')) || 0;

				// Deselect all options in this row
				$row.find('.pricing-option').removeClass('selected').removeClass('error');
				$row.find('.pricing-option input[type="radio"]').prop('checked', false);
				$row.find('.pricing-option .discount-input').prop('disabled', true).css('border-color', '#e0e0e0');

				// Select this option
				$option.addClass('selected');
				$option.find('input[type="radio"]').prop('checked', true);
				var $discountInput = $option.find('.discount-input');
				if ($discountInput.length) {
					$discountInput.prop('disabled', false).focus();
				}

				// Perakende fiyat seçildiğinde tüketim zorunluluğu kalkar
				if (selectedType === 'retail_price') {
					$row.find('.consumption-box-compact').removeClass('error');
				}

				// Update final price display
				updateFinalPrice($row);
			});

			// Discount input change - update price calculation and clear errors
			$(document).on('input', '.discount-input', function() {
				var $row = $(this).closest('.product-row');
				var $option = $(this).closest('.pricing-option');

				// Clear error state
				$option.removeClass('error');
				$(this).css('border-color', '#002c77');

				updateFinalPrice($row);
			});

			// Quantity input change - clear error
			$(document).on('input', '.quantity-input', function() {
				var $row = $(this).closest('.product-row');
				$row.find('.consumption-box-compact').removeClass('error');
			});

			// Update final price for a row
			function updateFinalPrice($row) {
				var basePrice = parseFloat($row.data('base-price')) || 0;
				var $selectedOption = $row.find('.pricing-option.selected');
				var selectedType = $selectedOption.data('type');
				var inputValue = parseFloat($selectedOption.find('.discount-input').val()) || 0;

				var finalPrice = 0;
				if (selectedType === 'retail_price') {
					finalPrice = basePrice;
				} else if (selectedType === 'fixed_discount') {
					finalPrice = Math.max(0, basePrice - inputValue);
				} else if (selectedType === 'fixed_price') {
					finalPrice = inputValue;
				} else if (selectedType === 'percentage_discount') {
					finalPrice = basePrice * (1 - inputValue / 100);
				}

				// Update the final price display
				$row.find('.final-price-value').text(formatPrice(finalPrice) + ' TL');
			}

			// Save button
			$('#save-btn').on('click', function() {
				var hasError = false;
				var $firstError = null;
				var errorMessage = '';

				$('.product-row').each(function() {
					var $row = $(this);
					var $selectedOption = $row.find('.pricing-option.selected');
					var selectedType = $selectedOption.data('type');
					var $input = $selectedOption.find('.discount-input');
					var inputVal = parseFloat($input.val()) || 0;
					var quantity = parseInt($row.find('.quantity-input').val()) || 0;

					// Hata durumlarini temizle
					$selectedOption.removeClass('error');
					$input.css('border-color', '#e0e0e0');
					$row.find('.consumption-box-compact').removeClass('error');

					// Perakende fiyat seciliyse input kontrolu gerekmez
					if (selectedType !== 'retail_price') {
						// Diger seceneklerde input degeri olmali
						if (inputVal <= 0) {
							$selectedOption.addClass('error');
							$input.css('border-color', '#e53935');
							hasError = true;
							errorMessage = 'Lütfen tüm ürünler için fiyat bilgisi giriniz.';
							if (!$firstError) {
								$firstError = $row;
							}
						}

						// Perakende disinda tuketim adedi zorunlu
						if (quantity <= 0) {
							$row.find('.consumption-box-compact').addClass('error');
							hasError = true;
							errorMessage = 'Perakende fiyat dışında bir seçenek için Aylık Ort. Tüketim girilmelidir.';
							if (!$firstError) {
								$firstError = $row;
							}
						}
					}
				});

				if (hasError) {
					showError(errorMessage);
					if ($firstError) {
						$('html, body').animate({
							scrollTop: $firstError.offset().top - 100
						}, 300);
					}
					return;
				}

				$('#save-modal').addClass('active');
			});

			$('#modal-cancel').on('click', function() {
				$('#save-modal').removeClass('active');
			});

			$('#modal-confirm').on('click', async function() {
				$('#save-modal').removeClass('active');
				showLoading('Kaydediliyor...');

				try {
					var customerId;

					// Yeni müşteri mi yoksa mevcut mu?
					if (!isEditMode || !currentCustomer) {
						// Yeni müşteri oluştur
						var customerData = {
							vkn: currentVkn,
							name: 'Müşteri ' + currentVkn,
							company_name: $('#customer-name').text().replace('YENİ MÜŞTERİ - ', '').split(' (VKN')[0],
							phone: '',
							dealer_id: currentDealerId,
							is_active: true
						};

						const { data: newCustomer, error: customerError } = await CustomersService.create(customerData);
						if (customerError) throw new Error(customerError);
						customerId = newCustomer.id;
					} else {
						customerId = currentCustomer.id;
					}

					// Teklif detaylarını topla - yeni fiyatlandırma yapısı ile
					var offerDetails = [];
					$('.product-row').each(function() {
						var $row = $(this);
						var productId = $row.data('product-id');
						var basePrice = parseFloat($row.data('base-price')) || 0;
						var quantity = parseInt($row.find('.quantity-input').val()) || 0;

						// Seçili pricing option'ı bul
						var $selectedOption = $row.find('.pricing-option.selected');
						var pricingType = $selectedOption.data('type');
						var inputVal = parseFloat($selectedOption.find('.discount-input').val()) || 0;

						// Son fiyatı hesapla
						var finalPrice = 0;
						var discountValue = 0;

						if (pricingType === 'retail_price') {
							discountValue = 0;
							finalPrice = basePrice;
						} else if (pricingType === 'fixed_discount') {
							discountValue = inputVal;
							finalPrice = Math.max(0, basePrice - inputVal);
						} else if (pricingType === 'fixed_price') {
							discountValue = 0;
							finalPrice = inputVal;
						} else if (pricingType === 'percentage_discount') {
							discountValue = inputVal;
							finalPrice = basePrice * (1 - inputVal / 100);
						}

						if (finalPrice > 0) {
							offerDetails.push({
								product_id: productId,
								unit_price: finalPrice,
								pricing_type: pricingType,
								discount_value: discountValue,
								commitment_quantity: quantity,
								this_month_quantity: 0,
								last_month_quantity: 0
							});
						}
					});

					// Teklif oluştur veya güncelle
					if (offerDetails.length > 0) {
						if (currentOffer) {
							// Mevcut teklifi güncelle
							const { error: detailsError } = await OffersService.updateDetails(currentOffer.id, offerDetails);
							if (detailsError) throw new Error(detailsError);

							// Fiyat guncelleme logunu kaydet
							await OfferLogsService.log(
								currentOffer.id,
								'price_updated',
								'dealer',
								currentDealerId,
								currentDealerName
							);

							// Status 'requested' ise 'pending' yap (bayi fiyat girdi)
							if (currentOffer.status === 'requested') {
								const { error: statusError } = await OffersService.updateStatus(currentOffer.id, 'pending');
								if (statusError) throw new Error(statusError);
							}
						} else {
							// Yeni teklif oluştur
							const saveAsAccepted = $('#save-as-accepted').is(':checked');
							const offerData = {
								dealer_id: currentDealerId,
								customer_id: customerId,
								status: saveAsAccepted ? 'accepted' : 'pending',
								notes: 'Bayi panelinden oluşturuldu'
							};
							const { data: newOffer, error: offerError } = await OffersService.create(offerData, offerDetails);
							if (offerError) throw new Error(offerError);

							// Teklif olusturma logunu kaydet
							if (newOffer && newOffer.id) {
								await OfferLogsService.log(
									newOffer.id,
									'created',
									'dealer',
									currentDealerId,
									currentDealerName
								);
							}
						}
					}

					hideLoading();
					$('#success-message').addClass('active');

					setTimeout(function() {
						$('#success-message').removeClass('active');
						window.location.href = 'bayi-musteri-listesi.html';
					}, 2000);

				} catch (err) {
					hideLoading();
					showError('Kayıt sırasında hata oluştu: ' + err.message);
					console.error(err);
				}
			});

			// Pasife Çek handlers
			$('#passive-customer-btn').on('click', function() {
				$('#passive-modal').addClass('active');
			});

			$('#passive-modal-cancel').on('click', function() {
				$('#passive-modal').removeClass('active');
			});

			$('#passive-modal-confirm').on('click', async function() {
				$('#passive-modal').removeClass('active');
				showLoading('İşlem yapılıyor...');

				try {
					if (currentOffer) {
						// Teklifi pasife al
						const { error } = await OffersService.update(currentOffer.id, {
							status: 'passive'
						});
						if (error) throw new Error(error);
						currentOffer.status = 'passive';

						// Pasife alma logunu kaydet
						await OfferLogsService.log(
							currentOffer.id,
							'passived',
							'dealer',
							currentDealerId,
							currentDealerName
						);

						// Timeline'i guncelle
						loadOfferLogs(currentOffer.id);
					}

					hideLoading();

					// Update UI - show passive banner, swap buttons
					$('#passive-status-banner').addClass('visible');
					$('#passive-customer-btn').hide();
					$('#activate-customer-btn').show();

					// Show success message
					$('#success-message').find('span').text('Teklif pasife alındı!');
					$('#success-message').addClass('active');

					setTimeout(function() {
						$('#success-message').removeClass('active');
					}, 2000);
				} catch (err) {
					hideLoading();
					showError('İşlem sırasında hata oluştu: ' + err.message);
				}
			});

			// Aktif Et handlers
			$('#activate-customer-btn').on('click', function() {
				$('#activate-modal').addClass('active');
			});

			$('#activate-modal-cancel').on('click', function() {
				$('#activate-modal').removeClass('active');
			});

			$('#activate-modal-confirm').on('click', async function() {
				$('#activate-modal').removeClass('active');
				showLoading('İşlem yapılıyor...');

				try {
					if (currentOffer) {
						// Teklifi aktif et (accepted durumuna geri al)
						const { error } = await OffersService.updateStatus(currentOffer.id, 'accepted');
						if (error) throw new Error(error);
						currentOffer.status = 'accepted';

						// Aktif etme logunu kaydet
						await OfferLogsService.log(
							currentOffer.id,
							'activated',
							'dealer',
							currentDealerId,
							currentDealerName
						);

						// Timeline'i guncelle
						loadOfferLogs(currentOffer.id);
					}

					hideLoading();

					// Update UI - hide passive banner, swap buttons
					$('#passive-status-banner').removeClass('visible');
					$('#passive-customer-btn').show();
					$('#activate-customer-btn').hide();

					// Show success message
					$('#success-message').find('span').text('Teklif aktif edildi!');
					$('#success-message').addClass('active');

					setTimeout(function() {
						$('#success-message').removeClass('active');
					}, 2000);
				} catch (err) {
					hideLoading();
					showError('İşlem sırasında hata oluştu: ' + err.message);
				}
			});

			// Teklifi İptal Et handlers
			$('#cancel-offer-btn').on('click', function() {
				$('#cancel-offer-modal').addClass('active');
			});

			$('#cancel-offer-modal-cancel').on('click', function() {
				$('#cancel-offer-modal').removeClass('active');
			});

			$('#cancel-offer-modal-confirm').on('click', async function() {
				$('#cancel-offer-modal').removeClass('active');
				showLoading('İşlem yapılıyor...');

				try {
					if (currentOffer) {
						// Teklifi iptal et
						const { error } = await OffersService.updateStatus(currentOffer.id, 'cancelled');
						if (error) throw new Error(error);
						currentOffer.status = 'cancelled';

						// Iptal logunu kaydet
						await OfferLogsService.log(
							currentOffer.id,
							'cancelled',
							'dealer',
							currentDealerId,
							currentDealerName
						);

						// Timeline'i guncelle
						loadOfferLogs(currentOffer.id);
					}

					hideLoading();

					// Update UI - hide cancel button
					$('#cancel-offer-btn').hide();
					$('#passive-customer-btn').hide();
					$('#activate-customer-btn').hide();
					$('#passive-status-banner').removeClass('visible');
					$('#cancelled-status-banner').addClass('visible');

					// Duzenlemeyi engelle
					disableEditingForCancelledOffer();

					// Show success message
					$('#success-message').find('span').text('Teklif iptal edildi!');
					$('#success-message').addClass('active');

					setTimeout(function() {
						$('#success-message').removeClass('active');
					}, 2000);
				} catch (err) {
					hideLoading();
					showError('İşlem sırasında hata oluştu: ' + err.message);
				}
			});

			// Close modals on overlay click
			$('.modal-overlay').on('click', function(e) {
				if ($(e.target).hasClass('modal-overlay')) {
					$(this).removeClass('active');
				}
			});

			// ==================== MESAJLASMA FONKSIYONLARI ====================

			// Mesajlari yukle
			async function loadMessages() {
				if (!currentOffer) {
					showChatDisabled();
					return;
				}

				try {
					const { data, error } = await MessagesService.getByOfferId(currentOffer.id);
					if (error) {
						console.error('Mesaj yukleme hatasi:', error);
						return;
					}

					renderMessages(data || []);

					// Okundu isaretle
					await MessagesService.markAsRead(currentOffer.id, currentUserType);
					updateUnreadBadge(0);

				} catch (err) {
					console.error('Mesaj yukleme hatasi:', err);
				}
			}

			// Mesajlari render et
			function renderMessages(messages) {
				var container = document.getElementById('chatMessages');

				if (!messages || messages.length === 0) {
					container.innerHTML = '<div class="no-messages">' +
						'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
						'<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>' +
						'</svg>' +
						'<p>Henuz mesaj yok</p>' +
					'</div>';
					return;
				}

				var html = '';
				var lastDate = null;

				messages.forEach(function(msg) {
					var msgDate = new Date(msg.created_at).toDateString();

					// Gun degistiyse ayirici ekle
					if (lastDate !== msgDate) {
						html += '<div class="date-separator"><span>' +
							formatDateSeparator(msg.created_at) + '</span></div>';
						lastDate = msgDate;
					}

					var senderName = msg.sender_type === 'dealer' ? 'Siz' : 'Musteri';
					var timeStr = formatMessageTime(msg.created_at);

					html += '<div class="message-bubble ' + msg.sender_type + '">' +
						'<div class="message-sender">' + senderName + '</div>' +
						'<div class="message-text">' + escapeHtml(msg.message) + '</div>' +
						'<div class="message-time">' + timeStr + '</div>' +
					'</div>';
				});

				container.innerHTML = html;
				scrollToBottom();
			}

			// HTML escape
			function escapeHtml(text) {
				var div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			// Gun ayirici formatlama
			function formatDateSeparator(dateStr) {
				var date = new Date(dateStr);
				var now = new Date();

				if (date.toDateString() === now.toDateString()) {
					return 'Bugun';
				}

				var yesterday = new Date(now);
				yesterday.setDate(yesterday.getDate() - 1);
				if (date.toDateString() === yesterday.toDateString()) {
					return 'Dun';
				}

				return date.toLocaleDateString('tr-TR', {
					day: 'numeric',
					month: 'long',
					year: 'numeric'
				});
			}

			// Mesaj zamani formatlama
			function formatMessageTime(dateStr) {
				var date = new Date(dateStr);
				var now = new Date();

				// Bugun mi?
				if (date.toDateString() === now.toDateString()) {
					return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
				}

				// Dun mu?
				var yesterday = new Date(now);
				yesterday.setDate(yesterday.getDate() - 1);
				if (date.toDateString() === yesterday.toDateString()) {
					return 'Dun ' + date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
				}

				// Daha eski
				return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }) + ' ' +
					date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
			}

			// Mesaj alanini en alta kaydir
			function scrollToBottom() {
				var container = document.getElementById('chatMessages');
				container.scrollTop = container.scrollHeight;
			}

			// Mesaj gonder
			window.sendMessage = async function() {
				var input = document.getElementById('messageInput');
				var message = input.value.trim();

				if (!message || !currentOffer || !currentDealerId) return;

				var btn = document.getElementById('btnSendMessage');
				btn.disabled = true;

				try {
					const { data, error } = await MessagesService.create({
						offer_id: currentOffer.id,
						sender_type: currentUserType,
						sender_id: currentDealerId,
						message: message
					});

					if (error) {
						console.error('Mesaj gonderme hatasi:', error);
						alert('Mesaj gonderilemedi. Lutfen tekrar deneyin.');
					} else {
						input.value = '';
						input.style.height = 'auto';
						loadMessages();
					}

				} catch (err) {
					console.error('Mesaj gonderme hatasi:', err);
					alert('Mesaj gonderilemedi. Lutfen tekrar deneyin.');
				}

				btn.disabled = false;
			};

			// Enter tusu ile mesaj gonder
			window.handleMessageKeydown = function(event) {
				if (event.key === 'Enter' && !event.shiftKey) {
					event.preventDefault();
					sendMessage();
				}
			};

			// Iptal edilmis teklifler icin duzenlemeyi engelle
			function disableEditingForCancelledOffer() {
				// Tum fiyat inputlarini disable et
				$('.discount-input').prop('disabled', true);
				$('.pricing-type-select').prop('disabled', true);

				// Urun ekleme bolumunu gizle
				$('#addProductSection').hide();

				// Kaydet butonunu gizle
				$('#save-btn').hide();

				// Mesajlasmayi kapat
				showChatDisabled();

				// Chat disabled mesajini guncelle
				$('#chatDisabled p').text('İptal edilmiş tekliflerde mesaj gönderilemez');
			}

			// Teklif gecmisini yukle ve goster
			async function loadOfferLogs(offerId) {
				if (!offerId) {
					$('#offer-metadata').hide();
					return;
				}

				$('#offer-metadata').show();
				var timeline = document.getElementById('metadata-timeline');
				timeline.innerHTML = '<p class="timeline-empty">Yukleniyor...</p>';

				var result = await OfferLogsService.getByOfferId(offerId);
				if (result.error || !result.data) {
					timeline.innerHTML = '<p class="timeline-empty">Gecmis yuklenemedi</p>';
					return;
				}

				var logs = result.data;
				if (!logs.length) {
					timeline.innerHTML = '<p class="timeline-empty">Henuz kayit yok</p>';
					return;
				}

				var actionLabels = {
					'created': 'Teklif olusturuldu',
					'requested': 'Teklif talep edildi',
					'price_updated': 'Fiyatlar guncellendi',
					'accepted': 'Teklif kabul edildi',
					'rejected': 'Teklif reddedildi',
					'cancelled': 'Teklif iptal edildi',
					'passived': 'Teklif pasife alindi',
					'activated': 'Teklif aktif edildi',
					'details_updated': 'Teklif detaylari guncellendi'
				};

				var html = logs.map(function(log) {
					var date = new Date(log.created_at);
					var timeStr = date.toLocaleDateString('tr-TR') + ' ' +
								  date.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});

					return '<div class="timeline-item">' +
						'<div class="timeline-dot ' + log.action + '"></div>' +
						'<div class="timeline-content">' +
							'<div class="timeline-action">' + (actionLabels[log.action] || log.action) + '</div>' +
							'<div class="timeline-actor">' + (log.actor_name || '-') + '</div>' +
							'<div class="timeline-time">' + timeStr + '</div>' +
						'</div>' +
					'</div>';
				}).join('');

				timeline.innerHTML = html;
			}

			// Chat'i devre disi goster
			function showChatDisabled() {
				document.getElementById('chatMessages').style.display = 'none';
				document.getElementById('chatInputWrapper').style.display = 'none';
				document.getElementById('chatDisabled').style.display = 'flex';
			}

			// Chat'i aktif goster
			function showChatEnabled() {
				document.getElementById('chatMessages').style.display = 'flex';
				document.getElementById('chatInputWrapper').style.display = 'flex';
				document.getElementById('chatDisabled').style.display = 'none';
			}

			// Okunmamis mesaj badge'i guncelle
			function updateUnreadBadge(count) {
				var badge = document.getElementById('chatBadge');
				var mobileBadge = document.getElementById('unreadBadgeMobile');

				if (count > 0) {
					badge.textContent = count;
					badge.style.display = 'inline';
					mobileBadge.textContent = count;
					mobileBadge.style.display = 'inline';
				} else {
					badge.style.display = 'none';
					mobileBadge.style.display = 'none';
				}
			}

			// Real-time mesaj dinleme
			function subscribeToMessages() {
				if (!currentOffer) return;

				// Onceki subscription'i kaldir
				if (messageSubscription) {
					MessagesService.unsubscribe(messageSubscription);
				}

				messageSubscription = MessagesService.subscribeToOffer(currentOffer.id, function(payload) {
					// Her yeni mesajda yükle (hem kendi hem karşı taraf)
					if (payload.new) {
						loadMessages();
					}
				});
			}

			// Mobil chat ac
			window.openChatMobile = function() {
				document.getElementById('chatColumn').classList.add('active');
				document.body.style.overflow = 'hidden';
				scrollToBottom();
			};

			// Mobil chat kapat
			window.closeChatMobile = function() {
				document.getElementById('chatColumn').classList.remove('active');
				document.body.style.overflow = '';
			};

			// Chat'i baslat
			window.initializeChat = async function() {
				if (currentOffer && ['requested', 'pending', 'accepted'].includes(currentOffer.status)) {
					showChatEnabled();
					await loadMessages();
					subscribeToMessages();
				} else {
					showChatDisabled();
				}
			};

			// Sayfa yuklendiginde chat disabled olarak baslasin
			showChatDisabled();
		});
	</script>
</body>
</html>
