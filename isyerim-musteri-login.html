<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>İşyerim Giriş - İpragaz</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			min-height: 100vh;
			background-color: #e31e24;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			overflow: hidden;
		}

		/* B Pattern Background */
		.bg-pattern {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			pointer-events: none;
		}

		.bg-pattern::before {
			content: 'B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B';
			position: absolute;
			top: -50px;
			left: -50px;
			width: calc(100% + 100px);
			height: calc(100% + 100px);
			font-size: 80px;
			font-weight: 700;
			color: rgba(255, 255, 255, 0.08);
			word-spacing: 30px;
			line-height: 1.2;
			letter-spacing: 20px;
			word-break: break-all;
		}

		/* Login Card */
		.login-container {
			position: relative;
			z-index: 1;
			width: 100%;
			max-width: 420px;
			padding: 20px;
		}

		.login-card {
			background: #fff;
			border-radius: 12px;
			padding: 40px 35px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		/* Logo */
		.logo {
			text-align: center;
			margin-bottom: 30px;
		}

		.logo svg {
			width: 140px;
			height: auto;
		}

		/* Back Link / Title */
		.back-link {
			display: flex;
			align-items: center;
			gap: 8px;
			color: #333;
			font-size: 18px;
			font-weight: 600;
			margin-bottom: 20px;
			cursor: pointer;
			text-decoration: none;
		}

		.back-link:hover {
			color: #e31e24;
		}

		.back-link svg {
			width: 20px;
			height: 20px;
		}

		/* Description */
		.description {
			color: #666;
			font-size: 14px;
			line-height: 1.6;
			margin-bottom: 25px;
		}

		/* Form */
		.form-group {
			margin-bottom: 25px;
		}

		.form-group label {
			display: block;
			color: #888;
			font-size: 12px;
			margin-bottom: 8px;
		}

		.form-group input {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			font-size: 15px;
			font-family: inherit;
			color: #333;
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		.form-group input:focus {
			outline: none;
			border-color: #e31e24;
			box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
		}

		.form-group input::placeholder {
			color: #bbb;
		}

		/* Submit Button */
		.btn-submit {
			width: 100%;
			padding: 14px 20px;
			background: #c41e24;
			border: none;
			border-radius: 25px;
			color: #fff;
			font-size: 15px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s, transform 0.2s;
		}

		.btn-submit:hover {
			background: #a81a1f;
			transform: translateY(-1px);
		}

		.btn-submit:active {
			transform: translateY(0);
		}

		/* Responsive */
		@media (max-width: 480px) {
			.login-card {
				padding: 30px 25px;
			}

			.logo svg {
				width: 120px;
			}

			.back-link {
				font-size: 16px;
			}

			.bg-pattern::before {
				font-size: 50px;
			}
		}

		/* Quick Login Section */
		.quick-login-section {
			margin-top: 25px;
			padding-top: 20px;
			border-top: 1px solid #eee;
		}
		.quick-login-title {
			font-size: 13px;
			color: #666;
			margin-bottom: 12px;
			text-align: center;
		}
		.customer-list {
			display: flex;
			flex-direction: column;
			gap: 8px;
			max-height: 200px;
			overflow-y: auto;
		}
		.customer-item {
			padding: 10px 14px;
			background: #f8f9fa;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			cursor: pointer;
			font-size: 13px;
			transition: all 0.2s;
		}
		.customer-item:hover {
			background: #fde8e8;
			border-color: #e31e24;
		}
		.customer-item .customer-name { font-weight: 500; color: #1a1a2e; }
		.customer-item .customer-company { font-size: 11px; color: #666; }
		.customer-item .customer-location { font-size: 11px; color: #888; }
		.no-user-badge {
			display: inline-block;
			background: #fee;
			color: #e31e24;
			font-size: 10px;
			padding: 2px 6px;
			border-radius: 4px;
			margin-left: 8px;
		}
		.customer-item {
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		.customer-item-info {
			flex: 1;
			min-width: 0;
		}
		.customer-delete-btn {
			width: 28px;
			height: 28px;
			border: none;
			background: transparent;
			color: #999;
			cursor: pointer;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-shrink: 0;
			margin-left: 8px;
			transition: all 0.2s;
		}
		.customer-delete-btn:hover {
			background: #fee;
			color: #e31e24;
		}
		.customer-delete-btn svg {
			width: 16px;
			height: 16px;
		}
	</style>
</head>
<body>
	<!-- Background Pattern -->
	<div class="bg-pattern"></div>

	<!-- Login Container -->
	<div class="login-container">
		<div class="login-card">
			<!-- Logo -->
			<div class="logo">
				<svg viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
					<!-- Power icon -->
					<circle cx="25" cy="25" r="20" fill="none" stroke="#e31e24" stroke-width="3"/>
					<path d="M25 10 L25 25" stroke="#e31e24" stroke-width="3" stroke-linecap="round"/>
					<!-- iPRAGAZ text -->
					<text x="55" y="32" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#e31e24">iPRAGAZ</text>
				</svg>
			</div>

			<!-- Back Link / Title -->
			<a href="#" class="back-link">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M19 12H5M12 19l-7-7 7-7"/>
				</svg>
				Giriş Yap
			</a>

			<!-- Description -->
			<p class="description">
				Sipariş verebilmeniz ve size özel kampanyalardan yararlanabilmeniz için telefon numaranızı girmelisiniz.
			</p>

			<!-- Phone Input -->
			<div class="form-group">
				<label>Telefon Numarası</label>
				<input type="tel" id="phone" placeholder="5xx xxx xxxx" maxlength="12">
			</div>

			<!-- Submit Button -->
			<button class="btn-submit" id="submit-btn">Devam</button>

			<!-- Quick Login Section -->
			<div class="quick-login-section">
				<p class="quick-login-title">Hızlı Giriş</p>
				<div class="customer-list" id="customer-list">
					<div style="text-align:center;color:#999;font-size:12px;">Yükleniyor...</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Supabase & Services -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/customer-users-service.js"></script>

	<script>
		// Yeni giriş için tüm session değerlerini temizle
		sessionStorage.removeItem('isyerim_cart');
		sessionStorage.removeItem('tekliften_cekildi');
		sessionStorage.removeItem('selected_bayi');
		sessionStorage.removeItem('isNewUser');
		sessionStorage.removeItem('isyerim_phone');
		sessionStorage.removeItem('isyerim_customer_id');
		sessionStorage.removeItem('selected_address_id');
		sessionStorage.removeItem('selected_address_name');
		sessionStorage.removeItem('isyerim_dealer_id');
		sessionStorage.removeItem('isyerim_dealer_name');

		// Phone number formatting
		document.getElementById('phone').addEventListener('input', function(e) {
			let value = e.target.value.replace(/\D/g, '');

			// Format: 5xx xxx xxxx
			if (value.length > 0) {
				if (value.length <= 3) {
					value = value;
				} else if (value.length <= 6) {
					value = value.slice(0, 3) + ' ' + value.slice(3);
				} else {
					value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6, 10);
				}
			}

			e.target.value = value;
		});

		// Submit button click
		document.getElementById('submit-btn').addEventListener('click', function() {
			var phone = document.getElementById('phone').value.replace(/\s/g, '');

			if (phone.length < 10) {
				alert('Lütfen geçerli bir telefon numarası giriniz.');
				return;
			}

			// Telefon numarasını sessionStorage'a kaydet
			sessionStorage.setItem('isyerim_phone', phone);

			// OTP sayfasına yönlendir (isNewUser kontrolü OTP sayfasında Supabase'den yapılacak)
			window.location.href = 'isyerim-musteri-otp.html?phone=' + phone;
		});

		// Müşterileri yükle (Hızlı Giriş için)
		async function loadCustomersForQuickLogin() {
			try {
				// Sadece aktif müşterileri getir (backend'de filtreleme)
				const { data: customers, error } = await CustomersService.getAll(null, true);
				if (error || !customers) return;

				const list = document.getElementById('customer-list');
				list.innerHTML = '';

				// Tüm müşteriler için paralel olarak kullanıcı durumunu kontrol et
				const userChecks = await Promise.all(
					customers.map(async function(customer) {
						const { data: users } = await CustomerUsersService.getByCustomerId(customer.id);
						const hasActiveOwner = users && users.some(function(u) { return u.role === 'owner' && u.is_active; });
						return { customer, hasActiveOwner };
					})
				);

				// Sırala: Önce kullanıcısı olanlar (alfabetik), sonra olmayanlar (alfabetik)
				userChecks.sort(function(a, b) {
					if (a.hasActiveOwner !== b.hasActiveOwner) {
						return a.hasActiveOwner ? -1 : 1; // Kullanıcısı olanlar önce
					}
					return a.customer.name.localeCompare(b.customer.name, 'tr'); // Alfabetik sıra
				});

				// Listeye ekle
				userChecks.forEach(function(item) {
					const customer = item.customer;
					const noUserBadge = item.hasActiveOwner ? '' : '<span class="no-user-badge">Kullanıcısı Yok</span>';

					const el = document.createElement('div');
					el.className = 'customer-item';
					el.innerHTML =
						'<div class="customer-item-info">' +
							'<div class="customer-name">' + customer.name + noUserBadge + '</div>' +
							(customer.company_name ? '<div class="customer-company">' + customer.company_name + '</div>' : '') +
							(customer.address ? '<div class="customer-location">' + customer.address.substring(0, 50) + '...</div>' : '') +
						'</div>' +
						'<button class="customer-delete-btn" title="Kalıcı Sil">' +
							'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>' +
						'</button>';

					// Info kısmına tıklayınca giriş yap
					el.querySelector('.customer-item-info').onclick = function() { quickLoginAsCustomer(customer); };

					// Silme butonuna tıklayınca hard delete
					el.querySelector('.customer-delete-btn').onclick = function(e) {
						e.stopPropagation();
						hardDeleteCustomer(customer);
					};

					list.appendChild(el);
				});
			} catch (err) {
				console.error('Müşteriler yüklenemedi:', err);
			}
		}

		// Müşteriyi kalıcı olarak sil (hard delete)
		async function hardDeleteCustomer(customer) {
			var confirmed = confirm('DİKKAT!\n\n"' + customer.name + '" müşterisi ve tüm verileri (kullanıcılar, şubeler, puanlar) kalıcı olarak silinecek.\n\nBu işlem geri alınamaz!\n\nEmin misiniz?');
			if (!confirmed) return;

			try {
				// Sırayla sil (CASCADE ilişkileri nedeniyle sadece customers silmek yeterli olabilir ama güvenlik için hepsini silelim)

				// 1. Puanları sil
				await supabaseClient
					.from('customer_points')
					.delete()
					.eq('customer_id', customer.id);

				// 2. Kullanıcı-şube ilişkilerini sil (customer_user_branches)
				const { data: users } = await supabaseClient
					.from('customer_users')
					.select('id')
					.eq('customer_id', customer.id);

				if (users && users.length > 0) {
					const userIds = users.map(function(u) { return u.id; });
					await supabaseClient
						.from('customer_user_branches')
						.delete()
						.in('customer_user_id', userIds);
				}

				// 3. Kullanıcıları sil
				await supabaseClient
					.from('customer_users')
					.delete()
					.eq('customer_id', customer.id);

				// 4. Şubeleri sil
				await supabaseClient
					.from('customer_branches')
					.delete()
					.eq('customer_id', customer.id);

				// 5. Müşteriyi sil
				const { error } = await supabaseClient
					.from('customers')
					.delete()
					.eq('id', customer.id);

				if (error) {
					alert('Silme hatası: ' + error.message);
					return;
				}

				alert('Müşteri ve tüm verileri kalıcı olarak silindi.');
				loadCustomersForQuickLogin(); // Listeyi yenile
			} catch (err) {
				console.error('Hard delete hatası:', err);
				alert('Silme işlemi başarısız: ' + err.message);
			}
		}

		// Hızlı giriş
		async function quickLoginAsCustomer(customer) {
			try {
				// Müşteri aktif mi kontrol et
				if (!customer.is_active) {
					alert('Bu hesap silinmiş. Giriş yapılamıyor.');
					return;
				}

				// Owner kullanıcısını bul veya oluştur
				let userId;
				const { data: users } = await CustomerUsersService.getByCustomerId(customer.id);
				const owner = users && users.find(function(u) { return u.role === 'owner' && u.is_active; });

				if (owner) {
					userId = owner.id;
				} else {
					// Aktif owner yoksa oluştur
					const { data: newOwner } = await CustomerUsersService.createOwner(
						customer.id,
						customer.name,
						customer.phone
					);
					if (!newOwner) {
						alert('Bu hesapta aktif kullanıcı bulunamadı.');
						return;
					}
					userId = newOwner.id;
				}

				// SessionStorage'a kaydet
				sessionStorage.setItem('isyerim_phone', customer.phone);
				sessionStorage.setItem('isyerim_customer_id', customer.id);
				sessionStorage.setItem('isyerim_user_id', userId);
				sessionStorage.setItem('isyerim_user_role', 'owner');
				sessionStorage.setItem('isyerim_user_name', customer.name);
				sessionStorage.setItem('isyerim_customer_name', customer.company_name || customer.name || 'Musteri');
				sessionStorage.setItem('isyerim_tabela_unvani', customer.tabela_unvani || '');
				sessionStorage.setItem('isNewUser', 'false');

				// Anasayfaya yönlendir
				window.location.href = 'isyerim-musteri-anasayfa.html';
			} catch (err) {
				console.error('Hızlı giriş hatası:', err);
				alert('Giriş yapılamadı');
			}
		}

		// Sayfa yüklendiğinde müşterileri getir
		loadCustomersForQuickLogin();
	</script>
</body>
</html>
