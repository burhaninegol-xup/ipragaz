<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Uyelik Bilgilerim - Ipragaz IsYerim</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #f5f5f5;
			color: #333;
		}

		a {
			text-decoration: none;
			color: inherit;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 0 20px;
		}

		/* Settings Layout */
		.settings-layout {
			display: flex;
			gap: 30px;
			padding: 30px 0;
		}

		/* Content Area */
		.settings-content {
			flex: 1;
			background: #fff;
			border-radius: 12px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.05);
			padding: 30px;
		}

		.content-title {
			font-size: 20px;
			font-weight: 600;
			color: #333;
			margin-bottom: 30px;
			padding-bottom: 15px;
			border-bottom: 1px solid #eee;
		}

		/* Form Styles */
		.form-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 20px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
		}

		.form-group.full-width {
			grid-column: 1 / -1;
		}

		.form-label {
			font-size: 13px;
			color: #666;
			margin-bottom: 8px;
			display: flex;
			align-items: center;
			gap: 5px;
		}

		.form-label .required {
			color: #e31e24;
		}

		.form-label .info-icon {
			width: 14px;
			height: 14px;
			color: #e31e24;
			cursor: help;
		}

		.form-input {
			padding: 14px 16px;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			font-size: 14px;
			font-family: inherit;
			color: #333;
			transition: border-color 0.2s, background-color 0.2s;
		}

		.form-input:focus {
			outline: none;
			border-color: #e31e24;
		}

		.form-input:disabled {
			background: #f5f5f5;
			color: #666;
			cursor: not-allowed;
		}

		.form-input.readonly {
			background: #f9f9f9;
			color: #333;
		}

		/* Submit Button */
		.btn-submit {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			padding: 14px 40px;
			background: #e31e24;
			border: none;
			border-radius: 30px;
			color: #fff;
			font-size: 15px;
			font-weight: 600;
			cursor: pointer;
			transition: background 0.2s, transform 0.2s;
			margin-top: 20px;
		}

		.btn-submit:hover {
			background: #c41a1f;
			transform: translateY(-2px);
		}

		.btn-submit:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		/* Success/Error Messages */
		.message {
			padding: 12px 16px;
			border-radius: 8px;
			font-size: 14px;
			margin-bottom: 20px;
			display: none;
		}

		.message.success {
			background: #e8f5e9;
			color: #2e7d32;
			border: 1px solid #a5d6a7;
		}

		.message.error {
			background: #ffebee;
			color: #c62828;
			border: 1px solid #ef9a9a;
		}

		.message.show {
			display: block;
		}

		/* Loading */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255,255,255,0.8);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			display: none;
		}

		.loading-overlay.show {
			display: flex;
		}

		.loading-spinner {
			width: 40px;
			height: 40px;
			border: 3px solid #f0f0f0;
			border-top-color: #e31e24;
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		/* Responsive */
		@media (max-width: 992px) {
			.settings-layout {
				flex-direction: column;
			}

			.form-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>
<body>
	<!-- Top Bar (Component) -->
	<div id="isyerim-top-bar"></div>

	<!-- Header (Component) -->
	<div id="isyerim-header"></div>

	<!-- Settings Layout -->
	<div class="container">
		<div class="settings-layout">
			<!-- Sidebar (Component) -->
			<div id="isyerim-settings-sidebar"></div>

			<!-- Content -->
			<div class="settings-content">
				<h1 class="content-title">Uyelik Bilgilerim</h1>

				<!-- Messages -->
				<div class="message success" id="successMessage">Bilgileriniz basariyla guncellendi.</div>
				<div class="message error" id="errorMessage">Bir hata olustu. Lutfen tekrar deneyin.</div>

				<!-- Form -->
				<form id="profileForm">
					<div class="form-grid">
						<!-- Sektor (readonly) -->
						<div class="form-group">
							<label class="form-label">Sektor<span class="required">*</span></label>
							<input type="text" class="form-input readonly" id="sektor" disabled>
						</div>

						<!-- Unvan (readonly) -->
						<div class="form-group">
							<label class="form-label">Unvan<span class="required">*</span></label>
							<input type="text" class="form-input readonly" id="unvan" disabled>
						</div>

						<!-- Ad -->
						<div class="form-group">
							<label class="form-label">Ad<span class="required">*</span></label>
							<input type="text" class="form-input" id="ad" placeholder="Adinizi giriniz">
						</div>

						<!-- Soyad -->
						<div class="form-group">
							<label class="form-label">Soyad<span class="required">*</span></label>
							<input type="text" class="form-input" id="soyad" placeholder="Soyadinizi giriniz">
						</div>

						<!-- Telefon Numarasi (readonly) -->
						<div class="form-group">
							<label class="form-label">Telefon Numarasi<span class="required">*</span></label>
							<input type="text" class="form-input readonly" id="telefon" disabled>
						</div>

						<!-- E-posta -->
						<div class="form-group">
							<label class="form-label">E-posta</label>
							<input type="email" class="form-input" id="email" placeholder="E-posta adresinizi giriniz">
						</div>

						<!-- Dogum Tarihi -->
						<div class="form-group">
							<label class="form-label">Dogum Tarihi</label>
							<input type="date" class="form-input" id="dogumTarihi">
						</div>

						<!-- VKN / TC Kimlik No (readonly) -->
						<div class="form-group">
							<label class="form-label">Vergi Kimlik Numarasi / T.C. Kimlik No<span class="required">*</span></label>
							<input type="text" class="form-input readonly" id="vkn" disabled>
						</div>

						<!-- Tabela Unvani -->
						<div class="form-group full-width">
							<label class="form-label">
								<svg class="info-icon" viewBox="0 0 24 24" fill="currentColor">
									<circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
									<line x1="12" y1="16" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
									<circle cx="12" cy="8" r="1" fill="currentColor"/>
								</svg>
								Tabela Unvani
							</label>
							<input type="text" class="form-input" id="tabelaUnvani" placeholder="Isyerinizin tabela unvanini giriniz">
						</div>
					</div>

					<button type="submit" class="btn-submit" id="submitBtn">Degisiklikleri Kaydet</button>
				</form>
			</div>
		</div>
	</div>

	<!-- Footer (Component) -->
	<div id="isyerim-footer"></div>

	<!-- Loading Overlay -->
	<div class="loading-overlay" id="loadingOverlay">
		<div class="loading-spinner"></div>
	</div>

	<!-- Supabase -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/branches-service.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/customer-users-service.js"></script>
	<script src="./js/component-loader.js"></script>
	<script src="./js/components/settings-sidebar.js"></script>
	<script>
		// Rol kontrolu - sadece owner erisebilir
		(function() {
			var userRole = sessionStorage.getItem('isyerim_user_role');
			if (userRole !== 'owner') {
				alert('Bu sayfaya erisim yetkiniz bulunmamaktadir.');
				window.location.href = 'isyerim-musteri-anasayfa.html';
				return;
			}
		})();

		// Global degiskenler
		var currentCustomer = null;
		var customerId = null;

		// Sayfa yuklendiginde
		document.addEventListener('DOMContentLoaded', async function() {
			// Musteri ID'sini al
			customerId = sessionStorage.getItem('isyerim_customer_id');

			if (!customerId) {
				// Giris yapilmamis, login sayfasina yonlendir
				window.location.href = 'isyerim-musteri-login.html';
				return;
			}

			// Sidebar'i yukle
			await loadSettingsSidebar();

			// Musteri verilerini yukle
			await loadCustomerData();
		});

		// Sidebar component'ini yukle
		async function loadSettingsSidebar() {
			try {
				var response = await fetch('./components/isyerim-settings-sidebar.html');
				var html = await response.text();
				document.getElementById('isyerim-settings-sidebar').innerHTML = html;

				// Sidebar'i baslat ve aktif sayfayi isaretle
				setTimeout(function() {
					if (typeof initSettingsSidebar === 'function') {
						initSettingsSidebar('uyelik-bilgilerim');
					}
				}, 100);
			} catch (err) {
				console.error('Sidebar yukleme hatasi:', err);
			}
		}

		// Musteri verilerini yukle
		async function loadCustomerData() {
			showLoading(true);

			try {
				var result = await CustomersService.getById(customerId);

				if (result.error || !result.data) {
					showMessage('error', 'Musteri bilgileri yuklenemedi.');
					return;
				}

				currentCustomer = result.data;

				// Formu doldur
				fillForm(currentCustomer);

			} catch (err) {
				console.error('Musteri yukleme hatasi:', err);
				showMessage('error', 'Bir hata olustu.');
			} finally {
				showLoading(false);
			}
		}

		// Formu doldur
		function fillForm(customer) {
			// Sektor
			var sektorMap = {
				'yeme-icme': 'Yeme-Icme',
				'perakende': 'Perakende',
				'uretim': 'Uretim',
				'hizmet': 'Hizmet',
				'diger': 'Diger',
				'enerji': 'Enerji'
			};
			document.getElementById('sektor').value = sektorMap[customer.sector] || customer.sector || '';

			// Unvan (name)
			document.getElementById('unvan').value = customer.name || '';

			// Ad ve Soyad (name'den parse)
			var nameParts = (customer.name || '').split(' ');
			var firstName = nameParts[0] || '';
			var lastName = nameParts.slice(1).join(' ') || '';

			document.getElementById('ad').value = firstName;
			document.getElementById('soyad').value = lastName;

			// Telefon
			document.getElementById('telefon').value = customer.phone || '';

			// E-posta
			document.getElementById('email').value = customer.email || '';

			// Dogum Tarihi
			if (customer.birth_date) {
				document.getElementById('dogumTarihi').value = customer.birth_date;
			}

			// VKN
			document.getElementById('vkn').value = customer.vkn || '';

			// Tabela Unvani
			document.getElementById('tabelaUnvani').value = customer.tabela_unvani || '';
		}

		// Form gonderimi
		document.getElementById('profileForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			// Formu dogrula
			if (!validateForm()) {
				return;
			}

			showLoading(true);
			hideMessages();

			try {
				// Form verilerini topla
				var ad = document.getElementById('ad').value.trim();
				var soyad = document.getElementById('soyad').value.trim();
				var email = document.getElementById('email').value.trim();
				var dogumTarihi = document.getElementById('dogumTarihi').value;
				var tabelaUnvani = document.getElementById('tabelaUnvani').value.trim();

				// Guncelleme verisi
				var updateData = {
					name: ad + (soyad ? ' ' + soyad : ''),
					email: email || null,
					birth_date: dogumTarihi || null,
					tabela_unvani: tabelaUnvani || null
				};

				// Guncelle
				var result = await CustomersService.update(customerId, updateData);

				if (result.error) {
					throw new Error(result.error);
				}

				// Session'daki ismi guncelle
				sessionStorage.setItem('isyerim_customer_name', updateData.name);

				// Basari mesaji goster
				showMessage('success', 'Bilgileriniz basariyla guncellendi.');

				// Unvan alanini guncelle
				document.getElementById('unvan').value = updateData.name;

			} catch (err) {
				console.error('Guncelleme hatasi:', err);
				showMessage('error', 'Bir hata olustu. Lutfen tekrar deneyin.');
			} finally {
				showLoading(false);
			}
		});

		// Form dogrulama
		function validateForm() {
			var ad = document.getElementById('ad').value.trim();

			if (!ad) {
				showMessage('error', 'Ad alani zorunludur.');
				return false;
			}

			var email = document.getElementById('email').value.trim();
			if (email && !isValidEmail(email)) {
				showMessage('error', 'Gecerli bir e-posta adresi giriniz.');
				return false;
			}

			return true;
		}

		// E-posta dogrulama
		function isValidEmail(email) {
			var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			return re.test(email);
		}

		// Mesaj goster
		function showMessage(type, text) {
			hideMessages();
			var messageEl = document.getElementById(type + 'Message');
			if (messageEl) {
				messageEl.textContent = text;
				messageEl.classList.add('show');

				// 5 saniye sonra gizle
				setTimeout(function() {
					messageEl.classList.remove('show');
				}, 5000);
			}
		}

		// Mesajlari gizle
		function hideMessages() {
			document.getElementById('successMessage').classList.remove('show');
			document.getElementById('errorMessage').classList.remove('show');
		}

		// Loading goster/gizle
		function showLoading(show) {
			var overlay = document.getElementById('loadingOverlay');
			if (show) {
				overlay.classList.add('show');
			} else {
				overlay.classList.remove('show');
			}
		}
	</script>
</body>
</html>
