<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Siparislerim - Ipragaz IsYerim</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<link rel="stylesheet" href="./css/components/security-overlay.css">
	<link rel="stylesheet" href="./css/components/delete-account-overlay.css">
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: 'Poppins', sans-serif; background: #f5f5f5; color: #333; }
		a { text-decoration: none; color: inherit; }
		.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
		.settings-layout { display: flex; gap: 30px; padding: 30px 0; }
		.settings-content { flex: 1; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 30px; }
		.content-title { font-size: 20px; font-weight: 600; color: #333; margin-bottom: 25px; }

		/* Search */
		.search-box { margin-bottom: 20px; }
		.search-input { width: 100%; padding: 12px 15px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; }
		.search-input:focus { outline: none; border-color: #e31e24; }

		/* Tabs */
		.tabs { display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; }
		.tab { padding: 12px 20px; font-size: 14px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
		.tab:hover { color: #e31e24; }
		.tab.active { color: #e31e24; border-bottom-color: #e31e24; }

		/* Date Filter */
		.date-filter { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; padding: 12px 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa; }
		.date-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
		.date-separator { color: #999; }

		/* Order List */
		.orders-list { display: flex; flex-direction: column; gap: 15px; }
		.order-card { border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; }
		.order-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 15px; }
		.order-status { display: flex; align-items: center; gap: 10px; }
		.status-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
		.status-icon svg { width: 14px; height: 14px; }
		.status-icon.pending { background: #fff3cd; color: #856404; }
		.status-icon.confirmed { background: #cce5ff; color: #004085; }
		.status-icon.delivered { background: #d4edda; color: #155724; }
		.status-icon.cancelled { background: #f8d7da; color: #721c24; }
		.status-text { font-size: 14px; font-weight: 600; }
		.status-text.pending { color: #856404; }
		.status-text.confirmed { color: #004085; }
		.status-text.delivered { color: #155724; }
		.status-text.cancelled { color: #721c24; }
		.order-meta { font-size: 13px; color: #888; }
		.order-products { font-size: 14px; color: #555; margin-bottom: 15px; line-height: 1.6; }
		.order-actions { display: flex; gap: 12px; justify-content: flex-end; }
		.btn-cancel { padding: 10px 20px; border: 1px solid #e31e24; color: #e31e24; background: #fff; border-radius: 25px; font-size: 14px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s; }
		.btn-cancel:hover { background: #fff5f5; }
		.btn-detail { padding: 10px 20px; border: none; background: #e31e24; color: #fff; border-radius: 25px; font-size: 14px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s; }
		.btn-detail:hover { background: #c91a1f; }

		/* Empty State */
		.empty-state { text-align: center; padding: 60px 20px; }
		.empty-icon { width: 80px; height: 80px; margin: 0 auto 20px; color: #ccc; }
		.empty-text { font-size: 16px; color: #666; margin-bottom: 10px; }
		.empty-subtext { font-size: 14px; color: #999; }

		/* Loading */
		.loading { text-align: center; padding: 40px; color: #666; }

		/* Recurring Order Card */
		.recurring-card { border: 2px solid #e31e24; border-radius: 12px; padding: 20px; background: linear-gradient(135deg, #FFF5F5 0%, #FFEBEE 100%); position: relative; }
		.recurring-status-badge { position: absolute; top: -1px; right: 20px; padding: 4px 12px; border-radius: 0 0 8px 8px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
		.recurring-status-badge.active { background: #4CAF50; color: white; }
		.recurring-status-badge.paused { background: #FF9800; color: white; }
		.recurring-status-badge.cancelled { background: #9E9E9E; color: white; }
		.recurring-status-badge svg { width: 12px; height: 12px; }
		@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
		.recurring-status-badge.active svg { animation: spin 2s linear infinite; }
		.recurring-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; margin-top: 10px; }
		.recurring-icon { width: 28px; height: 28px; color: #e31e24; }
		.recurring-schedule { font-size: 16px; font-weight: 600; color: #333; }
		.recurring-products { font-size: 14px; color: #555; margin-bottom: 16px; line-height: 1.6; }
		.recurring-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
		.recurring-info-item { font-size: 13px; }
		.recurring-info-label { color: #888; }
		.recurring-info-value { color: #333; font-weight: 500; }
		.recurring-info-value.highlight { color: #e31e24; }
		.recurring-actions { display: flex; gap: 10px; flex-wrap: wrap; }
		.btn-recurring { padding: 10px 20px; border-radius: 25px; font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.2s; }
		.btn-recurring-pause { border: 1px solid #FF9800; color: #FF9800; background: #fff; }
		.btn-recurring-pause:hover { background: #FFF3E0; }
		.btn-recurring-resume { border: 1px solid #4CAF50; color: #4CAF50; background: #fff; }
		.btn-recurring-resume:hover { background: #E8F5E9; }
		.btn-recurring-cancel { border: 1px solid #e31e24; color: #e31e24; background: #fff; }
		.btn-recurring-cancel:hover { background: #FFF5F5; }

		/* Confirm Modal */
		.confirm-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
		.confirm-modal.active { display: flex; }
		.confirm-box { background: #fff; border-radius: 12px; padding: 30px; max-width: 400px; width: 90%; text-align: center; }
		.confirm-icon { width: 60px; height: 60px; margin: 0 auto 20px; color: #e31e24; }
		.confirm-title { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
		.confirm-text { font-size: 14px; color: #666; margin-bottom: 25px; }
		.confirm-buttons { display: flex; gap: 15px; }
		.confirm-btn { flex: 1; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; border: none; transition: background 0.3s; }
		.confirm-btn.cancel { background: #f0f0f0; color: #333; }
		.confirm-btn.cancel:hover { background: #e0e0e0; }
		.confirm-btn.confirm { background: #e31e24; color: #fff; }
		.confirm-btn.confirm:hover { background: #c91a1f; }

		/* New Order Card Design */
		.order-card-new { display: flex; gap: 16px; padding: 20px; border: 1px solid #e8ecf1; border-radius: 12px; margin-bottom: 12px; background: #fff; transition: all 0.2s ease; }
		.order-card-new:hover { border-color: #e31e24; box-shadow: 0 4px 16px rgba(227, 30, 36, 0.1); }
		.order-card-left { flex: 1; display: flex; flex-direction: column; gap: 6px; min-width: 0; }
		.order-card-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; min-width: 150px; gap: 12px; }
		.order-branch-name { font-size: 15px; font-weight: 600; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
		.order-dealer-name { font-size: 14px; color: #666; display: flex; align-items: center; gap: 6px; }
		.order-dealer-name svg { width: 14px; height: 14px; color: #999; flex-shrink: 0; }
		.order-amount { font-size: 20px; font-weight: 700; color: #e31e24; margin: 4px 0; }
		.order-meta-info { font-size: 13px; color: #888; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
		.order-meta-info svg { width: 14px; height: 14px; color: #999; }
		.order-item-count { font-size: 12px; color: #666; padding: 4px 10px; background: #f5f7fa; border-radius: 6px; }
		.status-badge-new { display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; white-space: nowrap; }
		.status-badge-new svg { width: 14px; height: 14px; }
		.status-badge-new.pending { background: #fff8e6; color: #f5a623; border: 1px solid #ffe0b2; }
		.status-badge-new.confirmed { background: #e6f4ff; color: #1890ff; border: 1px solid #bbdefb; }
		.status-badge-new.delivered { background: #e6ffe6; color: #28a745; border: 1px solid #c8e6c9; }
		.status-badge-new.cancelled { background: #ffe6e6; color: #e31e24; border: 1px solid #ffcdd2; }

		/* Branch Filter */
		.filter-row { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
		.date-filter { margin-bottom: 0; flex: 1; min-width: 250px; }
		.branch-filter-wrapper { position: relative; }
		.branch-filter-btn {
			display: flex; align-items: center; gap: 8px;
			padding: 12px 15px; border: 1px solid #e0e0e0; border-radius: 8px;
			background: #fafafa; cursor: pointer; font-family: inherit; font-size: 14px; color: #333;
			transition: all 0.2s;
		}
		.branch-filter-btn:hover { border-color: #e31e24; }
		.branch-filter-btn svg { width: 18px; height: 18px; color: #e31e24; }
		.branch-count-badge {
			background: #e31e24; color: #fff; font-size: 11px; font-weight: 600;
			padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center;
		}
		.branch-dropdown {
			position: absolute; top: calc(100% + 5px); right: 0; min-width: 280px;
			background: #fff; border: 1px solid #e0e0e0; border-radius: 10px;
			box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 100;
			display: none; max-height: 300px; overflow: hidden;
		}
		.branch-dropdown.active { display: block; }
		.branch-dropdown-header {
			padding: 12px 15px; border-bottom: 1px solid #e0e0e0; background: #f9f9f9;
		}
		.branch-dropdown-list { max-height: 220px; overflow-y: auto; padding: 8px 0; }
		.branch-checkbox-item {
			display: flex; align-items: center; gap: 10px;
			padding: 10px 15px; cursor: pointer; transition: background 0.2s;
		}
		.branch-checkbox-item:hover { background: #f5f5f5; }
		.branch-checkbox-item input[type="checkbox"] {
			width: 18px; height: 18px; accent-color: #e31e24; cursor: pointer;
		}
		.branch-checkbox-item span { font-size: 14px; color: #333; }
		.branch-checkbox-item.select-all { font-weight: 600; }
		.branch-checkbox-item.select-all span { color: #e31e24; }

		@media (max-width: 992px) { .settings-layout { flex-direction: column; } }
		@media (max-width: 600px) {
			.tabs { overflow-x: auto; }
			.tab { white-space: nowrap; padding: 12px 15px; font-size: 13px; }
			.order-header { flex-direction: column; gap: 10px; }
			.order-actions { justify-content: stretch; }
			.order-actions button { flex: 1; }
			.filter-row { flex-direction: column; align-items: stretch; }
			.date-filter { min-width: auto; }
			.branch-filter-wrapper { width: 100%; }
			.branch-filter-btn { width: 100%; justify-content: center; }
			.branch-dropdown { left: 0; right: 0; min-width: auto; }
			/* Responsive Order Card */
			.order-card-new { flex-direction: column; gap: 12px; padding: 16px; }
			.order-card-right { flex-direction: row; justify-content: space-between; align-items: center; width: 100%; min-width: auto; }
			.order-amount { font-size: 18px; }
			.status-badge-new { padding: 6px 10px; font-size: 11px; }
			.btn-detail { padding: 10px 16px; font-size: 13px; }
		}
	</style>
</head>
<body>
	<div id="isyerim-top-bar"></div>
	<div id="isyerim-header"></div>
	<div class="container">
		<div class="settings-layout">
			<div id="isyerim-settings-sidebar"></div>
			<div class="settings-content">
				<h1 class="content-title">Siparislerim</h1>

				<!-- Search -->
				<div class="search-box">
					<input type="text" class="search-input" id="searchInput" placeholder="Siparis Ara" oninput="filterOrders()">
				</div>

				<!-- Tabs -->
				<div class="tabs">
					<div class="tab" data-status="recurring" onclick="switchTab('recurring')">
						<svg style="width:14px;height:14px;margin-right:4px;vertical-align:middle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
						Rutin Siparisler
					</div>
					<div class="tab active" data-status="ongoing" onclick="switchTab('ongoing')">Devam Eden</div>
					<div class="tab" data-status="delivered" onclick="switchTab('delivered')">Tamamlanan</div>
					<div class="tab" data-status="cancelled" onclick="switchTab('cancelled')">Iptal/Teslim Edilemedi</div>
				</div>

				<!-- Filter Row: Date + Branch -->
				<div class="filter-row" id="filterRow">
					<div class="date-filter">
						<input type="date" class="date-input" id="dateFrom" onchange="filterOrders()">
						<span class="date-separator">-</span>
						<input type="date" class="date-input" id="dateTo" onchange="filterOrders()">
					</div>
					<div class="branch-filter-wrapper">
						<button type="button" class="branch-filter-btn" onclick="toggleBranchDropdown()">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
								<circle cx="12" cy="10" r="3"/>
							</svg>
							<span id="branchFilterLabel">Tum Adresler</span>
							<span class="branch-count-badge" id="branchCountBadge">0</span>
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;color:#666">
								<polyline points="6 9 12 15 18 9"/>
							</svg>
						</button>
						<div class="branch-dropdown" id="branchDropdown">
							<div class="branch-dropdown-header">
								<label class="branch-checkbox-item select-all">
									<input type="checkbox" id="selectAllBranches" onchange="toggleAllBranches()">
									<span>Tumunu Sec</span>
								</label>
							</div>
							<div class="branch-dropdown-list" id="branchList">
								<!-- Dinamik olarak doldurulacak -->
							</div>
						</div>
					</div>
				</div>

				<!-- Orders List -->
				<div id="ordersList" class="orders-list">
					<div class="loading">Siparisler yukleniyor...</div>
				</div>
			</div>
		</div>
	</div>
	<div id="isyerim-footer"></div>

	<!-- Cancel Confirmation Modal -->
	<div class="confirm-modal" id="cancelModal">
		<div class="confirm-box">
			<svg class="confirm-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<circle cx="12" cy="12" r="10"/>
				<line x1="15" y1="9" x2="9" y2="15"/>
				<line x1="9" y1="9" x2="15" y2="15"/>
			</svg>
			<h3 class="confirm-title">Siparisi Iptal Et</h3>
			<p class="confirm-text">Bu siparisi iptal etmek istediginizden emin misiniz?</p>
			<div class="confirm-buttons">
				<button class="confirm-btn cancel" onclick="closeCancelModal()">Vazgec</button>
				<button class="confirm-btn confirm" onclick="confirmCancel()">Iptal Et</button>
			</div>
		</div>
	</div>

	<!-- Delete Account Overlay Container -->
	<div id="delete-account-overlay-container"></div>

	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/orders-service.js"></script>
	<script src="./js/services/branches-service.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/customer-users-service.js"></script>
	<script src="./js/services/recurring-orders-service.js"></script>
	<script src="./js/component-loader.js"></script>
	<script src="./js/services/account-deletion-service.js"></script>
	<script src="./js/components/settings-sidebar.js"></script>
	<script>
		var customerId = null;
		var userId = null;
		var userRole = null;
		var allOrders = [];
		var allRecurringOrders = [];
		var currentTab = 'ongoing';
		var cancelOrderId = null;
		var recurringActionId = null;

		// Sube filtresi icin
		var allBranches = [];
		var selectedBranchIds = [];

		// Durum mapping
		var statusMap = {
			'waiting_for_assignment': { text: 'Siparis Olusturuldu', class: 'pending' },
			'on_the_way': { text: 'Dagitimda', class: 'confirmed' },
			'completed': { text: 'Teslim Edildi', class: 'delivered' },
			'cancelled': { text: 'Iptal Edildi', class: 'cancelled' }
		};

		document.addEventListener('DOMContentLoaded', async function() {
			customerId = sessionStorage.getItem('isyerim_customer_id');
			userId = sessionStorage.getItem('isyerim_user_id');
			userRole = sessionStorage.getItem('isyerim_user_role') || 'owner';

			if (!customerId) { window.location.href = 'isyerim-musteri-login.html'; return; }

			// Sidebar yukle
			try {
				var response = await fetch('./components/isyerim-settings-sidebar.html');
				var html = await response.text();
				document.getElementById('isyerim-settings-sidebar').innerHTML = html;
				setTimeout(function() { if (typeof initSettingsSidebar === 'function') initSettingsSidebar('siparislerim'); }, 100);

				// Delete account overlay'i yukle
				var overlayResponse = await fetch('./components/delete-account-overlay.html');
				var overlayHtml = await overlayResponse.text();
				document.getElementById('delete-account-overlay-container').innerHTML = overlayHtml;
			} catch (err) { console.error('Sidebar yukleme hatasi:', err); }

			// Varsayilan tarih filtresi (son 30 gun)
			var today = new Date();
			var thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
			document.getElementById('dateTo').value = formatDateForInput(today);
			document.getElementById('dateFrom').value = formatDateForInput(thirtyDaysAgo);

			// Sube filtresini yukle
			await loadBranchFilter();

			// Siparisleri yukle
			await loadOrders();

			// Dropdown disina tiklaninca kapat
			document.addEventListener('click', function(e) {
				var dropdown = document.getElementById('branchDropdown');
				var btn = document.querySelector('.branch-filter-btn');
				if (dropdown && !dropdown.contains(e.target) && !btn.contains(e.target)) {
					dropdown.classList.remove('active');
				}
			});
		});

		function formatDateForInput(date) {
			return date.toISOString().split('T')[0];
		}

		async function loadOrders() {
			var listContainer = document.getElementById('ordersList');
			listContainer.innerHTML = '<div class="loading">Siparisler yukleniyor...</div>';

			var result;

			// Staff kullanicilar icin sadece yetkili subelerin siparislerini getir
			if (userRole === 'staff' && userId) {
				// Yetkili sube ID'lerini al
				var branchResult = await CustomerUsersService.getBranchIds(userId);
				var authorizedBranchIds = branchResult.data || [];

				if (authorizedBranchIds.length === 0) {
					listContainer.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p class="empty-text">Yetkili oldugunuz sube bulunmuyor</p><p class="empty-subtext">Lutfen yonetici ile iletisime gecin</p></div>';
					return;
				}

				result = await OrdersService.getByCustomerAndBranches(customerId, authorizedBranchIds);
			} else {
				// Owner - tum siparisleri getir
				result = await OrdersService.getByCustomerId(customerId);
			}

			if (result.error) {
				listContainer.innerHTML = '<div class="loading">Siparisler yuklenirken hata olustu</div>';
				return;
			}

			allOrders = result.data || [];
			filterOrders();
		}

		function switchTab(tab) {
			currentTab = tab;

			// Tab aktiflik
			document.querySelectorAll('.tab').forEach(function(t) {
				t.classList.remove('active');
				if (t.dataset.status === tab) {
					t.classList.add('active');
				}
			});

			// Rutin siparişler tabı için özel işlem
			if (tab === 'recurring') {
				document.getElementById('filterRow').style.display = 'none';
				loadRecurringOrders();
			} else {
				document.getElementById('filterRow').style.display = 'flex';
				filterOrders();
			}
		}

		function filterOrders() {
			var searchTerm = document.getElementById('searchInput').value.toLowerCase();
			var dateFrom = document.getElementById('dateFrom').value;
			var dateTo = document.getElementById('dateTo').value;

			var filtered = allOrders.filter(function(order) {
				// Tab filtresi
				if (currentTab === 'ongoing') {
					// waiting_for_assignment: Siparis olusturuldu, bayi atamasi bekleniyor
					// on_the_way: Dagitimda
					if (order.status !== 'waiting_for_assignment' && order.status !== 'on_the_way') return false;
				} else if (currentTab === 'delivered') {
					if (order.status !== 'completed') return false;
				} else if (currentTab === 'cancelled') {
					if (order.status !== 'cancelled') return false;
				}

				// Sube filtresi (tumu secili degilse uygula)
				if (selectedBranchIds.length > 0 && selectedBranchIds.length < allBranches.length) {
					if (!selectedBranchIds.includes(order.customer_branch_id)) {
						return false;
					}
				}

				// Arama filtresi
				if (searchTerm) {
					var orderNumber = (order.order_number || '').toLowerCase();
					var dealerName = (order.dealer?.name || '').toLowerCase();
					var branchName = (order.branch?.branch_name || '').toLowerCase();
					var productNames = (order.order_items || []).map(function(item) {
						return (item.product?.name || '').toLowerCase();
					}).join(' ');

					if (!orderNumber.includes(searchTerm) && !dealerName.includes(searchTerm) && !productNames.includes(searchTerm) && !branchName.includes(searchTerm)) {
						return false;
					}
				}

				// Tarih filtresi
				if (dateFrom) {
					var orderDate = new Date(order.created_at);
					var fromDate = new Date(dateFrom);
					if (orderDate < fromDate) return false;
				}
				if (dateTo) {
					var orderDate = new Date(order.created_at);
					var toDate = new Date(dateTo);
					toDate.setHours(23, 59, 59);
					if (orderDate > toDate) return false;
				}

				return true;
			});

			renderOrders(filtered);
		}

		// ============================================
		// SUBE FILTRESI FONKSIYONLARI
		// ============================================

		async function loadBranchFilter() {
			try {
				if (userRole === 'owner') {
					// Owner - tum subeleri getir
					var result = await BranchesService.getByCustomerId(customerId);
					allBranches = result.data || [];
				} else {
					// Staff - yetkili subeleri getir
					var result = await CustomerUsersService.getBranches(userId);
					allBranches = result.data || [];
				}

				renderBranchDropdown();

				// Varsayilan: tum subeler secili
				selectAllBranches();
			} catch (err) {
				console.error('Sube listesi yukleme hatasi:', err);
			}
		}

		function renderBranchDropdown() {
			var listContainer = document.getElementById('branchList');

			if (allBranches.length === 0) {
				listContainer.innerHTML = '<div style="padding:15px;color:#888;text-align:center">Sube bulunamadi</div>';
				return;
			}

			var html = '';
			allBranches.forEach(function(branch) {
				var branchId = branch.id;
				var branchName = branch.branch_name || branch.address_name || 'Sube';
				html += '<label class="branch-checkbox-item">';
				html += '<input type="checkbox" value="' + branchId + '" onchange="onBranchSelectionChange(\'' + branchId + '\')">';
				html += '<span>' + branchName + '</span>';
				html += '</label>';
			});

			listContainer.innerHTML = html;
		}

		function toggleBranchDropdown() {
			var dropdown = document.getElementById('branchDropdown');
			dropdown.classList.toggle('active');
		}

		function onBranchSelectionChange(branchId) {
			var checkbox = document.querySelector('#branchList input[value="' + branchId + '"]');

			if (checkbox.checked) {
				if (!selectedBranchIds.includes(branchId)) {
					selectedBranchIds.push(branchId);
				}
			} else {
				selectedBranchIds = selectedBranchIds.filter(function(id) { return id !== branchId; });
			}

			updateSelectAllCheckbox();
			updateBranchFilterLabel();
			filterOrders();
		}

		function toggleAllBranches() {
			var selectAllCheckbox = document.getElementById('selectAllBranches');
			var checkboxes = document.querySelectorAll('#branchList input[type="checkbox"]');

			if (selectAllCheckbox.checked) {
				// Tumunu sec
				selectedBranchIds = allBranches.map(function(b) { return b.id; });
				checkboxes.forEach(function(cb) { cb.checked = true; });
			} else {
				// Tumunu kaldir
				selectedBranchIds = [];
				checkboxes.forEach(function(cb) { cb.checked = false; });
			}

			updateBranchFilterLabel();
			filterOrders();
		}

		function selectAllBranches() {
			selectedBranchIds = allBranches.map(function(b) { return b.id; });

			// Checkboxlari isaretle
			var selectAllCheckbox = document.getElementById('selectAllBranches');
			if (selectAllCheckbox) selectAllCheckbox.checked = true;

			var checkboxes = document.querySelectorAll('#branchList input[type="checkbox"]');
			checkboxes.forEach(function(cb) { cb.checked = true; });

			updateBranchFilterLabel();
		}

		function updateSelectAllCheckbox() {
			var selectAllCheckbox = document.getElementById('selectAllBranches');
			if (selectedBranchIds.length === allBranches.length) {
				selectAllCheckbox.checked = true;
				selectAllCheckbox.indeterminate = false;
			} else if (selectedBranchIds.length === 0) {
				selectAllCheckbox.checked = false;
				selectAllCheckbox.indeterminate = false;
			} else {
				selectAllCheckbox.checked = false;
				selectAllCheckbox.indeterminate = true;
			}
		}

		function updateBranchFilterLabel() {
			var label = document.getElementById('branchFilterLabel');
			var badge = document.getElementById('branchCountBadge');

			badge.textContent = selectedBranchIds.length;

			if (selectedBranchIds.length === 0) {
				label.textContent = 'Sube Secin';
			} else if (selectedBranchIds.length === allBranches.length) {
				label.textContent = 'Tum Adresler';
			} else if (selectedBranchIds.length === 1) {
				var branch = allBranches.find(function(b) { return b.id === selectedBranchIds[0]; });
				label.textContent = branch ? (branch.branch_name || branch.address_name) : '1 Sube';
			} else {
				label.textContent = selectedBranchIds.length + ' Sube';
			}
		}

		function renderOrders(orders) {
			var listContainer = document.getElementById('ordersList');

			if (orders.length === 0) {
				listContainer.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p class="empty-text">Bu kategoride siparis bulunamadi</p><p class="empty-subtext">Farkli bir filtre deneyin</p></div>';
				return;
			}

			var html = '';
			orders.forEach(function(order) {
				var status = statusMap[order.status] || { text: order.status, class: 'pending' };
				var orderDate = new Date(order.created_at);
				var dateStr = orderDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' });
				var timeStr = orderDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

				// Sube ve bayi bilgileri
				var branchName = order.branch?.branch_name || 'Varsayilan Adres';
				var dealerName = order.dealer?.name || 'Bayi';

				// Urun sayisi
				var itemCount = (order.order_items || []).reduce(function(sum, item) {
					return sum + (item.quantity || 0);
				}, 0);

				// Tutar formatlama
				var amount = parseFloat(order.total_amount || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

				// Status icon
				var statusIcon = '';
				if (order.status === 'waiting_for_assignment') {
					statusIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>';
				} else if (order.status === 'on_the_way') {
					statusIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>';
				} else if (order.status === 'completed') {
					statusIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
				} else {
					statusIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
				}

				html += '<div class="order-card-new" onclick="goToDetail(\'' + order.id + '\')" style="cursor: pointer;">';

				// Sol taraf - Bilgiler
				html += '<div class="order-card-left">';
				html += '<div class="order-branch-name">' + branchName + '</div>';
				html += '<div class="order-dealer-name"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>' + dealerName + '</div>';
				html += '<div class="order-amount">' + amount + ' TL</div>';
				html += '<div class="order-meta-info">';
				html += '<span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> ' + dateStr + ' ' + timeStr + '</span>';
				html += '<span class="order-item-count">' + itemCount + ' urun</span>';
				html += '</div>';
				html += '</div>';

				// Sag taraf - Durum ve Buton
				html += '<div class="order-card-right">';
				html += '<span class="status-badge-new ' + status.class + '">' + statusIcon + status.text + '</span>';
				html += '<button class="btn-detail" onclick="event.stopPropagation(); goToDetail(\'' + order.id + '\')">Siparis Detayi</button>';
				html += '</div>';

				html += '</div>';
			});

			listContainer.innerHTML = html;
		}

		function goToDetail(orderId) {
			window.location.href = 'isyerim-musteri-siparis-detay.html?id=' + orderId;
		}

		function openCancelModal(orderId) {
			cancelOrderId = orderId;
			document.getElementById('cancelModal').classList.add('active');
		}

		function closeCancelModal() {
			cancelOrderId = null;
			document.getElementById('cancelModal').classList.remove('active');
		}

		async function confirmCancel() {
			if (!cancelOrderId) return;

			var result = await OrdersService.cancel(cancelOrderId);

			if (result.error) {
				alert('Siparis iptal edilemedi');
			} else {
				closeCancelModal();
				await loadOrders();
			}
		}

		// ============================================
		// RUTİN SİPARİŞ FONKSİYONLARI
		// ============================================

		var dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];

		async function loadRecurringOrders() {
			var listContainer = document.getElementById('ordersList');
			listContainer.innerHTML = '<div class="loading">Rutin siparisler yukleniyor...</div>';

			var result = await RecurringOrdersService.getByCustomerId(customerId);

			if (result.error) {
				listContainer.innerHTML = '<div class="loading">Rutin siparisler yuklenirken hata olustu</div>';
				return;
			}

			allRecurringOrders = result.data || [];
			renderRecurringOrders(allRecurringOrders);
		}

		function renderRecurringOrders(orders) {
			var listContainer = document.getElementById('ordersList');

			if (orders.length === 0) {
				listContainer.innerHTML = '<div class="empty-state"><svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg><p class="empty-text">Rutin siparisiniz bulunmuyor</p><p class="empty-subtext">Siparis verdikten sonra rutin siparis olusturabilirsiniz</p></div>';
				return;
			}

			var html = '';
			orders.forEach(function(order) {
				var dayName = dayNames[order.day_of_week] || '';
				var schedule = 'Her ' + dayName;
				if (order.delivery_time) {
					schedule += ' ' + order.delivery_time;
				}

				// Ürünler
				var productSummary = (order.items || []).map(function(item) {
					return item.quantity + 'x ' + (item.product?.name || 'Urun');
				}).join(', ');

				// Status badge
				var statusClass = order.status;
				var statusText = order.status === 'active' ? 'AKTİF' : (order.status === 'paused' ? 'DURAKLATILDI' : 'İPTAL');

				// Bir sonraki sipariş tarihi
				var nextOrderDate = order.next_order_date ? formatDateTurkish(order.next_order_date) : '-';

				// Oluşturulma tarihi
				var createdDate = order.created_at ? formatDateTurkish(order.created_at.split('T')[0]) : '-';

				html += '<div class="recurring-card">';
				html += '<div class="recurring-status-badge ' + statusClass + '">';
				html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
				html += statusText;
				html += '</div>';

				html += '<div class="recurring-card-header">';
				html += '<svg class="recurring-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>';
				html += '<span class="recurring-schedule">' + schedule + '</span>';
				html += '</div>';

				html += '<div class="recurring-products">' + (productSummary || 'Urun bilgisi yok') + '</div>';

				html += '<div class="recurring-info">';
				html += '<div class="recurring-info-item"><span class="recurring-info-label">Bayi:</span> <span class="recurring-info-value">' + (order.dealer?.name || '-') + '</span></div>';
				html += '<div class="recurring-info-item"><span class="recurring-info-label">Bir sonraki:</span> <span class="recurring-info-value highlight">' + nextOrderDate + '</span></div>';
				html += '<div class="recurring-info-item"><span class="recurring-info-label">Baslangic:</span> <span class="recurring-info-value">' + createdDate + '</span></div>';
				html += '<div class="recurring-info-item"><span class="recurring-info-label">Toplam siparis:</span> <span class="recurring-info-value">' + (order.total_orders_created || 0) + '</span></div>';
				html += '</div>';

				html += '<div class="recurring-actions">';
				if (order.status === 'active') {
					html += '<button class="btn-recurring btn-recurring-pause" onclick="pauseRecurring(\'' + order.id + '\')">Duraklat</button>';
				} else if (order.status === 'paused') {
					html += '<button class="btn-recurring btn-recurring-resume" onclick="resumeRecurring(\'' + order.id + '\')">Devam Ettir</button>';
				}
				if (order.status !== 'cancelled') {
					html += '<button class="btn-recurring btn-recurring-cancel" onclick="cancelRecurring(\'' + order.id + '\')">Iptal Et</button>';
				}
				html += '</div>';

				html += '</div>';
			});

			listContainer.innerHTML = html;
		}

		function formatDateTurkish(dateStr) {
			var date = new Date(dateStr);
			var aylar = ['Ocak', 'Subat', 'Mart', 'Nisan', 'Mayis', 'Haziran', 'Temmuz', 'Agustos', 'Eylul', 'Ekim', 'Kasim', 'Aralik'];
			return date.getDate() + ' ' + aylar[date.getMonth()] + ' ' + date.getFullYear();
		}

		async function pauseRecurring(id) {
			if (!confirm('Bu rutin siparisi duraklatmak istediginizden emin misiniz?')) return;

			var result = await RecurringOrdersService.updateStatus(id, 'paused');
			if (result.error) {
				alert('Rutin siparis durdurulamadi');
			} else {
				loadRecurringOrders();
			}
		}

		async function resumeRecurring(id) {
			var result = await RecurringOrdersService.updateStatus(id, 'active');
			if (result.error) {
				alert('Rutin siparis devam ettirilemedi');
			} else {
				loadRecurringOrders();
			}
		}

		async function cancelRecurring(id) {
			if (!confirm('Bu rutin siparisi iptal etmek istediginizden emin misiniz? Bu islem geri alinamaz.')) return;

			var result = await RecurringOrdersService.updateStatus(id, 'cancelled');
			if (result.error) {
				alert('Rutin siparis iptal edilemedi');
			} else {
				loadRecurringOrders();
			}
		}
	</script>
</body>
</html>
