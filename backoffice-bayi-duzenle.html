<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayi Duzenle - Ipragaz Back Office</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bo-primary: #e31e24;
            --bo-primary-dark: #b91820;
            --bo-primary-light: #ff4444;
            --bo-sidebar-bg: #1a1a1a;
            --bo-sidebar-width: 260px;
            --bo-sidebar-collapsed: 72px;
            --bo-header-height: 64px;
            --bo-bg-main: #f5f5f5;
            --bo-bg-paper: #ffffff;
            --bo-text-primary: #262626;
            --bo-text-secondary: #525252;
            --bo-border: #e5e5e5;
            --bo-success: #10b981;
            --bo-warning: #f59e0b;
            --bo-error: #ef4444;
            --bo-info: #3b82f6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bo-bg-main);
            min-height: 100vh;
        }

        .bo-main-content {
            margin-left: var(--bo-sidebar-width);
            padding-top: var(--bo-header-height);
            min-height: 100vh;
            padding-bottom: 80px;
            transition: margin-left 0.3s ease;
        }

        .bo-main-content.sidebar-collapsed {
            margin-left: var(--bo-sidebar-collapsed);
        }

        .bo-content {
            padding: 24px;
            max-width: 900px;
        }

        /* Page Header */
        .bo-page-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .bo-back-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--bo-border);
            background: var(--bo-bg-paper);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--bo-text-secondary);
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .bo-back-btn:hover {
            border-color: var(--bo-primary);
            color: var(--bo-primary);
        }

        .bo-back-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .bo-page-header-content h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--bo-text-primary);
            margin-bottom: 4px;
        }

        .bo-page-header-content p {
            font-size: 14px;
            color: var(--bo-text-secondary);
        }

        /* Card */
        .bo-card {
            background: var(--bo-bg-paper);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* Tabs */
        .bo-tabs {
            display: flex;
            border-bottom: 1px solid var(--bo-border);
            padding: 0 24px;
        }

        .bo-tab {
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--bo-text-secondary);
            border: none;
            background: none;
            cursor: pointer;
            position: relative;
            transition: color 0.2s ease;
        }

        .bo-tab:hover {
            color: var(--bo-text-primary);
        }

        .bo-tab.active {
            color: var(--bo-primary);
        }

        .bo-tab.active::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 2px;
            background: var(--bo-primary);
        }

        .bo-tab-content {
            display: none;
            padding: 24px;
        }

        .bo-tab-content.active {
            display: block;
        }

        /* Form */
        .bo-form-section {
            margin-bottom: 32px;
        }

        .bo-form-section:last-child {
            margin-bottom: 0;
        }

        .bo-form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--bo-text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bo-form-section-title svg {
            width: 20px;
            height: 20px;
            stroke: var(--bo-primary);
            fill: none;
            stroke-width: 2;
        }

        .bo-form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .bo-form-row.single {
            grid-template-columns: 1fr;
        }

        @media (max-width: 768px) {
            .bo-form-row {
                grid-template-columns: 1fr;
            }
        }

        .bo-form-group {
            display: flex;
            flex-direction: column;
        }

        .bo-form-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--bo-text-primary);
            margin-bottom: 8px;
        }

        .bo-form-label .required {
            color: var(--bo-error);
            margin-left: 2px;
        }

        .bo-form-input,
        .bo-form-select,
        .bo-form-textarea {
            padding: 12px 14px;
            border: 1px solid var(--bo-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bo-bg-paper);
            transition: all 0.2s ease;
        }

        .bo-form-input:focus,
        .bo-form-select:focus,
        .bo-form-textarea:focus {
            outline: none;
            border-color: var(--bo-primary);
            box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
        }

        .bo-form-input::placeholder,
        .bo-form-textarea::placeholder {
            color: var(--bo-text-secondary);
        }

        .bo-form-input.error,
        .bo-form-select.error,
        .bo-form-textarea.error {
            border-color: var(--bo-error);
        }

        .bo-form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .bo-form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23525252' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        .bo-form-error {
            font-size: 12px;
            color: var(--bo-error);
            margin-top: 6px;
            display: none;
        }

        .bo-form-error.show {
            display: block;
        }

        .bo-form-hint {
            font-size: 12px;
            color: var(--bo-text-secondary);
            margin-top: 6px;
        }

        /* Checkbox / Toggle */
        .bo-form-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .bo-form-checkbox input {
            width: 20px;
            height: 20px;
            accent-color: var(--bo-primary);
            cursor: pointer;
        }

        .bo-form-checkbox span {
            font-size: 14px;
            color: var(--bo-text-primary);
        }

        /* Sticky Footer */
        .bo-form-footer {
            position: fixed;
            bottom: 0;
            left: var(--bo-sidebar-width);
            right: 0;
            background: var(--bo-bg-paper);
            border-top: 1px solid var(--bo-border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            transition: left 0.3s ease;
        }

        .bo-main-content.sidebar-collapsed ~ .bo-form-footer,
        .sidebar-collapsed .bo-form-footer {
            left: var(--bo-sidebar-collapsed);
        }

        .bo-form-footer-left {
            font-size: 13px;
            color: var(--bo-text-secondary);
        }

        .bo-form-footer-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bo-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .bo-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .bo-btn-primary {
            background: var(--bo-primary);
            color: #ffffff;
        }

        .bo-btn-primary:hover {
            background: var(--bo-primary-dark);
        }

        .bo-btn-primary:disabled {
            background: var(--bo-text-secondary);
            cursor: not-allowed;
        }

        .bo-btn-secondary {
            background: var(--bo-bg-paper);
            color: var(--bo-text-primary);
            border: 1px solid var(--bo-border);
        }

        .bo-btn-secondary:hover {
            background: var(--bo-bg-main);
        }

        .bo-btn-danger {
            background: var(--bo-error);
            color: #ffffff;
        }

        .bo-btn-danger:hover {
            background: #dc2626;
        }

        /* Password change section */
        .bo-password-change {
            background: var(--bo-bg-main);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .bo-password-change-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--bo-text-primary);
        }

        .bo-password-change-toggle input {
            width: 18px;
            height: 18px;
            accent-color: var(--bo-primary);
        }

        .bo-password-change-fields {
            display: none;
            margin-top: 16px;
        }

        .bo-password-change-fields.show {
            display: block;
        }

        /* Loading */
        .bo-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .bo-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bo-border);
            border-top-color: var(--bo-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .bo-toast {
            position: fixed;
            bottom: 100px;
            right: 24px;
            padding: 16px 20px;
            background: var(--bo-text-primary);
            color: #ffffff;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 9999;
        }

        .bo-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .bo-toast.success { background: var(--bo-success); }
        .bo-toast.error { background: var(--bo-error); }

        .bo-toast svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        /* Confirm Modal */
        .bo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .bo-modal-overlay.show {
            display: flex;
        }

        .bo-modal {
            background: var(--bo-bg-paper);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .bo-modal h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--bo-text-primary);
            margin-bottom: 12px;
        }

        .bo-modal p {
            font-size: 14px;
            color: var(--bo-text-secondary);
            margin-bottom: 24px;
        }

        .bo-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Mikro Pazar Styles */
        .mikro-pazar-info {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .mikro-pazar-info svg {
            width: 20px;
            height: 20px;
            stroke: var(--bo-info);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .mikro-pazar-info p {
            font-size: 13px;
            color: var(--bo-text-secondary);
            line-height: 1.5;
        }

        .mikro-pazar-city-info {
            background: var(--bo-bg-main);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mikro-pazar-city-info span {
            font-size: 14px;
            color: var(--bo-text-secondary);
        }

        .mikro-pazar-city-info strong {
            color: var(--bo-text-primary);
        }

        .mikro-pazar-city-info a {
            color: var(--bo-primary);
            font-size: 13px;
            margin-left: auto;
        }

        .mikro-pazar-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .mikro-pazar-search {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .mikro-pazar-search input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--bo-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .mikro-pazar-search input:focus {
            outline: none;
            border-color: var(--bo-primary);
        }

        .mikro-pazar-search svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            stroke: var(--bo-text-secondary);
            fill: none;
            stroke-width: 2;
        }

        .mikro-pazar-counter {
            background: var(--bo-primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .mikro-pazar-actions {
            display: flex;
            gap: 8px;
        }

        .mikro-pazar-actions button {
            padding: 8px 12px;
            border: 1px solid var(--bo-border);
            background: var(--bo-bg-paper);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mikro-pazar-actions button:hover {
            background: var(--bo-bg-main);
        }

        .mikro-pazar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding: 4px;
        }

        @media (max-width: 768px) {
            .mikro-pazar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .mikro-pazar-grid {
                grid-template-columns: 1fr;
            }
        }

        .mikro-pazar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid var(--bo-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mikro-pazar-item:hover {
            background: var(--bo-bg-main);
        }

        .mikro-pazar-item.selected {
            background: rgba(227, 30, 36, 0.08);
            border-color: var(--bo-primary);
            border-left-width: 3px;
        }

        .mikro-pazar-item.hidden {
            display: none;
        }

        .mikro-pazar-item input {
            width: 18px;
            height: 18px;
            accent-color: var(--bo-primary);
            cursor: pointer;
            flex-shrink: 0;
        }

        .mikro-pazar-item label {
            font-size: 14px;
            color: var(--bo-text-primary);
            cursor: pointer;
            flex: 1;
        }

        .mikro-pazar-empty {
            text-align: center;
            padding: 48px 24px;
            color: var(--bo-text-secondary);
        }

        .mikro-pazar-empty svg {
            width: 48px;
            height: 48px;
            stroke: var(--bo-border);
            fill: none;
            stroke-width: 1.5;
            margin-bottom: 16px;
        }

        .mikro-pazar-empty h4 {
            font-size: 16px;
            font-weight: 500;
            color: var(--bo-text-primary);
            margin-bottom: 8px;
        }

        .mikro-pazar-empty p {
            font-size: 14px;
        }

        .mikro-pazar-empty a {
            color: var(--bo-primary);
            text-decoration: none;
        }

        .mikro-pazar-empty a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="bo-loading-overlay" id="loadingOverlay">
        <div class="bo-loading-spinner"></div>
    </div>

    <!-- Sidebar -->
    <div id="backoffice-sidebar"></div>

    <!-- Main Content -->
    <main class="bo-main-content">
        <!-- Header -->
        <div id="backoffice-header"></div>

        <!-- Page Content -->
        <div class="bo-content">
            <!-- Page Header -->
            <div class="bo-page-header">
                <a href="backoffice-bayi-listesi.html" class="bo-back-btn">
                    <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </a>
                <div class="bo-page-header-content">
                    <h1>Bayi Duzenle</h1>
                    <p id="dealerSubtitle">Bayi bilgilerini guncelleyin</p>
                </div>
            </div>

            <!-- Form Card -->
            <div class="bo-card">
                <!-- Tabs -->
                <div class="bo-tabs">
                    <button class="bo-tab active" onclick="switchTab('general')">Genel Bilgiler</button>
                    <button class="bo-tab" onclick="switchTab('contact')">Iletisim</button>
                    <button class="bo-tab" onclick="switchTab('login')">Giris Bilgileri</button>
                    <button class="bo-tab" onclick="switchTab('mikropazar')">Mikro Pazar</button>
                </div>

                <form id="dealerForm" onsubmit="handleSubmit(event)">
                    <input type="hidden" id="dealerId" name="dealerId">

                    <!-- Tab 1: Genel Bilgiler -->
                    <div class="bo-tab-content active" id="tab-general">
                        <div class="bo-form-section">
                            <div class="bo-form-section-title">
                                <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                Bayi Bilgileri
                            </div>

                            <div class="bo-form-row">
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Bayi Kodu</label>
                                    <input type="text" class="bo-form-input" id="code" name="code" readonly style="background: #f5f5f5;">
                                    <span class="bo-form-hint">Bayi kodu degistirilemez</span>
                                </div>
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Bayi Adi <span class="required">*</span></label>
                                    <input type="text" class="bo-form-input" id="name" name="name" placeholder="Ornek: Marmara LPG" required>
                                    <span class="bo-form-error" id="name-error">Bayi adi zorunludur</span>
                                </div>
                            </div>

                            <div class="bo-form-row">
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Yetkili Adi <span class="required">*</span></label>
                                    <input type="text" class="bo-form-input" id="owner_name" name="owner_name" placeholder="Ornek: Ahmet Yilmaz" required>
                                    <span class="bo-form-error" id="owner_name-error">Yetkili adi zorunludur</span>
                                </div>
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Vergi Dairesi</label>
                                    <input type="text" class="bo-form-input" id="tax_office" name="tax_office" placeholder="Ornek: Kadikoy">
                                </div>
                            </div>

                            <div class="bo-form-row">
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Vergi No</label>
                                    <input type="text" class="bo-form-input" id="tax_number" name="tax_number" placeholder="Ornek: 1234567890">
                                </div>
                            </div>

                            <div class="bo-form-row single">
                                <div class="bo-form-group">
                                    <label class="bo-form-checkbox">
                                        <input type="checkbox" id="is_active" name="is_active">
                                        <span>Bayi aktif</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 2: Iletisim -->
                    <div class="bo-tab-content" id="tab-contact">
                        <div class="bo-form-section">
                            <div class="bo-form-section-title">
                                <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                Iletisim Bilgileri
                            </div>

                            <div class="bo-form-row">
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Telefon <span class="required">*</span></label>
                                    <input type="tel" class="bo-form-input" id="phone" name="phone" placeholder="Ornek: 05XX XXX XX XX" required>
                                    <span class="bo-form-error" id="phone-error">Gecerli bir telefon numarasi giriniz</span>
                                </div>
                                <div class="bo-form-group">
                                    <label class="bo-form-label">E-posta</label>
                                    <input type="email" class="bo-form-input" id="email" name="email" placeholder="Ornek: bayi@email.com">
                                    <span class="bo-form-error" id="email-error">Gecerli bir e-posta adresi giriniz</span>
                                </div>
                            </div>
                        </div>

                        <div class="bo-form-section">
                            <div class="bo-form-section-title">
                                <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                Adres Bilgileri
                            </div>

                            <div class="bo-form-row">
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Il <span class="required">*</span></label>
                                    <select class="bo-form-select" id="city" name="city" required onchange="loadDistricts()">
                                        <option value="">Il seciniz</option>
                                    </select>
                                    <span class="bo-form-error" id="city-error">Il secimi zorunludur</span>
                                </div>
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Ilce <span class="required">*</span></label>
                                    <select class="bo-form-select" id="district" name="district" required>
                                        <option value="">Ilce seciniz</option>
                                    </select>
                                    <span class="bo-form-error" id="district-error">Ilce secimi zorunludur</span>
                                </div>
                            </div>

                            <div class="bo-form-row single">
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Acik Adres</label>
                                    <textarea class="bo-form-textarea" id="address" name="address" placeholder="Sokak, mahalle, bina no vb."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 3: Giris Bilgileri -->
                    <div class="bo-tab-content" id="tab-login">
                        <div class="bo-form-section">
                            <div class="bo-form-section-title">
                                <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                Giris Bilgileri
                            </div>

                            <div class="bo-form-row single">
                                <div class="bo-form-group">
                                    <label class="bo-form-label">Kullanici Adi <span class="required">*</span></label>
                                    <input type="text" class="bo-form-input" id="username" name="username" placeholder="Ornek: marmara_lpg" required>
                                    <span class="bo-form-hint">Sadece kucuk harf ve alt cizgi kullanabilirsiniz</span>
                                    <span class="bo-form-error" id="username-error">Kullanici adi zorunludur</span>
                                </div>
                            </div>

                            <div class="bo-password-change">
                                <label class="bo-password-change-toggle">
                                    <input type="checkbox" id="changePassword" onchange="togglePasswordFields()">
                                    <span>Sifreyi degistir</span>
                                </label>

                                <div class="bo-password-change-fields" id="passwordFields">
                                    <div class="bo-form-row">
                                        <div class="bo-form-group">
                                            <label class="bo-form-label">Yeni Sifre</label>
                                            <input type="password" class="bo-form-input" id="password" name="password" placeholder="En az 6 karakter" minlength="6">
                                            <span class="bo-form-error" id="password-error">Sifre en az 6 karakter olmalidir</span>
                                        </div>
                                        <div class="bo-form-group">
                                            <label class="bo-form-label">Sifre Tekrar</label>
                                            <input type="password" class="bo-form-input" id="password_confirm" name="password_confirm" placeholder="Sifreyi tekrar giriniz">
                                            <span class="bo-form-error" id="password_confirm-error">Sifreler eslesmeli</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 4: Mikro Pazar -->
                    <div class="bo-tab-content" id="tab-mikropazar">
                        <div class="bo-form-section">
                            <div class="bo-form-section-title">
                                <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                Mikro Pazar Yonetimi
                            </div>

                            <!-- Info Banner -->
                            <div class="mikro-pazar-info">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                                <p>Bayinizin hizmet verebilecegi ek ilceleri secin. Sectiginiz ilcelerdeki musteriler siparis ekraninda bayinizi gorebilecek ve tercih edebilecek.</p>
                            </div>

                            <!-- City Info -->
                            <div class="mikro-pazar-city-info" id="mikroPazarCityInfo">
                                <span>Sehir: <strong id="mikroPazarCityName">Secilmedi</strong></span>
                                <a href="#" onclick="switchTab('contact'); return false;">Degistir</a>
                            </div>

                            <!-- Districts Container -->
                            <div id="mikroPazarContainer">
                                <!-- Empty State (shown when no city selected) -->
                                <div class="mikro-pazar-empty" id="mikroPazarEmpty">
                                    <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                    <h4>Sehir Secilmedi</h4>
                                    <p>Mikro pazar tanimlamak icin once <a href="#" onclick="switchTab('contact'); return false;">Iletisim</a> tab'indan sehir secin.</p>
                                </div>

                                <!-- Districts Grid (shown when city selected) -->
                                <div id="mikroPazarContent" style="display: none;">
                                    <!-- Toolbar -->
                                    <div class="mikro-pazar-toolbar">
                                        <div class="mikro-pazar-search">
                                            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                            <input type="text" placeholder="Ilce ara..." id="mikroPazarSearch" oninput="filterMikroPazarDistricts()">
                                        </div>
                                        <span class="mikro-pazar-counter"><span id="mikroPazarCount">0</span> ilce secildi</span>
                                        <div class="mikro-pazar-actions">
                                            <button type="button" onclick="selectAllMikroPazar()">Tumunu Sec</button>
                                            <button type="button" onclick="clearAllMikroPazar()">Temizle</button>
                                        </div>
                                    </div>

                                    <!-- Districts Grid -->
                                    <div class="mikro-pazar-grid" id="mikroPazarGrid">
                                        <!-- Districts will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Sticky Footer -->
    <div class="bo-form-footer">
        <div class="bo-form-footer-left" id="lastUpdated">
            Son guncelleme: -
        </div>
        <div class="bo-form-footer-right">
            <button type="button" class="bo-btn bo-btn-danger" onclick="confirmDelete()">
                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                Sil
            </button>
            <a href="backoffice-bayi-listesi.html" class="bo-btn bo-btn-secondary">Iptal</a>
            <button type="submit" form="dealerForm" class="bo-btn bo-btn-primary" id="submitBtn">
                <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                <span id="submitBtnText">Guncelle</span>
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div class="bo-toast" id="toast">
        <svg viewBox="0 0 24 24" id="toastIcon"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        <span id="toastMessage">Islem basarili</span>
    </div>

    <!-- Confirm Modal -->
    <div class="bo-modal-overlay" id="confirmModal">
        <div class="bo-modal">
            <h3>Bayi Sil</h3>
            <p>Bu bayiyi silmek istediginize emin misiniz? Bu islemi geri alamazsiniz.</p>
            <div class="bo-modal-actions">
                <button class="bo-btn bo-btn-secondary" onclick="closeModal()">Iptal</button>
                <button class="bo-btn bo-btn-danger" onclick="deleteDealer()">Sil</button>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/services/dealers-service.js"></script>
    <script src="js/services/locations-service.js"></script>
    <script src="js/services/dealer-districts-service.js"></script>

    <script>
        var currentDealer = null;
        var mikroPazarDistricts = [];
        var selectedMikroPazarIds = [];

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.bo-tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.bo-tab-content').forEach(function(content) {
                content.classList.remove('active');
            });

            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Toggle password fields
        function togglePasswordFields() {
            var checkbox = document.getElementById('changePassword');
            var fields = document.getElementById('passwordFields');

            if (checkbox.checked) {
                fields.classList.add('show');
            } else {
                fields.classList.remove('show');
                document.getElementById('password').value = '';
                document.getElementById('password_confirm').value = '';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', async function() {
            var adminId = sessionStorage.getItem('backoffice_admin_id');
            if (!adminId) {
                window.location.href = 'backoffice-login.html';
                return;
            }

            // Get dealer ID from URL
            var urlParams = new URLSearchParams(window.location.search);
            var dealerId = urlParams.get('id');

            if (!dealerId) {
                window.location.href = 'backoffice-bayi-listesi.html';
                return;
            }

            await loadComponents();

            if (typeof setPageName === 'function') {
                setPageName('Bayi Duzenle');
            }

            await loadCities();
            await loadDealer(dealerId);
        });

        // Load components
        async function loadComponents() {
            try {
                var sidebarResponse = await fetch('components/backoffice-sidebar.html');
                var sidebarHtml = await sidebarResponse.text();
                document.getElementById('backoffice-sidebar').innerHTML = sidebarHtml;

                var headerResponse = await fetch('components/backoffice-header.html');
                var headerHtml = await headerResponse.text();
                document.getElementById('backoffice-header').innerHTML = headerHtml;

                executeScripts(document.getElementById('backoffice-sidebar'));
                executeScripts(document.getElementById('backoffice-header'));
            } catch (error) {
                console.error('Component load error:', error);
            }
        }

        function executeScripts(container) {
            var scripts = container.querySelectorAll('script');
            scripts.forEach(function(script) {
                var newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript);
            });
        }

        // Load dealer data
        async function loadDealer(dealerId) {
            try {
                var result = await DealersService.getById(dealerId);

                if (result.error || !result.data) {
                    showToast('Bayi bulunamadi', 'error');
                    setTimeout(function() {
                        window.location.href = 'backoffice-bayi-listesi.html';
                    }, 1500);
                    return;
                }

                currentDealer = result.data;

                // Fill form
                document.getElementById('dealerId').value = currentDealer.id;
                document.getElementById('code').value = currentDealer.code || '';
                document.getElementById('name').value = currentDealer.name || '';
                document.getElementById('owner_name').value = currentDealer.owner_name || '';
                document.getElementById('tax_office').value = currentDealer.tax_office || '';
                document.getElementById('tax_number').value = currentDealer.tax_number || '';
                document.getElementById('phone').value = currentDealer.phone || '';
                document.getElementById('email').value = currentDealer.email || '';
                document.getElementById('address').value = currentDealer.address || '';
                document.getElementById('username').value = currentDealer.username || '';
                document.getElementById('is_active').checked = currentDealer.is_active !== false;

                // Set city and load districts
                if (currentDealer.city) {
                    document.getElementById('city').value = currentDealer.city;

                    // Once mevcut Mikro Pazar ilcelerini yukle
                    await loadExistingMikroPazarDistricts(currentDealer.id);

                    // Sonra ilceleri yukle (preserveSelection = true)
                    await loadDistricts(true);

                    if (currentDealer.district) {
                        document.getElementById('district').value = currentDealer.district;
                    }
                }

                // Update subtitle
                document.getElementById('dealerSubtitle').textContent = currentDealer.name;

                // Update last updated
                if (currentDealer.updated_at) {
                    var date = new Date(currentDealer.updated_at);
                    document.getElementById('lastUpdated').textContent = 'Son guncelleme: ' + date.toLocaleString('tr-TR');
                }

                // Hide loading
                document.getElementById('loadingOverlay').style.display = 'none';

            } catch (error) {
                console.error('Load dealer error:', error);
                showToast('Bir hata olustu', 'error');
            }
        }

        // Load cities
        async function loadCities() {
            var citySelect = document.getElementById('city');
            citySelect.innerHTML = '<option value="">Yukleniyor...</option>';

            try {
                if (typeof LocationsService !== 'undefined') {
                    var result = await LocationsService.getCities();
                    if (result.data) {
                        citySelect.innerHTML = '<option value="">Il seciniz</option>';
                        result.data.forEach(function(city) {
                            citySelect.innerHTML += '<option value="' + city.name + '" data-id="' + city.id + '">' + city.name + '</option>';
                        });
                        return;
                    }
                }
            } catch (e) {
                console.warn('LocationsService not available');
            }

            // Fallback
            var cities = ['Istanbul', 'Ankara', 'Izmir', 'Bursa', 'Antalya', 'Adana', 'Konya', 'Gaziantep', 'Mersin', 'Kayseri'];
            citySelect.innerHTML = '<option value="">Il seciniz</option>';
            cities.forEach(function(city) {
                citySelect.innerHTML += '<option value="' + city + '">' + city + '</option>';
            });
        }

        // Load districts
        async function loadDistricts(preserveSelection) {
            var citySelect = document.getElementById('city');
            var districtSelect = document.getElementById('district');
            var selectedOption = citySelect.options[citySelect.selectedIndex];
            var cityId = selectedOption ? selectedOption.getAttribute('data-id') : null;

            districtSelect.innerHTML = '<option value="">Yukleniyor...</option>';

            if (!citySelect.value) {
                districtSelect.innerHTML = '<option value="">Ilce seciniz</option>';
                loadMikroPazarDistricts(null, citySelect.value, false);
                return;
            }

            try {
                if (typeof LocationsService !== 'undefined' && cityId) {
                    var result = await LocationsService.getDistricts(cityId);
                    if (result.data) {
                        districtSelect.innerHTML = '<option value="">Ilce seciniz</option>';
                        result.data.forEach(function(district) {
                            districtSelect.innerHTML += '<option value="' + district.name + '" data-id="' + district.id + '">' + district.name + '</option>';
                        });
                        // Mikro Pazar'i guncelle
                        loadMikroPazarDistricts(cityId, citySelect.value, preserveSelection);
                        return;
                    }
                }
            } catch (e) {
                console.warn('LocationsService districts not available');
            }

            districtSelect.innerHTML = '<option value="">Ilce seciniz</option>';
            loadMikroPazarDistricts(null, citySelect.value, false);
        }

        // Validate form
        function validateForm() {
            var isValid = true;

            // Clear previous errors
            document.querySelectorAll('.bo-form-error').forEach(function(el) {
                el.classList.remove('show');
            });
            document.querySelectorAll('.bo-form-input, .bo-form-select').forEach(function(el) {
                el.classList.remove('error');
            });

            // Required fields
            var requiredFields = ['name', 'owner_name', 'phone', 'city', 'district', 'username'];
            requiredFields.forEach(function(fieldId) {
                var field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('error');
                    document.getElementById(fieldId + '-error').classList.add('show');
                    isValid = false;
                }
            });

            // Email validation
            var email = document.getElementById('email');
            if (email.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
                email.classList.add('error');
                document.getElementById('email-error').classList.add('show');
                isValid = false;
            }

            // Password validation (only if changing password)
            if (document.getElementById('changePassword').checked) {
                var password = document.getElementById('password').value;
                var passwordConfirm = document.getElementById('password_confirm').value;

                if (password.length < 6) {
                    document.getElementById('password').classList.add('error');
                    document.getElementById('password-error').classList.add('show');
                    isValid = false;
                }

                if (password !== passwordConfirm) {
                    document.getElementById('password_confirm').classList.add('error');
                    document.getElementById('password_confirm-error').classList.add('show');
                    isValid = false;
                }
            }

            return isValid;
        }

        // SHA-256 hash fonksiyonu
        async function sha256(message) {
            var msgBuffer = new TextEncoder().encode(message);
            var hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            var hashArray = Array.from(new Uint8Array(hashBuffer));
            var hashHex = hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
            return hashHex;
        }

        // Handle form submit
        async function handleSubmit(e) {
            e.preventDefault();

            if (!validateForm()) {
                showToast('Lutfen tum zorunlu alanlari doldurun', 'error');
                return;
            }

            var submitBtn = document.getElementById('submitBtn');
            var submitBtnText = document.getElementById('submitBtnText');

            submitBtn.disabled = true;
            submitBtnText.textContent = 'Kaydediliyor...';

            try {
                var dealerData = {
                    name: document.getElementById('name').value.trim(),
                    owner_name: document.getElementById('owner_name').value.trim(),
                    tax_office: document.getElementById('tax_office').value.trim() || null,
                    tax_number: document.getElementById('tax_number').value.trim() || null,
                    phone: document.getElementById('phone').value.trim(),
                    email: document.getElementById('email').value.trim() || null,
                    city: document.getElementById('city').value,
                    district: document.getElementById('district').value,
                    address: document.getElementById('address').value.trim() || null,
                    username: document.getElementById('username').value.trim(),
                    is_active: document.getElementById('is_active').checked
                };

                // Add password_hash if changing
                if (document.getElementById('changePassword').checked) {
                    dealerData.password_hash = await sha256(document.getElementById('password').value);
                }

                var result = await DealersService.update(currentDealer.id, dealerData);

                if (result.error) {
                    showToast('Hata: ' + result.error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtnText.textContent = 'Guncelle';
                    return;
                }

                // Mikro Pazar ilcelerini kaydet
                try {
                    var mikroResult = await DealerDistrictsService.syncDealerDistricts(currentDealer.id, selectedMikroPazarIds);
                    if (mikroResult.error) {
                        console.warn('Mikro Pazar kayit hatasi:', mikroResult.error);
                    }
                } catch (mikroError) {
                    console.warn('Mikro Pazar kayit hatasi:', mikroError);
                }

                showToast('Bayi basariyla guncellendi', 'success');

                setTimeout(function() {
                    window.location.href = 'backoffice-bayi-listesi.html';
                }, 1500);

            } catch (error) {
                console.error('Submit error:', error);
                showToast('Bir hata olustu', 'error');
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Guncelle';
            }
        }

        // Confirm delete
        function confirmDelete() {
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }

        async function deleteDealer() {
            closeModal();

            try {
                var result = await DealersService.deactivate(currentDealer.id);

                if (result.error) {
                    showToast('Hata: ' + result.error.message, 'error');
                    return;
                }

                showToast('Bayi silindi', 'success');

                setTimeout(function() {
                    window.location.href = 'backoffice-bayi-listesi.html';
                }, 1500);

            } catch (error) {
                console.error('Delete error:', error);
                showToast('Bir hata olustu', 'error');
            }
        }

        // Toast
        function showToast(message, type) {
            var toast = document.getElementById('toast');
            var toastMessage = document.getElementById('toastMessage');
            var toastIcon = document.getElementById('toastIcon');

            toastMessage.textContent = message;
            toast.className = 'bo-toast ' + (type || '');

            if (type === 'success') {
                toastIcon.innerHTML = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>';
            } else if (type === 'error') {
                toastIcon.innerHTML = '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>';
            }

            toast.classList.add('show');
            setTimeout(function() {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==========================================
        // MIKRO PAZAR FUNCTIONS
        // ==========================================

        // Mevcut Mikro Pazar ilcelerini yukle
        async function loadExistingMikroPazarDistricts(dealerId) {
            try {
                if (typeof DealerDistrictsService !== 'undefined') {
                    var result = await DealerDistrictsService.getDistrictIds(dealerId);
                    if (result.data) {
                        selectedMikroPazarIds = result.data;
                        return;
                    }
                }
            } catch (e) {
                console.warn('Mevcut Mikro Pazar ilceleri yuklenemedi:', e);
            }
            selectedMikroPazarIds = [];
        }

        // Mikro Pazar ilcelerini yukle
        async function loadMikroPazarDistricts(cityId, cityName, preserveSelection) {
            var cityInfo = document.getElementById('mikroPazarCityName');
            var emptyState = document.getElementById('mikroPazarEmpty');
            var content = document.getElementById('mikroPazarContent');

            // Sehir ismini guncelle
            cityInfo.textContent = cityName || 'Secilmedi';

            // Sehir secilmemisse empty state goster
            if (!cityId) {
                emptyState.style.display = 'block';
                content.style.display = 'none';
                mikroPazarDistricts = [];
                if (!preserveSelection) {
                    selectedMikroPazarIds = [];
                }
                updateMikroPazarCount();
                return;
            }

            // Ilceleri yukle
            try {
                if (typeof LocationsService !== 'undefined') {
                    var result = await LocationsService.getDistricts(cityId);
                    if (result.data) {
                        mikroPazarDistricts = result.data;

                        // Empty state'i gizle, content'i goster
                        emptyState.style.display = 'none';
                        content.style.display = 'block';

                        // Grid'i olustur
                        renderMikroPazarGrid();
                        updateMikroPazarCount();
                        return;
                    }
                }
            } catch (e) {
                console.warn('Mikro Pazar ilceleri yuklenemedi:', e);
            }

            // Hata durumunda empty state
            emptyState.style.display = 'block';
            content.style.display = 'none';
        }

        // Mikro Pazar grid'ini render et
        function renderMikroPazarGrid() {
            var grid = document.getElementById('mikroPazarGrid');
            grid.innerHTML = '';

            mikroPazarDistricts.forEach(function(district) {
                var isSelected = selectedMikroPazarIds.indexOf(district.id) !== -1;
                var item = document.createElement('div');
                item.className = 'mikro-pazar-item' + (isSelected ? ' selected' : '');
                item.setAttribute('data-id', district.id);
                item.setAttribute('data-name', district.name.toLowerCase());
                item.onclick = function() { toggleMikroPazarDistrict(district.id); };

                item.innerHTML = '<input type="checkbox" ' + (isSelected ? 'checked' : '') + ' onclick="event.stopPropagation(); toggleMikroPazarDistrict(\'' + district.id + '\');">' +
                    '<label>' + district.name + '</label>';

                grid.appendChild(item);
            });
        }

        // Ilce sec/kaldir
        function toggleMikroPazarDistrict(districtId) {
            var index = selectedMikroPazarIds.indexOf(districtId);
            if (index === -1) {
                selectedMikroPazarIds.push(districtId);
            } else {
                selectedMikroPazarIds.splice(index, 1);
            }

            // UI'i guncelle
            var item = document.querySelector('.mikro-pazar-item[data-id="' + districtId + '"]');
            if (item) {
                var checkbox = item.querySelector('input[type="checkbox"]');
                if (index === -1) {
                    item.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                } else {
                    item.classList.remove('selected');
                    if (checkbox) checkbox.checked = false;
                }
            }

            updateMikroPazarCount();
        }

        // Tum ilceleri sec
        function selectAllMikroPazar() {
            selectedMikroPazarIds = mikroPazarDistricts.map(function(d) { return d.id; });
            renderMikroPazarGrid();
            updateMikroPazarCount();
        }

        // Tum secimi temizle
        function clearAllMikroPazar() {
            selectedMikroPazarIds = [];
            renderMikroPazarGrid();
            updateMikroPazarCount();
        }

        // Ilce ara
        function filterMikroPazarDistricts() {
            var searchTerm = document.getElementById('mikroPazarSearch').value.toLowerCase().trim();
            var items = document.querySelectorAll('.mikro-pazar-item');

            items.forEach(function(item) {
                var name = item.getAttribute('data-name');
                if (!searchTerm || name.indexOf(searchTerm) !== -1) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // Secili ilce sayisini guncelle
        function updateMikroPazarCount() {
            var countEl = document.getElementById('mikroPazarCount');
            countEl.textContent = selectedMikroPazarIds.length;
        }
    </script>
</body>
</html>
