<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bayi Seçimi - İpragaz</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			min-height: 100vh;
			background-color: #e31e24;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			overflow: hidden;
		}

		/* B Pattern Background */
		.bg-pattern {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			pointer-events: none;
		}

		.bg-pattern::before {
			content: 'B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B';
			position: absolute;
			top: -50px;
			left: -50px;
			width: calc(100% + 100px);
			height: calc(100% + 100px);
			font-size: 80px;
			font-weight: 700;
			color: rgba(255, 255, 255, 0.08);
			word-spacing: 30px;
			line-height: 1.2;
			letter-spacing: 20px;
			word-break: break-all;
		}

		/* Card Container */
		.dealer-container {
			position: relative;
			z-index: 1;
			width: 100%;
			max-width: 480px;
			padding: 20px;
		}

		.dealer-card {
			background: #fff;
			border-radius: 12px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
			display: flex;
			flex-direction: column;
			max-height: 90vh;
		}

		/* Card Header */
		.card-header {
			padding: 30px 30px 20px;
			flex-shrink: 0;
		}

		/* Logo */
		.logo {
			text-align: center;
			margin-bottom: 20px;
		}

		.logo svg {
			width: 140px;
			height: auto;
		}

		/* Title */
		.card-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 8px;
		}

		.card-subtitle {
			font-size: 14px;
			color: #666;
			line-height: 1.5;
		}

		.card-subtitle .location {
			color: #e31e24;
			font-weight: 600;
		}

		/* Card Body - Scrollable */
		.card-body {
			flex: 1;
			overflow-y: auto;
			padding: 0 30px 20px;
			max-height: 400px;
		}

		.card-body::-webkit-scrollbar {
			width: 5px;
		}

		.card-body::-webkit-scrollbar-track {
			background: #f1f1f1;
			border-radius: 3px;
		}

		.card-body::-webkit-scrollbar-thumb {
			background: #ccc;
			border-radius: 3px;
		}

		.card-body::-webkit-scrollbar-thumb:hover {
			background: #bbb;
		}

		/* Dealer List */
		.dealer-list {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.dealer-item {
			border: 2px solid #eee;
			border-radius: 10px;
			padding: 16px;
			cursor: pointer;
			transition: all 0.2s;
			position: relative;
		}

		.dealer-item:hover {
			border-color: #e31e24;
			background-color: #fff9f9;
		}

		.dealer-item.selected {
			border-color: #e31e24;
			background-color: #fff5f5;
		}

		.dealer-item.selected::before {
			content: '';
			position: absolute;
			top: 16px;
			right: 16px;
			width: 20px;
			height: 20px;
			background: #e31e24;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.dealer-item.selected::after {
			content: '';
			position: absolute;
			top: 21px;
			right: 24px;
			width: 6px;
			height: 10px;
			border: solid white;
			border-width: 0 2px 2px 0;
			transform: rotate(45deg);
		}

		.dealer-radio {
			position: absolute;
			top: 18px;
			right: 18px;
			width: 18px;
			height: 18px;
			border: 2px solid #ddd;
			border-radius: 50%;
			background: #fff;
		}

		.dealer-item.selected .dealer-radio {
			display: none;
		}

		.dealer-name {
			font-size: 15px;
			font-weight: 600;
			color: #333;
			margin-bottom: 8px;
			padding-right: 30px;
		}

		.dealer-info {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		.dealer-info-row {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 13px;
			color: #666;
		}

		.dealer-info-row svg {
			width: 14px;
			height: 14px;
			color: #999;
			flex-shrink: 0;
		}

		/* Empty State */
		.empty-state {
			text-align: center;
			padding: 40px 20px;
		}

		.empty-icon {
			width: 64px;
			height: 64px;
			margin: 0 auto 16px;
			background: #fff3f3;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.empty-icon svg {
			width: 32px;
			height: 32px;
			color: #e31e24;
		}

		.empty-title {
			font-size: 16px;
			font-weight: 600;
			color: #333;
			margin-bottom: 8px;
		}

		.empty-text {
			font-size: 14px;
			color: #666;
			line-height: 1.5;
			margin-bottom: 20px;
		}

		.btn-secondary {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 12px 24px;
			background: #f5f5f5;
			border: none;
			border-radius: 25px;
			color: #333;
			font-size: 14px;
			font-weight: 500;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s;
		}

		.btn-secondary:hover {
			background: #eee;
		}

		.btn-secondary svg {
			width: 16px;
			height: 16px;
		}

		/* Loading State */
		.loading-state {
			text-align: center;
			padding: 40px 20px;
		}

		.loading-spinner {
			width: 40px;
			height: 40px;
			border: 3px solid #eee;
			border-top-color: #e31e24;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
			margin: 0 auto 16px;
		}

		.loading-text {
			font-size: 14px;
			color: #666;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		/* Card Footer */
		.card-footer {
			padding: 20px 30px;
			border-top: 1px solid #eee;
			flex-shrink: 0;
			background: #fff;
			border-radius: 0 0 12px 12px;
		}

		/* Submit Button */
		.btn-submit {
			width: 100%;
			padding: 14px 20px;
			background: #c41e24;
			border: none;
			border-radius: 25px;
			color: #fff;
			font-size: 15px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s, transform 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
		}

		.btn-submit:hover {
			background: #a81a1f;
			transform: translateY(-1px);
		}

		.btn-submit:active {
			transform: translateY(0);
		}

		.btn-submit:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		.btn-submit svg {
			width: 18px;
			height: 18px;
		}

		/* Spinner */
		.spinner {
			width: 18px;
			height: 18px;
			border: 2px solid #fff;
			border-top-color: transparent;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}

		/* Responsive */
		@media (max-width: 480px) {
			.dealer-card {
				max-height: 95vh;
			}

			.card-header {
				padding: 25px 20px 15px;
			}

			.card-body {
				padding: 0 20px 15px;
				max-height: 320px;
			}

			.card-footer {
				padding: 15px 20px;
			}

			.logo svg {
				width: 120px;
			}

			.card-title {
				font-size: 16px;
			}

			.card-subtitle {
				font-size: 13px;
			}

			.bg-pattern::before {
				font-size: 50px;
			}
		}
	</style>
</head>
<body>
	<!-- Background Pattern -->
	<div class="bg-pattern"></div>

	<!-- Dealer Container -->
	<div class="dealer-container">
		<div class="dealer-card">
			<!-- Card Header -->
			<div class="card-header">
				<!-- Logo -->
				<div class="logo">
					<svg viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
						<circle cx="25" cy="25" r="20" fill="none" stroke="#e31e24" stroke-width="3"/>
						<path d="M25 10 L25 25" stroke="#e31e24" stroke-width="3" stroke-linecap="round"/>
						<text x="55" y="32" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#e31e24">iPRAGAZ</text>
					</svg>
				</div>

				<!-- Title -->
				<h1 class="card-title">Bayinizi Seçin</h1>
				<p class="card-subtitle">
					<span class="location" id="locationText"></span> bölgesinde size hizmet verecek bayiyi seçin.
				</p>
			</div>

			<!-- Card Body - Scrollable Dealer List -->
			<div class="card-body">
				<div id="dealerListContainer">
					<!-- Loading State -->
					<div class="loading-state" id="loadingState">
						<div class="loading-spinner"></div>
						<p class="loading-text">Bayiler yükleniyor...</p>
					</div>
				</div>
			</div>

			<!-- Card Footer -->
			<div class="card-footer" id="footerSection" style="display: none;">
				<button class="btn-submit" id="submitBtn" disabled>
					Devam Et
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M5 12h14M12 5l7 7-7 7"/>
					</svg>
				</button>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/customers-service.js"></script>

	<script>
		// Browser back engelleme
		window.history.pushState(null, null, window.location.href);
		window.addEventListener('popstate', function() {
			window.history.pushState(null, null, window.location.href);
		});

		// Session bilgilerini al
		var customerId = sessionStorage.getItem('isyerim_customer_id');
		var userCity = sessionStorage.getItem('isyerim_user_city');
		var userDistrict = sessionStorage.getItem('isyerim_user_district');

		// Kullanıcı kontrolü
		if (!customerId) {
			window.location.href = 'isyerim-musteri-login.html';
		}

		// Konum bilgisi kontrolü
		if (!userCity || !userDistrict) {
			// Konum bilgisi yoksa adres ekleme sayfasına yönlendir
			window.location.href = 'isyerim-musteri-adres-ekle.html';
		}

		// Seçilen bayi
		var selectedDealerId = null;

		// Sayfa yüklendiğinde
		document.addEventListener('DOMContentLoaded', function() {
			// Konum bilgisini göster
			document.getElementById('locationText').textContent = userDistrict + ', ' + userCity;

			// Bayileri yükle
			loadDealers();
		});

		// Bayileri yükle
		async function loadDealers() {
			var container = document.getElementById('dealerListContainer');
			var footer = document.getElementById('footerSection');

			try {
				var result = await DealersService.getByDistrict(userCity, userDistrict);

				if (result.error) {
					console.error('Bayi yükleme hatası:', result.error);
					showEmptyState('Bayiler yüklenirken bir hata oluştu.');
					return;
				}

				var dealers = result.data;

				if (!dealers || dealers.length === 0) {
					showEmptyState();
					return;
				}

				// Bayi listesini göster
				renderDealerList(dealers);
				footer.style.display = 'block';

			} catch (error) {
				console.error('Hata:', error);
				showEmptyState('Bayiler yüklenirken bir hata oluştu.');
			}
		}

		// Bayi listesini render et
		function renderDealerList(dealers) {
			var container = document.getElementById('dealerListContainer');

			var html = '<div class="dealer-list">';

			dealers.forEach(function(dealer) {
				html += '<div class="dealer-item" data-id="' + dealer.id + '" onclick="selectDealer(this, \'' + dealer.id + '\')">';
				html += '<div class="dealer-radio"></div>';
				html += '<div class="dealer-name">' + escapeHtml(dealer.name) + '</div>';
				html += '<div class="dealer-info">';
				html += '<div class="dealer-info-row">';
				html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>';
				html += '<span>' + escapeHtml(dealer.district) + ', ' + escapeHtml(dealer.city) + '</span>';
				html += '</div>';
				if (dealer.phone) {
					html += '<div class="dealer-info-row">';
					html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>';
					html += '<span>' + escapeHtml(dealer.phone) + '</span>';
					html += '</div>';
				}
				html += '</div>';
				html += '</div>';
			});

			html += '</div>';

			container.innerHTML = html;
		}

		// Boş durum göster
		function showEmptyState(message) {
			var container = document.getElementById('dealerListContainer');
			var footer = document.getElementById('footerSection');

			footer.style.display = 'none';

			container.innerHTML = '<div class="empty-state">' +
				'<div class="empty-icon">' +
				'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>' +
				'</div>' +
				'<h3 class="empty-title">Bölgenizde Bayi Bulunamadı</h3>' +
				'<p class="empty-text">' + (message || 'Maalesef ' + userDistrict + ', ' + userCity + ' bölgesinde aktif bayi bulunmamaktadır. Farklı bir adres ekleyerek tekrar deneyebilirsiniz.') + '</p>' +
				'<button class="btn-secondary" onclick="goToAddressPage()">' +
				'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>' +
				'Farklı Adres Ekle' +
				'</button>' +
				'</div>';
		}

		// Bayi seç
		function selectDealer(element, dealerId) {
			// Önceki seçimi kaldır
			var items = document.querySelectorAll('.dealer-item');
			items.forEach(function(item) {
				item.classList.remove('selected');
			});

			// Yeni seçimi işaretle
			element.classList.add('selected');
			selectedDealerId = dealerId;

			// Butonu aktif et
			document.getElementById('submitBtn').disabled = false;
		}

		// Adres sayfasına git
		function goToAddressPage() {
			window.location.href = 'isyerim-musteri-adres-ekle.html';
		}

		// HTML escape
		function escapeHtml(text) {
			if (!text) return '';
			var div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		// Form submit
		document.getElementById('submitBtn').addEventListener('click', async function(e) {
			e.preventDefault();

			if (!selectedDealerId) {
				alert('Lütfen bir bayi seçiniz.');
				return;
			}

			var btn = this;
			btn.disabled = true;
			btn.innerHTML = '<div class="spinner"></div> Kaydediliyor...';

			try {
				// Müşteriyi güncelle - dealer_id ekle
				var result = await CustomersService.update(customerId, {
					dealer_id: selectedDealerId
				});

				if (result.error) {
					console.error('Bayi kaydedilemedi:', result.error);
					alert('Bayi kaydedilemedi. Lütfen tekrar deneyiniz.');
					btn.disabled = false;
					btn.innerHTML = 'Devam Et <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
					return;
				}

				// SessionStorage'a bayi bilgisi kaydet
				sessionStorage.setItem('isyerim_dealer_id', selectedDealerId);

				// Anasayfaya yönlendir
				window.location.href = 'isyerim-musteri-anasayfa.html';

			} catch (error) {
				console.error('Hata:', error);
				alert('Bir hata oluştu. Lütfen tekrar deneyiniz.');
				btn.disabled = false;
				btn.innerHTML = 'Devam Et <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
			}
		});
	</script>
</body>
</html>
