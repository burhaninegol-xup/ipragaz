<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satis Raporu - Ipragaz Back Office</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bo-primary: #e31e24;
            --bo-primary-dark: #b91820;
            --bo-sidebar-width: 260px;
            --bo-sidebar-collapsed: 72px;
            --bo-header-height: 64px;
            --bo-bg-main: #f5f5f5;
            --bo-bg-paper: #ffffff;
            --bo-text-primary: #262626;
            --bo-text-secondary: #525252;
            --bo-border: #e5e5e5;
            --bo-success: #10b981;
            --bo-warning: #f59e0b;
            --bo-error: #ef4444;
            --bo-info: #3b82f6;
        }

        body { font-family: 'Poppins', sans-serif; background: var(--bo-bg-main); min-height: 100vh; }

        .bo-main-content {
            margin-left: var(--bo-sidebar-width);
            padding-top: var(--bo-header-height);
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        .bo-main-content.sidebar-collapsed { margin-left: var(--bo-sidebar-collapsed); }
        .bo-content { padding: 24px; max-width: 1400px; }

        /* Page Header */
        .bo-page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        .bo-page-header h1 { font-size: 24px; font-weight: 600; color: var(--bo-text-primary); margin-bottom: 4px; }
        .bo-page-header p { font-size: 14px; color: var(--bo-text-secondary); }

        /* Filter Bar */
        .bo-filter-bar {
            background: var(--bo-bg-paper);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex-wrap: wrap;
        }
        .bo-filter-group { flex: 1; min-width: 180px; }
        .bo-filter-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--bo-text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .bo-filter-select {
            width: 100%;
            height: 44px;
            padding: 0 16px;
            border: 1px solid var(--bo-border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            color: var(--bo-text-primary);
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23525252' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }
        .bo-filter-select:hover { border-color: #d4d4d4; }
        .bo-filter-select:focus { outline: none; border-color: var(--bo-primary); box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1); }
        .bo-filter-select:disabled { background-color: #f9f9f9; color: #a3a3a3; cursor: not-allowed; }
        .bo-filter-actions { display: flex; gap: 12px; }
        .bo-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 44px;
        }
        .bo-btn svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }
        .bo-btn-primary { background: var(--bo-primary); color: #fff; }
        .bo-btn-primary:hover { background: var(--bo-primary-dark); }
        .bo-btn-secondary { background: var(--bo-bg-paper); color: var(--bo-text-primary); border: 1px solid var(--bo-border); }
        .bo-btn-secondary:hover { background: var(--bo-bg-main); }

        /* Metrics Grid */
        .bo-metrics-primary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .bo-metrics-secondary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        @media (max-width: 1024px) {
            .bo-metrics-primary { grid-template-columns: 1fr; }
            .bo-metrics-secondary { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .bo-filter-bar { flex-direction: column; align-items: stretch; }
            .bo-filter-group { width: 100%; min-width: 100%; }
            .bo-filter-actions { width: 100%; flex-direction: column; }
            .bo-filter-actions .bo-btn { width: 100%; justify-content: center; }
        }

        /* Metric Card */
        .bo-metric-card {
            background: var(--bo-bg-paper);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .bo-metric-card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
        .bo-metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--bo-primary);
            border-radius: 12px 0 0 12px;
        }
        .bo-metric-card.secondary::before { background: var(--bo-text-secondary); }
        .bo-metric-card.success::before { background: var(--bo-success); }
        .bo-metric-card.info::before { background: var(--bo-info); }
        .bo-metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .bo-metric-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--bo-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .bo-metric-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(227, 30, 36, 0.1);
        }
        .bo-metric-icon svg { width: 22px; height: 22px; stroke: var(--bo-primary); fill: none; stroke-width: 2; }
        .bo-metric-icon.secondary { background: rgba(82, 82, 82, 0.1); }
        .bo-metric-icon.secondary svg { stroke: var(--bo-text-secondary); }
        .bo-metric-icon.success { background: rgba(16, 185, 129, 0.1); }
        .bo-metric-icon.success svg { stroke: var(--bo-success); }
        .bo-metric-icon.info { background: rgba(59, 130, 246, 0.1); }
        .bo-metric-icon.info svg { stroke: var(--bo-info); }
        .bo-metric-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--bo-text-primary);
            line-height: 1;
            margin-bottom: 8px;
        }
        .bo-metric-unit { font-size: 16px; font-weight: 500; color: var(--bo-text-secondary); margin-left: 4px; }
        .bo-metric-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        .bo-metric-change.positive { background: rgba(16, 185, 129, 0.1); color: #047857; }
        .bo-metric-change.negative { background: rgba(239, 68, 68, 0.1); color: #b91c1c; }
        .bo-metric-change.neutral { background: rgba(113, 113, 122, 0.1); color: #71717a; }
        .bo-metric-change svg { width: 14px; height: 14px; }
        .bo-metric-subtitle { font-size: 13px; color: var(--bo-text-secondary); margin-top: 4px; }

        /* Products Section */
        .bo-products-section {
            background: var(--bo-bg-paper);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        .bo-products-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--bo-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .bo-products-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--bo-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bo-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            background: var(--bo-primary);
            color: #fff;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Table */
        .bo-table { width: 100%; border-collapse: collapse; }
        .bo-table thead { background: #f9fafb; }
        .bo-table th {
            padding: 14px 24px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: var(--bo-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--bo-border);
        }
        .bo-table th:last-child { text-align: right; }
        .bo-table tbody tr { border-bottom: 1px solid var(--bo-border); transition: background 0.2s ease; }
        .bo-table tbody tr:hover { background: #f9fafb; }
        .bo-table tbody tr:last-child { border-bottom: none; }
        .bo-table td { padding: 16px 24px; font-size: 14px; color: var(--bo-text-primary); }
        .bo-table td:last-child { text-align: right; }
        .bo-product-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .bo-product-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #e31e24 0%, #b91820 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .bo-product-icon svg { width: 20px; height: 20px; stroke: #fff; fill: none; stroke-width: 2; }
        .bo-product-info { display: flex; flex-direction: column; gap: 2px; }
        .bo-product-name { font-weight: 500; color: var(--bo-text-primary); }
        .bo-product-code { font-size: 12px; color: var(--bo-text-secondary); }
        .bo-quantity-highlight {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            padding: 6px 12px;
            background: rgba(227, 30, 36, 0.08);
            color: var(--bo-primary);
            border-radius: 6px;
            font-weight: 600;
        }

        /* Empty State */
        .bo-empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        .bo-empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bo-empty-icon svg { width: 40px; height: 40px; stroke: var(--bo-text-secondary); opacity: 0.5; }
        .bo-empty-state h3 { font-size: 18px; font-weight: 600; color: var(--bo-text-primary); margin-bottom: 8px; }
        .bo-empty-state p { font-size: 14px; color: var(--bo-text-secondary); margin-bottom: 24px; }

        /* Loading */
        .bo-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px; }
        .bo-loading-spinner {
            width: 40px; height: 40px; border: 3px solid var(--bo-border);
            border-top-color: var(--bo-primary); border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .bo-loading-text { margin-top: 16px; color: var(--bo-text-secondary); font-size: 14px; }

        /* Skeleton Loading */
        .bo-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .bo-skeleton-value { width: 120px; height: 36px; margin-bottom: 8px; }
        .bo-skeleton-label { width: 80px; height: 14px; }

        /* Info State (Single Dealer Selected) */
        .bo-info-state {
            background: var(--bo-bg-paper);
            border-radius: 12px;
            padding: 48px 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .bo-info-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bo-info-icon svg { width: 64px; height: 64px; }
        .bo-info-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--bo-text-primary);
            margin-bottom: 8px;
        }
        .bo-info-description {
            font-size: 14px;
            color: var(--bo-text-secondary);
            line-height: 1.6;
            max-width: 400px;
            margin: 0 auto 24px;
        }

        /* Chart Widget */
        .bo-chart-widget {
            background: var(--bo-bg-paper);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .bo-chart-widget.hiding {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        .bo-chart-widget:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .bo-chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .bo-chart-title-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .bo-chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--bo-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }
        .bo-chart-subtitle {
            font-size: 13px;
            color: var(--bo-text-secondary);
            font-weight: 400;
            margin: 0;
        }
        .bo-chart-count-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            background: rgba(227, 30, 36, 0.08);
            color: var(--bo-primary);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .bo-chart-legend { display: flex; align-items: center; gap: 24px; }
        .bo-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--bo-text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        .bo-legend-item:hover { opacity: 0.7; }
        .bo-legend-item.inactive { opacity: 0.4; text-decoration: line-through; }
        .bo-legend-marker { width: 16px; height: 16px; border-radius: 3px; flex-shrink: 0; }
        .bo-legend-marker.bar { background: var(--bo-primary); }
        .bo-legend-marker.line { background: var(--bo-info); border-radius: 50%; }
        .bo-chart-container { position: relative; height: 400px; width: 100%; }
        @media (max-width: 1024px) {
            .bo-chart-container { height: 320px; }
            .bo-chart-header { flex-direction: column; align-items: flex-start; }
            .bo-chart-legend { width: 100%; justify-content: center; }
        }
        @media (max-width: 768px) {
            .bo-chart-container { height: 280px; }
            .bo-chart-widget { overflow-x: auto; overflow-y: hidden; }
            .bo-chart-legend { flex-direction: column; align-items: flex-start; gap: 12px; }
            .bo-legend-item { width: 100%; }
        }

        /* Multiselect Dropdown */
        .bo-multiselect {
            position: relative;
            width: 100%;
        }
        .bo-multiselect-trigger {
            width: 100%;
            height: 44px;
            padding: 0 16px;
            border: 1px solid var(--bo-border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            color: var(--bo-text-primary);
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .bo-multiselect-trigger:hover { border-color: #d4d4d4; }
        .bo-multiselect-trigger.active { border-color: var(--bo-primary); box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1); }
        .bo-multiselect-trigger svg {
            width: 16px;
            height: 16px;
            stroke: var(--bo-text-secondary);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }
        .bo-multiselect-trigger.active svg { transform: rotate(180deg); }
        .bo-multiselect-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: left;
        }
        .bo-multiselect-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--bo-primary);
            color: #fff;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .bo-multiselect-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            width: 100%;
            min-width: 280px;
            background: #fff;
            border: 1px solid var(--bo-border);
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            max-height: 350px;
            overflow: hidden;
            flex-direction: column;
        }
        .bo-multiselect-dropdown.open { display: flex; }
        .bo-multiselect-search {
            padding: 12px;
            border-bottom: 1px solid var(--bo-border);
        }
        .bo-multiselect-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--bo-border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            color: var(--bo-text-primary);
            transition: all 0.2s ease;
        }
        .bo-multiselect-search input:focus {
            outline: none;
            border-color: var(--bo-primary);
            box-shadow: 0 0 0 2px rgba(227, 30, 36, 0.1);
        }
        .bo-multiselect-options {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
            max-height: 220px;
        }
        .bo-multiselect-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-size: 13px;
            color: var(--bo-text-primary);
        }
        .bo-multiselect-option:hover { background: #f5f5f5; }
        .bo-multiselect-option.selected { background: rgba(227, 30, 36, 0.06); }
        .bo-multiselect-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--bo-primary);
            cursor: pointer;
            flex-shrink: 0;
        }
        .bo-multiselect-option-text { flex: 1; }
        .bo-multiselect-option-badge {
            font-size: 11px;
            color: var(--bo-text-secondary);
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .bo-multiselect-actions {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid var(--bo-border);
            background: #fafafa;
        }
        .bo-multiselect-actions button {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--bo-border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
            color: var(--bo-text-primary);
        }
        .bo-multiselect-actions button:hover { background: #f0f0f0; }
        .bo-multiselect-actions button.primary {
            background: var(--bo-primary);
            color: #fff;
            border-color: var(--bo-primary);
        }
        .bo-multiselect-actions button.primary:hover { background: var(--bo-primary-dark); }
        .bo-multiselect-empty {
            padding: 20px;
            text-align: center;
            color: var(--bo-text-secondary);
            font-size: 13px;
        }
        .bo-multiselect.disabled .bo-multiselect-trigger {
            background-color: #f9f9f9;
            color: #a3a3a3;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="backoffice-sidebar"></div>

    <main class="bo-main-content">
        <div id="backoffice-header"></div>

        <div class="bo-content">
            <!-- Page Header -->
            <div class="bo-page-header">
                <div>
                    <h1>Satis Raporu</h1>
                    <p>Il, ilce ve bayi bazinda satis performansi</p>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="bo-filter-bar">
                <!-- Il Multiselect -->
                <div class="bo-filter-group">
                    <label>Il</label>
                    <div class="bo-multiselect" id="cityMultiselect">
                        <div class="bo-multiselect-trigger" onclick="toggleMultiselect('city')">
                            <span class="bo-multiselect-text">Tum Iller</span>
                            <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="bo-multiselect-dropdown" id="cityDropdown">
                            <div class="bo-multiselect-search">
                                <input type="text" placeholder="Il ara..." oninput="filterMultiselectOptions('city', this.value)">
                            </div>
                            <div class="bo-multiselect-options" id="cityOptions">
                                <div class="bo-multiselect-empty">Yukleniyor...</div>
                            </div>
                            <div class="bo-multiselect-actions">
                                <button onclick="selectAllMultiselect('city')">Tumunu Sec</button>
                                <button onclick="clearMultiselect('city')">Temizle</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ilce Multiselect -->
                <div class="bo-filter-group">
                    <label>Ilce</label>
                    <div class="bo-multiselect disabled" id="districtMultiselect">
                        <div class="bo-multiselect-trigger" onclick="toggleMultiselect('district')">
                            <span class="bo-multiselect-text">Once il secin</span>
                            <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="bo-multiselect-dropdown" id="districtDropdown">
                            <div class="bo-multiselect-search">
                                <input type="text" placeholder="Ilce ara..." oninput="filterMultiselectOptions('district', this.value)">
                            </div>
                            <div class="bo-multiselect-options" id="districtOptions">
                                <div class="bo-multiselect-empty">Once il secin</div>
                            </div>
                            <div class="bo-multiselect-actions">
                                <button onclick="selectAllMultiselect('district')">Tumunu Sec</button>
                                <button onclick="clearMultiselect('district')">Temizle</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bayi Multiselect -->
                <div class="bo-filter-group">
                    <label>Bayi</label>
                    <div class="bo-multiselect disabled" id="dealerMultiselect">
                        <div class="bo-multiselect-trigger" onclick="toggleMultiselect('dealer')">
                            <span class="bo-multiselect-text">Once ilce secin</span>
                            <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="bo-multiselect-dropdown" id="dealerDropdown">
                            <div class="bo-multiselect-search">
                                <input type="text" placeholder="Bayi ara..." oninput="filterMultiselectOptions('dealer', this.value)">
                            </div>
                            <div class="bo-multiselect-options" id="dealerOptions">
                                <div class="bo-multiselect-empty">Once ilce secin</div>
                            </div>
                            <div class="bo-multiselect-actions">
                                <button onclick="selectAllMultiselect('dealer')">Tumunu Sec</button>
                                <button onclick="clearMultiselect('dealer')">Temizle</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bo-filter-actions">
                    <button class="bo-btn bo-btn-primary" onclick="applyFilters()">
                        <svg viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                        Filtrele
                    </button>
                    <button class="bo-btn bo-btn-secondary" onclick="clearFilters()">
                        <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        Temizle
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" style="display: none;">
                <div class="bo-loading">
                    <div class="bo-loading-spinner"></div>
                    <span class="bo-loading-text">Rapor verileri yukleniyor...</span>
                </div>
            </div>

            <!-- Report Content -->
            <div id="reportContent">
                <!-- Primary Metrics -->
                <div class="bo-metrics-primary">
                    <!-- Bu Ay Tonaj -->
                    <div class="bo-metric-card">
                        <div class="bo-metric-header">
                            <span class="bo-metric-label">Bu Ay Toplam Satis</span>
                            <div class="bo-metric-icon">
                                <svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                            </div>
                        </div>
                        <div class="bo-metric-value" id="currentMonthTonnage">0<span class="bo-metric-unit">ton</span></div>
                        <div class="bo-metric-subtitle" id="currentMonthLabel">Ocak 2026</div>
                    </div>

                    <!-- Gecen Ay Tonaj -->
                    <div class="bo-metric-card secondary">
                        <div class="bo-metric-header">
                            <span class="bo-metric-label">Gecen Ay Toplam Satis</span>
                            <div class="bo-metric-icon secondary">
                                <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            </div>
                        </div>
                        <div class="bo-metric-value" id="previousMonthTonnage">0<span class="bo-metric-unit">ton</span></div>
                        <div class="bo-metric-subtitle" id="previousMonthLabel">Aralik 2025</div>
                    </div>

                    <!-- Degisim -->
                    <div class="bo-metric-card success" id="changeCard">
                        <div class="bo-metric-header">
                            <span class="bo-metric-label">Degisim Orani</span>
                            <div class="bo-metric-icon success" id="changeIcon">
                                <svg viewBox="0 0 24 24" id="changeIconSvg"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                            </div>
                        </div>
                        <div class="bo-metric-value" id="changePercentage">0<span class="bo-metric-unit">%</span></div>
                        <div id="changeDetail">
                            <span class="bo-metric-change positive" id="changeBadge">
                                <svg viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"></polyline></svg>
                                <span id="changeDiff">0 ton artis</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Secondary Metrics -->
                <div class="bo-metrics-secondary">
                    <!-- Siparis Adedi -->
                    <div class="bo-metric-card info">
                        <div class="bo-metric-header">
                            <span class="bo-metric-label">Bu Ay Siparis Adedi</span>
                            <div class="bo-metric-icon info">
                                <svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                            </div>
                        </div>
                        <div class="bo-metric-value" id="orderCount">0</div>
                        <div class="bo-metric-subtitle"><span id="completedOrders">0</span> tamamlandi, <span id="pendingOrders">0</span> bekliyor</div>
                    </div>

                    <!-- Rutin Siparis -->
                    <div class="bo-metric-card">
                        <div class="bo-metric-header">
                            <span class="bo-metric-label">Aktif Rutin Siparis</span>
                            <div class="bo-metric-icon">
                                <svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                            </div>
                        </div>
                        <div class="bo-metric-value" id="recurringCount">0</div>
                        <div class="bo-metric-subtitle">Otomatik yinelenen siparisler</div>
                    </div>
                </div>

                <!-- Single Dealer Info Message (when specific dealer selected) -->
                <div class="bo-info-state" id="singleDealerInfo" style="display: none;">
                    <div class="bo-info-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke="#3b82f6" fill="rgba(59, 130, 246, 0.1)" stroke-width="2"/>
                            <line x1="12" y1="16" x2="12" y2="12" stroke="#3b82f6" stroke-width="2"/>
                            <circle cx="12" cy="8" r="1" fill="#3b82f6"/>
                        </svg>
                    </div>
                    <h3 class="bo-info-title">Grafik Gorunumu Devre Disi</h3>
                    <p class="bo-info-description">
                        Tek bayi secildiginde grafik gorunumu anlamsiz oldugu icin gizlenmistir.<br>
                        Bayi performansini yukaridaki metrik kartlardan takip edebilirsiniz.
                    </p>
                    <button class="bo-btn bo-btn-primary" onclick="clearDealerFilter()">
                        <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        Tum Bayileri Goster
                    </button>
                </div>

                <!-- Location Chart Widget (Il/Ilce) -->
                <div class="bo-chart-widget" id="locationChartWidget">
                    <div class="bo-chart-header">
                        <div class="bo-chart-title-group">
                            <h2 class="bo-chart-title">
                                <svg class="bo-chart-icon" id="locationChartIcon" viewBox="0 0 24 24" style="width:20px;height:20px;stroke:var(--bo-primary);fill:none;stroke-width:2;">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                <span id="locationChartTitle">Il Bazli Satis Dagilimi</span>
                            </h2>
                            <p class="bo-chart-subtitle" id="locationChartSubtitle">
                                Turkiye geneli il bazinda toplam satis performansi
                            </p>
                        </div>
                        <div class="bo-chart-meta">
                            <span class="bo-chart-count-badge" id="locationChartCount">0 Il</span>
                        </div>
                    </div>
                    <div class="bo-chart-legend" id="locationChartLegend">
                        <div class="bo-legend-item" data-chart="location" data-dataset="0">
                            <span class="bo-legend-marker bar"></span>
                            <span>Tonaj (Ton)</span>
                        </div>
                        <div class="bo-legend-item" data-chart="location" data-dataset="1">
                            <span class="bo-legend-marker line"></span>
                            <span>Adet</span>
                        </div>
                    </div>
                    <div class="bo-chart-container">
                        <canvas id="locationSalesChart"></canvas>
                    </div>
                    <div class="bo-empty-state" id="locationChartEmpty" style="display: none;">
                        <div class="bo-empty-icon">
                            <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </div>
                        <h3>Satis Verisi Bulunamadi</h3>
                        <p id="locationEmptyText">Bu donemde satis kaydi bulunmamaktadir.</p>
                    </div>
                </div>

                <!-- Dealer Chart Widget -->
                <div class="bo-chart-widget" id="chartWidget">
                    <div class="bo-chart-header">
                        <h2 class="bo-chart-title">
                            <svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:var(--bo-text-primary);fill:none;stroke-width:2;">
                                <line x1="18" y1="20" x2="18" y2="10"></line>
                                <line x1="12" y1="20" x2="12" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="14"></line>
                            </svg>
                            Bayi Bazli Satis Performansi
                        </h2>
                        <div class="bo-chart-legend">
                            <div class="bo-legend-item" data-dataset="0">
                                <span class="bo-legend-marker bar"></span>
                                <span>Tonaj (Ton)</span>
                            </div>
                            <div class="bo-legend-item" data-dataset="1">
                                <span class="bo-legend-marker line"></span>
                                <span>Adet</span>
                            </div>
                        </div>
                    </div>
                    <div class="bo-chart-container">
                        <canvas id="salesPerformanceChart"></canvas>
                    </div>
                    <div class="bo-empty-state" id="chartEmptyState" style="display: none;">
                        <div class="bo-empty-icon">
                            <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        </div>
                        <h3>Grafik Verisi Yok</h3>
                        <p>Sectiginiz filtrelere uygun bayi satisi bulunamadi.</p>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="bo-products-section">
                    <div class="bo-products-header">
                        <h2>
                            <svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:var(--bo-text-primary);fill:none;stroke-width:2;"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                            Urun Bazli Satis Detayi
                            <span class="bo-count-badge" id="productCount">0</span>
                        </h2>
                    </div>
                    <div id="productsTableContainer">
                        <table class="bo-table">
                            <thead>
                                <tr>
                                    <th>Urun</th>
                                    <th>Kategori</th>
                                    <th>Bu Ay (Adet)</th>
                                    <th>Gecen Ay</th>
                                    <th>Degisim</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div class="bo-empty-state" id="emptyState" style="display: none;">
                        <div class="bo-empty-icon">
                            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <h3>Veri Bulunamadi</h3>
                        <p>Sectiginiz filtrelere uygun satis verisi bulunamadi.</p>
                        <button class="bo-btn bo-btn-secondary" onclick="clearFilters()">Filtreleri Temizle</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/services/reports-service.js"></script>
    <script src="js/services/locations-service.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // State
        var citiesData = [];
        var districtsData = [];
        var dealersData = [];
        var currentFilters = { dealerIds: [] };
        var currentMonthProducts = [];
        var previousMonthProducts = [];
        var salesChart = null;
        var locationChart = null;

        // Multiselect State
        var selectedCities = [];      // [{id, name}]
        var selectedDistricts = [];   // [{id, name}]
        var selectedDealers = [];     // [{id, name}]
        var openMultiselect = null;   // Currently open dropdown

        // Init
        document.addEventListener('DOMContentLoaded', async function() {
            var adminId = sessionStorage.getItem('backoffice_admin_id');
            if (!adminId) { window.location.href = 'backoffice-login.html'; return; }

            await loadComponents();
            if (typeof setPageName === 'function') setPageName('Satis Raporu');

            await loadCities();
            await loadReportData();
        });

        async function loadComponents() {
            try {
                var sidebarRes = await fetch('components/backoffice-sidebar.html');
                document.getElementById('backoffice-sidebar').innerHTML = await sidebarRes.text();
                var headerRes = await fetch('components/backoffice-header.html');
                document.getElementById('backoffice-header').innerHTML = await headerRes.text();
                executeScripts(document.getElementById('backoffice-sidebar'));
                executeScripts(document.getElementById('backoffice-header'));
            } catch (e) { console.error('Component load error:', e); }
        }

        function executeScripts(container) {
            container.querySelectorAll('script').forEach(function(script) {
                var newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript);
            });
        }

        // ============================================
        // MULTISELECT FUNCTIONS
        // ============================================

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (openMultiselect && !e.target.closest('.bo-multiselect')) {
                closeAllMultiselects();
            }
        });

        function toggleMultiselect(type) {
            var multiselect = document.getElementById(type + 'Multiselect');
            var dropdown = document.getElementById(type + 'Dropdown');
            var trigger = multiselect.querySelector('.bo-multiselect-trigger');

            // If disabled, don't open
            if (multiselect.classList.contains('disabled')) return;

            // Close other open dropdowns
            if (openMultiselect && openMultiselect !== type) {
                closeAllMultiselects();
            }

            var isOpen = dropdown.classList.contains('open');
            if (isOpen) {
                dropdown.classList.remove('open');
                trigger.classList.remove('active');
                openMultiselect = null;
            } else {
                dropdown.classList.add('open');
                trigger.classList.add('active');
                openMultiselect = type;
                // Focus search input
                var searchInput = dropdown.querySelector('input');
                if (searchInput) setTimeout(function() { searchInput.focus(); }, 50);
            }
        }

        function closeAllMultiselects() {
            ['city', 'district', 'dealer'].forEach(function(type) {
                var dropdown = document.getElementById(type + 'Dropdown');
                var trigger = document.querySelector('#' + type + 'Multiselect .bo-multiselect-trigger');
                if (dropdown) dropdown.classList.remove('open');
                if (trigger) trigger.classList.remove('active');
            });
            openMultiselect = null;
        }

        function filterMultiselectOptions(type, query) {
            var optionsContainer = document.getElementById(type + 'Options');
            var options = optionsContainer.querySelectorAll('.bo-multiselect-option');
            var normalizedQuery = query.toLowerCase().trim();

            options.forEach(function(option) {
                var text = option.querySelector('.bo-multiselect-option-text').textContent.toLowerCase();
                option.style.display = text.includes(normalizedQuery) ? 'flex' : 'none';
            });
        }

        function selectAllMultiselect(type) {
            var optionsContainer = document.getElementById(type + 'Options');
            var checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');

            checkboxes.forEach(function(cb) {
                if (!cb.checked && cb.closest('.bo-multiselect-option').style.display !== 'none') {
                    cb.checked = true;
                    onMultiselectOptionChange(type, cb);
                }
            });
        }

        function clearMultiselect(type) {
            var optionsContainer = document.getElementById(type + 'Options');
            var checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');

            checkboxes.forEach(function(cb) {
                if (cb.checked) {
                    cb.checked = false;
                    onMultiselectOptionChange(type, cb);
                }
            });
        }

        function onMultiselectOptionChange(type, checkbox) {
            var id = checkbox.getAttribute('data-id');
            var name = checkbox.getAttribute('data-name');
            var option = checkbox.closest('.bo-multiselect-option');

            if (type === 'city') {
                if (checkbox.checked) {
                    if (!selectedCities.find(function(c) { return c.id === id; })) {
                        selectedCities.push({ id: id, name: name });
                    }
                    option.classList.add('selected');
                } else {
                    selectedCities = selectedCities.filter(function(c) { return c.id !== id; });
                    option.classList.remove('selected');
                }
                updateMultiselectTrigger('city');
                loadDistrictsForSelectedCities();
            } else if (type === 'district') {
                if (checkbox.checked) {
                    if (!selectedDistricts.find(function(d) { return d.id === id; })) {
                        selectedDistricts.push({ id: id, name: name });
                    }
                    option.classList.add('selected');
                } else {
                    selectedDistricts = selectedDistricts.filter(function(d) { return d.id !== id; });
                    option.classList.remove('selected');
                }
                updateMultiselectTrigger('district');
                loadDealersForSelectedDistricts();
            } else if (type === 'dealer') {
                if (checkbox.checked) {
                    if (!selectedDealers.find(function(d) { return d.id === id; })) {
                        selectedDealers.push({ id: id, name: name });
                    }
                    option.classList.add('selected');
                } else {
                    selectedDealers = selectedDealers.filter(function(d) { return d.id !== id; });
                    option.classList.remove('selected');
                }
                updateMultiselectTrigger('dealer');
            }
        }

        function updateMultiselectTrigger(type) {
            var trigger = document.querySelector('#' + type + 'Multiselect .bo-multiselect-trigger');
            var textSpan = trigger.querySelector('.bo-multiselect-text');
            var existingCount = trigger.querySelector('.bo-multiselect-count');
            if (existingCount) existingCount.remove();

            var selected;
            var defaultText;

            if (type === 'city') {
                selected = selectedCities;
                defaultText = 'Tum Iller';
            } else if (type === 'district') {
                selected = selectedDistricts;
                defaultText = selectedCities.length > 0 ? 'Tum Ilceler' : 'Once il secin';
            } else {
                selected = selectedDealers;
                defaultText = selectedDistricts.length > 0 ? 'Tum Bayiler' : 'Once ilce secin';
            }

            if (selected.length === 0) {
                textSpan.textContent = defaultText;
            } else if (selected.length === 1) {
                textSpan.textContent = selected[0].name;
            } else {
                textSpan.textContent = selected.length + ' secili';
                var countBadge = document.createElement('span');
                countBadge.className = 'bo-multiselect-count';
                countBadge.textContent = selected.length;
                trigger.insertBefore(countBadge, trigger.querySelector('svg'));
            }
        }

        function renderMultiselectOptions(type, data) {
            var optionsContainer = document.getElementById(type + 'Options');

            if (!data || data.length === 0) {
                var emptyText = type === 'city' ? 'Il bulunamadi' :
                               (type === 'district' ? 'Ilce bulunamadi' : 'Bayi bulunamadi');
                optionsContainer.innerHTML = '<div class="bo-multiselect-empty">' + emptyText + '</div>';
                return;
            }

            var selected = type === 'city' ? selectedCities :
                          (type === 'district' ? selectedDistricts : selectedDealers);

            optionsContainer.innerHTML = data.map(function(item) {
                var isSelected = selected.find(function(s) { return s.id === item.id; });
                return '<div class="bo-multiselect-option' + (isSelected ? ' selected' : '') + '">' +
                    '<input type="checkbox" data-id="' + item.id + '" data-name="' + item.name + '"' +
                    (isSelected ? ' checked' : '') +
                    ' onchange="onMultiselectOptionChange(\'' + type + '\', this)">' +
                    '<span class="bo-multiselect-option-text">' + item.name + '</span>' +
                    '</div>';
            }).join('');
        }

        // ============================================
        // FILTER FUNCTIONS
        // ============================================

        async function loadCities() {
            try {
                var result = await ReportsService.getCities();
                if (result.data) {
                    citiesData = result.data;
                    renderMultiselectOptions('city', result.data);
                }
            } catch (e) { console.error('Cities load error:', e); }
        }

        async function loadDistrictsForSelectedCities() {
            var districtMultiselect = document.getElementById('districtMultiselect');
            var dealerMultiselect = document.getElementById('dealerMultiselect');

            // Reset district and dealer
            selectedDistricts = [];
            selectedDealers = [];
            updateMultiselectTrigger('district');
            updateMultiselectTrigger('dealer');

            if (selectedCities.length === 0) {
                districtMultiselect.classList.add('disabled');
                dealerMultiselect.classList.add('disabled');
                document.getElementById('districtOptions').innerHTML = '<div class="bo-multiselect-empty">Once il secin</div>';
                document.getElementById('dealerOptions').innerHTML = '<div class="bo-multiselect-empty">Once ilce secin</div>';
                districtsData = [];
                dealersData = [];
                return;
            }

            districtMultiselect.classList.remove('disabled');
            document.getElementById('districtOptions').innerHTML = '<div class="bo-multiselect-empty">Yukleniyor...</div>';

            try {
                // Secili illerin ilcelerini getir
                var allDistricts = [];
                for (var i = 0; i < selectedCities.length; i++) {
                    var result = await ReportsService.getDistrictsByCity(selectedCities[i].id);
                    if (result.data) {
                        allDistricts = allDistricts.concat(result.data);
                    }
                }

                // Duplicate'leri kaldir ve sirala
                var uniqueDistricts = [];
                var seen = {};
                allDistricts.forEach(function(d) {
                    if (!seen[d.id]) {
                        seen[d.id] = true;
                        uniqueDistricts.push(d);
                    }
                });
                uniqueDistricts.sort(function(a, b) { return a.name.localeCompare(b.name, 'tr'); });

                districtsData = uniqueDistricts;
                renderMultiselectOptions('district', uniqueDistricts);

                // Dealer'lari sifirla
                dealerMultiselect.classList.add('disabled');
                document.getElementById('dealerOptions').innerHTML = '<div class="bo-multiselect-empty">Once ilce secin</div>';
                dealersData = [];

            } catch (e) { console.error('Districts load error:', e); }
        }

        async function loadDealersForSelectedDistricts() {
            var dealerMultiselect = document.getElementById('dealerMultiselect');

            // Reset dealers
            selectedDealers = [];
            updateMultiselectTrigger('dealer');

            if (selectedDistricts.length === 0) {
                // Ilce secili degilse ama il seciliyse, o illerdeki tum bayileri goster
                if (selectedCities.length > 0) {
                    dealerMultiselect.classList.remove('disabled');
                    document.getElementById('dealerOptions').innerHTML = '<div class="bo-multiselect-empty">Yukleniyor...</div>';

                    try {
                        var allDealers = [];
                        for (var i = 0; i < selectedCities.length; i++) {
                            var result = await ReportsService.getDealersByLocation(selectedCities[i].name, null);
                            if (result.data) {
                                allDealers = allDealers.concat(result.data);
                            }
                        }

                        // Duplicate'leri kaldir ve sirala
                        var uniqueDealers = [];
                        var seen = {};
                        allDealers.forEach(function(d) {
                            if (!seen[d.id]) {
                                seen[d.id] = true;
                                uniqueDealers.push(d);
                            }
                        });
                        uniqueDealers.sort(function(a, b) { return a.name.localeCompare(b.name, 'tr'); });

                        dealersData = uniqueDealers;
                        renderMultiselectOptions('dealer', uniqueDealers);
                    } catch (e) { console.error('Dealers load error:', e); }
                } else {
                    dealerMultiselect.classList.add('disabled');
                    document.getElementById('dealerOptions').innerHTML = '<div class="bo-multiselect-empty">Once ilce secin</div>';
                    dealersData = [];
                }
                return;
            }

            dealerMultiselect.classList.remove('disabled');
            document.getElementById('dealerOptions').innerHTML = '<div class="bo-multiselect-empty">Yukleniyor...</div>';

            try {
                // Secili ilcelerdeki bayileri getir
                var allDealers = [];

                // Secili illerin isimlerini al
                var cityNames = selectedCities.map(function(c) { return c.name; });

                for (var i = 0; i < selectedDistricts.length; i++) {
                    // Her ilce icin, uygun il adini bul
                    for (var j = 0; j < cityNames.length; j++) {
                        var result = await ReportsService.getDealersByLocation(cityNames[j], selectedDistricts[i].name);
                        if (result.data && result.data.length > 0) {
                            allDealers = allDealers.concat(result.data);
                        }
                    }
                }

                // Duplicate'leri kaldir ve sirala
                var uniqueDealers = [];
                var seen = {};
                allDealers.forEach(function(d) {
                    if (!seen[d.id]) {
                        seen[d.id] = true;
                        uniqueDealers.push(d);
                    }
                });
                uniqueDealers.sort(function(a, b) { return a.name.localeCompare(b.name, 'tr'); });

                dealersData = uniqueDealers;
                renderMultiselectOptions('dealer', uniqueDealers);

            } catch (e) { console.error('Dealers load error:', e); }
        }

        function applyFilters() {
            closeAllMultiselects();

            // Bayi ID'lerini belirle
            if (selectedDealers.length > 0) {
                currentFilters.dealerIds = selectedDealers.map(function(d) { return d.id; });
            } else if (dealersData.length > 0) {
                currentFilters.dealerIds = dealersData.map(function(d) { return d.id; });
            } else {
                currentFilters.dealerIds = [];
            }

            loadReportData();
        }

        function clearFilters() {
            closeAllMultiselects();

            // Reset all selections
            selectedCities = [];
            selectedDistricts = [];
            selectedDealers = [];
            districtsData = [];
            dealersData = [];

            // Reset UI
            updateMultiselectTrigger('city');
            updateMultiselectTrigger('district');
            updateMultiselectTrigger('dealer');

            // Re-render city options (clear checkboxes)
            renderMultiselectOptions('city', citiesData);

            // Disable district and dealer
            document.getElementById('districtMultiselect').classList.add('disabled');
            document.getElementById('dealerMultiselect').classList.add('disabled');
            document.getElementById('districtOptions').innerHTML = '<div class="bo-multiselect-empty">Once il secin</div>';
            document.getElementById('dealerOptions').innerHTML = '<div class="bo-multiselect-empty">Once ilce secin</div>';

            currentFilters.dealerIds = [];
            loadReportData();
        }

        // Report Data Loading
        async function loadReportData() {
            showLoading(true);

            try {
                var currentMonth = ReportsService.getCurrentMonthRange();
                var previousMonth = ReportsService.getPreviousMonthRange();

                // Ay etiketlerini guncelle
                updateMonthLabels();

                // Paralel veri cekimi
                var [
                    currentTonnage,
                    previousTonnage,
                    currentProducts,
                    previousProducts,
                    orderCounts,
                    recurringCounts
                ] = await Promise.all([
                    ReportsService.getSalesTonnage({ ...currentFilters, ...currentMonth }),
                    ReportsService.getSalesTonnage({ ...currentFilters, ...previousMonth }),
                    ReportsService.getProductSales({ ...currentFilters, ...currentMonth }),
                    ReportsService.getProductSales({ ...currentFilters, ...previousMonth }),
                    ReportsService.getOrderCounts({ ...currentFilters, ...currentMonth }),
                    ReportsService.getRecurringOrderCounts(currentFilters)
                ]);

                // Tonaj goster
                var currentTon = currentTonnage.data ? currentTonnage.data.totalTonnage : 0;
                var previousTon = previousTonnage.data ? previousTonnage.data.totalTonnage : 0;

                document.getElementById('currentMonthTonnage').innerHTML = formatNumber(currentTon.toFixed(2)) + '<span class="bo-metric-unit">ton</span>';
                document.getElementById('previousMonthTonnage').innerHTML = formatNumber(previousTon.toFixed(2)) + '<span class="bo-metric-unit">ton</span>';

                // Degisim hesapla
                updateChangeMetric(currentTon, previousTon);

                // Siparis adetleri
                if (orderCounts.data) {
                    document.getElementById('orderCount').textContent = formatNumber(orderCounts.data.total);
                    document.getElementById('completedOrders').textContent = formatNumber(orderCounts.data.completed);
                    document.getElementById('pendingOrders').textContent = formatNumber(orderCounts.data.pending);
                }

                // Rutin siparisler
                if (recurringCounts.data) {
                    document.getElementById('recurringCount').textContent = formatNumber(recurringCounts.data.active);
                }

                // Urun tablosu
                currentMonthProducts = currentProducts.data || [];
                previousMonthProducts = previousProducts.data || [];
                renderProductsTable();

                // Grafik gorunurlugunu guncelle ve yukle
                updateChartsVisibility();
                await loadLocationChart();
                await loadChartData();

            } catch (e) {
                console.error('Load report error:', e);
            }

            showLoading(false);
        }

        function updateMonthLabels() {
            var months = ['Ocak', 'Subat', 'Mart', 'Nisan', 'Mayis', 'Haziran', 'Temmuz', 'Agustos', 'Eylul', 'Ekim', 'Kasim', 'Aralik'];
            var now = new Date();
            var currentMonthName = months[now.getMonth()] + ' ' + now.getFullYear();

            var prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            var prevMonthName = months[prevDate.getMonth()] + ' ' + prevDate.getFullYear();

            document.getElementById('currentMonthLabel').textContent = currentMonthName;
            document.getElementById('previousMonthLabel').textContent = prevMonthName;
        }

        function updateChangeMetric(current, previous) {
            var changeCard = document.getElementById('changeCard');
            var changeIcon = document.getElementById('changeIcon');
            var changeIconSvg = document.getElementById('changeIconSvg');
            var changeBadge = document.getElementById('changeBadge');
            var changeDiff = document.getElementById('changeDiff');
            var changePercentage = document.getElementById('changePercentage');

            var diff = current - previous;
            var percent = previous > 0 ? ((diff / previous) * 100) : (current > 0 ? 100 : 0);

            if (diff > 0) {
                changeCard.className = 'bo-metric-card success';
                changeIcon.className = 'bo-metric-icon success';
                changeIconSvg.innerHTML = '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>';
                changeBadge.className = 'bo-metric-change positive';
                changeBadge.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"></polyline></svg><span>' + formatNumber(diff.toFixed(2)) + ' ton artis</span>';
                changePercentage.innerHTML = '+' + percent.toFixed(1) + '<span class="bo-metric-unit">%</span>';
            } else if (diff < 0) {
                changeCard.className = 'bo-metric-card';
                changeCard.style.setProperty('--accent', 'var(--bo-error)');
                changeIcon.className = 'bo-metric-icon';
                changeIcon.style.background = 'rgba(239, 68, 68, 0.1)';
                changeIconSvg.style.stroke = 'var(--bo-error)';
                changeIconSvg.innerHTML = '<polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline>';
                changeBadge.className = 'bo-metric-change negative';
                changeBadge.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="18 9 12 15 6 9"></polyline></svg><span>' + formatNumber(Math.abs(diff).toFixed(2)) + ' ton azalis</span>';
                changePercentage.innerHTML = percent.toFixed(1) + '<span class="bo-metric-unit">%</span>';
                changeCard.querySelector('::before') && (changeCard.style.setProperty('--bo-primary', 'var(--bo-error)'));
            } else {
                changeCard.className = 'bo-metric-card secondary';
                changeIcon.className = 'bo-metric-icon secondary';
                changeIconSvg.innerHTML = '<line x1="5" y1="12" x2="19" y2="12"></line>';
                changeBadge.className = 'bo-metric-change neutral';
                changeBadge.innerHTML = '<span>Degisim yok</span>';
                changePercentage.innerHTML = '0<span class="bo-metric-unit">%</span>';
            }
        }

        function renderProductsTable() {
            var tbody = document.getElementById('productsTableBody');
            var emptyState = document.getElementById('emptyState');
            var tableContainer = document.getElementById('productsTableContainer');
            var productCount = document.getElementById('productCount');

            // Onceki ay verisini map'e cevir
            var prevMap = {};
            previousMonthProducts.forEach(function(p) {
                prevMap[p.id] = p.quantity;
            });

            if (currentMonthProducts.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                productCount.textContent = '0';
                return;
            }

            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            productCount.textContent = currentMonthProducts.length;

            tbody.innerHTML = currentMonthProducts.map(function(product) {
                var prevQty = prevMap[product.id] || 0;
                var diff = product.quantity - prevQty;
                var percent = prevQty > 0 ? ((diff / prevQty) * 100) : (product.quantity > 0 ? 100 : 0);

                var changeClass = diff > 0 ? 'positive' : (diff < 0 ? 'negative' : 'neutral');
                var changeIcon = diff > 0
                    ? '<svg viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"></polyline></svg>'
                    : (diff < 0 ? '<svg viewBox="0 0 24 24"><polyline points="18 9 12 15 6 9"></polyline></svg>' : '');
                var changeText = diff !== 0 ? (diff > 0 ? '+' : '') + percent.toFixed(0) + '%' : '-';

                return '<tr>' +
                    '<td>' +
                        '<div class="bo-product-cell">' +
                            '<div class="bo-product-icon"><svg viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg></div>' +
                            '<div class="bo-product-info">' +
                                '<span class="bo-product-name">' + product.name + '</span>' +
                                '<span class="bo-product-code">' + (product.code || '-') + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</td>' +
                    '<td>' + (product.category || '-') + '</td>' +
                    '<td><span class="bo-quantity-highlight">' + formatNumber(product.quantity) + '</span></td>' +
                    '<td>' + formatNumber(prevQty) + '</td>' +
                    '<td><span class="bo-metric-change ' + changeClass + '">' + changeIcon + changeText + '</span></td>' +
                '</tr>';
            }).join('');
        }

        // Chart Functions
        async function loadChartData() {
            // Tek bayi seciliyse grafik gizli, yukleme
            if (selectedDealers.length === 1) {
                return;
            }

            try {
                var currentMonth = ReportsService.getCurrentMonthRange();
                var chartFilters = { ...currentMonth };

                // Lokasyona gore bayi filtresi olustur
                if (selectedDealers.length > 0) {
                    // Secili bayiler varsa onlari kullan
                    chartFilters.dealerIds = selectedDealers.map(function(d) { return d.id; });
                } else if (dealersData.length > 0) {
                    // Secili bayi yoksa ama dealersData varsa (il/ilce secilmis demek)
                    chartFilters.dealerIds = dealersData.map(function(d) { return d.id; });
                }
                // Hicbir filtre yoksa dealerIds bos = tum bayiler

                var result = await ReportsService.getDealerSalesData(chartFilters);

                if (result.data && result.data.length > 0) {
                    document.getElementById('chartEmptyState').style.display = 'none';
                    document.querySelector('#chartWidget .bo-chart-container canvas').style.display = 'block';
                    initSalesChart(result.data);
                } else {
                    document.getElementById('chartEmptyState').style.display = 'block';
                    document.querySelector('#chartWidget .bo-chart-container canvas').style.display = 'none';
                    if (salesChart) {
                        salesChart.destroy();
                        salesChart = null;
                    }
                }
            } catch (e) {
                console.error('Chart data load error:', e);
            }
        }

        function initSalesChart(data) {
            var ctx = document.getElementById('salesPerformanceChart').getContext('2d');

            // Destroy existing chart
            if (salesChart) {
                salesChart.destroy();
            }

            // Prepare data
            var labels = data.map(function(d) { return d.dealerName; });
            var tonnageData = data.map(function(d) { return parseFloat(d.tonnage.toFixed(2)); });
            var quantityData = data.map(function(d) { return d.quantity; });

            salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Tonaj (Ton)',
                            data: tonnageData,
                            backgroundColor: 'rgba(227, 30, 36, 0.85)',
                            borderColor: '#e31e24',
                            borderWidth: 1,
                            borderRadius: 4,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'Adet',
                            data: quantityData,
                            type: 'line',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderColor: '#3b82f6',
                            borderWidth: 3,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false // Custom legend kullaniyoruz
                        },
                        tooltip: {
                            backgroundColor: 'rgba(38, 38, 38, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#e5e5e5',
                            padding: 12,
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    var value = context.parsed.y;
                                    if (context.datasetIndex === 0) {
                                        return label + ': ' + value.toFixed(2) + ' ton';
                                    } else {
                                        return label + ': ' + formatNumber(value) + ' adet';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#71717a',
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Tonaj (Ton)',
                                color: '#e31e24',
                                font: { size: 12, weight: '500' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#e31e24',
                                font: { size: 11 }
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Adet',
                                color: '#3b82f6',
                                font: { size: 12, weight: '500' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#3b82f6',
                                font: { size: 11 }
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Setup legend click handlers
            setupLegendHandlers();
        }

        function setupLegendHandlers() {
            // Bayi chart legend
            var dealerLegendItems = document.querySelectorAll('#chartWidget .bo-legend-item');
            dealerLegendItems.forEach(function(item) {
                item.onclick = function() {
                    if (!salesChart) return;
                    var datasetIndex = parseInt(item.getAttribute('data-dataset'));
                    var meta = salesChart.getDatasetMeta(datasetIndex);
                    meta.hidden = !meta.hidden;
                    item.classList.toggle('inactive', meta.hidden);
                    salesChart.update();
                };
            });
        }

        function setupLocationLegendHandlers() {
            // Location chart legend
            var locationLegendItems = document.querySelectorAll('#locationChartLegend .bo-legend-item');
            locationLegendItems.forEach(function(item) {
                item.onclick = function() {
                    if (!locationChart) return;
                    var datasetIndex = parseInt(item.getAttribute('data-dataset'));
                    var meta = locationChart.getDatasetMeta(datasetIndex);
                    meta.hidden = !meta.hidden;
                    item.classList.toggle('inactive', meta.hidden);
                    locationChart.update();
                };
            });
        }

        // Charts Visibility Control
        function updateChartsVisibility() {
            var locationWidget = document.getElementById('locationChartWidget');
            var dealerWidget = document.getElementById('chartWidget');
            var singleDealerInfo = document.getElementById('singleDealerInfo');

            // Tek bayi seciliyse - grafikler gizli, bilgilendirme goster
            if (selectedDealers.length === 1) {
                locationWidget.style.display = 'none';
                dealerWidget.style.display = 'none';
                singleDealerInfo.style.display = 'block';
                return;
            }

            // Bilgilendirme mesajini gizle
            singleDealerInfo.style.display = 'none';

            // Il/Ilce grafii her zaman goster (tek bayi secili degilse)
            locationWidget.style.display = 'block';

            // Bayi grafigi: Tek bayi secili degilse her zaman goster
            dealerWidget.style.display = 'block';
        }

        // Location Chart Functions
        async function loadLocationChart() {
            // Eger tek bayi seciliyse grafik gizli, yukleme
            if (selectedDealers.length === 1) {
                return;
            }

            try {
                var currentMonth = ReportsService.getCurrentMonthRange();
                var result;

                if (selectedCities.length === 0) {
                    // Tum iller
                    result = await ReportsService.getCitySalesData(currentMonth);
                    updateLocationChartHeader(null, result.data ? result.data.length : 0);
                } else if (selectedCities.length === 1) {
                    // Tek il seciliyse, o ilin ilceleri
                    result = await ReportsService.getDistrictSalesData({
                        ...currentMonth,
                        cityName: selectedCities[0].name
                    });
                    updateLocationChartHeader(selectedCities[0].name, result.data ? result.data.length : 0);
                } else {
                    // Birden fazla il seciliyse, secili illeri goster
                    result = await ReportsService.getCitySalesData(currentMonth);
                    // Secili illere gore filtrele
                    if (result.data) {
                        var cityNames = selectedCities.map(function(c) { return c.name; });
                        result.data = result.data.filter(function(d) {
                            return cityNames.indexOf(d.name) !== -1;
                        });
                    }
                    updateLocationChartHeader(null, result.data ? result.data.length : 0, true);
                }

                if (result.data && result.data.length > 0) {
                    document.getElementById('locationChartEmpty').style.display = 'none';
                    document.querySelector('#locationChartWidget .bo-chart-container canvas').style.display = 'block';
                    initLocationChart(result.data);
                } else {
                    document.getElementById('locationChartEmpty').style.display = 'block';
                    document.querySelector('#locationChartWidget .bo-chart-container canvas').style.display = 'none';
                    if (locationChart) {
                        locationChart.destroy();
                        locationChart = null;
                    }
                }

            } catch (e) {
                console.error('Location chart load error:', e);
            }
        }

        function initLocationChart(data) {
            var ctx = document.getElementById('locationSalesChart').getContext('2d');

            // Destroy existing chart
            if (locationChart) {
                locationChart.destroy();
            }

            // Prepare data
            var labels = data.map(function(d) { return d.name; });
            var tonnageData = data.map(function(d) { return parseFloat(d.tonnage.toFixed(2)); });
            var quantityData = data.map(function(d) { return d.quantity; });

            locationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Tonaj (Ton)',
                            data: tonnageData,
                            backgroundColor: 'rgba(227, 30, 36, 0.85)',
                            borderColor: '#e31e24',
                            borderWidth: 1,
                            borderRadius: 4,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'Adet',
                            data: quantityData,
                            type: 'line',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderColor: '#3b82f6',
                            borderWidth: 3,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(38, 38, 38, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#e5e5e5',
                            padding: 12,
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    var value = context.parsed.y;
                                    if (context.datasetIndex === 0) {
                                        return label + ': ' + value.toFixed(2) + ' ton';
                                    } else {
                                        return label + ': ' + formatNumber(value) + ' adet';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#71717a',
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Tonaj (Ton)',
                                color: '#e31e24',
                                font: { size: 12, weight: '500' }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: { color: '#e31e24', font: { size: 11 } },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Adet',
                                color: '#3b82f6',
                                font: { size: 12, weight: '500' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#3b82f6', font: { size: 11 } },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Setup legend click handlers
            setupLocationLegendHandlers();
        }

        function updateLocationChartHeader(cityName, count, isMultiCity) {
            var titleEl = document.getElementById('locationChartTitle');
            var subtitleEl = document.getElementById('locationChartSubtitle');
            var countEl = document.getElementById('locationChartCount');

            if (isMultiCity) {
                // Birden fazla il secili
                titleEl.textContent = 'Secili Iller Satis Dagilimi';
                subtitleEl.textContent = selectedCities.length + ' il secili - karsilastirmali satis analizi';
                countEl.textContent = count + ' Il';
            } else if (!cityName) {
                titleEl.textContent = 'Il Bazli Satis Dagilimi';
                subtitleEl.textContent = 'Turkiye geneli il bazinda toplam satis performansi';
                countEl.textContent = count + ' Il';
            } else {
                titleEl.textContent = cityName + ' Ilce Bazli Satis Dagilimi';
                subtitleEl.textContent = cityName + ' ili ilce bazinda detayli satis analizi';
                countEl.textContent = count + ' Ilce';
            }
        }

        function clearDealerFilter() {
            selectedDealers = [];
            updateMultiselectTrigger('dealer');
            renderMultiselectOptions('dealer', dealersData);
            applyFilters();
        }

        // Helpers
        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
            document.getElementById('reportContent').style.display = show ? 'none' : 'block';
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
    </script>
</body>
</html>
