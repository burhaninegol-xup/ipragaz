<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Tekliflerim - Ipragaz IsYerim</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<link rel="stylesheet" href="./css/components/security-overlay.css">
	<link rel="stylesheet" href="./css/components/delete-account-overlay.css">
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: 'Poppins', sans-serif; background: #f5f5f5; color: #333; }
		a { text-decoration: none; color: inherit; }
		.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
		.settings-layout { display: flex; gap: 30px; padding: 30px 0; }
		.settings-content { flex: 1; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 30px; }
		.content-title { font-size: 20px; font-weight: 600; color: #333; margin-bottom: 25px; }

		/* Search */
		.search-box { flex: 1; min-width: 0; }
		.search-input { width: 100%; padding: 12px 15px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; }
		.search-input:focus { outline: none; border-color: #e31e24; }

		/* Tabs */
		.tabs { display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; overflow-x: auto; }
		.tab { padding: 12px 20px; font-size: 14px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
		.tab:hover { color: #e31e24; }
		.tab.active { color: #e31e24; border-bottom-color: #e31e24; }
		.tab-count { font-weight: 500; margin-left: 4px; }
		.tab-count.empty { opacity: 0.5; color: #aaa; }
		.tab.active .tab-count.empty { color: #e31e24; opacity: 0.6; }

		/* Filter Row */
		.filter-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }

		/* Offers List */
		.offers-list { display: flex; flex-direction: column; gap: 12px; }

		/* Offer Card */
		.offer-card {
			display: flex; gap: 16px; padding: 20px;
			border: 1px solid #e8ecf1; border-radius: 12px;
			background: #fff; transition: all 0.2s ease; cursor: pointer;
		}
		.offer-card:hover { border-color: #e31e24; box-shadow: 0 4px 16px rgba(227, 30, 36, 0.1); }
		.offer-card-left { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
		.offer-card-right { display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-width: 140px; gap: 12px; }

		.offer-header { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
		.offer-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #f5f7fa; color: #e31e24; flex-shrink: 0; }
		.offer-icon svg { width: 20px; height: 20px; }
		.offer-number { font-size: 15px; font-weight: 600; color: #333; }
		.offer-date { font-size: 12px; color: #999; margin-left: auto; }

		.offer-branch { font-size: 14px; color: #333; display: flex; align-items: center; gap: 6px; }
		.offer-branch svg { width: 14px; height: 14px; color: #e31e24; flex-shrink: 0; }

		.offer-products { font-size: 13px; color: #666; display: flex; align-items: center; gap: 6px; }
		.offer-products svg { width: 14px; height: 14px; color: #999; flex-shrink: 0; }

		.offer-dealer { font-size: 13px; color: #666; display: flex; align-items: center; gap: 6px; }
		.offer-dealer svg { width: 14px; height: 14px; color: #999; flex-shrink: 0; }

		.offer-item-count { font-size: 12px; color: #666; padding: 4px 10px; background: #f5f7fa; border-radius: 6px; }

		/* Status Badges */
		.offer-status-badge {
			display: inline-flex; align-items: center; gap: 6px;
			padding: 8px 14px; border-radius: 8px;
			font-size: 12px; font-weight: 600; white-space: nowrap;
		}
		.offer-status-badge svg { width: 14px; height: 14px; }

		/* Requested - Mavi */
		.offer-status-badge.requested { background: #E3F2FD; color: #1565C0; border: 1px solid #90CAF9; }
		/* Pending - Turuncu */
		.offer-status-badge.pending { background: #FFF3E0; color: #E65100; border: 1px solid #FFB74D; }
		/* Accepted - Yesil */
		.offer-status-badge.accepted { background: #E8F5E9; color: #2E7D32; border: 1px solid #81C784; }
		/* Passive - Acik Gri */
		.offer-status-badge.passive { background: #FAFAFA; color: #757575; border: 1px solid #E0E0E0; }
		/* Rejected - Gri */
		.offer-status-badge.rejected { background: #F5F5F5; color: #616161; border: 1px solid #BDBDBD; }
		/* Cancelled - Kirmizi */
		.offer-status-badge.cancelled { background: #FFEBEE; color: #C62828; border: 1px solid #EF9A9A; }

		/* Countdown Timer for Offer Cards */
		.offer-countdown {
			display: flex;
			align-items: center;
			gap: 6px;
			background: #fff3cd;
			border: 1px solid #fbbf24;
			border-radius: 6px;
			padding: 4px 10px;
			font-size: 11px;
		}

		.offer-countdown .countdown-icon {
			width: 12px;
			height: 12px;
			color: #92400e;
		}

		.offer-countdown .countdown-time {
			color: #92400e;
			font-weight: 700;
			font-family: 'Courier New', monospace;
		}

		.offer-countdown.warning {
			background: #fee2e2;
			border-color: #f87171;
		}

		.offer-countdown.warning .countdown-icon,
		.offer-countdown.warning .countdown-time {
			color: #991b1b;
		}

		.offer-arrow { color: #ccc; transition: color 0.2s; }
		.offer-card:hover .offer-arrow { color: #e31e24; }
		.offer-arrow svg { width: 20px; height: 20px; }

		/* Empty State */
		.empty-state { text-align: center; padding: 60px 20px; }
		.empty-icon { width: 80px; height: 80px; margin: 0 auto 20px; color: #ccc; }
		.empty-text { font-size: 16px; color: #666; margin-bottom: 10px; }
		.empty-subtext { font-size: 14px; color: #999; margin-bottom: 20px; }
		.btn-primary { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: #e31e24; color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; transition: background 0.2s; }
		.btn-primary:hover { background: #c91a1f; }
		.btn-secondary { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: #f5f5f5; color: #333; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; font-family: inherit; transition: background 0.2s; }
		.btn-secondary:hover { background: #e0e0e0; }

		/* Loading */
		.loading { text-align: center; padding: 40px; color: #666; }

		@media (max-width: 992px) { .settings-layout { flex-direction: column; } }
		@media (max-width: 768px) {
			.tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
			.tab { padding: 12px 15px; font-size: 13px; }
		}
		@media (max-width: 600px) {
			.filter-row { flex-direction: column; align-items: stretch; }
			.search-box { width: 100%; }
			/* Responsive Offer Card */
			.offer-card { flex-direction: column; gap: 12px; padding: 16px; }
			.offer-card-right { flex-direction: row; justify-content: space-between; align-items: center; width: 100%; min-width: auto; }
			.offer-status-badge { padding: 6px 10px; font-size: 11px; }
		}
	</style>
</head>
<body>
	<div id="isyerim-top-bar"></div>
	<div id="isyerim-header"></div>
	<div class="container">
		<div class="settings-layout">
			<div id="isyerim-settings-sidebar"></div>
			<div class="settings-content">
				<h1 class="content-title">Tekliflerim</h1>

				<!-- Search -->
				<div class="filter-row">
					<div class="search-box">
						<input type="text" class="search-input" id="searchInput" placeholder="Teklif ara (bayi adi, urun adi...)" oninput="filterOffers()">
					</div>
				</div>

				<!-- Tabs -->
				<div class="tabs">
					<div class="tab active" data-status="all" onclick="switchTab('all')">Tumunu Gor <span class="tab-count" id="count-all">(0)</span></div>
					<div class="tab" data-status="requested" onclick="switchTab('requested')">Talep Edildi <span class="tab-count" id="count-requested">(0)</span></div>
					<div class="tab" data-status="pending" onclick="switchTab('pending')">Inceleniyor <span class="tab-count" id="count-pending">(0)</span></div>
					<div class="tab" data-status="accepted" onclick="switchTab('accepted')">Onaylandi <span class="tab-count" id="count-accepted">(0)</span></div>
					<div class="tab" data-status="closed" onclick="switchTab('closed')">Kapali <span class="tab-count" id="count-closed">(0)</span></div>
				</div>

				<!-- Offers List -->
				<div id="offersList" class="offers-list">
					<div class="loading">Teklifler yukleniyor...</div>
				</div>
			</div>
		</div>
	</div>
	<div id="isyerim-footer"></div>

	<!-- Delete Account Overlay Container -->
	<div id="delete-account-overlay-container"></div>

	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/offers-service.js"></script>
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/customer-users-service.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/notifications-service.js"></script>
	<script src="./js/services/offer-logs-service.js"></script>
	<script src="./js/services/account-deletion-service.js"></script>
	<script src="./js/component-loader.js"></script>
	<script src="./js/components/settings-sidebar.js"></script>
	<script>
		var customerId = null;
		var userId = null;
		var userRole = null;
		var allOffers = [];
		var currentTab = 'all';

		// Durum mapping
		var statusMap = {
			'requested': { text: 'Talep Edildi', class: 'requested', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>' },
			'pending': { text: 'Inceleniyor', class: 'pending', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' },
			'accepted': { text: 'Onaylandi', class: 'accepted', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' },
			'passive': { text: 'Pasif', class: 'passive', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>' },
			'rejected': { text: 'Reddedildi', class: 'rejected', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>' },
			'cancelled': { text: 'Iptal Edildi', class: 'cancelled', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>' }
		};

		document.addEventListener('DOMContentLoaded', async function() {
			customerId = sessionStorage.getItem('isyerim_customer_id');
			userId = sessionStorage.getItem('isyerim_user_id');
			userRole = sessionStorage.getItem('isyerim_user_role') || 'owner';

			if (!customerId) { window.location.href = 'isyerim-musteri-login.html'; return; }

			// Sidebar yukle
			try {
				var response = await fetch('./components/isyerim-settings-sidebar.html');
				var html = await response.text();
				document.getElementById('isyerim-settings-sidebar').innerHTML = html;
				// Delete account overlay'i yukle
				var overlayResponse = await fetch('./components/delete-account-overlay.html');
				var overlayHtml = await overlayResponse.text();
				document.getElementById('delete-account-overlay-container').innerHTML = overlayHtml;
				setTimeout(function() { if (typeof initSettingsSidebar === 'function') initSettingsSidebar('tekliflerim'); }, 100);
			} catch (err) { console.error('Sidebar yukleme hatasi:', err); }

			// Teklifleri yukle
			await loadOffers();
		});

		async function loadOffers() {
			var listContainer = document.getElementById('offersList');
			listContainer.innerHTML = '<div class="loading">Teklifler yukleniyor...</div>';

			try {
				var result = await OffersService.getByCustomerId(customerId);

				if (result.error) {
					listContainer.innerHTML = '<div class="loading">Teklifler yuklenirken hata olustu</div>';
					return;
				}

				allOffers = result.data || [];
				updateTabCounts();
				filterOffers();
			} catch (err) {
				console.error('Teklif yukleme hatasi:', err);
				listContainer.innerHTML = '<div class="loading">Teklifler yuklenirken hata olustu</div>';
			}
		}

		function switchTab(tab) {
			currentTab = tab;

			// Tab aktiflik
			document.querySelectorAll('.tab').forEach(function(t) {
				t.classList.remove('active');
				if (t.dataset.status === tab) {
					t.classList.add('active');
				}
			});

			filterOffers();
		}

		function filterOffers() {
			var searchTerm = document.getElementById('searchInput').value.toLowerCase();

			var filtered = allOffers.filter(function(offer) {
				// Tab filtresi
				if (currentTab === 'all') {
					// Tum teklifler
				} else if (currentTab === 'closed') {
					// Kapali: rejected, cancelled, passive
					if (!['rejected', 'cancelled', 'passive'].includes(offer.status)) return false;
				} else {
					// Spesifik durum
					if (offer.status !== currentTab) return false;
				}

				// Arama filtresi
				if (searchTerm) {
					var dealerName = (offer.dealer?.name || '').toLowerCase();
					var branchName = (offer.customer_branch?.branch_name || 'Tum Subeler').toLowerCase();
					var productNames = (offer.offer_details || []).map(function(item) {
						return (item.product?.name || '').toLowerCase();
					}).join(' ');

					if (!dealerName.includes(searchTerm) && !branchName.includes(searchTerm) && !productNames.includes(searchTerm)) {
						return false;
					}
				}

				return true;
			});

			renderOffers(filtered);
		}

		function renderOffers(offers) {
			var listContainer = document.getElementById('offersList');

			if (offers.length === 0) {
				var emptyMessage = currentTab === 'all'
					? 'Henuz teklifiniz bulunmuyor'
					: 'Bu kategoride teklif bulunamadi';

				listContainer.innerHTML = '<div class="empty-state">' +
					'<svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">' +
					'<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>' +
					'<polyline points="14 2 14 8 20 8"/>' +
					'<line x1="16" y1="13" x2="8" y2="13"/>' +
					'<line x1="16" y1="17" x2="8" y2="17"/>' +
					'</svg>' +
					'<p class="empty-text">' + emptyMessage + '</p>' +
					'<p class="empty-subtext">Teklif almak icin "Teklif Iste" sayfasini ziyaret edebilirsiniz</p>' +
					'<button class="btn-primary" onclick="window.location.href=\'isyerim-musteri-teklif-iste.html\'">' +
					'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
					'Teklif Iste' +
					'</button>' +
					'</div>';
				return;
			}

			var html = '';
			offers.forEach(function(offer) {
				var status = statusMap[offer.status] || { text: offer.status, class: 'pending', icon: '' };
				var branchName = offer.customer_branch ? (offer.customer_branch.branch_name || offer.customer_branch.district || 'Sube') : 'Tum Subeler';
				var dealerName = offer.dealer ? offer.dealer.name : 'Bayi Atanmadi';
				var createdAt = new Date(offer.created_at);
				var dateStr = createdAt.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
				var timeStr = createdAt.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

				// Urun ozeti
				var productCount = (offer.offer_details || []).length;
				var productSummary = '';
				if (offer.offer_details && offer.offer_details.length > 0) {
					var firstTwo = offer.offer_details.slice(0, 2).map(function(d) {
						return d.product ? d.product.name : 'Urun';
					});
					productSummary = firstTwo.join(', ');
					if (offer.offer_details.length > 2) {
						productSummary += ' +' + (offer.offer_details.length - 2) + ' urun';
					}
				}

				html += '<div class="offer-card" onclick="goToOfferDetail(\'' + offer.id + '\')">';
				html += '<div class="offer-card-left">';

				// Header: Icon + Number (tarih artik bayi altinda)
				html += '<div class="offer-header">';
				html += '<div class="offer-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>';
				html += '<span class="offer-number">Teklif #' + (offer.id || '').substring(0, 8).toUpperCase() + '</span>';
				html += '</div>';

				// Branch
				html += '<div class="offer-branch">';
				html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>';
				html += branchName;
				html += '</div>';

				// Dealer
				html += '<div class="offer-dealer">';
				html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>';
				html += dealerName;
				html += '</div>';

				// Tarih (bayi altinda)
				html += '<div class="offer-date" style="margin-left:20px;font-size:12px;color:#999">' + dateStr + ' ' + timeStr + '</div>';

				html += '</div>'; // card-left

				html += '<div class="offer-card-right">';
				html += '<span class="offer-status-badge ' + status.class + '">' + status.icon + status.text + '</span>';

				// Countdown timer (sadece pending icin)
				if (offer.status === 'pending') {
					html += '<div class="offer-countdown">';
					html += '<svg class="countdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
					html += '<span class="countdown-time" id="countdown-' + offer.id + '">--:--:--</span>';
					html += '</div>';
				}

				html += '</div>'; // card-right

				html += '</div>'; // offer-card
			});

			listContainer.innerHTML = html;

			// Countdown timer'ları başlat
			clearAllCountdowns();
			initOfferCountdowns();
		}

		function goToOfferDetail(offerId) {
			// Teklif detay sayfasina yonlendir
			// Secili subeyi ayarla (varsa)
			var offer = allOffers.find(function(o) { return o.id === offerId; });
			if (offer && offer.customer_branch_id) {
				sessionStorage.setItem('selected_address_id', offer.customer_branch_id);
			}
			window.location.href = 'isyerim-musteri-teklif-iste.html';
		}

		// ============================================
		// TAB SAYILARI
		// ============================================

		function updateTabCounts() {
			var counts = {
				'all': allOffers.length,
				'requested': allOffers.filter(function(o) { return o.status === 'requested'; }).length,
				'pending': allOffers.filter(function(o) { return o.status === 'pending'; }).length,
				'accepted': allOffers.filter(function(o) { return o.status === 'accepted'; }).length,
				'closed': allOffers.filter(function(o) { return ['rejected', 'cancelled', 'passive'].includes(o.status); }).length
			};

			// Her tab icin sayiyi guncelle
			Object.keys(counts).forEach(function(key) {
				var countEl = document.getElementById('count-' + key);
				if (countEl) {
					countEl.textContent = '(' + counts[key] + ')';
					// Sifir ise soluk goster
					if (counts[key] === 0) {
						countEl.classList.add('empty');
					} else {
						countEl.classList.remove('empty');
					}
				}
			});
		}

		// ============================================
		// COUNTDOWN TIMER FONKSIYONLARI
		// ============================================

		var countdownIntervals = {}; // offerId -> intervalId

		async function initOfferCountdowns() {
			// Tum pending teklifler icin countdown baslat
			var pendingOffers = allOffers.filter(function(o) { return o.status === 'pending'; });

			for (var i = 0; i < pendingOffers.length; i++) {
				var offer = pendingOffers[i];
				await initSingleCountdown(offer.id);
			}
		}

		async function initSingleCountdown(offerId) {
			var logsResult = await OfferLogsService.getByOfferId(offerId);
			if (!logsResult.data || logsResult.data.length === 0) return;

			// En son 'price_updated' veya 'created' action'ini bul
			var lastSentLog = logsResult.data.find(function(log) {
				return log.action === 'price_updated' || log.action === 'created';
			});

			if (lastSentLog) {
				startCardCountdown(offerId, lastSentLog.created_at);
			}
		}

		function startCardCountdown(offerId, sentTimestamp) {
			var timerEl = document.getElementById('countdown-' + offerId);
			if (!timerEl) return;

			var sentTime = new Date(sentTimestamp).getTime();
			var endTime = sentTime + (24 * 60 * 60 * 1000);

			// Onceki interval'i temizle
			if (countdownIntervals[offerId]) {
				clearInterval(countdownIntervals[offerId]);
			}

			function updateTimer() {
				var now = Date.now();
				var remaining = endTime - now;
				var container = timerEl.closest('.offer-countdown');

				if (remaining <= 0) {
					timerEl.textContent = '00:00:00';
					if (container) container.classList.add('warning');
					clearInterval(countdownIntervals[offerId]);
					return;
				}

				var hours = Math.floor(remaining / (1000 * 60 * 60));
				var minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
				var seconds = Math.floor((remaining % (1000 * 60)) / 1000);

				timerEl.textContent =
					String(hours).padStart(2, '0') + ':' +
					String(minutes).padStart(2, '0') + ':' +
					String(seconds).padStart(2, '0');

				// Son 1 saat kaldığında uyarı rengi
				if (remaining < 60 * 60 * 1000) {
					if (container) container.classList.add('warning');
				}
			}

			updateTimer();
			countdownIntervals[offerId] = setInterval(updateTimer, 1000);
		}

		function clearAllCountdowns() {
			Object.keys(countdownIntervals).forEach(function(offerId) {
				clearInterval(countdownIntervals[offerId]);
			});
			countdownIntervals = {};
		}
	</script>
</body>
</html>
