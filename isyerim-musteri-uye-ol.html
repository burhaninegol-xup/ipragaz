<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Üye Ol - İpragaz</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<link rel="stylesheet" href="css/components/security-overlay.css">
	<link rel="stylesheet" href="css/components/vkn-duplicate-overlay.css">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			min-height: 100vh;
			background-color: #f5f5f5;
		}

		a {
			text-decoration: none;
			color: inherit;
		}

		/* Card Container */
		.card {
			background: #fff;
			border-radius: 16px;
			width: 100%;
			max-width: 480px;
			padding: 40px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		/* Logo */
		.logo {
			text-align: center;
			margin-bottom: 30px;
		}

		.logo svg {
			height: 40px;
			width: auto;
		}

		/* Back Link */
		.back-link {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			font-size: 14px;
			font-weight: 500;
			color: #333;
			margin-bottom: 25px;
			cursor: pointer;
			transition: color 0.2s;
		}

		.back-link:hover {
			color: #e31e24;
		}

		.back-link svg {
			width: 18px;
			height: 18px;
		}

		/* Section Title */
		.section-title {
			font-size: 16px;
			font-weight: 600;
			color: #333;
			margin-bottom: 20px;
		}

		/* Form */
		.form-group {
			margin-bottom: 20px;
		}

		.form-label {
			display: block;
			font-size: 13px;
			color: #666;
			margin-bottom: 8px;
		}

		.form-label.required::after {
			content: '*';
			color: #e31e24;
			margin-left: 2px;
		}

		.form-input,
		.form-select {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid #ddd;
			border-radius: 8px;
			font-size: 14px;
			font-family: inherit;
			color: #333;
			background: #fff;
			transition: border-color 0.2s;
		}

		.form-input:focus,
		.form-select:focus {
			outline: none;
			border-color: #e31e24;
		}

		.form-select {
			cursor: pointer;
			appearance: none;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 16px center;
		}

		/* Input with icon */
		.input-with-icon {
			position: relative;
		}

		.input-with-icon .form-label {
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.input-with-icon .info-icon {
			width: 16px;
			height: 16px;
			color: #e31e24;
			cursor: help;
		}

		/* Info Text */
		.info-text {
			font-size: 13px;
			color: #666;
			line-height: 1.6;
			margin-bottom: 20px;
		}

		.info-text a {
			color: #e31e24;
			font-weight: 500;
		}

		.info-text a:hover {
			text-decoration: underline;
		}

		/* Checkbox */
		.checkbox-group {
			display: flex;
			align-items: flex-start;
			gap: 10px;
			margin-bottom: 25px;
		}

		.checkbox-group input[type="checkbox"] {
			width: 18px;
			height: 18px;
			margin-top: 2px;
			accent-color: #e31e24;
			cursor: pointer;
			flex-shrink: 0;
		}

		.checkbox-group label {
			font-size: 13px;
			color: #333;
			line-height: 1.5;
			cursor: pointer;
		}

		.checkbox-group label a {
			color: #e31e24;
			font-weight: 500;
		}

		.checkbox-group label a:hover {
			text-decoration: underline;
		}

		/* Submit Button */
		.btn-submit {
			width: 100%;
			padding: 16px 30px;
			background: #e31e24;
			color: #fff;
			border: none;
			border-radius: 30px;
			font-size: 15px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s, transform 0.2s;
		}

		.btn-submit:hover {
			background: #c41a1f;
			transform: translateY(-1px);
		}

		.btn-submit:active {
			transform: translateY(0);
		}

		/* Slide Panel Overlay */
		.panel-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			opacity: 0;
			visibility: hidden;
			transition: opacity 0.3s, visibility 0.3s;
			z-index: 1000;
		}

		.panel-overlay.active {
			opacity: 1;
			visibility: visible;
		}

		/* Slide Panel */
		.slide-panel {
			position: fixed;
			top: 0;
			right: 0;
			width: 100%;
			max-width: 500px;
			height: 100%;
			background: #fff;
			transform: translateX(100%);
			transition: transform 0.3s ease;
			z-index: 1001;
			display: flex;
			flex-direction: column;
		}

		.panel-overlay.active .slide-panel {
			transform: translateX(0);
		}

		.panel-header {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			padding: 20px 24px;
			border-bottom: 1px solid #eee;
		}

		.panel-close {
			width: 36px;
			height: 36px;
			border: none;
			background: #f5f5f5;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: background 0.2s;
		}

		.panel-close:hover {
			background: #eee;
		}

		.panel-close svg {
			width: 18px;
			height: 18px;
			color: #666;
		}

		.panel-content {
			flex: 1;
			overflow-y: auto;
			padding: 24px;
		}

		.panel-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 20px;
		}

		.panel-text {
			font-size: 14px;
			color: #555;
			line-height: 1.8;
		}

		.panel-text p {
			margin-bottom: 15px;
		}

		.panel-text h3 {
			font-size: 15px;
			font-weight: 600;
			color: #333;
			margin-top: 25px;
			margin-bottom: 10px;
		}

		/* CAPTCHA */
		.captcha-group {
			margin-bottom: 25px;
		}
		.captcha-group .form-label {
			margin-bottom: 10px;
		}
		.captcha-row {
			display: flex;
			align-items: center;
			gap: 12px;
			margin-bottom: 10px;
		}
		.captcha-canvas {
			border: 1px solid #ddd;
			border-radius: 8px;
			cursor: pointer;
		}
		.captcha-refresh {
			width: 40px;
			height: 40px;
			border: 1px solid #ddd;
			border-radius: 8px;
			background: #f9f9f9;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background 0.2s;
		}
		.captcha-refresh:hover {
			background: #eee;
		}
		.captcha-refresh svg {
			width: 18px;
			height: 18px;
			color: #666;
		}

		/* Responsive */
		@media (max-width: 520px) {
			.card {
				padding: 30px 20px;
			}

			.slide-panel {
				max-width: 100%;
			}
		}
	</style>
</head>
<body>
	<!-- Top Bar (Component) -->
	<div id="isyerim-top-bar"></div>

	<!-- Header (Component) -->
	<div id="isyerim-header"></div>

	<div class="card" style="margin: 30px auto;">
		<!-- Logo -->
		<div class="logo">
			<svg viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
				<circle cx="25" cy="25" r="20" fill="none" stroke="#e31e24" stroke-width="3"/>
				<path d="M25 10 L25 25" stroke="#e31e24" stroke-width="3" stroke-linecap="round"/>
				<text x="55" y="32" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#e31e24">iPRAGAZ</text>
			</svg>
		</div>

		<!-- Back Link -->
		<a href="isyerim-musteri-login.html" class="back-link">
			<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M19 12H5M12 19l-7-7 7-7"/>
			</svg>
			Üye Ol
		</a>

		<!-- Section Title -->
		<h2 class="section-title">Müşteri Bilgileri</h2>

		<!-- Form -->
		<form id="registerForm">
			<div class="form-group">
				<label class="form-label required">Sektör</label>
				<select class="form-select" id="sektor" required>
					<option value="">Seçiniz</option>
					<option value="yeme-icme">Yeme-İçme</option>
					<option value="perakende">Perakende</option>
					<option value="uretim">Üretim</option>
					<option value="hizmet">Hizmet</option>
					<option value="diger">Diğer</option>
				</select>
			</div>

			<div class="form-group">
				<label class="form-label required">İl</label>
				<select class="form-select" id="citySelect" onchange="loadDistricts()">
					<option value="">İl Seçiniz</option>
				</select>
			</div>

			<div class="form-group">
				<label class="form-label required">İlçe</label>
				<select class="form-select" id="districtSelect" disabled>
					<option value="">Önce il seçiniz</option>
				</select>
			</div>

			<div class="form-group">
				<label class="form-label required">Vergi / TC Kimlik Numarası</label>
				<input type="text" class="form-input" id="vergiNo" placeholder="" maxlength="11" required>
			</div>

			<div class="form-group">
				<label class="form-label">Şirket Ünvanı</label>
				<input type="text" class="form-input" id="sirketUnvani" placeholder="">
			</div>

			<div class="form-group">
				<label class="form-label">Ad</label>
				<input type="text" class="form-input" id="ad" placeholder="">
			</div>

			<div class="form-group">
				<label class="form-label">Soyad</label>
				<input type="text" class="form-input" id="soyad" placeholder="">
			</div>

			<div class="form-group">
				<label class="form-label">E-posta Adresi</label>
				<input type="email" class="form-input" id="email" placeholder="">
			</div>

			<div class="form-group input-with-icon">
				<label class="form-label">
					<svg class="info-icon" viewBox="0 0 24 24" fill="currentColor">
						<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
					</svg>
					Tabela Unvanı
				</label>
				<input type="text" class="form-input" id="tabelaUnvani" placeholder="">
			</div>

			<!-- Info Text -->
			<p class="info-text">
				Kişisel verilerin işlenmesine ilişkin <a href="#" id="aydinlatmaLink">Aydınlatma Metni</a>'ne buradan ulaşabilirsiniz.
			</p>

			<!-- Checkbox -->
			<div class="checkbox-group">
				<input type="checkbox" id="sozlesmeKabul" required>
				<label for="sozlesmeKabul">
					<a href="#" id="uyeligSozlesmesiLink">Üyelik Sözleşmesi</a>'ni ve <a href="#" id="kullanimKosullariLink">Kullanım Koşulları</a>'nı okudum, kabul ediyorum
				</label>
			</div>

			<!-- CAPTCHA -->
			<div class="captcha-group">
				<label class="form-label required">Güvenlik Doğrulaması</label>
				<div class="captcha-row">
					<canvas id="captchaCanvas" class="captcha-canvas" width="160" height="48" title="Yenilemek için tıklayın"></canvas>
					<button type="button" class="captcha-refresh" onclick="generateCaptcha()" title="Yenile">
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<polyline points="23 4 23 10 17 10"/>
							<path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
						</svg>
					</button>
				</div>
				<input type="text" class="form-input" id="captchaInput" placeholder="Yukarıdaki kodu giriniz" autocomplete="off" maxlength="5">
			</div>

			<!-- Submit Button -->
			<button type="submit" class="btn-submit">Devam</button>
		</form>
	</div>

	<!-- Footer (Component) -->
	<div id="isyerim-footer"></div>

	<!-- Üyelik Sözleşmesi Panel -->
	<div class="panel-overlay" id="sozlesmePanel">
		<div class="slide-panel">
			<div class="panel-header">
				<button class="panel-close" id="panelClose">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<line x1="18" y1="6" x2="6" y2="18"/>
						<line x1="6" y1="6" x2="18" y2="18"/>
					</svg>
				</button>
			</div>
			<div class="panel-content">
				<h2 class="panel-title">İpragaz İşYerim Üyelik Sözleşmesi</h2>
				<div class="panel-text">
					<p>
						Aşağıda belirtilen şartlar, kurallar ve yasal sorumlulukları içeren işbu Üyelik Sözleşmesi'nin ("Sözleşme") İpragaz İşYerim uygulamasının ("İpragaz İşYerim"/"Platform") kullanılmasından önce okunması tavsiye edilir. Belirtilen şartların sizin için uygun olmaması halinde lütfen uygulamayı kullanmayınız. İpragaz İşYerim uygulamasını kullanarak ve bilgilerinizin yer alacağı formu doldurarak bu sayfalarda yazılı şartları kabul etmiş sayılmaktasınız. İpragaz A.Ş. ("İpragaz") dilediği zaman bu yasal uyarı sayfasının içeriğini güncelleme yetkisini saklı tutmaktadır ve kullanıcılarına platforma her girişte yasal uyarı sayfasını ziyaret etmelerini tavsiye etmektedir.
					</p>

					<h3>1. Taraflar</h3>
					<p>Bu Sözleşmenin tarafları;</p>
					<p>
						<strong>1.1.</strong> İpragaz İşYerim uygulamasının sahibi olan "Atatürk Mah. Ertuğrul Gazi Sok. Metropol İstanbul Sitesi C2 Blok No:2 A/25 (Kat: 22-24) 34758 Ataşehir / İSTANBUL" adresinde mukim İPRAGAZ A.Ş. ("İpragaz")
					</p>
					<p>ile</p>
					<p>
						<strong>1.2.</strong> İpragaz İşYerim uygulamasına üye olan işyeri müşterisi ("Üye")'dir.
					</p>
					<p>
						Bu Sözleşmede Taraflar tek başına "Taraf", birlikte "Taraflar" olarak anılacaktır.
					</p>

					<h3>2. Sözleşmenin Konusu</h3>
					<p>
						İşbu Sözleşme, İpragaz İşYerim uygulaması üzerinden Üye'nin LPG siparişi vermesine, sipariş takibi yapmasına, fatura görüntülemesine ve diğer hizmetlerden yararlanmasına ilişkin koşulları düzenlemektedir.
					</p>

					<h3>3. Üyelik Koşulları</h3>
					<p>
						<strong>3.1.</strong> Üye olmak için 18 yaşını doldurmuş olmak ve Türkiye Cumhuriyeti vatandaşı olmak veya Türkiye'de yasal olarak faaliyet gösteren bir işletmeye sahip olmak gerekmektedir.
					</p>
					<p>
						<strong>3.2.</strong> Üyelik başvurusu sırasında verilen bilgilerin doğru ve güncel olması gerekmektedir. Yanlış veya eksik bilgi verilmesi durumunda İpragaz üyeliği askıya alma veya iptal etme hakkını saklı tutar.
					</p>

					<h3>4. Gizlilik</h3>
					<p>
						Üye'nin kişisel verileri, İpragaz'ın Kişisel Verilerin Korunması Politikası çerçevesinde işlenmekte ve korunmaktadır. Detaylı bilgi için Aydınlatma Metni'ni inceleyebilirsiniz.
					</p>

					<h3>5. Sorumluluklar</h3>
					<p>
						<strong>5.1.</strong> Üye, hesap bilgilerinin gizliliğini korumakla yükümlüdür.
					</p>
					<p>
						<strong>5.2.</strong> Üye, uygulama üzerinden gerçekleştirdiği tüm işlemlerden sorumludur.
					</p>
					<p>
						<strong>5.3.</strong> İpragaz, uygulamanın kesintisiz çalışacağını garanti etmez ve teknik bakım nedeniyle hizmeti geçici olarak durdurabilir.
					</p>

					<h3>6. Sözleşmenin Feshi</h3>
					<p>
						Taraflardan her biri, herhangi bir neden göstermeksizin işbu Sözleşme'yi feshedebilir. Üye, üyeliğini uygulama üzerinden veya İpragaz müşteri hizmetleri aracılığıyla sonlandırabilir.
					</p>

					<h3>7. Uyuşmazlıkların Çözümü</h3>
					<p>
						İşbu Sözleşme'den doğabilecek uyuşmazlıklarda İstanbul Mahkemeleri ve İcra Daireleri yetkilidir.
					</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Supabase CDN -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<!-- Supabase Client -->
	<script src="./js/supabase-client.js"></script>
	<!-- Service Dosyaları -->
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/branches-service.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/customer-users-service.js"></script>
	<script src="./js/services/locations-service.js"></script>
	<!-- Component Loader -->
	<script src="./js/component-loader.js"></script>

	<script>
		// CAPTCHA
		var captchaCode = '';

		function generateCaptcha() {
			var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
			captchaCode = '';
			for (var i = 0; i < 5; i++) {
				captchaCode += chars.charAt(Math.floor(Math.random() * chars.length));
			}

			var canvas = document.getElementById('captchaCanvas');
			var ctx = canvas.getContext('2d');
			var w = canvas.width;
			var h = canvas.height;

			// Arka plan
			ctx.fillStyle = '#f0f0f0';
			ctx.fillRect(0, 0, w, h);

			// Noise cizgiler
			for (var i = 0; i < 5; i++) {
				ctx.beginPath();
				ctx.moveTo(Math.random() * w, Math.random() * h);
				ctx.lineTo(Math.random() * w, Math.random() * h);
				ctx.strokeStyle = 'rgba(' + Math.floor(Math.random()*200) + ',' + Math.floor(Math.random()*200) + ',' + Math.floor(Math.random()*200) + ',0.4)';
				ctx.lineWidth = 1;
				ctx.stroke();
			}

			// Karakterleri ciz
			var colors = ['#e31e24','#2e7d32','#1565c0','#6a1b9a','#e65100','#00695c'];
			for (var i = 0; i < captchaCode.length; i++) {
				ctx.save();
				var fontSize = 22 + Math.floor(Math.random() * 7);
				ctx.font = 'bold ' + fontSize + 'px Poppins, sans-serif';
				ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
				var x = 12 + i * 28;
				var y = 28 + Math.floor(Math.random() * 10);
				var angle = (Math.random() - 0.5) * (30 * Math.PI / 180);
				ctx.translate(x, y);
				ctx.rotate(angle);
				ctx.fillText(captchaCode[i], 0, 0);
				ctx.restore();
			}
		}

		// Canvas tiklandiginda yenile
		document.getElementById('captchaCanvas').addEventListener('click', generateCaptcha);

		// Sayfa yuklendiginde CAPTCHA olustur
		generateCaptcha();

		// Telefon numarasını sessionStorage'dan al
		var phone = sessionStorage.getItem('isyerim_phone');

		// Telefon yoksa login'e yönlendir
		if (!phone) {
			alert('Lütfen önce telefon numaranızı giriniz.');
			window.location.href = 'isyerim-musteri-login.html';
		}

		// Panel elements
		var sozlesmePanel = document.getElementById('sozlesmePanel');
		var panelClose = document.getElementById('panelClose');
		var uyeligSozlesmesiLink = document.getElementById('uyeligSozlesmesiLink');
		var kullanimKosullariLink = document.getElementById('kullanimKosullariLink');

		// Open panel
		uyeligSozlesmesiLink.addEventListener('click', function(e) {
			e.preventDefault();
			sozlesmePanel.classList.add('active');
			document.body.style.overflow = 'hidden';
		});

		kullanimKosullariLink.addEventListener('click', function(e) {
			e.preventDefault();
			sozlesmePanel.classList.add('active');
			document.body.style.overflow = 'hidden';
		});

		// Close panel - X button
		panelClose.addEventListener('click', function() {
			sozlesmePanel.classList.remove('active');
			document.body.style.overflow = '';
		});

		// Close panel - click outside
		sozlesmePanel.addEventListener('click', function(e) {
			if (e.target === this) {
				this.classList.remove('active');
				document.body.style.overflow = '';
			}
		});

		// Illeri yukle
		async function loadCities() {
			var select = document.getElementById('citySelect');
			var result = await LocationsService.getCities();
			select.innerHTML = '<option value="">İl Seçiniz</option>';
			result.data.forEach(function(city) {
				select.innerHTML += '<option value="' + city.id + '" data-name="' + city.name + '">' + city.name + '</option>';
			});
		}

		// Ilceleri yukle
		async function loadDistricts() {
			var citySelect = document.getElementById('citySelect');
			var districtSelect = document.getElementById('districtSelect');
			var cityId = citySelect.value;

			if (!cityId) {
				districtSelect.innerHTML = '<option value="">Önce il seçiniz</option>';
				districtSelect.disabled = true;
				return;
			}

			districtSelect.innerHTML = '<option value="">İlçe Yükleniyor...</option>';
			var result = await LocationsService.getDistrictsByCityId(cityId);
			districtSelect.innerHTML = '<option value="">İlçe Seçiniz</option>';
			districtSelect.disabled = false;
			result.data.forEach(function(district) {
				districtSelect.innerHTML += '<option value="' + district.id + '" data-name="' + district.name + '">' + district.name + '</option>';
			});
		}

		// Sayfa yuklendiginde illeri getir
		loadCities();

		// Form submission
		document.getElementById('registerForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			var sektor = document.getElementById('sektor').value;
			var vergiNo = document.getElementById('vergiNo').value.trim();
			var sirketUnvani = document.getElementById('sirketUnvani').value.trim();
			var ad = document.getElementById('ad').value.trim();
			var soyad = document.getElementById('soyad').value.trim();
			var email = document.getElementById('email').value.trim();
			var tabelaUnvani = document.getElementById('tabelaUnvani').value.trim();
			var sozlesmeKabul = document.getElementById('sozlesmeKabul').checked;

			// Validasyon
			if (!sektor) {
				alert('Lütfen sektör seçiniz.');
				return;
			}

			// Il kontrolu
			var citySelect = document.getElementById('citySelect');
			if (!citySelect.value) {
				alert('Lütfen il seçiniz.');
				return;
			}

			// Ilce kontrolu
			var districtSelect = document.getElementById('districtSelect');
			if (!districtSelect.value) {
				alert('Lütfen ilçe seçiniz.');
				return;
			}

			if (!vergiNo) {
				alert('Lütfen Vergi / TC Kimlik Numarası giriniz.');
				return;
			}

			// VKN kontrolu
			var existingCustomer = await CustomersService.getByVkn(vergiNo);
			if (existingCustomer.data) {
				// Bayi tarafından oluşturulmuş ama müşteri henüz kayıt olmamış
				if (existingCustomer.data.registration_status === 'dealer_created') {
					// GÜNCELLEME MODU: Mevcut kaydı güncelle, yeni kayıt açma
					await updateDealerCreatedCustomer(existingCustomer.data, vergiNo, sektor, email, sirketUnvani, ad, soyad, tabelaUnvani, citySelect, districtSelect);
					return;
				}
				// Normal duplicate - uyarı göster
				showVknDuplicateOverlay(existingCustomer.data);
				return;
			}

			if (!sozlesmeKabul) {
				alert('Devam etmek için üyelik sözleşmesini kabul etmelisiniz.');
				return;
			}

			// CAPTCHA kontrolu
			var captchaInput = document.getElementById('captchaInput').value.trim().toUpperCase();
			if (captchaInput !== captchaCode) {
				alert('Güvenlik kodu hatalı. Lütfen tekrar deneyiniz.');
				generateCaptcha();
				document.getElementById('captchaInput').value = '';
				document.getElementById('captchaInput').focus();
				return;
			}

			// Submit butonunu devre dışı bırak
			var submitBtn = document.querySelector('.btn-submit');
			submitBtn.disabled = true;
			submitBtn.textContent = 'Kaydediliyor...';

			try {
				// Müşteri verisini hazırla
				var customerData = {
					phone: phone,
					vkn: vergiNo,
					name: (ad && soyad) ? (ad + ' ' + soyad) : (ad || soyad || sirketUnvani || 'Müşteri'),
					company_name: sirketUnvani || null,
					email: email || null,
					sector: sektor,
					tabela_unvani: tabelaUnvani || null,
					is_active: true
				};

				// Supabase'e kaydet
				var result = await CustomersService.create(customerData);

				if (result.error) {
					console.error('Kayit hatasi:', result.error);
					alert('Kayit sirasinda bir hata olustu: ' + (result.error.message || result.error));
					submitBtn.disabled = false;
					submitBtn.textContent = 'Devam';
					return;
				}

				var customer = result.data;

				// Musteri icin owner kullanici olustur
				var ownerResult = await CustomerUsersService.createOwner(
					customer.id,
					customerData.name,
					phone
				);

				// Basarili - customer ve user bilgilerini kaydet
				sessionStorage.setItem('isyerim_customer_id', customer.id);
				sessionStorage.setItem('isyerim_customer_name', customer.company_name || customer.name || customerData.name);

				// Owner kullanici olusturulduysa bilgilerini kaydet
				if (ownerResult.data) {
					sessionStorage.setItem('isyerim_user_id', ownerResult.data.id);
					sessionStorage.setItem('isyerim_user_role', 'owner');
					sessionStorage.setItem('isyerim_user_name', customerData.name);
				} else {
					// Fallback - owner olmadan devam et
					sessionStorage.setItem('isyerim_user_role', 'owner');
					sessionStorage.setItem('isyerim_user_name', customerData.name);
				}

				// Merkez subesi olustur
				var cityOption = citySelect.options[citySelect.selectedIndex];
				var districtOption = districtSelect.options[districtSelect.selectedIndex];

				var branchData = {
					customer_id: customer.id,
					branch_name: 'Merkez',
					city_id: citySelect.value,
					district_id: districtSelect.value,
					city: cityOption.getAttribute('data-name'),
					district: districtOption.getAttribute('data-name'),
					is_default: true
				};
				var branchResult = await BranchesService.create(branchData);

				// Sube bilgilerini sessionStorage'a kaydet
				if (branchResult.data) {
					sessionStorage.setItem('selected_address_id', branchResult.data.id);
					sessionStorage.setItem('selected_address_name', 'Merkez');
					sessionStorage.setItem('isyerim_user_city_id', citySelect.value);
					sessionStorage.setItem('isyerim_user_district_id', districtSelect.value);
					sessionStorage.setItem('isyerim_user_city', cityOption.getAttribute('data-name'));
					sessionStorage.setItem('isyerim_user_district', districtOption.getAttribute('data-name'));
				}

				sessionStorage.setItem('isNewUser', 'true');

				// Anasayfaya yonlendir (guvenlik sorulari artik Teklif Al akisinda)
				window.location.href = 'isyerim-musteri-anasayfa.html';

			} catch (error) {
				console.error('Kayıt hatası:', error);
				alert('Kayıt sırasında bir hata oluştu. Lütfen tekrar deneyin.');
				submitBtn.disabled = false;
				submitBtn.textContent = 'Devam';
			}
		});
	</script>

	<!-- VKN Duplicate Overlay Container -->
	<div id="vknDuplicateOverlayContainer"></div>

	<script>
		// VKN Duplicate Overlay icin degiskenler
		var vknDuplicateOverlayHtml = '';
		var existingCustomerData = null;

		// Overlay HTML'i yukle
		fetch('./components/vkn-duplicate-overlay.html')
			.then(function(response) { return response.text(); })
			.then(function(html) {
				vknDuplicateOverlayHtml = html;
				document.getElementById('vknDuplicateOverlayContainer').innerHTML = html;
			});

		// Isim maskeleme fonksiyonu
		function maskName(name) {
			if (!name) return '****';
			var parts = name.trim().split(' ');
			return parts.map(function(part) {
				if (part.length <= 2) return part[0] + '*';
				return part.substring(0, 2) + '*'.repeat(Math.min(part.length - 2, 4));
			}).join(' ');
		}

		// VKN Duplicate Overlay'i goster
		function showVknDuplicateOverlay(customer) {
			existingCustomerData = customer;
			var maskedNameEl = document.getElementById('maskedOwnerName');
			if (maskedNameEl) {
				maskedNameEl.textContent = maskName(customer.name);
			}
			var overlay = document.getElementById('vknDuplicateOverlay');
			if (overlay) {
				overlay.classList.add('active');
				document.body.style.overflow = 'hidden';
			}
		}

		// VKN Duplicate Overlay'i kapat
		function closeVknDuplicateOverlay() {
			var overlay = document.getElementById('vknDuplicateOverlay');
			if (overlay) {
				overlay.classList.remove('active');
				document.body.style.overflow = '';
			}
			existingCustomerData = null;
			// VKN inputuna fokusla
			document.getElementById('vergiNo').focus();
		}

		// VKN Dogrulama sayfasina git
		function goToVknVerification() {
			if (existingCustomerData) {
				// VKN ve mevcut musteri ID'sini sessionStorage'a kaydet
				sessionStorage.setItem('vkn_verification_vkn', existingCustomerData.vkn);
				sessionStorage.setItem('vkn_verification_existing_customer_id', existingCustomerData.id);
				sessionStorage.setItem('vkn_verification_existing_customer_name', existingCustomerData.name);
			}
			window.location.href = 'isyerim-vkn-dogrulama.html';
		}

		// Bayi tarafından oluşturulan müşteriyi güncelle
		async function updateDealerCreatedCustomer(existingCustomer, vergiNo, sektor, email, sirketUnvani, ad, soyad, tabelaUnvani, citySelect, districtSelect) {
			// Submit butonunu devre dışı bırak
			var submitBtn = document.querySelector('.btn-submit');
			submitBtn.disabled = true;
			submitBtn.textContent = 'Kaydediliyor...';

			try {
				// Müşteri verisini güncelle
				var updateData = {
					phone: phone,
					name: (ad && soyad) ? (ad + ' ' + soyad) : (ad || soyad || sirketUnvani || existingCustomer.name),
					company_name: sirketUnvani || existingCustomer.company_name || null,
					email: email || existingCustomer.email || null,
					sector: sektor,
					tabela_unvani: tabelaUnvani || existingCustomer.tabela_unvani || null,
					registration_status: 'customer_registered' // Artık müşteri kayıt oldu
				};

				// Supabase'de güncelle
				var result = await CustomersService.update(existingCustomer.id, updateData);

				if (result.error) {
					console.error('Güncelleme hatası:', result.error);
					alert('Güncelleme sırasında bir hata oluştu: ' + (result.error.message || result.error));
					submitBtn.disabled = false;
					submitBtn.textContent = 'Devam';
					return;
				}

				var customer = result.data;

				// Musteri icin owner kullanici olustur (yoksa)
				var ownerResult = await CustomerUsersService.createOwner(
					customer.id,
					updateData.name,
					phone
				);

				// Basarili - customer ve user bilgilerini kaydet
				sessionStorage.setItem('isyerim_customer_id', customer.id);
				sessionStorage.setItem('isyerim_customer_name', customer.company_name || customer.name || updateData.name);

				if (ownerResult.data) {
					sessionStorage.setItem('isyerim_user_id', ownerResult.data.id);
					sessionStorage.setItem('isyerim_user_role', 'owner');
					sessionStorage.setItem('isyerim_user_name', updateData.name);
				} else {
					sessionStorage.setItem('isyerim_user_role', 'owner');
					sessionStorage.setItem('isyerim_user_name', updateData.name);
				}

				// Mevcut şubeyi kontrol et, yoksa oluştur
				var branchesResult = await BranchesService.getByCustomerId(customer.id);
				var cityOption = citySelect.options[citySelect.selectedIndex];
				var districtOption = districtSelect.options[districtSelect.selectedIndex];

				if (!branchesResult.data || branchesResult.data.length === 0) {
					// Şube yok, merkez şubesi oluştur
					var branchData = {
						customer_id: customer.id,
						branch_name: 'Merkez',
						city_id: citySelect.value,
						district_id: districtSelect.value,
						city: cityOption.getAttribute('data-name'),
						district: districtOption.getAttribute('data-name'),
						is_default: true
					};
					var branchResult = await BranchesService.create(branchData);

					if (branchResult.data) {
						sessionStorage.setItem('selected_address_id', branchResult.data.id);
						sessionStorage.setItem('selected_address_name', 'Merkez');
					}
				} else {
					// Mevcut şubeyi kullan (bayi tarafından oluşturulan)
					var defaultBranch = branchesResult.data.find(function(b) { return b.is_default; }) || branchesResult.data[0];
					sessionStorage.setItem('selected_address_id', defaultBranch.id);
					sessionStorage.setItem('selected_address_name', defaultBranch.branch_name || 'Merkez');

					// Şube lokasyonunu güncelle (kullanıcının seçtiği ile)
					await BranchesService.update(defaultBranch.id, {
						city_id: citySelect.value,
						district_id: districtSelect.value,
						city: cityOption.getAttribute('data-name'),
						district: districtOption.getAttribute('data-name')
					});
				}

				sessionStorage.setItem('isyerim_user_city_id', citySelect.value);
				sessionStorage.setItem('isyerim_user_district_id', districtSelect.value);
				sessionStorage.setItem('isyerim_user_city', cityOption.getAttribute('data-name'));
				sessionStorage.setItem('isyerim_user_district', districtOption.getAttribute('data-name'));
				sessionStorage.setItem('isNewUser', 'true');

				// Anasayfaya yönlendir
				window.location.href = 'isyerim-musteri-anasayfa.html';

			} catch (error) {
				console.error('Güncelleme hatası:', error);
				alert('Güncelleme sırasında bir hata oluştu. Lütfen tekrar deneyin.');
				submitBtn.disabled = false;
				submitBtn.textContent = 'Devam';
			}
		}
	</script>
</body>
</html>
