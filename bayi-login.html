<!DOCTYPE html>
<html lang="tr">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Bayi Girişi - İpragaz</title>
	<meta http-equiv="Content-Language" content="Turkish">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<link rel="shortcut icon" type="image/x-icon" media="all" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" type="text/css" href="./İpragaz Bayi_files/css">

	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 20px;
		}

		.login-container {
			width: 100%;
			max-width: 420px;
		}

		.login-card {
			background: #fff;
			border-radius: 20px;
			padding: 40px;
			box-shadow: 0 10px 40px rgba(0,44,119,0.12);
		}

		.login-header {
			text-align: center;
			margin-bottom: 35px;
		}

		.login-logo {
			margin-bottom: 20px;
		}

		.login-logo img {
			height: 50px;
		}

		.login-title {
			font-size: 24px;
			font-weight: 700;
			color: #1a1a2e;
			margin-bottom: 8px;
		}

		.login-subtitle {
			font-size: 14px;
			color: #666;
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			font-size: 13px;
			font-weight: 500;
			color: #666;
			margin-bottom: 8px;
		}

		.form-group input {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid #e0e0e0;
			border-radius: 10px;
			font-size: 15px;
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		.form-group input:focus {
			outline: none;
			border-color: #002c77;
			box-shadow: 0 0 0 3px rgba(0,44,119,0.1);
		}

		.form-group input.error {
			border-color: #e53935;
			background: #fff5f5;
		}

		.error-message {
			display: none;
			align-items: center;
			gap: 8px;
			padding: 12px 16px;
			background: #ffebee;
			border: 1px solid #ffcdd2;
			border-radius: 10px;
			margin-bottom: 20px;
			color: #c62828;
			font-size: 13px;
		}

		.error-message.visible {
			display: flex;
		}

		.error-message svg {
			width: 18px;
			height: 18px;
			flex-shrink: 0;
		}

		.login-btn {
			width: 100%;
			padding: 16px;
			background: linear-gradient(135deg, #002c77 0%, #0056b3 100%);
			color: #fff;
			border: none;
			border-radius: 10px;
			font-size: 15px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
		}

		.login-btn:hover {
			background: linear-gradient(135deg, #001a4d 0%, #003d80 100%);
			transform: translateY(-2px);
			box-shadow: 0 4px 15px rgba(0,44,119,0.3);
		}

		.login-btn:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
			box-shadow: none;
		}

		.login-btn svg {
			width: 20px;
			height: 20px;
		}

		.login-btn .spinner {
			width: 20px;
			height: 20px;
			border: 2px solid #fff;
			border-top-color: transparent;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
			display: none;
		}

		.login-btn.loading .spinner {
			display: block;
		}

		.login-btn.loading .btn-text {
			display: none;
		}

		.login-btn.loading svg {
			display: none;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		.login-footer {
			text-align: center;
			margin-top: 25px;
			padding-top: 20px;
			border-top: 1px solid #eee;
		}

		.login-footer p {
			font-size: 12px;
			color: #999;
		}

		/* Responsive */
		@media (max-width: 480px) {
			.login-card {
				padding: 30px 25px;
			}

			.login-title {
				font-size: 20px;
			}
		}

		/* Quick Login Section */
		.quick-login-section {
			margin-top: 25px;
			padding-top: 20px;
			border-top: 1px solid #eee;
		}
		.quick-login-title {
			font-size: 13px;
			color: #666;
			margin-bottom: 12px;
			text-align: center;
		}
		.dealer-list {
			display: flex;
			flex-direction: column;
			gap: 8px;
			max-height: 200px;
			overflow-y: auto;
		}
		.dealer-item {
			padding: 10px 14px;
			background: #f8f9fa;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			cursor: pointer;
			font-size: 13px;
			transition: all 0.2s;
		}
		.dealer-item:hover {
			background: #e8f4fd;
			border-color: #002c77;
		}
		.dealer-item .dealer-name { font-weight: 500; color: #1a1a2e; }
		.dealer-item .dealer-location { font-size: 11px; color: #888; margin-left: 6px; }
	</style>
</head>

<body>
	<div class="login-container">
		<div class="login-card">
			<div class="login-header">
				<div class="login-logo">
					<img src="./İpragaz Bayi_files/ipragaz-logo.svg" alt="İpragaz">
				</div>
				<h1 class="login-title">Bayi Girişi</h1>
				<p class="login-subtitle">Bayi panelinize erişmek için giriş yapın</p>
			</div>

			<div class="error-message" id="error-message">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
				</svg>
				<span id="error-text">Kullanıcı adı veya şifre hatalı</span>
			</div>

			<form id="login-form">
				<div class="form-group">
					<label for="username">Kullanıcı Adı</label>
					<input type="text" id="username" placeholder="Kullanıcı adınızı girin" required autocomplete="username">
				</div>

				<div class="form-group">
					<label for="password">Şifre</label>
					<input type="password" id="password" placeholder="Şifrenizi girin" required autocomplete="current-password">
				</div>

				<button type="submit" class="login-btn" id="login-btn">
					<span class="btn-text">Giriş Yap</span>
					<svg viewBox="0 0 24 24" fill="currentColor">
						<path d="M10 17l5-5-5-5v10z"/>
						<path d="M3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2zm16 14H5V5h14v14z"/>
					</svg>
					<div class="spinner"></div>
				</button>
			</form>

			<div class="quick-login-section">
				<p class="quick-login-title">Hızlı Giriş</p>
				<div class="dealer-list" id="dealer-list">
					<div style="text-align:center;color:#999;font-size:12px;">Yükleniyor...</div>
				</div>
			</div>

			<div class="login-footer">
				<p>&copy; 2025 İpragaz - Tüm hakları saklıdır</p>
			</div>
		</div>
	</div>

	<script src="./İpragaz Bayi_files/jquery-3.6.0.min.js"></script>
	<!-- Supabase -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script>
		/**
		 * SHA-256 hash fonksiyonu (SubtleCrypto API)
		 */
		async function sha256(message) {
			const msgBuffer = new TextEncoder().encode(message);
			const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
			const hashArray = Array.from(new Uint8Array(hashBuffer));
			const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
			return hashHex;
		}

		$(document).ready(function() {
			// Zaten giriş yapmışsa anasayfaya yönlendir
			if (sessionStorage.getItem('bayi_dealer_id')) {
				window.location.href = 'bayi-anasayfa.html';
				return;
			}

			const $form = $('#login-form');
			const $username = $('#username');
			const $password = $('#password');
			const $loginBtn = $('#login-btn');
			const $errorMessage = $('#error-message');
			const $errorText = $('#error-text');

			function showError(message) {
				$errorText.text(message);
				$errorMessage.addClass('visible');
				$username.addClass('error');
				$password.addClass('error');
			}

			function hideError() {
				$errorMessage.removeClass('visible');
				$username.removeClass('error');
				$password.removeClass('error');
			}

			function setLoading(loading) {
				if (loading) {
					$loginBtn.addClass('loading').prop('disabled', true);
				} else {
					$loginBtn.removeClass('loading').prop('disabled', false);
				}
			}

			// Input değiştiğinde hata mesajını gizle
			$username.add($password).on('input', function() {
				hideError();
			});

			// Form submit
			$form.on('submit', async function(e) {
				e.preventDefault();
				hideError();

				const username = $username.val().trim();
				const password = $password.val();

				if (!username || !password) {
					showError('Kullanıcı adı ve şifre gereklidir');
					return;
				}

				setLoading(true);

				try {
					// Şifreyi SHA-256 ile hash'le
					const passwordHash = await sha256(password);

					// Giriş yap
					const { data: dealer, error } = await DealersService.login(username, passwordHash);

					if (error || !dealer) {
						showError(error || 'Kullanıcı adı veya şifre hatalı');
						setLoading(false);
						return;
					}

					// Session'a kaydet
					sessionStorage.setItem('bayi_dealer_id', dealer.id);
					sessionStorage.setItem('bayi_dealer_name', dealer.name);
					sessionStorage.setItem('bayi_dealer_code', dealer.code);

					// Anasayfaya yönlendir
					window.location.href = 'bayi-anasayfa.html';

				} catch (err) {
					console.error('Login error:', err);
					showError('Bir hata oluştu. Lütfen tekrar deneyin.');
					setLoading(false);
				}
			});

			// Enter tuşu ile submit
			$password.on('keypress', function(e) {
				if (e.which === 13) {
					$form.submit();
				}
			});

			// Hızlı giriş için bayileri yükle
			loadDealersForQuickLogin();
		});

		// Hızlı giriş - bayileri listele
		async function loadDealersForQuickLogin() {
			try {
				const { data: dealers, error } = await DealersService.getAll();
				if (error || !dealers) return;

				const $list = $('#dealer-list');
				$list.empty();

				dealers.forEach(dealer => {
					const location = [dealer.district, dealer.city].filter(Boolean).join(', ');
					const $item = $(`
						<div class="dealer-item" data-id="${dealer.id}" data-name="${dealer.name}" data-code="${dealer.code || ''}">
							<span class="dealer-name">${dealer.name}</span>
							${location ? `<span class="dealer-location">(${location})</span>` : ''}
						</div>
					`);
					$list.append($item);
				});
			} catch (err) {
				console.error('Bayiler yüklenemedi:', err);
			}
		}

		// Bayi tıklama ile hızlı giriş
		$(document).on('click', '.dealer-item', function() {
			const id = $(this).data('id');
			const name = $(this).data('name');
			const code = $(this).data('code');

			sessionStorage.setItem('bayi_dealer_id', id);
			sessionStorage.setItem('bayi_dealer_name', name);
			sessionStorage.setItem('bayi_dealer_code', code || '');

			window.location.href = 'bayi-anasayfa.html';
		});
	</script>
</body>
</html>
