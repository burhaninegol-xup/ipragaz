<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Ürün Detayı - İpragaz İşYerim</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #f5f5f5;
			color: #333;
		}

		a {
			text-decoration: none;
			color: inherit;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 0 20px;
		}

		/* Breadcrumb */
		.breadcrumb {
			padding: 15px 0;
			background: #fff;
			border-bottom: 1px solid #eee;
		}

		.breadcrumb-list {
			display: flex;
			align-items: center;
			gap: 8px;
			list-style: none;
			font-size: 13px;
		}

		.breadcrumb-list li {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.breadcrumb-list a {
			color: #666;
			transition: color 0.2s;
		}

		.breadcrumb-list a:hover {
			color: #e31e24;
		}

		.breadcrumb-list .separator {
			color: #ccc;
		}

		.breadcrumb-list .current {
			color: #333;
			font-weight: 500;
		}

		/* Product Detail Section */
		.product-detail-section {
			padding: 40px 0;
			background: #fff;
		}

		.product-detail-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 50px;
			align-items: start;
		}

		/* Product Image */
		.product-image-container {
			position: relative;
			background: #f9f9f9;
			border-radius: 12px;
			padding: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			min-height: 400px;
		}

		.product-image-container img {
			max-width: 100%;
			max-height: 350px;
			object-fit: contain;
		}

		.product-favorite-btn {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 40px;
			height: 40px;
			background: #fff;
			border: none;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			transition: transform 0.2s;
		}

		.product-favorite-btn:hover {
			transform: scale(1.1);
		}

		.product-favorite-btn svg {
			width: 20px;
			height: 20px;
			color: #ccc;
			fill: none;
			stroke: currentColor;
			stroke-width: 2;
			transition: all 0.2s;
		}

		.product-favorite-btn.active svg {
			color: #e31e24;
			fill: #e31e24;
		}

		/* Product Info */
		.product-info {
			padding: 20px 0;
		}

		.product-title {
			font-size: 28px;
			font-weight: 700;
			color: #333;
			margin-bottom: 15px;
			line-height: 1.3;
		}

		.product-price-info {
			font-size: 14px;
			color: #666;
			margin-bottom: 20px;
		}

		.product-price-value {
			font-size: 24px;
			font-weight: 700;
			color: #e31e24;
		}

		.product-price-label {
			font-size: 13px;
			color: #888;
			margin-top: 4px;
		}

		/* Price Labels */
		.price-label {
			font-size: 11px;
			padding: 3px 8px;
			border-radius: 4px;
			margin-left: 8px;
			font-weight: 500;
		}
		.price-label.size-ozel {
			background: #e8f5e9;
			color: #2e7d32;
		}
		.price-label.bayi-ozel {
			background: #e3f2fd;
			color: #1565c0;
		}
		.price-label.perakende {
			background: #f5f5f5;
			color: #666;
		}

		.product-description {
			font-size: 14px;
			color: #666;
			line-height: 1.7;
			margin-bottom: 30px;
		}

		/* Quantity Selector */
		.quantity-cart-row {
			display: flex;
			align-items: center;
			gap: 15px;
			margin-bottom: 30px;
		}

		.quantity-selector {
			display: flex;
			align-items: center;
			border: 1px solid #e0e0e0;
			border-radius: 30px;
			overflow: hidden;
		}

		.quantity-btn {
			width: 44px;
			height: 44px;
			background: #fff;
			border: none;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 20px;
			color: #e31e24;
			transition: background 0.2s;
		}

		.quantity-btn:hover {
			background: #f5f5f5;
		}

		.quantity-btn:disabled {
			color: #ccc;
			cursor: not-allowed;
		}

		.quantity-input {
			width: 50px;
			text-align: center;
			border: none;
			font-size: 16px;
			font-weight: 600;
			font-family: inherit;
			-moz-appearance: textfield;
		}

		.quantity-input::-webkit-outer-spin-button,
		.quantity-input::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}

		.btn-add-to-cart {
			flex: 1;
			max-width: 250px;
			padding: 14px 30px;
			background: #e31e24;
			border: none;
			border-radius: 30px;
			color: #fff;
			font-size: 15px;
			font-weight: 600;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
			transition: background 0.2s, transform 0.2s;
		}

		.btn-add-to-cart:hover {
			background: #c41a1f;
			transform: translateY(-2px);
		}

		.btn-add-to-cart.added {
			background: #28a745;
		}

		.btn-add-to-cart svg {
			width: 20px;
			height: 20px;
		}

		/* Accordion Sections */
		.accordion-section {
			border-top: 1px solid #eee;
			padding: 20px 0;
		}

		.accordion-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			cursor: pointer;
			padding: 5px 0;
		}

		.accordion-title {
			font-size: 16px;
			font-weight: 600;
			color: #333;
		}

		.accordion-icon {
			width: 24px;
			height: 24px;
			color: #666;
			transition: transform 0.3s;
		}

		.accordion-section.open .accordion-icon {
			transform: rotate(180deg);
		}

		.accordion-content {
			max-height: 0;
			overflow: hidden;
			transition: max-height 0.3s ease;
		}

		.accordion-section.open .accordion-content {
			max-height: 500px;
		}

		.accordion-body {
			padding-top: 15px;
		}

		/* Technical Specs */
		.specs-list {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 12px;
		}

		.spec-item {
			display: flex;
			justify-content: space-between;
			padding: 8px 0;
			border-bottom: 1px solid #f0f0f0;
		}

		.spec-label {
			font-size: 14px;
			color: #666;
		}

		.spec-value {
			font-size: 14px;
			font-weight: 600;
			color: #333;
		}

		/* Warnings */
		.warnings-text {
			font-size: 13px;
			color: #666;
			line-height: 1.7;
		}

		/* Recommended Products Section */
		.recommended-section {
			padding: 50px 0;
			background: #f5f5f5;
		}

		.section-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 25px;
		}

		.section-title {
			font-size: 20px;
			font-weight: 600;
			color: #333;
		}

		.section-link {
			font-size: 13px;
			color: #e31e24;
			display: flex;
			align-items: center;
			gap: 4px;
		}

		.section-link:hover {
			text-decoration: underline;
		}

		/* Product Cards */
		.products-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 20px;
		}

		.product-card {
			position: relative;
			background: #fff;
			border: 1px solid #eee;
			border-radius: 12px;
			padding: 20px;
			text-align: center;
			transition: box-shadow 0.2s, transform 0.2s;
			cursor: pointer;
		}

		.product-card:hover {
			box-shadow: 0 5px 20px rgba(0,0,0,0.1);
			transform: translateY(-2px);
		}

		.product-card-favorite {
			position: absolute;
			top: 12px;
			right: 12px;
			width: 32px;
			height: 32px;
			background: #fff;
			border: none;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			z-index: 2;
			transition: transform 0.2s;
		}

		.product-card-favorite:hover {
			transform: scale(1.1);
		}

		.product-card-favorite svg {
			width: 18px;
			height: 18px;
			color: #ccc;
			fill: none;
			stroke: currentColor;
			stroke-width: 2;
			transition: all 0.2s;
		}

		.product-card-favorite.active svg {
			color: #e31e24;
			fill: #e31e24;
		}

		.product-card-image {
			height: 120px;
			display: flex;
			align-items: center;
			justify-content: center;
			margin-bottom: 15px;
		}

		.product-card-image img {
			max-height: 100%;
			max-width: 100%;
			object-fit: contain;
		}

		.product-card-name {
			font-size: 14px;
			font-weight: 600;
			color: #333;
			margin-bottom: 8px;
			min-height: 40px;
		}

		.product-card-price {
			font-size: 12px;
			color: #888;
			margin-bottom: 15px;
		}

		.btn-card-add-cart {
			width: 100%;
			padding: 10px 16px;
			background: #fff;
			border: 2px solid #e31e24;
			border-radius: 25px;
			color: #e31e24;
			font-size: 13px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
		}

		.btn-card-add-cart:hover {
			background: #e31e24;
			color: #fff;
		}

		.btn-card-add-cart.added {
			background: #28a745;
			border-color: #28a745;
			color: #fff;
		}

		/* Loading State */
		.loading {
			text-align: center;
			padding: 60px;
			color: #666;
		}

		.loading-spinner {
			width: 40px;
			height: 40px;
			border: 3px solid #f0f0f0;
			border-top-color: #e31e24;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 0 auto 15px;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		/* Error State */
		.error-message {
			text-align: center;
			padding: 60px;
			color: #666;
		}

		.error-message svg {
			width: 60px;
			height: 60px;
			color: #e31e24;
			margin-bottom: 15px;
		}

		/* Footer */
		.footer {
			background: #f5f5f5;
			padding: 40px 0 20px;
			border-top: 1px solid #eee;
		}

		/* Responsive */
		@media (max-width: 992px) {
			.product-detail-grid {
				grid-template-columns: 1fr;
				gap: 30px;
			}

			.product-image-container {
				min-height: 300px;
			}

			.products-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		@media (max-width: 768px) {
			.product-title {
				font-size: 22px;
			}

			.quantity-cart-row {
				flex-direction: column;
				align-items: stretch;
			}

			.btn-add-to-cart {
				max-width: none;
			}

			.specs-list {
				grid-template-columns: 1fr;
			}

			.products-grid {
				grid-template-columns: 1fr;
			}
		}

		@media (max-width: 576px) {
			.product-image-container {
				min-height: 250px;
				padding: 20px;
			}
		}
	</style>
</head>
<body>
	<!-- Top Bar (Component) -->
	<div id="isyerim-top-bar"></div>

	<!-- Header (Component) -->
	<div id="isyerim-header"></div>

	<!-- Breadcrumb -->
	<nav class="breadcrumb">
		<div class="container">
			<ul class="breadcrumb-list">
				<li><a href="isyerim-musteri-anasayfa.html">Anasayfa</a></li>
				<li><span class="separator">/</span></li>
				<li><a href="isyerim-musteri-anasayfa.html">İşYerim Ürünler</a></li>
				<li><span class="separator">/</span></li>
				<li><span class="current" id="breadcrumb-product-name">Yükleniyor...</span></li>
			</ul>
		</div>
	</nav>

	<!-- Product Detail Section -->
	<section class="product-detail-section">
		<div class="container">
			<div id="product-detail-content">
				<!-- Loading state -->
				<div class="loading">
					<div class="loading-spinner"></div>
					<p>Ürün bilgileri yükleniyor...</p>
				</div>
			</div>
		</div>
	</section>

	<!-- Recommended Products Section -->
	<section class="recommended-section">
		<div class="container">
			<div class="section-header">
				<h2 class="section-title">Önerilen Ürünler</h2>
				<a href="isyerim-musteri-anasayfa.html" class="section-link">
					Tümünü Gör
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
						<path d="M9 18l6-6-6-6"/>
					</svg>
				</a>
			</div>
			<div class="products-grid" id="recommended-products">
				<!-- Loading state -->
				<div class="loading" style="grid-column: 1/-1;">
					<div class="loading-spinner"></div>
					<p>Önerilen ürünler yükleniyor...</p>
				</div>
			</div>
		</div>
	</section>

	<!-- Footer (Component) -->
	<div id="isyerim-footer"></div>

	<!-- Supabase -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="./js/supabase-client.js"></script>
	<script src="./js/services/products-service.js"></script>
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/customer-prices-service.js"></script>
	<script src="./js/services/cart-service.js?v=4"></script>
	<script src="./js/services/branches-service.js"></script>
	<script src="./js/services/favorites-service.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/offers-service.js"></script>
	<script src="./js/services/price-resolver-service.js"></script>
	<script src="./js/component-loader.js"></script>
	<script>
		// Global değişkenler
		var currentProduct = null;
		var allProducts = [];
		var resolvedPrices = {}; // PriceResolverService'den gelen fiyatlar
		var currentQuantity = 1;
		var currentCustomerId = null;
		var currentBranchId = null;
		var currentDealerId = null;
		var isProductFavorite = false; // Favori durumu

		// URL'den product ID al
		function getProductIdFromUrl() {
			var params = new URLSearchParams(window.location.search);
			return params.get('id');
		}

		// Sayfa yüklendiğinde
		document.addEventListener('DOMContentLoaded', async function() {
			var productId = getProductIdFromUrl();

			if (!productId) {
				showError('Ürün bulunamadı');
				return;
			}

			// Müşteri ID'sini al
			var customerId = sessionStorage.getItem('isyerim_customer_id');

			// Veritabanından sepeti yükle (login olmuşsa)
			if (customerId) {
				await CartService.loadFromDatabase(customerId);
			}

			// Sepet badge'ini güncelle
			updateCartBadge();

			// Ürün verilerini yükle
			await loadProductData(productId);
		});

		// Ürün verilerini yükle
		async function loadProductData(productId) {
			try {
				// Ürünü getir
				var result = await ProductsService.getById(productId);
				if (result.error || !result.data) {
					showError('Ürün bulunamadı');
					return;
				}

				currentProduct = result.data;

				// Session'dan müşteri bilgilerini al
				currentCustomerId = sessionStorage.getItem('isyerim_customer_id');
				currentBranchId = sessionStorage.getItem('selected_address_id');
				currentDealerId = sessionStorage.getItem('isyerim_dealer_id');

				// Tüm ürünleri getir (önerilen ürünler için)
				var allResult = await ProductsService.getAll();
				if (allResult.data) {
					allProducts = allResult.data;
				}

				// PriceResolverService ile fiyatları çözümle
				resolvedPrices = await PriceResolverService.resolvePricesForProducts(
					allProducts,
					currentCustomerId,
					currentBranchId,
					currentDealerId
				);

				// Favori durumunu kontrol et
				var isyerimCustomerId = sessionStorage.getItem('isyerim_customer_id');
				if (isyerimCustomerId) {
					var favResult = await FavoritesService.isFavorite(isyerimCustomerId, productId);
					if (favResult.data) {
						isProductFavorite = true;
					}
				}

				// Sayfayı render et
				renderProductDetail();
				renderRecommendedProducts();

			} catch (err) {
				console.error('Ürün yükleme hatası:', err);
				showError('Ürün yüklenirken bir hata oluştu');
			}
		}

		// Ürün detayını render et
		function renderProductDetail() {
			var container = document.getElementById('product-detail-content');

			// PriceResolverService'den çözümlenmiş fiyatı al
			var priceInfo = resolvedPrices[currentProduct.id] || {
				price: currentProduct.base_price || 0,
				label: 'Perakende',
				cssClass: 'perakende'
			};
			var formattedPrice = parseFloat(priceInfo.price).toLocaleString('tr-TR', {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			});

			// Ürün resim URL'i
			var imageUrl = currentProduct.image_url || './İpragaz Bayi_files/IPR-BAYI-12-kg-ipr-uzun.png';

			// Teknik özellikler
			var specs = [];
			if (currentProduct.color) specs.push({ label: 'Rengi', value: currentProduct.color });
			if (currentProduct.weight_kg) specs.push({ label: 'Kapasite', value: currentProduct.weight_kg + ' kg' });
			if (currentProduct.height_mm) specs.push({ label: 'Tüp Boyu', value: currentProduct.height_mm + ' mm' });
			if (currentProduct.diameter_mm) specs.push({ label: 'Tüp Çapı', value: currentProduct.diameter_mm + ' mm' });

			var specsHtml = specs.map(function(spec) {
				return '<div class="spec-item"><span class="spec-label">' + spec.label + '</span><span class="spec-value">' + spec.value + '</span></div>';
			}).join('');

			// Breadcrumb güncelle
			document.getElementById('breadcrumb-product-name').textContent = currentProduct.name;
			document.title = currentProduct.name + ' - İpragaz İşYerim';

			// Favori butonu class'ı
			var favBtnClass = isProductFavorite ? 'product-favorite-btn active' : 'product-favorite-btn';

			var html = '<div class="product-detail-grid">' +
				'<div class="product-image-container">' +
					'<button class="' + favBtnClass + '" id="favoriteBtn">' +
						'<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>' +
					'</button>' +
					'<img src="' + imageUrl + '" alt="' + currentProduct.name + '">' +
				'</div>' +
				'<div class="product-info">' +
					'<h1 class="product-title">' + currentProduct.name + '</h1>' +
					'<div class="product-price-info">' +
						'<div class="product-price-value">₺' + formattedPrice + ' <span class="price-label ' + priceInfo.cssClass + '">' + priceInfo.label + '</span></div>' +
						'<div class="product-price-label">/ Adet* KDV dahil</div>' +
					'</div>' +
					(currentProduct.description ? '<p class="product-description">' + currentProduct.description + '</p>' : '') +
					'<div class="quantity-cart-row">' +
						'<div class="quantity-selector">' +
							'<button class="quantity-btn" id="decreaseBtn" onclick="decreaseQuantity()">−</button>' +
							'<input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="99" onchange="onQuantityChange()">' +
							'<button class="quantity-btn" id="increaseBtn" onclick="increaseQuantity()">+</button>' +
						'</div>' +
						'<button class="btn-add-to-cart" id="addToCartBtn" onclick="addToCart()">' +
							'<span>Sepete Ekle</span>' +
							'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
								'<path d="M9 18l6-6-6-6"/>' +
							'</svg>' +
						'</button>' +
					'</div>' +
					(specs.length > 0 ?
						'<div class="accordion-section open" id="specsAccordion">' +
							'<div class="accordion-header" onclick="toggleAccordion(\'specsAccordion\')">' +
								'<span class="accordion-title">Teknik Özellikler</span>' +
								'<svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>' +
							'</div>' +
							'<div class="accordion-content">' +
								'<div class="accordion-body">' +
									'<div class="specs-list">' + specsHtml + '</div>' +
								'</div>' +
							'</div>' +
						'</div>' : '') +
					(currentProduct.warnings ?
						'<div class="accordion-section open" id="warningsAccordion">' +
							'<div class="accordion-header" onclick="toggleAccordion(\'warningsAccordion\')">' +
								'<span class="accordion-title">Uyarılar</span>' +
								'<svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>' +
							'</div>' +
							'<div class="accordion-content">' +
								'<div class="accordion-body">' +
									'<p class="warnings-text">' + currentProduct.warnings + '</p>' +
								'</div>' +
							'</div>' +
						'</div>' : '') +
				'</div>' +
			'</div>';

			container.innerHTML = html;

			// Favori butonuna event listener ekle
			document.getElementById('favoriteBtn').addEventListener('click', async function() {
				var customerId = sessionStorage.getItem('isyerim_customer_id');
				if (!customerId) {
					alert('Favorilere eklemek icin giris yapmaniz gerekiyor.');
					return;
				}

				var btn = this;
				var result = await FavoritesService.toggleFavorite(customerId, currentProduct.id);
				if (result.error) {
					console.error('Favori hatasi:', result.error);
					return;
				}

				// UI guncelle
				isProductFavorite = result.data.isFavorite;
				if (isProductFavorite) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
			});
		}

		// Önerilen ürünleri render et
		function renderRecommendedProducts() {
			var container = document.getElementById('recommended-products');

			// Mevcut ürünü filtrele
			var otherProducts = allProducts.filter(function(p) {
				return p.id !== currentProduct.id;
			});

			// Rastgele 3 ürün seç
			var shuffled = otherProducts.sort(function() { return 0.5 - Math.random(); });
			var recommended = shuffled.slice(0, 3);

			if (recommended.length === 0) {
				container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">Önerilen ürün bulunamadı</p>';
				return;
			}

			var html = recommended.map(function(product) {
				var priceInfo = resolvedPrices[product.id] || {
					price: product.base_price || 0,
					label: 'Perakende',
					cssClass: 'perakende'
				};
				var formattedPrice = parseFloat(priceInfo.price).toLocaleString('tr-TR', {
					minimumFractionDigits: 2,
					maximumFractionDigits: 2
				});
				var imageUrl = product.image_url || './İpragaz Bayi_files/IPR-BAYI-12-kg-ipr-uzun.png';

				return '<div class="product-card" data-product-id="' + product.id + '" onclick="goToProductDetail(\'' + product.id + '\')">' +
					'<button class="product-card-favorite" onclick="event.stopPropagation(); toggleCardFavorite(this)">' +
						'<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>' +
					'</button>' +
					'<div class="product-card-image">' +
						'<img src="' + imageUrl + '" alt="' + product.name + '">' +
					'</div>' +
					'<div class="product-card-name">' + product.name + '</div>' +
					'<div class="product-card-price">₺' + formattedPrice + ' <span class="price-label ' + priceInfo.cssClass + '">' + priceInfo.label + '</span></div>' +
					'<button class="btn-card-add-cart" onclick="event.stopPropagation(); addRecommendedToCart(this, \'' + product.id + '\')">Sepete Ekle</button>' +
				'</div>';
			}).join('');

			container.innerHTML = html;
		}

		// Bayi değişikliğinde fiyatları yenile
		window.refreshPrices = async function() {
			// Güncel bayi/şube bilgilerini sessionStorage'dan al
			currentBranchId = sessionStorage.getItem('selected_address_id');
			currentDealerId = sessionStorage.getItem('isyerim_dealer_id');

			// PriceResolverService ile fiyatları yeniden çözümle
			resolvedPrices = await PriceResolverService.resolvePricesForProducts(
				allProducts,
				currentCustomerId,
				currentBranchId,
				currentDealerId
			);

			// Sayfayı yeniden render et
			renderProductDetail();
			renderRecommendedProducts();
		};

		// Accordion toggle
		function toggleAccordion(id) {
			var accordion = document.getElementById(id);
			accordion.classList.toggle('open');
		}

		// Miktar azalt
		function decreaseQuantity() {
			if (currentQuantity > 1) {
				currentQuantity--;
				document.getElementById('quantityInput').value = currentQuantity;
				updateQuantityButtons();
			}
		}

		// Miktar artır
		function increaseQuantity() {
			if (currentQuantity < 99) {
				currentQuantity++;
				document.getElementById('quantityInput').value = currentQuantity;
				updateQuantityButtons();
			}
		}

		// Miktar değişikliği
		function onQuantityChange() {
			var input = document.getElementById('quantityInput');
			var value = parseInt(input.value) || 1;
			value = Math.max(1, Math.min(99, value));
			currentQuantity = value;
			input.value = currentQuantity;
			updateQuantityButtons();
		}

		// Buton durumlarını güncelle
		function updateQuantityButtons() {
			document.getElementById('decreaseBtn').disabled = currentQuantity <= 1;
			document.getElementById('increaseBtn').disabled = currentQuantity >= 99;
		}

		// Sepete ekle
		async function addToCart() {
			if (!currentProduct) return;

			// Çözümlenmiş fiyatı al
			var priceInfo = resolvedPrices[currentProduct.id] || { price: currentProduct.base_price || 0 };
			var btn = document.getElementById('addToCartBtn');

			// Ürünü sepete ekle
			await CartService.addItem({
				id: currentProduct.id,
				code: currentProduct.code,
				name: currentProduct.name,
				price: priceInfo.price,
				points: currentProduct.points_per_unit || 0,
				image_url: currentProduct.image_url
			}, currentQuantity);

			// Badge'i güncelle
			updateCartBadge();

			// Buton animasyonu
			btn.innerHTML = '<span>Eklendi ✓</span>';
			btn.classList.add('added');

			setTimeout(function() {
				btn.innerHTML = '<span>Sepete Ekle</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>';
				btn.classList.remove('added');
			}, 1500);
		}

		// Önerilen ürünü sepete ekle
		async function addRecommendedToCart(btn, productId) {
			var product = allProducts.find(function(p) { return p.id === productId; });
			if (!product) return;

			// Çözümlenmiş fiyatı al
			var priceInfo = resolvedPrices[product.id] || { price: product.base_price || 0 };

			await CartService.addItem({
				id: product.id,
				code: product.code,
				name: product.name,
				price: priceInfo.price,
				points: product.points_per_unit || 0,
				image_url: product.image_url
			});

			updateCartBadge();

			// Buton animasyonu
			var originalText = btn.textContent;
			btn.textContent = 'Eklendi ✓';
			btn.classList.add('added');

			setTimeout(function() {
				btn.textContent = originalText;
				btn.classList.remove('added');
			}, 1500);
		}

		// Ürün detayına git
		function goToProductDetail(productId) {
			window.location.href = 'isyerim-musteri-urun-detay.html?id=' + productId;
		}

		// Kart favorisini toggle
		function toggleCardFavorite(btn) {
			btn.classList.toggle('active');
		}

		// Sepet badge güncelleme
		function updateCartBadge() {
			var count = CartService.getItemCount();
			var badge = document.getElementById('cartBadge');
			if (badge) {
				if (count > 0) {
					badge.textContent = count;
					badge.style.display = 'flex';
				} else {
					badge.style.display = 'none';
				}
			}
		}

		// Hata göster
		function showError(message) {
			var container = document.getElementById('product-detail-content');
			container.innerHTML = '<div class="error-message">' +
				'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
					'<circle cx="12" cy="12" r="10"/>' +
					'<line x1="12" y1="8" x2="12" y2="12"/>' +
					'<line x1="12" y1="16" x2="12.01" y2="16"/>' +
				'</svg>' +
				'<p>' + message + '</p>' +
				'<a href="isyerim-musteri-anasayfa.html" style="color: #e31e24; margin-top: 15px; display: inline-block;">← Anasayfaya Dön</a>' +
			'</div>';

			// Önerilen ürünleri gizle
			document.querySelector('.recommended-section').style.display = 'none';
		}

		// Sepet güncellendiğinde badge'i güncelle
		window.addEventListener('cartUpdated', function() {
			updateCartBadge();
		});
	</script>
</body>
</html>
