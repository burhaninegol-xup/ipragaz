<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Doğrulama Kodu - İpragaz</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			min-height: 100vh;
			background-color: #e31e24;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			overflow: hidden;
		}

		/* B Pattern Background */
		.bg-pattern {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			pointer-events: none;
		}

		.bg-pattern::before {
			content: 'B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B B';
			position: absolute;
			top: -50px;
			left: -50px;
			width: calc(100% + 100px);
			height: calc(100% + 100px);
			font-size: 80px;
			font-weight: 700;
			color: rgba(255, 255, 255, 0.08);
			word-spacing: 30px;
			line-height: 1.2;
			letter-spacing: 20px;
			word-break: break-all;
		}

		/* Login Card */
		.login-container {
			position: relative;
			z-index: 1;
			width: 100%;
			max-width: 420px;
			padding: 20px;
		}

		.login-card {
			background: #fff;
			border-radius: 12px;
			padding: 40px 35px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		/* Logo */
		.logo {
			text-align: center;
			margin-bottom: 30px;
		}

		.logo svg {
			width: 140px;
			height: auto;
		}

		/* Back Link / Title */
		.back-link {
			display: flex;
			align-items: center;
			gap: 8px;
			color: #333;
			font-size: 18px;
			font-weight: 600;
			margin-bottom: 20px;
			cursor: pointer;
			text-decoration: none;
		}

		.back-link:hover {
			color: #e31e24;
		}

		.back-link svg {
			width: 20px;
			height: 20px;
		}

		/* Description */
		.description {
			color: #666;
			font-size: 14px;
			line-height: 1.6;
			margin-bottom: 25px;
		}

		.description .phone-number {
			color: #e31e24;
			font-weight: 600;
		}

		/* OTP Inputs */
		.otp-container {
			display: flex;
			justify-content: center;
			gap: 12px;
			margin-bottom: 20px;
		}

		.otp-input {
			width: 60px;
			height: 60px;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			font-size: 24px;
			font-weight: 600;
			text-align: center;
			font-family: inherit;
			color: #333;
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		.otp-input:focus {
			outline: none;
			border-color: #e31e24;
			box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
		}

		.otp-input.error {
			border-color: #e31e24;
			background-color: #fff5f5;
		}

		.otp-input::placeholder {
			color: #ddd;
		}

		/* Timer */
		.timer {
			text-align: center;
			color: #888;
			font-size: 13px;
			margin-bottom: 25px;
		}

		.timer span {
			color: #333;
			font-weight: 500;
		}

		.timer.expired {
			color: #e31e24;
		}

		/* Submit Button */
		.btn-submit {
			width: 100%;
			padding: 14px 20px;
			background: #c41e24;
			border: none;
			border-radius: 25px;
			color: #fff;
			font-size: 15px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			transition: background 0.2s, transform 0.2s;
		}

		.btn-submit:hover {
			background: #a81a1f;
			transform: translateY(-1px);
		}

		.btn-submit:active {
			transform: translateY(0);
		}

		.btn-submit:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		/* Resend Link */
		.resend-link {
			text-align: center;
			margin-top: 20px;
		}

		.resend-link a {
			color: #888;
			font-size: 13px;
			text-decoration: none;
		}

		.resend-link a:hover {
			color: #e31e24;
			text-decoration: underline;
		}

		.resend-link a.disabled {
			color: #ccc;
			pointer-events: none;
		}

		/* Responsive */
		@media (max-width: 480px) {
			.login-card {
				padding: 30px 25px;
			}

			.logo svg {
				width: 120px;
			}

			.back-link {
				font-size: 16px;
			}

			.otp-input {
				width: 50px;
				height: 50px;
				font-size: 20px;
			}

			.bg-pattern::before {
				font-size: 50px;
			}
		}
	</style>
</head>
<body>
	<!-- Background Pattern -->
	<div class="bg-pattern"></div>

	<!-- Login Container -->
	<div class="login-container">
		<div class="login-card">
			<!-- Logo -->
			<div class="logo">
				<svg viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
					<!-- Power icon -->
					<circle cx="25" cy="25" r="20" fill="none" stroke="#e31e24" stroke-width="3"/>
					<path d="M25 10 L25 25" stroke="#e31e24" stroke-width="3" stroke-linecap="round"/>
					<!-- iPRAGAZ text -->
					<text x="55" y="32" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="#e31e24">iPRAGAZ</text>
				</svg>
			</div>

			<!-- Back Link / Title -->
			<a href="isyerim-musteri-login.html" class="back-link">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M19 12H5M12 19l-7-7 7-7"/>
				</svg>
				Giriş Yap
			</a>

			<!-- Description -->
			<p class="description">
				<span class="phone-number" id="phone-display">0 599 999 9999</span> numaralı telefona gönderilen 4 haneli doğrulama kodunu girmelisiniz.
			</p>

			<!-- OTP Inputs -->
			<div class="otp-container">
				<input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="one-time-code">
				<input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]">
				<input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]">
				<input type="text" class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]">
			</div>

			<!-- Timer -->
			<div class="timer" id="timer">
				Kalan Süre:<span id="countdown">10:00</span>
			</div>

			<!-- Submit Button -->
			<button class="btn-submit" id="submit-btn">Devam</button>

			<!-- Resend Link -->
			<div class="resend-link">
				<a href="#" id="resend-link" class="disabled">Kodu tekrar gönder</a>
			</div>
		</div>
	</div>

	<!-- Supabase CDN -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<!-- Supabase Client -->
	<script src="./js/supabase-client.js"></script>
	<!-- Service Dosyaları -->
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/customer-users-service.js"></script>

	<script>
		// Get phone from URL or sessionStorage
		var urlParams = new URLSearchParams(window.location.search);
		var phone = urlParams.get('phone') || sessionStorage.getItem('isyerim_phone');

		if (phone) {
			// Telefonu sessionStorage'a da kaydet (eğer URL'den geldiyse)
			sessionStorage.setItem('isyerim_phone', phone);
			// Format phone for display
			var formatted = '0 ' + phone.slice(0, 3) + ' ' + phone.slice(3, 6) + ' ' + phone.slice(6, 10);
			document.getElementById('phone-display').textContent = formatted;
		}

		// OTP Input handling
		var otpInputs = document.querySelectorAll('.otp-input');

		otpInputs.forEach(function(input, index) {
			// Only allow numbers
			input.addEventListener('input', function(e) {
				var value = e.target.value.replace(/\D/g, '');
				e.target.value = value;

				// Remove error state on input
				e.target.classList.remove('error');

				// Auto-focus next input
				if (value && index < otpInputs.length - 1) {
					otpInputs[index + 1].focus();
				}
			});

			// Handle backspace
			input.addEventListener('keydown', function(e) {
				if (e.key === 'Backspace' && !e.target.value && index > 0) {
					otpInputs[index - 1].focus();
				}
			});

			// Handle paste
			input.addEventListener('paste', function(e) {
				e.preventDefault();
				var pastedData = (e.clipboardData || window.clipboardData).getData('text');
				var digits = pastedData.replace(/\D/g, '').slice(0, 4);

				digits.split('').forEach(function(digit, i) {
					if (otpInputs[i]) {
						otpInputs[i].value = digit;
						otpInputs[i].classList.remove('error');
					}
				});

				// Focus last filled or next empty
				var lastIndex = Math.min(digits.length, otpInputs.length) - 1;
				if (lastIndex >= 0) {
					otpInputs[lastIndex].focus();
				}
			});
		});

		// Focus first input on load
		otpInputs[0].focus();

		// Countdown Timer (10 minutes = 600 seconds)
		var totalSeconds = 600;
		var timerElement = document.getElementById('countdown');
		var timerContainer = document.getElementById('timer');
		var resendLink = document.getElementById('resend-link');
		var submitBtn = document.getElementById('submit-btn');

		function updateTimer() {
			var minutes = Math.floor(totalSeconds / 60);
			var seconds = totalSeconds % 60;

			timerElement.textContent = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');

			if (totalSeconds <= 0) {
				clearInterval(timerInterval);
				timerContainer.classList.add('expired');
				timerElement.textContent = 'Süre doldu';
				resendLink.classList.remove('disabled');
				submitBtn.disabled = true;
			} else {
				totalSeconds--;
			}
		}

		var timerInterval = setInterval(updateTimer, 1000);

		// Submit button
		submitBtn.addEventListener('click', async function() {
			var code = '';
			var hasEmpty = false;

			otpInputs.forEach(function(input) {
				if (!input.value) {
					input.classList.add('error');
					hasEmpty = true;
				}
				code += input.value;
			});

			if (hasEmpty) {
				return;
			}

			if (code.length !== 4) {
				otpInputs.forEach(function(input) {
					input.classList.add('error');
				});
				return;
			}

			// Butonu devre dışı bırak
			submitBtn.disabled = true;
			submitBtn.textContent = 'Kontrol ediliyor...';

			try {
				// Supabase'den telefon numarası ile kullanici kontrolu yap
				var userResult = await CustomerUsersService.getByPhone(phone);

				if (userResult.data) {
					// Kullanici bulundu - session bilgilerini kaydet
					var user = userResult.data;
					var customer = user.customer;

					// Musterinin aktif olup olmadigini kontrol et
					if (!customer || !customer.is_active) {
						alert('Hesabiniz aktif degil. Lutfen bayi ile iletisime gecin.');
						submitBtn.disabled = false;
						submitBtn.textContent = 'Devam';
						return;
					}

					// Kullanici bilgilerini kaydet
					sessionStorage.setItem('isyerim_customer_id', user.customer_id);
					sessionStorage.setItem('isyerim_user_id', user.id);
					sessionStorage.setItem('isyerim_user_role', user.role);
					sessionStorage.setItem('isyerim_user_name', user.name);
					sessionStorage.setItem('isyerim_customer_name', customer.company_name || customer.name || 'Musteri');
					sessionStorage.setItem('isyerim_tabela_unvani', customer.tabela_unvani || '');
					sessionStorage.setItem('isNewUser', 'false');

					window.location.href = 'isyerim-musteri-anasayfa.html';
				} else {
					// Kullanici bulunamadi - eski sistemdeki musteriye bakalim
					var customerResult = await CustomersService.getByPhone(phone);

					if (customerResult.data) {
						// Musteri var ama kullanicisi yok - owner olustur ve giris yap
						var customer = customerResult.data;

						// Musterinin aktif olup olmadigini kontrol et
						if (!customer.is_active) {
							alert('Hesabiniz aktif degil. Lutfen bayi ile iletisime gecin.');
							submitBtn.disabled = false;
							submitBtn.textContent = 'Devam';
							return;
						}

						// Owner kullanici olustur
						var ownerResult = await CustomerUsersService.createOwner(
							customer.id,
							customer.name,
							customer.phone
						);

						if (ownerResult.data) {
							// Olusturulan owner ile giris yap
							sessionStorage.setItem('isyerim_customer_id', customer.id);
							sessionStorage.setItem('isyerim_user_id', ownerResult.data.id);
							sessionStorage.setItem('isyerim_user_role', 'owner');
							sessionStorage.setItem('isyerim_user_name', customer.name);
							sessionStorage.setItem('isyerim_customer_name', customer.company_name || customer.name || 'Musteri');
							sessionStorage.setItem('isyerim_tabela_unvani', customer.tabela_unvani || '');
							sessionStorage.setItem('isNewUser', 'false');

							window.location.href = 'isyerim-musteri-anasayfa.html';
						} else {
							// Owner olusturulamadi - yine de giris yap (eski akis)
							sessionStorage.setItem('isyerim_customer_id', customer.id);
							sessionStorage.setItem('isyerim_user_id', customer.id); // Owner icin customer.id kullan
							sessionStorage.setItem('isyerim_user_role', 'owner');
							sessionStorage.setItem('isyerim_user_name', customer.name);
							sessionStorage.setItem('isyerim_customer_name', customer.company_name || customer.name || 'Musteri');
							sessionStorage.setItem('isyerim_tabela_unvani', customer.tabela_unvani || '');
							sessionStorage.setItem('isNewUser', 'false');

							window.location.href = 'isyerim-musteri-anasayfa.html';
						}
					} else {
						// Yeni kullanici - uye ol sayfasina yonlendir
						sessionStorage.setItem('isNewUser', 'true');
						window.location.href = 'isyerim-musteri-uye-ol.html';
					}
				}
			} catch (error) {
				console.error('Kullanici kontrolu hatasi:', error);
				// Hata durumunda yeni kullanici gibi davran
				sessionStorage.setItem('isNewUser', 'true');
				window.location.href = 'isyerim-musteri-uye-ol.html';
			}
		});

		// Resend code
		resendLink.addEventListener('click', function(e) {
			e.preventDefault();

			if (this.classList.contains('disabled')) {
				return;
			}

			// Reset timer
			totalSeconds = 600;
			timerContainer.classList.remove('expired');
			resendLink.classList.add('disabled');
			submitBtn.disabled = false;

			// Clear inputs
			otpInputs.forEach(function(input) {
				input.value = '';
				input.classList.remove('error');
			});
			otpInputs[0].focus();

			// Restart timer
			timerInterval = setInterval(updateTimer, 1000);

			alert('Yeni doğrulama kodu gönderildi!');
		});
	</script>
</body>
</html>
