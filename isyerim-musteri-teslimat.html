<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Teslimat ve Ödeme - İpragaz</title>
	<link rel="shortcut icon" type="image/x-icon" href="https://ipappbayi.ipragaz.com.tr/bayi/_ui/responsive/theme-ipragaz/images/faviconNew.jpg">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #fff;
			color: #333;
			min-height: 100vh;
			display: flex;
			flex-direction: column;
		}

		a {
			text-decoration: none;
			color: inherit;
		}

		/* Stepper */
		.stepper {
			display: flex;
			align-items: center;
			gap: 0;
		}

		.step {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.step-number {
			width: 28px;
			height: 28px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 13px;
			font-weight: 600;
		}

		.step-number.active {
			background: #e31e24;
			color: #fff;
		}

		.step-number.completed {
			background: #e31e24;
			color: #fff;
		}

		.step-number.inactive {
			border: 1px solid #ccc;
			color: #999;
			background: #fff;
		}

		.step-label {
			font-size: 14px;
			font-weight: 500;
		}

		.step-label.active {
			color: #333;
		}

		.step-label.inactive {
			color: #999;
		}

		.step-line {
			width: 80px;
			height: 1px;
			background: #ddd;
			margin: 0 15px;
		}

		/* Main Layout */
		.main-container {
			max-width: 1400px;
			margin: 0 auto;
			padding: 40px 60px;
			display: flex;
			gap: 80px;
			flex: 1;
			width: 100%;
		}

		/* Form Content */
		.form-content {
			flex: 2;
		}

		.form-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 20px;
		}

		.form-divider {
			height: 1px;
			background: #eee;
			margin-bottom: 30px;
		}

		/* Form Row */
		.form-row {
			display: flex;
			gap: 20px;
			margin-bottom: 30px;
		}

		.form-group {
			flex: 1;
		}

		.form-label {
			display: block;
			font-size: 13px;
			color: #666;
			margin-bottom: 8px;
		}

		.form-select {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid #ddd;
			border-radius: 8px;
			font-size: 14px;
			font-family: inherit;
			color: #333;
			background: #fff;
			cursor: pointer;
			appearance: none;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 16px center;
		}

		.form-select:focus {
			outline: none;
			border-color: #e31e24;
		}

		/* Custom Bayi Selector */
		.bayi-selector {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid #ddd;
			border-radius: 8px;
			font-size: 14px;
			color: #333;
			background: #fff;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: space-between;
			transition: border-color 0.2s;
		}

		.bayi-selector:hover {
			border-color: #e31e24;
		}

		.bayi-selector-text {
			color: #333;
		}

		.bayi-selector-text.placeholder {
			color: #999;
		}

		.bayi-selector svg {
			width: 16px;
			height: 16px;
			color: #666;
		}

		/* Bayi Overlay Modal */
		.bayi-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}

		.bayi-overlay.active {
			display: flex;
		}

		.bayi-modal {
			background: #fff;
			border-radius: 16px;
			width: 90%;
			max-width: 500px;
			max-height: 80vh;
			overflow: hidden;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		.bayi-modal-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 20px 24px;
			border-bottom: 1px solid #eee;
		}

		.bayi-modal-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
		}

		.bayi-modal-close {
			width: 32px;
			height: 32px;
			border: none;
			background: #f5f5f5;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: background 0.2s;
		}

		.bayi-modal-close:hover {
			background: #eee;
		}

		.bayi-modal-close svg {
			width: 16px;
			height: 16px;
			color: #666;
		}

		.bayi-list {
			padding: 12px 0;
			max-height: 400px;
			overflow-y: auto;
		}

		.bayi-item {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 16px 24px;
			cursor: pointer;
			transition: background 0.2s;
		}

		.bayi-item:hover {
			background: #f9f9f9;
		}

		.bayi-item-info {
			flex: 1;
		}

		.bayi-item-name {
			font-size: 15px;
			font-weight: 500;
			color: #333;
			margin-bottom: 4px;
		}

		.bayi-item-address {
			font-size: 13px;
			color: #888;
		}

		.bayi-item-distance {
			font-size: 14px;
			font-weight: 600;
			color: #e31e24;
			margin-left: 20px;
		}

		/* Delivery Selector */
		.delivery-selector {
			width: 100%;
			padding: 14px 16px;
			border: 1px solid #ddd;
			border-radius: 8px;
			font-size: 14px;
			color: #333;
			background: #fff;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: space-between;
			transition: border-color 0.2s, opacity 0.2s;
		}

		.delivery-selector:hover:not(.disabled) {
			border-color: #e31e24;
		}

		.delivery-selector.disabled {
			opacity: 0.5;
			cursor: not-allowed;
			background: #f9f9f9;
		}

		.delivery-selector-text {
			color: #333;
		}

		.delivery-selector-text.placeholder {
			color: #999;
		}

		.delivery-selector svg {
			width: 16px;
			height: 16px;
			color: #666;
		}

		/* Delivery Overlay Modal */
		.delivery-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}

		.delivery-overlay.active {
			display: flex;
		}

		.delivery-modal {
			background: #fff;
			border-radius: 16px;
			width: 90%;
			max-width: 550px;
			max-height: 80vh;
			overflow: hidden;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		.delivery-modal-header {
			padding: 24px 24px 0;
			text-align: center;
		}

		.delivery-modal-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 20px;
		}

		/* Day Tabs */
		.delivery-tabs {
			display: flex;
			border-bottom: 1px solid #eee;
			padding: 0 24px;
			overflow-x: auto;
		}

		.delivery-tab {
			flex: 1;
			padding: 12px 8px;
			text-align: center;
			cursor: pointer;
			border-bottom: 2px solid transparent;
			transition: all 0.2s;
			min-width: 80px;
		}

		.delivery-tab:hover {
			background: #f9f9f9;
		}

		.delivery-tab.active {
			border-bottom-color: #e31e24;
		}

		.delivery-tab-day {
			font-size: 13px;
			color: #333;
			font-weight: 500;
		}

		.delivery-tab-date {
			font-size: 12px;
			color: #888;
			margin-top: 2px;
		}

		.delivery-tab.active .delivery-tab-day,
		.delivery-tab.active .delivery-tab-date {
			color: #333;
		}

		/* Time Slots */
		.delivery-times {
			padding: 20px 24px;
			max-height: 300px;
			overflow-y: auto;
		}

		.delivery-time-option {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 14px 0;
			border-bottom: 1px solid #f5f5f5;
			cursor: pointer;
		}

		.delivery-time-option:last-child {
			border-bottom: none;
		}

		.delivery-time-option input[type="radio"] {
			width: 20px;
			height: 20px;
			accent-color: #e31e24;
			cursor: pointer;
		}

		.delivery-time-option label {
			font-size: 15px;
			color: #333;
			cursor: pointer;
		}

		/* Select Button */
		.delivery-modal-footer {
			padding: 20px 24px;
		}

		.btn-select-delivery {
			width: 100%;
			padding: 16px 30px;
			background: #e31e24;
			color: #fff;
			border: none;
			border-radius: 30px;
			font-size: 15px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			transition: background 0.2s;
		}

		.btn-select-delivery:hover {
			background: #c41a1f;
		}

		.btn-select-delivery svg {
			width: 18px;
			height: 18px;
		}

		/* Delivery Notice Bar */
		.delivery-notice {
			background: #fff8e6;
			border: 1px solid #ffc107;
			border-radius: 8px;
			padding: 12px 16px;
			margin-top: 20px;
			display: none;
		}

		.delivery-notice.active {
			display: flex;
			align-items: flex-start;
			gap: 10px;
		}

		.delivery-notice-icon {
			flex-shrink: 0;
			color: #ffc107;
		}

		.delivery-notice-icon svg {
			width: 20px;
			height: 20px;
		}

		.delivery-notice-text {
			font-size: 13px;
			color: #856404;
			line-height: 1.5;
		}

		/* Payment Method */
		.payment-section {
			margin-top: 10px;
		}

		.payment-title {
			font-size: 14px;
			font-weight: 500;
			color: #333;
			margin-bottom: 15px;
		}

		.payment-options {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.payment-option {
			display: flex;
			align-items: center;
			gap: 10px;
			cursor: pointer;
		}

		.payment-option input[type="radio"] {
			width: 20px;
			height: 20px;
			accent-color: #e31e24;
			cursor: pointer;
		}

		.payment-option label {
			font-size: 14px;
			color: #333;
			cursor: pointer;
		}

		/* Sidebar - Order Summary */
		.sidebar {
			width: 380px;
			flex-shrink: 0;
		}

		.order-summary {
			background: #fff;
		}

		.order-summary-title {
			font-size: 20px;
			font-weight: 600;
			color: #333;
			margin-bottom: 5px;
		}

		.order-summary-count {
			font-size: 13px;
			color: #666;
			margin-bottom: 20px;
		}

		.order-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}

		.order-row-label {
			font-size: 14px;
			color: #333;
		}

		.order-row-value {
			font-size: 14px;
			font-weight: 600;
			color: #333;
		}

		.order-row-value span {
			font-weight: 400;
			margin-left: 5px;
		}

		/* Fiyat + Puan Görünümü */
		.order-row-values {
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 4px;
		}

		.price-value {
			font-size: 15px;
			font-weight: 600;
			color: #333;
			line-height: 1.3;
		}

		.price-value-large {
			font-size: 18px;
		}

		.points-value {
			font-size: 12px;
			font-weight: 400;
			color: #888;
			line-height: 1.3;
		}

		/* Campaign Section */
		.campaign-section {
			margin-top: 25px;
			border: 1px solid #eee;
			border-radius: 8px;
			overflow: hidden;
		}

		.campaign-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 15px;
			background: #f9f9f9;
			cursor: pointer;
		}

		.campaign-header-title {
			font-size: 14px;
			font-weight: 500;
			color: #333;
		}

		.campaign-header svg {
			width: 18px;
			height: 18px;
			color: #666;
			transition: transform 0.3s;
		}

		.campaign-header.open svg {
			transform: rotate(180deg);
		}

		.campaign-content {
			padding: 15px;
			display: none;
		}

		.campaign-content.open {
			display: block;
		}

		.campaign-label {
			font-size: 13px;
			color: #666;
			margin-bottom: 12px;
		}

		.campaign-option {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 12px;
			border: 1px solid #eee;
			border-radius: 8px;
		}

		.campaign-option input[type="radio"] {
			width: 18px;
			height: 18px;
			accent-color: #e31e24;
			cursor: pointer;
		}

		.campaign-option-icon {
			width: 40px;
			height: 40px;
			background: #fff5f5;
			border-radius: 8px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.campaign-option-icon svg {
			width: 24px;
			height: 24px;
			color: #e31e24;
		}

		.campaign-option-details {
			flex: 1;
		}

		.campaign-option-name {
			font-size: 14px;
			font-weight: 500;
			color: #333;
		}

		.campaign-option-desc {
			font-size: 12px;
			color: #888;
		}

		.campaign-option-link {
			font-size: 13px;
			color: #e31e24;
			font-weight: 500;
		}

		.campaign-option-link:hover {
			text-decoration: underline;
		}

		/* Order Note */
		.order-note-section {
			margin-top: 25px;
		}

		.order-note-label {
			font-size: 13px;
			color: #666;
			margin-bottom: 8px;
		}

		.order-note-textarea {
			width: 100%;
			min-height: 100px;
			padding: 12px;
			border: 1px solid #eee;
			border-radius: 8px;
			font-size: 14px;
			font-family: inherit;
			resize: vertical;
		}

		.order-note-textarea:focus {
			outline: none;
			border-color: #e31e24;
		}

		/* Submit Button */
		.btn-submit {
			width: 100%;
			padding: 16px 30px;
			background: #e31e24;
			color: #fff;
			border: none;
			border-radius: 30px;
			font-size: 15px;
			font-weight: 600;
			font-family: inherit;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			margin-top: 25px;
			transition: background 0.2s, transform 0.2s;
		}

		.btn-submit:hover {
			background: #c41a1f;
			transform: translateY(-1px);
		}

		.btn-submit:active {
			transform: translateY(0);
		}

		.btn-submit svg {
			width: 18px;
			height: 18px;
		}

		/* Responsive */
		@media (max-width: 900px) {
			.stepper-container {
				padding: 15px 20px !important;
			}

			.stepper {
				flex-wrap: wrap;
				justify-content: center;
			}

			.step-line {
				width: 30px;
				margin: 0 10px;
			}

			.main-container {
				flex-direction: column;
				padding: 20px;
				gap: 30px;
			}

			.sidebar {
				width: 100%;
			}

			.form-row {
				flex-direction: column;
			}
		}

		@media (max-width: 600px) {
			.step-label {
				display: none;
			}

			.step-line {
				width: 20px;
			}

			/* Fiyat + Puan responsive */
			.price-value {
				font-size: 16px;
			}
			.price-value-large {
				font-size: 20px;
			}
			.points-value {
				font-size: 13px;
			}
		}
	</style>
</head>
<body>
	<!-- Top Bar (Component) -->
	<div id="isyerim-top-bar"></div>

	<!-- Header (Component) -->
	<div id="isyerim-header"></div>

	<!-- Stepper -->
	<div class="stepper-container" style="background: #fff; padding: 20px 60px; border-bottom: 1px solid #eee; display: flex; justify-content: center;">
		<div class="stepper">
			<div class="step">
				<span class="step-number completed">1</span>
				<span class="step-label active">Siparis Detayi</span>
			</div>
			<div class="step-line"></div>
			<div class="step">
				<span class="step-number completed">2</span>
				<span class="step-label active">Sepet</span>
			</div>
			<div class="step-line"></div>
			<div class="step">
				<span class="step-number active">3</span>
				<span class="step-label active">Teslimat ve Odeme</span>
			</div>
		</div>
	</div>

	<!-- Main Container -->
	<div class="main-container">
		<!-- Form Content -->
		<div class="form-content">
			<h1 class="form-title">Teslimat ve Ödeme</h1>
			<div class="form-divider"></div>

			<!-- Form Fields -->
			<div class="form-row">
				<div class="form-group">
					<label class="form-label">Bayi</label>
					<div class="bayi-selector" id="bayiSelector">
						<span class="bayi-selector-text placeholder" id="bayiSelectorText">Bayi Seçiniz</span>
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M6 9l6 6 6-6"/>
						</svg>
					</div>
					<input type="hidden" id="bayiSelect" value="">
				</div>
				<div class="form-group">
					<label class="form-label">Teslimat Tarihi ve Saati</label>
					<div class="delivery-selector disabled" id="deliverySelector">
						<span class="delivery-selector-text placeholder" id="deliverySelectorText">Teslimat Tarihi ve Saati Seçiniz</span>
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M6 9l6 6 6-6"/>
						</svg>
					</div>
					<input type="hidden" id="deliverySelect" value="">
				</div>
			</div>

			<!-- Delivery Notice Bar -->
			<div class="delivery-notice" id="deliveryNotice">
				<div class="delivery-notice-icon">
					<svg viewBox="0 0 24 24" fill="currentColor">
						<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
					</svg>
				</div>
				<span class="delivery-notice-text">Teslimat tarihindeki fiyat uygulanacaktır. Sipariş ve teslimat tarihindeki fiyatlar farklı olabilir.</span>
			</div>

			<!-- Payment Method -->
			<div class="payment-section">
				<div class="payment-title">Ödeme Yöntemi</div>
				<div class="payment-options">
					<div class="payment-option">
						<input type="radio" id="payment-cash" name="payment" value="cash">
						<label for="payment-cash">Nakit ödeyeceğim.</label>
					</div>
					<div class="payment-option">
						<input type="radio" id="payment-card" name="payment" value="card">
						<label for="payment-card">Kredi kartı ile ödeyeceğim.</label>
					</div>
				</div>
			</div>
		</div>

		<!-- Sidebar - Order Summary -->
		<aside class="sidebar">
			<div class="order-summary">
				<h2 class="order-summary-title">Sipariş Özeti</h2>
				<div class="order-summary-count" id="orderCount">(0 Ürün)</div>

				<div class="order-row">
					<span class="order-row-label">Sipariş Tutarı</span>
					<div class="order-row-values">
						<span class="price-value price-value-large" id="orderTotal">₺0,00</span>
						<span class="points-value" id="orderTotalPoints">★ 0 Puan</span>
					</div>
				</div>

				<!-- Campaign Section -->
				<div class="campaign-section">
					<div class="campaign-header open" id="campaignHeader">
						<span class="campaign-header-title">Sepete Uygulanan Kampanya</span>
						<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<polyline points="6 9 12 15 18 9"/>
						</svg>
					</div>
					<div class="campaign-content open" id="campaignContent">
						<div class="campaign-label">Kampanyalar</div>
						<div class="campaign-option">
							<input type="radio" name="campaign" id="campaign1" checked>
							<div class="campaign-option-icon">
								<svg viewBox="0 0 24 24" fill="currentColor">
									<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
								</svg>
							</div>
							<div class="campaign-option-details">
								<div class="campaign-option-name">Kilo Kilo Puan Kampanyası</div>
								<div class="campaign-option-desc">Kilo Kilo Puan Kampanyası</div>
							</div>
							<a href="#" class="campaign-option-link">Detaylar</a>
						</div>
					</div>
				</div>

				<!-- Order Note -->
				<div class="order-note-section">
					<label class="order-note-label">Sipariş Notu</label>
					<textarea class="order-note-textarea" id="orderNote" placeholder="Siparişiniz için not ekleyebilirsiniz..."></textarea>
				</div>

				<!-- Submit Button -->
				<button class="btn-submit" id="submitBtn">
					Sipariş Ver
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M5 12h14M12 5l7 7-7 7"/>
					</svg>
				</button>
			</div>
		</aside>
	</div>

	<!-- Footer (Component) -->
	<div id="isyerim-footer"></div>

	<!-- Bayi Selection Overlay -->
	<div class="bayi-overlay" id="bayiOverlay">
		<div class="bayi-modal">
			<div class="bayi-modal-header">
				<h3 class="bayi-modal-title">Bayi Seçiniz</h3>
				<button class="bayi-modal-close" id="bayiModalClose">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="18" y1="6" x2="6" y2="18"/>
						<line x1="6" y1="6" x2="18" y2="18"/>
					</svg>
				</button>
			</div>
			<div class="bayi-list" id="bayiList">
				<!-- Bayiler Supabase'den dinamik olarak yüklenir -->
				<div style="text-align: center; padding: 20px; color: #666;">Bayiler yükleniyor...</div>
			</div>
		</div>
	</div>

	<!-- Delivery Date/Time Selection Overlay -->
	<div class="delivery-overlay" id="deliveryOverlay">
		<div class="delivery-modal">
			<div class="delivery-modal-header">
				<h3 class="delivery-modal-title">Teslimat Tarihi ve Saati</h3>
			</div>
			<div class="delivery-tabs" id="deliveryTabs">
				<!-- Tarihler JavaScript ile dinamik olarak oluşturulacak -->
			</div>
			<div class="delivery-times" id="deliveryTimes">
				<div class="delivery-time-option">
					<input type="radio" id="time1" name="deliveryTime" value="09:00-12:00">
					<label for="time1">09:00-12:00</label>
				</div>
				<div class="delivery-time-option">
					<input type="radio" id="time2" name="deliveryTime" value="12:00-15:00">
					<label for="time2">12:00-15:00</label>
				</div>
				<div class="delivery-time-option">
					<input type="radio" id="time3" name="deliveryTime" value="15:00-18:00">
					<label for="time3">15:00-18:00</label>
				</div>
			</div>
			<div class="delivery-modal-footer">
				<button class="btn-select-delivery" id="selectDeliveryBtn">
					Seç
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M5 12h14M12 5l7 7-7 7"/>
					</svg>
				</button>
			</div>
		</div>
	</div>

	<!-- Component Loader -->
	<script src="./js/component-loader.js"></script>

	<!-- Supabase CDN -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<!-- Supabase Client -->
	<script src="./js/supabase-client.js"></script>
	<!-- Service Dosyaları -->
	<script src="./js/services/products-service.js"></script>
	<script src="./js/services/customers-service.js"></script>
	<script src="./js/services/customer-prices-service.js"></script>
	<script src="./js/services/orders-service.js"></script>
	<script src="./js/services/dealers-service.js"></script>
	<script src="./js/services/cart-service.js"></script>
	<script src="./js/services/branches-service.js"></script>
	<script src="./js/services/customer-users-service.js"></script>
	<script src="./js/services/offers-service.js"></script>

	<script>
		// Global değişkenler
		var dealersList = [];
		var selectedDeliveryDate = null;

		// Fiyat formatlama fonksiyonu
		function formatPrice(price) {
			return '₺' + parseFloat(price || 0).toLocaleString('tr-TR', {
				minimumFractionDigits: 2,
				maximumFractionDigits: 2
			});
		}

		// Sayfa yüklendiğinde sepeti kontrol et ve özeti göster
		function loadOrderSummary() {
			var cart = CartService.getCart();

			// Sepet boşsa anasayfaya yönlendir
			if (cart.items.length === 0) {
				alert('Sepetiniz boş. Lütfen ürün ekleyin.');
				window.location.href = 'isyerim-musteri-anasayfa.html';
				return;
			}

			// Toplam hesapla
			var totalItems = CartService.getItemCount();
			var totalPoints = CartService.getTotalPoints();
			var totalPrice = CartService.getTotal();

			// DOM güncelle
			document.getElementById('orderCount').textContent = '(' + totalItems + ' Ürün)';
			document.getElementById('orderTotal').textContent = formatPrice(totalPrice);
			document.getElementById('orderTotalPoints').textContent = '★ ' + totalPoints + ' Puan';
		}

		// Bayileri Supabase'den yükle (seçili şubenin il/ilçesine göre filtrelenmiş)
		async function loadDealers() {
			var bayiListContainer = document.getElementById('bayiList');
			bayiListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Bayiler yükleniyor...</div>';

			try {
				// Seçili şube ID'sini al
				var selectedBranchId = sessionStorage.getItem('selected_address_id');

				console.log('Seçili şube ID:', selectedBranchId);

				if (!selectedBranchId) {
					bayiListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Lütfen önce bir şube seçin.</div>';
					return;
				}

				// ============ Aktif teklif kontrolü ============
				var customerId = sessionStorage.getItem('isyerim_customer_id');
				if (customerId) {
					var offerResult = await OffersService.getLatestOfferByCustomerId(customerId);

					if (offerResult.data && offerResult.data.dealer) {
						var offer = offerResult.data;
						// Aktif teklif durumları: accepted, pending, requested
						var activeStatuses = ['accepted', 'pending', 'requested'];

						if (activeStatuses.includes(offer.status)) {
							// Aktif teklif var - sadece bu bayiyi göster ve otomatik seç
							var dealer = offer.dealer;
							dealersList = [dealer];

							// Bayiyi otomatik seç
							bayiSelect.value = dealer.id;
							bayiSelectorText.textContent = dealer.name;
							bayiSelectorText.classList.remove('placeholder');

							// Bayi listesini güncelle (modal açılırsa göster)
							var location = [dealer.district, dealer.city].filter(Boolean).join(', ') || 'Adres bilgisi yok';
							bayiListContainer.innerHTML = '<div class="bayi-item selected" data-value="' + dealer.id + '" data-name="' + dealer.name + '">' +
								'<div class="bayi-item-info">' +
									'<div class="bayi-item-name">' + dealer.name + '</div>' +
									'<div class="bayi-item-address">' + location + '</div>' +
								'</div>' +
							'</div>';

							attachBayiItemEvents();

							// Teslimat seçiciyi aktif et
							var deliverySelector = document.getElementById('deliverySelector');
							var deliveryNotice = document.getElementById('deliveryNotice');
							if (deliverySelector) deliverySelector.classList.remove('disabled');
							if (deliveryNotice) deliveryNotice.style.display = 'none';

							console.log('Aktif teklif bulundu, bayi otomatik seçildi:', dealer.name);
							return;
						}
					}
				}
				// ============ Aktif teklif kontrolü sonu ============

				// Şube bilgilerini getir
				var branchResult = await BranchesService.getById(selectedBranchId);
				console.log('Şube verisi:', branchResult.data);

				if (!branchResult.data) {
					bayiListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e31e24;">Şube bilgisi bulunamadı.</div>';
					return;
				}

				var branch = branchResult.data;
				var city = branch.city;
				var district = branch.district;
				var districtId = branch.district_id;

				// Eğer city/district VARCHAR alanları boşsa ama UUID'ler varsa, isimleri çek
				if ((!city || !district) && (branch.city_id || branch.district_id)) {
					console.log('VARCHAR alanlar boş, UUID ile isim çekiliyor...');

					if (branch.city_id && !city) {
						var cityResult = await supabaseClient
							.from('cities')
							.select('name')
							.eq('id', branch.city_id)
							.single();
						if (cityResult.data) city = cityResult.data.name;
					}

					if (branch.district_id && !district) {
						var districtResult = await supabaseClient
							.from('districts')
							.select('name')
							.eq('id', branch.district_id)
							.single();
						if (districtResult.data) district = districtResult.data.name;
						districtId = branch.district_id;
					}
				}

				console.log('Filtreleme parametreleri:', { city: city, district: district, districtId: districtId });

				if (!city || !district) {
					bayiListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e31e24;">Şube adres bilgisi eksik. Lütfen şube adresini güncelleyin.</div>';
					return;
				}

				// Micropazar filtrelemesi ile bayileri getir
				var result = await DealersService.getByDistrictWithMikroPazar(city, district, districtId);

				console.log('Filtrelenmiş bayiler:', result.data ? result.data.length : 0, 'adet');

				if (result.error) {
					bayiListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e31e24;">Bayiler yüklenirken hata oluştu.</div>';
					console.error('Bayiler yükleme hatası:', result.error);
					return;
				}

				dealersList = result.data || [];

				if (dealersList.length === 0) {
					bayiListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">' +
						city + ' / ' + district + ' bölgesinde hizmet veren bayi bulunamadı.</div>';
					return;
				}

				// Bayi listesini render et
				bayiListContainer.innerHTML = dealersList.map(function(dealer) {
					var location = [dealer.district, dealer.city].filter(Boolean).join(', ') || 'Adres bilgisi yok';
					return '<div class="bayi-item" data-value="' + dealer.id + '" data-name="' + dealer.name + '">' +
						'<div class="bayi-item-info">' +
							'<div class="bayi-item-name">' + dealer.name + '</div>' +
							'<div class="bayi-item-address">' + location + '</div>' +
						'</div>' +
					'</div>';
				}).join('');

				// Bayi item event'lerini bağla
				attachBayiItemEvents();

			} catch (error) {
				bayiListContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e31e24;">Bayiler yüklenirken hata oluştu.</div>';
				console.error('Bayiler yükleme hatası:', error);
			}
		}

		// Bayi item event'lerini bağla
		function attachBayiItemEvents() {
			var bayiItems = document.querySelectorAll('.bayi-item');
			var deliverySelector = document.getElementById('deliverySelector');
			var deliveryNotice = document.getElementById('deliveryNotice');

			bayiItems.forEach(function(item) {
				item.addEventListener('click', function() {
					var value = this.getAttribute('data-value');
					var name = this.getAttribute('data-name');

					bayiSelect.value = value;
					bayiSelectorText.textContent = name;
					bayiSelectorText.classList.remove('placeholder');
					bayiOverlay.classList.remove('active');

					// Enable delivery selector
					deliverySelector.classList.remove('disabled');

					// Clear previous delivery selection when bayi changes
					deliverySelect.value = '';
					deliverySelectorText.textContent = 'Teslimat Tarihi ve Saati Seçiniz';
					deliverySelectorText.classList.add('placeholder');
					selectedDeliveryDate = null;

					// Clear time radio selections
					var timeRadios = document.querySelectorAll('input[name="deliveryTime"]');
					timeRadios.forEach(function(radio) {
						radio.checked = false;
					});

					// Hide delivery notice
					deliveryNotice.classList.remove('active');
				});
			});
		}

		// Sayfa yüklendiğinde çalıştır
		window.onload = function() {
			console.log('Window loaded, checking services...');
			console.log('CartService:', typeof CartService);
			console.log('DealersService:', typeof DealersService);
			console.log('OrdersService:', typeof OrdersService);

			// Script'lerin yüklendiğinden emin ol
			if (typeof CartService === 'undefined') {
				console.error('CartService yüklenemedi! Lütfen tarayıcı konsolunu kontrol edin.');
				alert('Sayfa yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.');
				return;
			}
			loadOrderSummary();
			loadDealers();
		};

		// Bayi Selector
		var bayiOverlay = document.getElementById('bayiOverlay');
		var bayiSelector = document.getElementById('bayiSelector');
		var bayiSelectorText = document.getElementById('bayiSelectorText');
		var bayiSelect = document.getElementById('bayiSelect');
		var bayiModalClose = document.getElementById('bayiModalClose');

		// Open modal
		bayiSelector.addEventListener('click', function() {
			bayiOverlay.classList.add('active');
		});

		// Close modal - X button
		bayiModalClose.addEventListener('click', function() {
			bayiOverlay.classList.remove('active');
		});

		// Close modal - click outside
		bayiOverlay.addEventListener('click', function(e) {
			if (e.target === this) {
				this.classList.remove('active');
			}
		});

		// Delivery Selector
		var deliveryOverlay = document.getElementById('deliveryOverlay');
		var deliverySelector = document.getElementById('deliverySelector');
		var deliverySelectorText = document.getElementById('deliverySelectorText');
		var deliverySelect = document.getElementById('deliverySelect');
		var selectDeliveryBtn = document.getElementById('selectDeliveryBtn');
		var selectedDay = '';

		// Türkçe gün ve ay isimleri
		var gunler = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
		var aylar = ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Ağu', 'Eyl', 'Eki', 'Kas', 'Ara'];

		// Dinamik tarih oluşturma fonksiyonu
		function generateDeliveryDates() {
			var deliveryTabsContainer = document.getElementById('deliveryTabs');
			deliveryTabsContainer.innerHTML = '';

			var today = new Date();

			// 5 gün için tab oluştur (bugünden başlayarak)
			for (var i = 0; i < 5; i++) {
				var date = new Date(today);
				date.setDate(today.getDate() + i);

				var gunAdi = gunler[date.getDay()];
				var gun = date.getDate();
				var ay = aylar[date.getMonth()];

				var tab = document.createElement('div');
				tab.className = 'delivery-tab' + (i === 0 ? ' active' : '');
				tab.setAttribute('data-day', i);
				tab.setAttribute('data-date', date.toISOString().split('T')[0]); // YYYY-MM-DD format
				tab.innerHTML = '<div class="delivery-tab-day">' + gunAdi + '</div>' +
								'<div class="delivery-tab-date">' + gun + ' ' + ay + '</div>';

				deliveryTabsContainer.appendChild(tab);

				// İlk tab'ın değerini selectedDay olarak ayarla
				if (i === 0) {
					selectedDay = gunAdi + ' ' + gun + ' ' + ay;
					selectedDeliveryDate = date.toISOString().split('T')[0];
				}
			}

			// Tab'lara click event ekle
			attachTabEvents();
		}

		// Tab event'lerini bağlama fonksiyonu
		function attachTabEvents() {
			var deliveryTabs = document.querySelectorAll('.delivery-tab');
			deliveryTabs.forEach(function(tab) {
				tab.addEventListener('click', function() {
					deliveryTabs.forEach(function(t) {
						t.classList.remove('active');
					});
					this.classList.add('active');
					selectedDay = this.querySelector('.delivery-tab-day').textContent + ' ' +
								  this.querySelector('.delivery-tab-date').textContent;
					selectedDeliveryDate = this.getAttribute('data-date');

					// Gün değişince saat seçimini sıfırla
					var timeRadios = document.querySelectorAll('input[name="deliveryTime"]');
					timeRadios.forEach(function(radio) {
						radio.checked = false;
					});
				});
			});
		}

		// Sayfa yüklendiğinde tarihleri oluştur
		generateDeliveryDates();

		// Open delivery modal (only if not disabled)
		deliverySelector.addEventListener('click', function() {
			if (this.classList.contains('disabled')) {
				alert('Lütfen önce bir bayi seçiniz.');
				return;
			}
			deliveryOverlay.classList.add('active');
		});

		// Close delivery modal - click outside
		deliveryOverlay.addEventListener('click', function(e) {
			if (e.target === this) {
				this.classList.remove('active');
			}
		});

		// Select delivery button
		selectDeliveryBtn.addEventListener('click', function() {
			var selectedTime = document.querySelector('input[name="deliveryTime"]:checked');

			if (!selectedTime) {
				alert('Lütfen bir saat dilimi seçiniz.');
				return;
			}

			var timeLabel = selectedTime.nextElementSibling.textContent;
			var displayText = selectedDay + ' / ' + timeLabel;

			deliverySelect.value = selectedDay + '-' + timeLabel;
			deliverySelectorText.textContent = displayText;
			deliverySelectorText.classList.remove('placeholder');
			deliveryOverlay.classList.remove('active');

			// Show delivery notice bar
			var deliveryNotice = document.getElementById('deliveryNotice');
			deliveryNotice.classList.add('active');
		});

		// Campaign toggle
		document.getElementById('campaignHeader').addEventListener('click', function() {
			this.classList.toggle('open');
			document.getElementById('campaignContent').classList.toggle('open');
		});

		// Form validation and submission
		document.getElementById('submitBtn').addEventListener('click', async function() {
			var bayiId = document.getElementById('bayiSelect').value;
			var delivery = document.getElementById('deliverySelect').value;
			var payment = document.querySelector('input[name="payment"]:checked');
			var orderNote = document.getElementById('orderNote').value;

			if (!bayiId) {
				alert('Lütfen bir bayi seçiniz.');
				return;
			}

			if (!delivery) {
				alert('Lütfen teslimat tarihi ve saati seçiniz.');
				return;
			}

			if (!payment) {
				alert('Lütfen ödeme yöntemi seçiniz.');
				return;
			}

			// Butonu devre dışı bırak
			var submitBtn = document.getElementById('submitBtn');
			submitBtn.disabled = true;
			submitBtn.innerHTML = 'Sipariş Oluşturuluyor...';

			try {
				// Teslimat saatini al
				var selectedTime = document.querySelector('input[name="deliveryTime"]:checked');
				var deliveryTime = selectedTime ? selectedTime.value : null;

				// Sube ID'sini al
				var branchId = sessionStorage.getItem('selected_address_id') || null;

				// Teslimat bilgileri
				var deliveryInfo = {
					date: selectedDeliveryDate,
					time: deliveryTime,
					paymentMethod: payment.value,
					notes: orderNote || null,
					branchId: branchId
				};

				// Demo müşteri ID (gerçek uygulamada login'den alınacak)
				var customerId = sessionStorage.getItem('isyerim_customer_id') || null;

				// Sipariş oluştur - CartService.checkout() kullan
				var result = await CartService.checkout(customerId, bayiId, deliveryInfo);

				if (result.error) {
					alert('Sipariş oluşturulurken hata oluştu: ' + result.error);
					submitBtn.disabled = false;
					submitBtn.innerHTML = 'Sipariş Ver <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
					return;
				}

				// Sipariş ID'sini kaydet (özet sayfasında göstermek için)
				if (result.data && result.data.id) {
					sessionStorage.setItem('isyerim_last_order_id', result.data.id);
					sessionStorage.setItem('isyerim_last_order_number', result.data.order_number);
				}

				// Başarılı - sipariş özet sayfasına yönlendir
				window.location.href = 'isyerim-musteri-siparis-ozet.html';

			} catch (error) {
				console.error('Sipariş hatası:', error);
				alert('Sipariş oluşturulurken bir hata oluştu. Lütfen tekrar deneyin.');
				submitBtn.disabled = false;
				submitBtn.innerHTML = 'Sipariş Ver <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
			}
		});

		// Sube degisikligini dinle (header'dan sube degistiginde)
		window.addEventListener('branchChanged', function(event) {
			console.log('Sube degisti, bayiler yeniden yukleniyor...');

			// Mevcut bayi secimini temizle
			bayiSelect.value = '';
			bayiSelectorText.textContent = 'Bayi Seciniz';
			bayiSelectorText.classList.add('placeholder');

			// Teslimat secimini sifirla
			deliverySelect.value = '';
			deliverySelectorText.textContent = 'Teslimat Tarihi ve Saati Seçiniz';
			deliverySelectorText.classList.add('placeholder');
			deliverySelector.classList.add('disabled');
			document.getElementById('deliveryNotice').classList.remove('active');

			// Saat secimini sifirla
			var timeRadios = document.querySelectorAll('input[name="deliveryTime"]');
			timeRadios.forEach(function(radio) {
				radio.checked = false;
			});
			selectedDeliveryDate = null;

			// Bayileri yeniden yukle
			loadDealers();
		});
	</script>
</body>
</html>
